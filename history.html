<!-- templates/attendance/history.html -->
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Närvarohistorik - {{ school_class.name }} - Study Smart</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/index_styles.css') }}">
    <style>
        .history-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: 'Helvetica Neue', Arial, sans-serif;
        }

        .history-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .history-header h1 {
            margin: 0 0 0.5rem 0;
            font-size: 2rem;
            font-weight: 600;
        }

        .class-info {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .personal-stats-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .personal-stats-header h3 {
            margin: 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .attendance-records {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .records-header {
            background: #f8fafc;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .records-header h3 {
            margin: 0;
            color: #374151;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .records-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .record-item {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }

        .record-item:hover {
            background: #f9fafb;
        }

        .record-item:last-child {
            border-bottom: none;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .record-date-time {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .record-date {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
        }

        .record-time {
            font-size: 0.9rem;
            color: #6b7280;
        }

        .record-subject {
            font-size: 1rem;
            color: #667eea;
            font-weight: 500;
        }

        .record-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .record-stat {
            text-align: center;
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .record-stat.present {
            background: #d1fae5;
            color: #065f46;
        }

        .record-stat.late {
            background: #fef3c7;
            color: #92400e;
        }

        .record-stat.absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .record-stat.excused {
            background: #e0e7ff;
            color: #3730a3;
        }

        .record-stat-number {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .record-stat-label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .record-notes {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            color: #374151;
            font-style: italic;
            margin-top: 1rem;
        }

        .attendance-rate {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .attendance-rate.excellent {
            background: #d1fae5;
            color: #065f46;
        }

        .attendance-rate.good {
            background: #fef3c7;
            color: #92400e;
        }

        .attendance-rate.poor {
            background: #fee2e2;
            color: #991b1b;
        }

        .no-records {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .no-records svg {
            width: 64px;
            height: 64px;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .back-link {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            color: #374151;
            padding: 12px 20px;
            border-radius: 8px;
            text-decoration: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 1000;
        }

        .back-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 2rem;
        }

        .filter-group {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
        }

        .export-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .clear-selection-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .clear-selection-btn:hover {
            background: #4b5563;
        }

        /* Personlig statistik specifika stilar */
        .personal-record-item {
            border-left: 4px solid #10b981;
            background: #f0fdf4;
        }

        .personal-record-item:hover {
            background: #ecfdf5;
        }

        .personal-status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .personal-status-badge.present {
            background: #d1fae5;
            color: #065f46;
        }

        .personal-status-badge.late {
            background: #fef3c7;
            color: #92400e;
        }

        .personal-status-badge.absent {
            background: #fee2e2;
            color: #991b1b;
        }

        .personal-status-badge.excused {
            background: #e0e7ff;
            color: #3730a3;
        }

        /* Nya stilar för tidsperiod filter */
        .timespan-controls {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .timespan-filter {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .timespan-select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .timespan-info {
            background: #e0f2fe;
            color: #0369a1;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .custom-date-range {
            display: none;
            gap: 1rem;
            align-items: center;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .custom-date-range.active {
            display: flex;
        }

        .loading-stats {
            text-align: center;
            padding: 2rem;
            color: #6b7280;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .history-container {
                padding: 10px;
            }
            
            .record-header {
                flex-direction: column;
                align-items: stretch;
                gap: 1rem;
            }
            
            .record-stats {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-group {
                flex-direction: column;
                align-items: stretch;
            }

            .timespan-filter {
                flex-direction: column;
                align-items: stretch;
            }

            .custom-date-range {
                flex-direction: column;
                align-items: stretch;
            }
            
            .back-link {
                position: static;
                margin-bottom: 1rem;
            }
        }
    </style>
</head>
<body>
    <a href="{{ url_for('index') }}" class="back-link">
        ← Tillbaka till startsidan
    </a>

    <!-- Klass-väljare -->
    <div class="filters">
      <div class="filter-group">
        <label for="class-selector">Välj klass:</label>
        <select id="class-selector" class="filter-select">
          {% for cls in teacher_classes %}
            <option
              value="{{ url_for('attendance_history', class_id=cls.id) }}"
              {% if cls.id == current_class_id %} selected {% endif %}>
              {{ cls.name }}
            </option>
          {% endfor %}
        </select>

        <label for="student-selector">Välj elev:</label>
        <select id="student-selector" class="filter-select">
            <option value="">Alla elever (klassstatistik)</option>
            {% for student in students %}
            <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
            {% endfor %}
        </select>

        <button id="clear-selection" class="clear-selection-btn" style="display: none;">
            Rensa val
        </button>
      </div>
    </div>

    <!-- Tidsperiod kontroller -->
    <div class="filters">
        <div class="timespan-controls">
            <div class="timespan-filter">
                <label for="timespan-selector">📅 Tidsperiod:</label>
                <select id="timespan-selector" class="timespan-select">
                    <option value="30days">Senaste 30 dagarna</option>
                    <option value="7days">Senaste veckan</option>
                    <option value="month">Denna månad</option>
                    <option value="semester">Detta läsår/termin</option>
                    <option value="all">Totalt (alla datum)</option>
                    <option value="custom">Anpassat datumintervall</option>
                </select>
                <span id="timespan-info" class="timespan-info">Visar senaste 30 dagarna</span>
            </div>
            
            <div id="custom-date-range" class="custom-date-range">
                <label for="custom-date-from">Från:</label>
                <input type="date" id="custom-date-from" class="filter-input">
                <label for="custom-date-to">Till:</label>
                <input type="date" id="custom-date-to" class="filter-input">
                <button id="apply-custom-range" class="export-btn" style="background: #667eea;">Tillämpa</button>
            </div>
        </div>
    </div>

    <div class="history-container">
        <div class="history-header">
            <h1>📊 Närvarohistorik</h1>
            <div class="class-info">
                {{ school_class.name }} – {{ school_class.school.name or 'Okänd skola' }}
            </div>
        </div>

        <!-- Klassstatistik (visas som standard) -->
        <div id="class-stats" class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="total-lessons-stat">{{ total_lessons }}</div>
                <div class="stat-label">Rapporterade lektioner</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-present-stat">{{ total_present }}</div>
                <div class="stat-label">Närvarande totalt</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-late-stat">{{ total_late }}</div>
                <div class="stat-label">Sena totalt</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-absent-stat">{{ total_absent }}</div>
                <div class="stat-label">Frånvarande totalt</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-excused-stat">{{ total_excused }}</div>
                <div class="stat-label">Ursäktade totalt</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avg-attendance-stat">{{ avg_attendance }}%</div>
                <div class="stat-label">Genomsnittlig närvaro</div>
            </div>
        </div>

        <!-- Personlig statistik (dold som standard) -->
        <div id="student-stats" class="stats-overview" style="display: none;">
            <div class="personal-stats-header">
                <h3 id="selected-student-name">Personlig statistik</h3>
            </div>
            <!-- Här fylls det på via JS -->
        </div>

        <!-- Datum- och ämnesfilter + export -->
        <div class="filters">
            <div class="filter-group">
                <label for="date-from">Från datum:</label>
                <input type="date" id="date-from" class="filter-input">
                <label for="date-to">Till datum:</label>
                <input type="date" id="date-to" class="filter-input">
                <label for="subject-filter">Ämne:</label>
                <select id="subject-filter" class="filter-select">
                    <option value="">Alla ämnen</option>
                    {% for rec in attendance_records %}
                      {% if rec.subject %}
                        <option value="{{ rec.subject.name }}">{{ rec.subject.name }}</option>
                      {% endif %}
                    {% endfor %}
                </select>
                <button class="export-btn" onclick="exportData()">📊 Exportera</button>
            </div>
        </div>

        <!-- Närvarorapporter -->
        <div class="attendance-records">
            <div class="records-header">
                <h3 id="records-title">Närvarorapporter (senaste 30 dagarna)</h3>
            </div>
            <div class="records-list" id="records-list">
                {% if attendance_records %}
                    {% for record in attendance_records %}
                        {% set summary = summaries[record.id] %}
                        <div class="record-item" 
                             data-date="{{ record.date }}" 
                             data-subject="{{ record.subject.name if record.subject else '' }}"
                             data-record-id="{{ record.id }}">
                            <div class="record-header">
                                <div class="record-date-time">
                                    <div class="record-date">
                                        {{ record.date.strftime('%A, %d %B %Y') }}
                                    </div>
                                    <div class="record-time">
                                        {% if record.schedule_item %}
                                            {{ record.schedule_item.start_time }} – {{ record.schedule_item.end_time }}
                                        {% endif %}
                                        • Rapporterat {{ record.created_at.strftime('%H:%M') }}
                                    </div>
                                </div>
                                <div class="record-subject">
                                    {{ record.subject.name if record.subject else 'Okänt ämne' }}
                                    {% set rate = summary.attendance_rate %}
                                    <div class="attendance-rate {{ 'excellent' if summary.attendance_rate >= 90 else 'good' if summary.attendance_rate >= 75 else 'poor' }}">
                                        {{ summary.attendance_rate }}% närvaro
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Klassstatistik (standard) -->
                            <div class="record-stats class-stats-view">
                                <div class="record-stat present">
                                    <div class="record-stat-number">{{ summary.present }}</div>
                                    <div class="record-stat-label">Närvarande</div>
                                </div>
                                <div class="record-stat late">
                                    <div class="record-stat-number">{{ summary.late }}</div>
                                    <div class="record-stat-label">Sena</div>
                                </div>
                                <div class="record-stat absent">
                                    <div class="record-stat-number">{{ summary.absent }}</div>
                                    <div class="record-stat-label">Frånvarande</div>
                                </div>
                                <div class="record-stat excused">
                                    <div class="record-stat-number">{{ summary.get('excused', 0) }}</div>
                                    <div class="record-stat-label">Ursäktade</div>
                                </div>
                            </div>

                            <!-- Personlig närvaro (dold som standard) -->
                            <div class="personal-stats-view" style="display: none;">
                                <div class="personal-attendance-info">
                                    <span class="personal-status-badge" data-status="unknown">Läser in...</span>
                                    <span class="arrival-time" style="margin-left: 1rem; font-size: 0.9rem; color: #6b7280;"></span>
                                </div>
                                <div class="personal-notes" style="margin-top: 0.5rem; font-size: 0.9rem; color: #6b7280;"></div>
                            </div>

                            {% if record.lesson_notes %}
                            <div class="record-notes">
                                <strong>Lektionsanteckningar:</strong> {{ record.lesson_notes }}
                            </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-records">
                        <h3>Inga närvarorapporter hittades</h3>
                        <p>Det finns inga rapporterade närvaroregistreringar för denna klass under de senaste 30 dagarna.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        // Globala variabler för att hålla all data
        const studentStats = {{ student_stats|tojson }};
        const attendanceData = {{ attendance_records_json|tojson }};
        let selectedStudentId = null;
        let personalAttendanceData = {};
        let currentTimespan = '30days';

        // Tidsspann beräkningar
        function getTimespanDates(timespan) {
            const today = new Date();
            const dates = { from: null, to: today };

            switch(timespan) {
                case '7days':
                    dates.from = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                    break;
                case '30days':
                    dates.from = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                    break;
                case 'month':
                    dates.from = new Date(today.getFullYear(), today.getMonth(), 1);
                    break;
                case 'semester':
                    // Approximation: augusti till juni
                    const currentMonth = today.getMonth();
                    if (currentMonth >= 7) { // Augusti och framåt = hösttermin
                        dates.from = new Date(today.getFullYear(), 7, 1); // 1 augusti
                    } else { // Januari till juli = vårtermin
                        dates.from = new Date(today.getFullYear(), 0, 1); // 1 januari
                    }
                    break;
                case 'all':
                    dates.from = new Date('2000-01-01'); // Mycket tidigt datum
                    break;
                case 'custom':
                    // Hanteras separat
                    return null;
                default:
                    dates.from = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            }

            return dates;
        }

        function getTimespanDescription(timespan) {
            const descriptions = {
                '7days': 'Visar senaste 7 dagarna',
                '30days': 'Visar senaste 30 dagarna', 
                'month': 'Visar denna månad',
                'semester': 'Visar detta läsår/termin',
                'all': 'Visar alla datum',
                'custom': 'Anpassat datumintervall'
            };
            return descriptions[timespan] || 'Okänd tidsperiod';
        }

        function updateTimespanInfo(timespan) {
            const infoElement = document.getElementById('timespan-info');
            infoElement.textContent = getTimespanDescription(timespan);
        }

        function calculateStatsForTimespan(timespan, customFrom = null, customTo = null) {
            let fromDate, toDate;

            if (timespan === 'custom' && customFrom && customTo) {
                fromDate = new Date(customFrom);
                toDate = new Date(customTo);
            } else if (timespan !== 'custom') {
                const dates = getTimespanDates(timespan);
                if (!dates) return null;
                fromDate = dates.from;
                toDate = dates.to;
            } else {
                return null;
            }

            // Filtrera attendance records baserat på tidsperiod
            const filteredRecords = attendanceData.filter(record => {
                const recordDate = new Date(record.date);
                return recordDate >= fromDate && recordDate <= toDate;
            });

            // Beräkna statistik för klassöversikt
            let totalLessons = filteredRecords.length;
            let totalPresent = 0;
            let totalLate = 0; 
            let totalAbsent = 0;
            let totalExcused = 0;

            filteredRecords.forEach(record => {
                const summary = record.summary || {};
                totalPresent += summary.present || 0;
                totalLate += summary.late || 0;
                totalAbsent += summary.absent || 0;
                totalExcused += summary.excused || 0;
            });

            const totalStudentRecords = totalPresent + totalLate + totalAbsent + totalExcused;
            const avgAttendance = totalStudentRecords > 0 ? 
                Math.round(((totalPresent + totalLate) / totalStudentRecords) * 100) : 0;

            return {
                totalLessons,
                totalPresent,
                totalLate,
                totalAbsent,
                totalExcused,
                avgAttendance,
                filteredRecords
            };
        }

        function calculatePersonalStatsForTimespan(studentId, timespan, customFrom = null, customTo = null) {
            let fromDate, toDate;

            if (timespan === 'custom' && customFrom && customTo) {
                fromDate = new Date(customFrom);
                toDate = new Date(customTo);
            } else if (timespan !== 'custom') {
                const dates = getTimespanDates(timespan);
                if (!dates) return null;
                fromDate = dates.from;
                toDate = dates.to;
            } else {
                return null;
            }

            // Filtrera personlig attendance data
            const filteredPersonalData = Object.entries(personalAttendanceData)
                .filter(([recordId, record]) => {
                    const attendanceRecord = attendanceData.find(ar => ar.id == recordId);
                    if (!attendanceRecord) return false;
                    const recordDate = new Date(attendanceRecord.date);
                    return recordDate >= fromDate && recordDate <= toDate;
                })
                .map(([recordId, record]) => record);

            let present = 0, late = 0, absent = 0, excused = 0;

            filteredPersonalData.forEach(record => {
                switch(record.status) {
                    case 'present': present++; break;
                    case 'late': late++; break;
                    case 'absent': absent++; break;
                    case 'excused': excused++; break;
                }
            });

            const total = present + late + absent + excused;
            const rate = total > 0 ? Math.round(((present + late) / total) * 100) : 0;

            return {
                total,
                present, 
                late,
                absent,
                excused,
                rate
            };
        }

        function updateClassStats(stats) {
            if (!stats) return;
            
            document.getElementById('total-lessons-stat').textContent = stats.totalLessons;
            document.getElementById('total-present-stat').textContent = stats.totalPresent;
            document.getElementById('total-late-stat').textContent = stats.totalLate;
            document.getElementById('total-absent-stat').textContent = stats.totalAbsent;
            document.getElementById('total-excused-stat').textContent = stats.totalExcused;
            document.getElementById('avg-attendance-stat').textContent = stats.avgAttendance + '%';
        }

        function updatePersonalStats(studentId, stats) {
            if (!stats) return;

            const student = studentStats.find(s => s.id == studentId);
            if (!student) return;

            const studentStatsDiv = document.getElementById('student-stats');
            studentStatsDiv.innerHTML = `
                <div class="personal-stats-header">
                    <h3>${student.name} - Personlig statistik</h3>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.total}</div>
                    <div class="stat-label">Totalt lektioner</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.present}</div>
                    <div class="stat-label">Närvarande</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.late}</div>
                    <div class="stat-label">Sena</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.absent}</div>
                    <div class="stat-label">Frånvarande</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.excused}</div>
                    <div class="stat-label">Ursäktade</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${stats.rate}%</div>
                    <div class="stat-label">Närvaro %</div>
                </div>
            `;
        }

        function filterRecordsByTimespan(timespan, customFrom = null, customTo = null) {
            let fromDate, toDate;

            if (timespan === 'custom' && customFrom && customTo) {
                fromDate = new Date(customFrom);
                toDate = new Date(customTo);
            } else if (timespan !== 'custom') {
                const dates = getTimespanDates(timespan);
                if (!dates) return;
                fromDate = dates.from;
                toDate = dates.to;
            } else {
                return;
            }

            // Uppdatera datum filter inputs
            const dateFromInput = document.getElementById('date-from');
            const dateToInput = document.getElementById('date-to');
            dateFromInput.value = fromDate.toISOString().split('T')[0];
            dateToInput.value = toDate.toISOString().split('T')[0];

            // Kör befintlig filter funktion
            filterRecords();

            // Uppdatera records titel
            const recordsTitle = document.getElementById('records-title');
            const timespanText = getTimespanDescription(timespan);
            if (selectedStudentId) {
                const student = studentStats.find(s => s.id == selectedStudentId);
                recordsTitle.textContent = `Närvarorapporter för ${student.name} (${timespanText.toLowerCase()})`;
            } else {
                recordsTitle.textContent = `Närvarorapporter (${timespanText.toLowerCase()})`;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const dateFromInput = document.getElementById('date-from');
            const dateToInput = document.getElementById('date-to');
            const subjectFilter = document.getElementById('subject-filter');
            const recordsList = document.getElementById('records-list');
            const studentSelector = document.getElementById('student-selector');
            const classSelector = document.getElementById('class-selector');
            const clearSelectionBtn = document.getElementById('clear-selection');
            const classStatsDiv = document.getElementById('class-stats');
            const studentStatsDiv = document.getElementById('student-stats');
            const recordsTitle = document.getElementById('records-title');
            const selectedStudentName = document.getElementById('selected-student-name');
            
            // Nya element för tidsperiod
            const timespanSelector = document.getElementById('timespan-selector');
            const customDateRange = document.getElementById('custom-date-range');
            const customDateFrom = document.getElementById('custom-date-from');
            const customDateTo = document.getElementById('custom-date-to');
            const applyCustomRange = document.getElementById('apply-custom-range');
            
            // Sätt standarddatum (senaste 30 dagarna)
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            dateFromInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            dateToInput.value = today.toISOString().split('T')[0];
            
            // Tidsperiod väljare
            timespanSelector.addEventListener('change', function() {
                const selectedTimespan = this.value;
                currentTimespan = selectedTimespan;
                updateTimespanInfo(selectedTimespan);
                
                if (selectedTimespan === 'custom') {
                    customDateRange.classList.add('active');
                } else {
                    customDateRange.classList.remove('active');
                    
                    // Beräkna och uppdatera statistik
                    const stats = calculateStatsForTimespan(selectedTimespan);
                    if (stats) {
                        updateClassStats(stats);
                        
                        // Om en elev är vald, uppdatera även personlig statistik
                        if (selectedStudentId) {
                            const personalStats = calculatePersonalStatsForTimespan(selectedStudentId, selectedTimespan);
                            if (personalStats) {
                                updatePersonalStats(selectedStudentId, personalStats);
                            }
                        }
                    }
                    
                    // Filtrera synliga records
                    filterRecordsByTimespan(selectedTimespan);
                }
            });
            
            // Anpassat datumintervall
            applyCustomRange.addEventListener('click', function() {
                const fromDate = customDateFrom.value;
                const toDate = customDateTo.value;
                
                if (!fromDate || !toDate) {
                    alert('Vänligen välj både från- och till-datum.');
                    return;
                }
                
                if (new Date(fromDate) > new Date(toDate)) {
                    alert('Från-datum kan inte vara senare än till-datum.');
                    return;
                }
                
                // Beräkna och uppdatera statistik
                const stats = calculateStatsForTimespan('custom', fromDate, toDate);
                if (stats) {
                    updateClassStats(stats);
                    
                    // Om en elev är vald, uppdatera även personlig statistik
                    if (selectedStudentId) {
                        const personalStats = calculatePersonalStatsForTimespan(selectedStudentId, 'custom', fromDate, toDate);
                        if (personalStats) {
                            updatePersonalStats(selectedStudentId, personalStats);
                        }
                    }
                }
                
                // Filtrera synliga records
                filterRecordsByTimespan('custom', fromDate, toDate);
                
                // Uppdatera info text
                const fromStr = new Date(fromDate).toLocaleDateString('sv-SE');
                const toStr = new Date(toDate).toLocaleDateString('sv-SE');
                document.getElementById('timespan-info').textContent = `Anpassat: ${fromStr} - ${toStr}`;
            });
            
            // Klassväljare
            classSelector.addEventListener('change', () => {
                window.location.href = classSelector.value;
            });

            // Elevväljare
            studentSelector.addEventListener('change', async () => {
                const studentId = studentSelector.value;
                selectedStudentId = studentId;

                if (!studentId) {
                    // Visa klassstatistik
                    showClassStats();
                } else {
                    // Visa personlig statistik
                    await showPersonalStats(studentId);
                }
            });

            // Rensa val
            clearSelectionBtn.addEventListener('click', () => {
                studentSelector.value = '';
                selectedStudentId = null;
                showClassStats();
            });

            function showClassStats() {
                classStatsDiv.style.display = 'grid';
                studentStatsDiv.style.display = 'none';
                clearSelectionBtn.style.display = 'none';
                
                // Uppdatera titel baserat på tidsperiod
                const timespanText = getTimespanDescription(currentTimespan);
                recordsTitle.textContent = `Närvarorapporter (${timespanText.toLowerCase()})`;

                // Visa klassstatistik i alla record-items
                document.querySelectorAll('.record-item').forEach(item => {
                    const classStats = item.querySelector('.class-stats-view');
                    const personalStats = item.querySelector('.personal-stats-view');
                    if (classStats) classStats.style.display = 'grid';
                    if (personalStats) personalStats.style.display = 'none';
                    item.classList.remove('personal-record-item');
                });
                
                // Uppdatera klassstatistik baserat på aktuell tidsperiod
                if (currentTimespan === 'custom') {
                    const fromDate = customDateFrom.value;
                    const toDate = customDateTo.value;
                    if (fromDate && toDate) {
                        const stats = calculateStatsForTimespan('custom', fromDate, toDate);
                        if (stats) updateClassStats(stats);
                    }
                } else {
                    const stats = calculateStatsForTimespan(currentTimespan);
                    if (stats) updateClassStats(stats);
                }
            }

            async function showPersonalStats(studentId) {
                const student = studentStats.find(s => s.id == studentId);
                if (!student) return;

                // Uppdatera UI
                classStatsDiv.style.display = 'none';
                studentStatsDiv.style.display = 'grid';
                clearSelectionBtn.style.display = 'inline-block';
                
                const timespanText = getTimespanDescription(currentTimespan);
                recordsTitle.textContent = `Närvarorapporter för ${student.name} (${timespanText.toLowerCase()})`;
                selectedStudentName.textContent = `${student.name} - Personlig statistik`;

                // Hämta personlig närvarodata
                await loadPersonalAttendanceData(studentId);
                
                // Beräkna personlig statistik baserat på aktuell tidsperiod
                let personalStats;
                if (currentTimespan === 'custom') {
                    const fromDate = customDateFrom.value;
                    const toDate = customDateTo.value;
                    if (fromDate && toDate) {
                        personalStats = calculatePersonalStatsForTimespan(studentId, 'custom', fromDate, toDate);
                    }
                } else {
                    personalStats = calculatePersonalStatsForTimespan(studentId, currentTimespan);
                }
                
                if (personalStats) {
                    updatePersonalStats(studentId, personalStats);
                } else {
                    // Fallback till original data
                    studentStatsDiv.innerHTML = `
                        <div class="personal-stats-header">
                            <h3>${student.name} - Personlig statistik</h3>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.total}</div>
                            <div class="stat-label">Totalt lektioner</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.present}</div>
                            <div class="stat-label">Närvarande</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.late}</div>
                            <div class="stat-label">Sena</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.absent}</div>
                            <div class="stat-label">Frånvarande</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.excused}</div>
                            <div class="stat-label">Ursäktade</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number">${student.rate}%</div>
                            <div class="stat-label">Närvaro %</div>
                        </div>
                    `;
                }

                updatePersonalRecordItems();
            }

            async function loadPersonalAttendanceData(studentId) {
                try {
                    const response = await fetch(`/api/attendance/student/${studentId}/class/{{ current_class_id }}`);
                    const data = await response.json();
                    
                    if (data.status === 'success') {
                        personalAttendanceData = {};
                        data.attendance_records.forEach(record => {
                            personalAttendanceData[record.attendance_id] = record;
                        });
                    }
                } catch (error) {
                    console.error('Error loading personal attendance data:', error);
                }
            }

            function updatePersonalRecordItems() {
                document.querySelectorAll('.record-item').forEach(item => {
                    const recordId = item.dataset.recordId;
                    const classStats = item.querySelector('.class-stats-view');
                    const personalStats = item.querySelector('.personal-stats-view');
                    
                    if (classStats) classStats.style.display = 'none';
                    if (personalStats) {
                        personalStats.style.display = 'block';
                        item.classList.add('personal-record-item');
                        
                        const personalRecord = personalAttendanceData[recordId];
                        const statusBadge = personalStats.querySelector('.personal-status-badge');
                        const arrivalTime = personalStats.querySelector('.arrival-time');
                        const personalNotes = personalStats.querySelector('.personal-notes');
                        
                        if (personalRecord) {
                            const status = personalRecord.status || 'unknown';
                            const statusText = {
                                'present': 'Närvarande',
                                'late': 'Sen',
                                'absent': 'Frånvarande',
                                'excused': 'Ursäktad'
                            }[status] || 'Okänd';
                            
                            statusBadge.textContent = statusText;
                            statusBadge.className = `personal-status-badge ${status}`;
                            statusBadge.dataset.status = status;
                            
                            // Visa ankomsttid om eleven var sen
                            if (status === 'late' && personalRecord.arrival_time) {
                                arrivalTime.textContent = `Ankomst: ${personalRecord.arrival_time}`;
                                arrivalTime.style.display = 'inline';
                            } else {
                                arrivalTime.style.display = 'none';
                            }
                            
                            // Visa personliga anteckningar
                            if (personalRecord.notes) {
                                personalNotes.textContent = `Anteckning: ${personalRecord.notes}`;
                                personalNotes.style.display = 'block';
                            } else {
                                personalNotes.style.display = 'none';
                            }
                        } else {
                            // Ingen data för denna elev på denna lektion
                            statusBadge.textContent = 'Ej rapporterad';
                            statusBadge.className = 'personal-status-badge absent';
                            statusBadge.dataset.status = 'unknown';
                            arrivalTime.style.display = 'none';
                            personalNotes.style.display = 'none';
                        }
                    }
                });
            }
            
            // Samla unika ämnen för filter
            const subjects = new Set();
            document.querySelectorAll('.record-item').forEach(item => {
                const subject = item.dataset.subject;
                if (subject) subjects.add(subject);
            });
            
            // Uppdatera ämnesfilter
            subjects.forEach(subject => {
                if (!document.querySelector(`option[value="${subject}"]`)) {
                    const option = document.createElement('option');
                    option.value = subject;
                    option.textContent = subject;
                    subjectFilter.appendChild(option);
                }
            });
            
            // Filter funktioner
            function filterRecords() {
                const fromDate = new Date(dateFromInput.value);
                const toDate = new Date(dateToInput.value);
                const selectedSubject = subjectFilter.value;
                
                document.querySelectorAll('.record-item').forEach(item => {
                    const itemDate = new Date(item.dataset.date);
                    const itemSubject = item.dataset.subject;
                    
                    let showItem = true;
                    
                    // Datum filter
                    if (dateFromInput.value && itemDate < fromDate) {
                        showItem = false;
                    }
                    if (dateToInput.value && itemDate > toDate) {
                        showItem = false;
                    }
                    
                    // Ämnes filter
                    if (selectedSubject && itemSubject !== selectedSubject) {
                        showItem = false;
                    }
                    
                    item.style.display = showItem ? 'block' : 'none';
                });
                
                // Kontrollera om några poster visas
                const visibleItems = document.querySelectorAll('.record-item[style="display: block"], .record-item:not([style*="display: none"])');
                const noRecords = document.querySelector('.no-records');
                
                if (visibleItems.length === 0 && !noRecords) {
                    const noResultsDiv = document.createElement('div');
                    noResultsDiv.className = 'no-records';
                    noResultsDiv.id = 'no-filter-results';
                    noResultsDiv.innerHTML = `
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                        </svg>
                        <h3>Inga resultat hittades</h3>
                        <p>Inga närvarorapporter matchar de valda filtren.</p>
                    `;
                    recordsList.appendChild(noResultsDiv);
                } else if (visibleItems.length > 0) {
                    const existingNoResults = document.getElementById('no-filter-results');
                    if (existingNoResults) {
                        existingNoResults.remove();
                    }
                }
            }
            
            // Event listeners för filter
            dateFromInput.addEventListener('change', filterRecords);
            dateToInput.addEventListener('change', filterRecords);
            subjectFilter.addEventListener('change', filterRecords);
            
            // Export funktion
            // Export funktion
            window.exportData = function() {
                const visibleItems = document.querySelectorAll('.record-item:not([style*="display: none"])');

                if (visibleItems.length === 0) {
                    alert('Inga data att exportera med nuvarande filter.');
                    return;
                }

                let csvContent = '';
                const timespanText = getTimespanDescription(currentTimespan);

                if (selectedStudentId) {
                    // Export för specifik elev - lägg till kolumn för närvaroprocent
                    const student = studentStats.find(s => s.id == selectedStudentId);
                    csvContent = `Elev,Datum,Ämne,Status,Ankomsttid,Anteckningar,Tidsperiod,Närvaroprocent\n`;

                    let presentCount = 0;
                    let totalLessons = visibleItems.length;

                    visibleItems.forEach(item => {
                        const date = item.dataset.date;
                        const subject = item.dataset.subject || 'Okänt ämne';
                        const recordId = item.dataset.recordId;
                        const personalRecord = personalAttendanceData[recordId];

                        const status = personalRecord ? personalRecord.status : 'ej_rapporterad';
                        const arrivalTime = personalRecord?.arrival_time || '';
                        const notes = personalRecord?.notes || '';

                        const statusText = {
                            'present': 'Närvarande',
                            'late': 'Sen',
                            'absent': 'Frånvarande',
                            'excused': 'Ursäktad',
                            'ej_rapporterad': 'Ej rapporterad'
                        }[status] || 'Okänd';

                        // Räkna närvarande (inkl. sena)
                        if (status === 'present' || status === 'late') {
                            presentCount++;
                        }

                        // Skriv rad (sista kolumn är tom för radvisa poster)
                        csvContent += `"${student.name}","${date}","${subject}","${statusText}","${arrivalTime}","${notes.replace(/"/g, '""')}","${timespanText}",""\n`;
                    });

                    // Beräkna procent (om totalt > 0)
                    const rate = totalLessons > 0 ? Math.round((presentCount / totalLessons) * 100) : 0;

                    // Lägg till sammanfattningsrad längst ner med både X/Y och procent
                    // Placera "Närvarande X / Y lektioner" i Status-kolumn och procentsatsen i sista kolumnen.
                    csvContent += `"${student.name}","SAMMANFATTNING","", "Närvarande: ${presentCount} / ${totalLessons} lektioner","","","${timespanText}","${rate}%"\n`;
                } else {
                    // Export för hela klassen (oförändrad)
                    csvContent = 'Datum,Ämne,Närvarande,Sena,Frånvarande,Ursäktade,Närvaro %,Anteckningar,Tidsperiod\n';

                    visibleItems.forEach(item => {
                        const date = item.dataset.date;
                        const subject = item.dataset.subject || 'Okänt ämne';
                        const stats = item.querySelectorAll('.class-stats-view .record-stat-number');
                        const present = stats[0]?.textContent || '0';
                        const late = stats[1]?.textContent || '0';
                        const absent = stats[2]?.textContent || '0';
                        const excused = stats[3]?.textContent || '0';
                        const attendanceRate = item.querySelector('.attendance-rate')?.textContent?.replace('% närvaro', '') || '0';
                        const notes = item.querySelector('.record-notes')?.textContent?.replace('Lektionsanteckningar: ', '') || '';

                        csvContent += `"${date}","${subject}","${present}","${late}","${absent}","${excused}","${attendanceRate}","${notes.replace(/"/g, '""')}","${timespanText}"\n`;
                    });
                }

                // Skapa och ladda ner fil
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);

                const timespanSuffix = currentTimespan.replace('days', 'd').replace('month', 'm').replace('semester', 's').replace('all', 'total').replace('custom', 'custom');
                const filename = selectedStudentId
                    ? `personlig_narvarohistorik_${timespanSuffix}_${new Date().toISOString().split('T')[0]}.csv`
                    : `narvarohistorik_${timespanSuffix}_${new Date().toISOString().split('T')[0]}.csv`;

                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };


            // Gör filterRecords globalt tillgänglig
            window.filterRecords = filterRecords;
        });
    </script>
</body>
</html>
