<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schemagenerator - {{ school.name if school else 'Ok√§nd skola' }}</title>
    <style>
        /* --- (Samma stil som innan, of√∂r√§ndrad) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            color: #2d3748;
            font-size: 1.8rem;
        }
        .back-btn {
            background: #718096;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .back-btn:hover {
            background: #4a5568;
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .generator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .card h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        /* Multi-select klasser */
        .classes-container {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
            max-height: 200px;
            overflow-y: auto;
        }
        .class-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .class-item:last-child {
            margin-bottom: 0;
        }
        .class-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: auto;
        }
        .class-item-info {
            flex: 1;
        }
        .class-name {
            font-weight: 600;
            color: #2d3748;
        }
        .class-details {
            font-size: 0.85rem;
            color: #718096;
        }
        .subjects-container {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
        }
        .class-subject-section {
            margin-bottom: 1rem;
        }
        .class-subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        .subject-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .subject-item:last-child {
            margin-bottom: 0;
        }
        .subject-item input, .subject-item select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .add-subject-btn {
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .add-subject-btn:hover {
            background: #38a169;
        }
        .remove-subject-btn {
            background: #f56565;
            color: white;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .remove-subject-btn:hover {
            background: #e53e3e;
        }
        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .room-item {
            display: flex;
            align-items: center;
            background: #f7fafc;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .room-item input[type="checkbox"] {
            margin-right: 0.5rem;
            width: auto;
        }
        .constraints-section {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
        }
        .constraint-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .constraint-item input[type="checkbox"] {
            margin-right: 0.5rem;
            width: auto;
        }
        .time-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .lesson-duration-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .btn {
            background: #4299e1;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            justify-self: center;
        }
        .btn-generate:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .schedule-preview {
            min-height: 400px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 1.1rem;
            position: relative;
            overflow-x: auto;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 800px;
        }




        .schedule-status-indicator {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .class-item {
            position: relative;
            transition: all 0.2s ease;
        }

        .class-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .generation-controls {
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .reset-schedule-btn:hover {
            background: #e53e3e !important;
            transform: scale(1.02);
        }

        .save-status {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.85rem;
            margin: 0.5rem 0;
        }

        .save-status.unsaved {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #feb2b2;
        }

        .save-status.saved {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .schedule-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .schedule-actions .btn {
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .schedule-actions .btn:hover {
            transform: translateY(-1px);
        }

        .loading-save {
            opacity: 0.7;
            pointer-events: none;
        }

        /* Enhanced schedule table styles */
        .schedule-table {
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .lesson-cell {
            vertical-align: top !important;
        }

        .lesson-subject {
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: #2d3748;
        }

        .lesson-class {
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 0.25rem;
        }
        .schedule-table th {
            background: #4299e1;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .schedule-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: middle;
            font-size: 0.85rem;
            min-width: 120px;
        }
        .schedule-table tr:hover {
            background: #f7fafc;
        }
        .lesson-cell {
            background: #ebf8ff;
            border-left: 3px solid #4299e1;
            font-size: 0.8rem;
            line-height: 1.1;
            text-align: left;
            padding: 0.4rem;
        }
        .lesson-subject {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.8rem;
        }
        .lesson-class {
            color: #4299e1;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .lesson-room {
            color: #718096;
            font-size: 0.7rem;
        }
        .empty-cell {
            color: #a0aec0;
            font-style: italic;
            font-size: 0.8rem;
        }
        .generation-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4299e1;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border-color: #38a169;
        }
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border-color: #e53e3e;
        }
        .alert-info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #4299e1;
        }
        .alert-warning {
            background: #fffbeb;
            color: #744210;
            border-color: #f59e0b;
        }
        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #4a5568;
        }
        .validation-warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            color: #744210;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .selected-classes-info {
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            color: #234e52;
        }
        .class-color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @media (max-width: 1200px) {
            .generator-layout {
                grid-template-columns: 1fr;
            }
            .subject-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .rooms-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Multi-klass Schemagenerator - {{ school.name if school else 'Testskolan' }}</h1>
        <a href="#" class="back-btn">‚Üê Tillbaka till Dashboard</a>
    </div>

    <div class="container">



        <!-- L√§gg till denna sektion INNAN formul√§ret i schedule_generator.html -->
        <!-- L√§gg till denna sektion INNAN formul√§ret i schedule_generator.html -->
        <div class="card" style="margin-bottom: 2rem;">
            <h3>üìö Hantera Skol√§mnen & L√§rarbeh√∂righeter</h3>
            
            <div class="form-group">
                <label>L√§gg till nytt √§mne:</label>
                <div style="display: flex; gap: 1rem; align-items: end;">
                    <div style="flex: 1;">
                        <input type="text" id="newSubjectName" placeholder="√Ñmnesnamn (t.ex. Matematik, Svenska, Historia)" style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    <button type="button" class="btn" onclick="addNewSubject()" style="background: #48bb78; white-space: nowrap;">+ L√§gg till</button>
                </div>
            </div>
            
            <div class="form-group">
                <label>Befintliga √§mnen & beh√∂riga l√§rare:</label>
                <div id="existingSubjects" class="subjects-list" style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem; background: #f7fafc; min-height: 100px; max-height: 400px; overflow-y: auto;">
                    <div style="color: #666; text-align: center;" id="noSubjectsMessage">
                        Inga √§mnen √§nnu. L√§gg till √§mnen ovan.
                    </div>
                </div>
            </div>
            
            <div class="alert alert-info" style="margin-top: 1rem;">
                <strong>üí° Tips:</strong> √Ñmnena du skapar h√§r kommer att vara tillg√§ngliga f√∂r alla klasser n√§r du genererar scheman. Endast l√§rare som √§r markerade som beh√∂riga kan schemal√§ggas f√∂r respektive √§mne.
            </div>
        </div>

        <!-- Modal f√∂r l√§rarhantering -->
        <div id="teacherModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
            <div class="modal-content" style="background: white; margin: 5% auto; padding: 2rem; width: 80%; max-width: 600px; border-radius: 12px; max-height: 80vh; overflow-y: auto;">
                <div class="modal-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid #e2e8f0; padding-bottom: 1rem;">
                    <h3 id="modalTitle" style="margin: 0; color: #2d3748;">Hantera L√§rarbeh√∂righeter</h3>
                    <button class="close" onclick="closeTeacherModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666;">&times;</button>
                </div>
                
                <div id="modalContent" style="margin-bottom: 1.5rem;">
                    <!-- Content fylls dynamiskt -->
                </div>
                
                <div class="modal-footer" style="border-top: 1px solid #e2e8f0; padding-top: 1rem; text-align: right;">
                    <button type="button" class="btn" onclick="closeTeacherModal()" style="background: #718096;">St√§ng</button>
                </div>
            </div>
        </div>

        
        <!-- Informationsbox om nya regler -->
        <div class="alert alert-info">
            <h4>üìã Multi-klass schemal√§ggningsregler</h4>
            <ul style="margin: 0.5rem 0;">
                <li><strong>5-minutersintervall:</strong> Lektioner kan starta var 5:e minut f√∂r flexibilitet</li>
                <li><strong>10-minuters paus:</strong> Minst 10 minuter mellan alla lektioner</li>
                <li><strong>Max 1 √§mne per dag per klass:</strong> Varje klass kan bara ha 1 lektion i samma √§mne per dag</li>
                <li><strong>Ingen klassrumskonflikt:</strong> Samma klassrum kan inte anv√§ndas samtidigt av flera klasser</li>
                <li><strong>Max 5 lektioner per √§mne:</strong> Per vecka och klass (1 per dag √ó 5 dagar)</li>
            </ul>
        </div>





        <!-- Add a schedule management section before the main generator -->
        <div class="card" style="margin-bottom: 2rem;" id="scheduleManagement">
            <h3>üìÖ Schemahantering</h3>
            
            <div class="form-group">
                <label>Snabb√•tg√§rder:</label>
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.5rem;">
                    <button type="button" class="btn" onclick="viewAllClassSchedules()" style="background: #4299e1;">
                        üëÅÔ∏è Visa alla klassers scheman
                    </button>
                    <button type="button" class="btn" onclick="exportSchedulesToCSV()" style="background: #38b2ac;">
                        üìä Exportera scheman
                    </button>
                    <button type="button" class="btn" onclick="showScheduleStatistics()" style="background: #9f7aea;">
                        üìà Schemastatistik
                    </button>
                </div>
            </div>
            
            <div id="scheduleOverview" style="margin-top: 1rem; display: none;">
                <!-- Schedule overview will be populated by JavaScript -->
            </div>
        </div>

        <div class="generator-layout">
            <!-- V√§nster sida - Inst√§llningar -->
            <div class="card">
                <h3>‚öôÔ∏è Multi-klass Schemainst√§llningar</h3>
                
                <form id="scheduleForm">
                    <!-- Klassval - Nu multi-select -->
                    <div class="form-group">
                        <label>V√§lj klasser (flera klasser till√•tet):</label>
                        <div class="classes-container" id="classesContainer">
                            {% if classes %}
                                {% for class in classes %}
                                    <div class="class-item">
                                        <input type="checkbox" name="class_ids[]" value="{{ class.id }}" id="class_{{ class.id }}" onchange="updateSelectedClasses()">
                                        <div class="class-item-info">
                                            <div class="class-name">{{ class.name }}</div>
                                            <div class="class-details">
                                                {{ class.users|length if class.users else 0 }} elever
                                                {% if class.year_level %} - √Örskurs {{ class.year_level }}{% endif %}
                                            </div>
                                        </div>
                                        <div class="class-color-indicator" style="background-color: {{ loop.cycle('#4299e1', '#48bb78', '#f56565', '#ed8936', '#9f7aea', '#38b2ac') }};"></div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; color: #666;">
                                    <p>Inga klasser tillg√§ngliga</p>
                                </div>
                            {% endif %}
                        </div>
                        <div class="selected-classes-info" id="selectedClassesInfo" style="display: none;">
                            <strong>Valda klasser:</strong> <span id="selectedClassesList"></span>
                        </div>
                    </div>

                    <!-- √Ñmnen och timmar per klass -->
                    <div class="form-group">
                        <label>√Ñmnen och timmar per vecka (per klass):</label>
                        <div class="validation-warning" id="subjectValidation" style="display: none;">
                            <strong>‚ö†Ô∏è Viktigt:</strong> Varje √§mne kan max ha 5 lektioner per vecka per klass (1 per dag).
                        </div>
                        <div class="subjects-container" id="subjectsContainer">
                            <div id="subjectsPlaceholder" style="color:#666;">
                                V√§lj en eller flera klasser till v√§nster f√∂r att ange √§mnen och timmar per klass.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tillg√§ngliga klassrum:</label>
                        <div class="rooms-container">
                            {% if school and school.classrooms %}
                                {% set classrooms = school.classrooms | from_json %}
                                {% for classroom in classrooms %}
                                    <div class="room-item">
                                        <input type="checkbox" name="rooms[]" value="{{ classroom }}" id="room_{{ loop.index }}" checked>
                                        <label for="room_{{ loop.index }}">{{ classroom }}</label>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <!-- Fallback if no classrooms are defined -->
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal A" id="room_a" checked>
                                    <label for="room_a">Sal A</label>
                                </div>
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal B" id="room_b" checked>
                                    <label for="room_b">Sal B</label>
                                </div>
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal C" id="room_c" checked>
                                    <label for="room_c">Sal C</label>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tidsinst√§llningar -->
                    <div class="form-group">
                        <label>Schema-begr√§nsningar:</label>
                        <div class="constraints-section">
                            <div class="constraint-item">
                                <input type="checkbox" id="balanced_days" name="constraints[]" value="balanced_days" checked>
                                <label for="balanced_days">J√§mn f√∂rdelning √∂ver veckan</label>
                            </div>
                            <div class="constraint-item">
                                <input type="checkbox" id="morning_priority" name="constraints[]" value="morning_priority">
                                <label for="morning_priority">Prioritera f√∂rmiddagstid</label>
                            </div>
                            <div class="constraint-item">
                                <input type="checkbox" id="no_room_conflicts" name="constraints[]" value="no_room_conflicts" checked disabled>
                                <label for="no_room_conflicts">F√∂rhindra klassrumskonflikter (automatiskt aktivt)</label>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <label>Skoldagens timmar:</label>
                                <div class="time-range">
                                    <input type="time" name="start_time" value="08:00">
                                    <input type="time" name="end_time" value="15:00">
                                </div>
                            </div>

                            <!-- Lektionsl√§ngd sektion -->
                            <div class="lesson-duration-section">
                                <label for="lesson_duration">Lektionsl√§ngd (minuter):</label>
                                <select name="lesson_duration" id="lesson_duration">
                                    <option value="45">45 minuter</option>
                                    <option value="60" selected>60 minuter</option>
                                    <option value="90">90 minuter</option>
                                </select>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">
                                    üí° Multi-klass schema med automatisk klassrumshantering.
                                </p>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-generate" onclick="generateMultiClassSchedule()">
                        üé≤ Generera Multi-klass Schema
                    </button>
                </form>
                
                <!-- Debug info -->
                <div id="debugInfo" class="debug-info" style="display: none;">
                    <h4>Debug Information:</h4>
                    <div id="debugContent"></div>
                </div>
            </div>

            <!-- H√∂ger sida - Schemaf√∂rhandsvisning -->
            <div class="card">
                <h3>üìã Multi-klass Schemaf√∂rhandsvisning</h3>

                <div style="display:flex; gap:0.75rem; align-items:center; margin-bottom:0.75rem;">
                    <label for="classFilter" style="margin:0; font-weight:600; color:#4a5568;">Visa:</label>
                    <select id="classFilter" onchange="onClassFilterChange()" style="padding:0.5rem; border-radius:6px; border:1px solid #e2e8f0;">
                        <option value="all">Alla klasser</option>
                        <!-- JS fyller resterande -->
                    </select>

                    <label for="teacherFilter" style="margin:0; font-weight:600; color:#4a5568;">L√§rare:</label>
                    <select id="teacherFilter" onchange="onTeacherFilterChange()" style="padding:0.5rem; border-radius:6px; border:1px solid #e2e8f0;">
                        <option value="all">Alla l√§rare</option>
                        <!-- JS fyller resterande -->
                    </select>
                </div>




                
                <div class="schedule-preview" id="schedulePreview">
                    <div style="text-align: center;">
                        <p>V√§lj klasser och √§mnen f√∂r att generera ett multi-klass schema</p>
                        <p style="color: #a0aec0; font-size: 0.9rem;">
                            Multi-klass schema f√∂ljer:<br>
                            ‚Ä¢ Automatisk klassrumshantering<br>
                            ‚Ä¢ Max 1 √§mne per dag per klass<br>
                            ‚Ä¢ 5-minutersintervall med 10-min paus
                        </p>
                    </div>
                </div>

                <div class="generation-controls" id="generationControls" style="display: none;">
                    <div class="schedule-actions">
                        <button type="button" class="btn" onclick="generateMultiClassSchedule()">
                            üîÑ Generera nytt
                        </button>
                        <button type="button" class="btn" style="background: #48bb78;" onclick="saveMultiClassSchedule()">
                            üíæ Spara schema
                        </button>
                        <button type="button" class="btn reset-schedule-btn" style="background: #f56565;" onclick="resetClassSchedules()">
                            üóëÔ∏è Rensa scheman
                        </button>
                    </div>
                    
                    <div id="saveStatus" class="save-status" style="display: none;">
                        <!-- Status information will be populated by JavaScript -->
                    </div>
                    
                    <div class="alert alert-info" style="margin-top: 1rem; font-size: 0.85rem;">
                        <strong>üí° Tips:</strong>
                        <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                            <li><strong>Spara schema:</strong> Sparar schemat permanent till databasen</li>
                            <li><strong>Rensa scheman:</strong> Tar bort befintliga scheman f√∂r valda klasser</li>
                            <li><strong>Generera nytt:</strong> Skapar ett nytt schema (ers√§tter inte sparat schema)</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
            let availableTeachers = {{ available_teachers | tojson | safe }} || [];

            let currentSchedule = null;
            let availableSubjects = {{ available_subjects | tojson }};
            let availableClasses = {{ classes | tojson }};
            let selectedClasses = [];


            let isEditMode = false;
            let editingClassId = null;
            let editingClassName = null;
            let originalScheduleData = null;
            let draggedLesson = null;

            // L√§gg h√∂gst upp (efter att serverdata injicerats)
            let schoolSubjects = (typeof availableSubjects !== 'undefined' && Array.isArray(availableSubjects))
                ? availableSubjects.slice()   // kopiera s√• vi inte muterar originalet ov√§ntat
                : (window.schoolSubjects || []);

            // och l√§gg g√§rna tillbaka p√• window om andra moduler f√∂rv√§ntar sig det
            window.schoolSubjects = schoolSubjects;
            // Class colors for visual distinction
            const classColors = ['#4299e1', '#48bb78', '#f56565', '#ed8936', '#9f7aea', '#38b2ac', '#ec407a', '#26c6da', '#ab47bc', '#66bb6a'];

            // Debug flag
            const DEBUG = true;

            function debugLog(message, data = null) {
                if (DEBUG) {
                    console.log(`[MULTI-CLASS SCHEDULE DEBUG] ${message}`, data);
                    
                    const debugInfo = document.getElementById('debugInfo');
                    const debugContent = document.getElementById('debugContent');
                    
                    debugInfo.style.display = 'block';
                    debugContent.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
                    if (data) {
                        debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                    }
                }
            }

            function updateSelectedClasses() {
                const checkboxes = document.querySelectorAll('input[name="class_ids[]"]:checked');
                const infoDiv = document.getElementById('selectedClassesInfo');
                const listSpan = document.getElementById('selectedClassesList');
                
                // Build selectedClasses anew
                const tempSelected = Array.from(checkboxes).map(cb => {
                    const classId = cb.value;
                    const classData = availableClasses.find(c => c.id == classId);
                    return {
                        id: classId,
                        name: classData ? classData.name : `Klass ${classId}`
                    };
                });

                selectedClasses = tempSelected;

                if (selectedClasses.length > 0) {
                    infoDiv.style.display = 'block';
                    listSpan.innerHTML = selectedClasses.map((cls, index) => 
                        `<span style="color: ${classColors[index % classColors.length]};">‚óè</span> ${cls.name}`
                    ).join(', ');
                    debugLog('Selected classes updated:', selectedClasses);
                } else {
                    infoDiv.style.display = 'none';
                    debugLog('No classes selected');
                }

                // Re-render per-class subject sections
                renderClassSubjectSections();
            }


            // Fyll klass-filtret (finns redan i din kod om du f√∂ljde tidigare steg)
            function populateClassFilter() {
                const sel = document.getElementById('classFilter');
                if (!sel) return;
                // Ta bort tidigare genererade options
                sel.querySelectorAll('option[data-generated]').forEach(o => o.remove());
                availableClasses.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls.id;
                    opt.textContent = cls.name;
                    opt.setAttribute('data-generated', '1');
                    sel.appendChild(opt);
                });
            }



            
            // JavaScript f√∂r √§mneshantering - l√§gg till i <script>-sektionen


            


            function updateClassStatusIndicators(statusData) {
                // Update class checkboxes with status indicators
                selectedClasses.forEach(cls => {
                    const checkbox = document.getElementById(`class_${cls.id}`);
                    if (!checkbox) return;

                    const classItem = checkbox.closest('.class-item');
                    if (!classItem) return;

                    // Remove existing status indicators
                    const existingIndicator = classItem.querySelector('.schedule-status-indicator');
                    if (existingIndicator) existingIndicator.remove();

                    // Find class status
                    const status = statusData.classes_status.find(s => s.class_id == cls.id);
                    
                    if (status) {
                        const indicator = document.createElement('div');
                        indicator.className = 'schedule-status-indicator';
                        indicator.style.cssText = `
                            font-size: 0.75rem; 
                            margin-top: 0.25rem;
                            padding: 0.125rem 0.375rem;
                            border-radius: 0.25rem;
                            ${status.has_schedule ? 
                                'background: #c6f6d5; color: #22543d; border: 1px solid #9ae6b4;' : 
                                'background: #fed7d7; color: #742a2a; border: 1px solid #feb2b2;'
                            }
                        `;
                        
                        if (status.has_schedule) {
                            indicator.innerHTML = `‚úÖ Schema sparat (${status.lesson_count} lektioner)`;
                        } else {
                            indicator.innerHTML = `üìù Inget sparat schema`;
                        }

                        const classDetails = classItem.querySelector('.class-details');
                        if (classDetails) {
                            classDetails.appendChild(indicator);
                        }
                    }
                });

                // Update summary info
                updateScheduleSummary(statusData.summary);
            }


            async function updateClassScheduleStatus() {
                if (selectedClasses.length === 0) return;

                try {
                    const response = await fetch('/api/multi_class_schedule/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_ids: selectedClasses.map(c => parseInt(c.id))
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Update status cache
                        result.classes_status.forEach(cls => {
                            scheduleSaveState.classScheduleStatus[cls.class_id] = cls;
                        });

                        // Update UI indicators
                        updateClassStatusIndicators(result);
                        debugLog('Class schedule status updated:', result);
                    }

                } catch (error) {
                    console.error('Error updating class schedule status:', error);
                    debugLog('Status update failed:', error);
                }
            }


            async function addNewSubject() {
                const input = document.getElementById('newSubjectName');
                const subjectName = input.value.trim();
                
                if (!subjectName) {
                    alert('Ange ett √§mnesnamn');
                    return;
                }
                
                try {
                    const response = await fetch('/api/school_subjects', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ name: subjectName })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        schoolSubjects.push(data.subject);
                        availableSubjects.push(data.subject); // Uppdatera √§ven global variabel
                        input.value = '';
                        renderSubjects();
                        debugLog('Subject added successfully:', data.subject);
                    } else {
                        alert(data.error || 'Fel vid sparande av √§mne');
                    }
                } catch (error) {
                    console.error('Error adding subject:', error);
                    alert('Fel vid kommunikation med servern');
                }
            }

            async function removeSubject(subjectId) {
                if (!confirm('√Ñr du s√§ker p√• att du vill ta bort detta √§mne?')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/school_subjects/${subjectId}`, {
                        method: 'DELETE'
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        schoolSubjects = schoolSubjects.filter(s => s.id !== subjectId);
                        availableSubjects = availableSubjects.filter(s => s.id !== subjectId); // Uppdatera √§ven global variabel
                        renderSubjects();
                        debugLog('Subject removed successfully:', subjectId);
                    } else {
                        alert(data.error || 'Fel vid borttagning av √§mne');
                    }
                } catch (error) {
                    console.error('Error removing subject:', error);
                    alert('Fel vid kommunikation med servern');
                }
            }



            function updateScheduleSummary(summary) {
                const infoDiv = document.getElementById('selectedClassesInfo');
                if (!infoDiv) return;

                // Add summary after class list
                let existingSummary = infoDiv.querySelector('.schedule-summary');
                if (existingSummary) existingSummary.remove();

                if (summary.total_classes > 0) {
                    const summaryDiv = document.createElement('div');
                    summaryDiv.className = 'schedule-summary';
                    summaryDiv.style.cssText = `
                        margin-top: 0.5rem; 
                        padding: 0.5rem; 
                        background: #f7fafc; 
                        border-radius: 0.375rem; 
                        font-size: 0.85rem;
                        border-left: 3px solid #4299e1;
                    `;

                    summaryDiv.innerHTML = `
                        <strong>üìä Schemastatus:</strong><br>
                        ${summary.classes_with_schedule}/${summary.total_classes} klasser har scheman (${summary.total_lessons} totalt lektioner)<br>
                        ${summary.all_classes_have_schedule ? 
                            '<span style="color: #38a169;">‚úÖ Alla klasser har scheman</span>' : 
                            '<span style="color: #d69e2e;">‚ö†Ô∏è Vissa klasser saknar scheman</span>'
                        }
                    `;

                    infoDiv.appendChild(summaryDiv);
                }
            }

            /**
             * Update the overall schedule UI based on current state
             */
            function updateScheduleUI() {
                const controls = document.getElementById('generationControls');
                if (!controls) return;

                // Check if we have unsaved changes
                const hasUnsaved = scheduleSaveState.hasUnsavedChanges;
                
                // Update save button
                const saveButton = controls.querySelector('button[onclick="saveMultiClassSchedule()"]');
                if (saveButton) {
                    if (hasUnsaved) {
                        saveButton.style.background = '#ed8936';
                        saveButton.innerHTML = 'üíæ Spara (osparade √§ndringar)';
                    } else {
                        saveButton.style.background = '#48bb78';
                        saveButton.innerHTML = 'üíæ Sparat';
                    }
                }

                // Add reset button if it doesn't exist
                let resetButton = controls.querySelector('.reset-schedule-btn');
                if (!resetButton) {
                    resetButton = document.createElement('button');
                    resetButton.type = 'button';
                    resetButton.className = 'btn reset-schedule-btn';
                    resetButton.style.cssText = 'background: #f56565; margin-left: 0.5rem;';
                    resetButton.onclick = resetClassSchedules;
                    resetButton.innerHTML = 'üóëÔ∏è Rensa scheman';
                    controls.appendChild(resetButton);
                }
            }


            function updateSubjectDropdowns() {
                const subjectSelects = document.querySelectorAll('select[name^="subjects_"]');
                subjectSelects.forEach(select => {
                    // spara nuvarande val (kan vara string eller number)
                    const currentValue = String(select.value);

                    // bygg options fr√•n schoolSubjects
                    let optionsHtml = '<option value="">V√§lj √§mne...</option>';
                    schoolSubjects.forEach(subject => {
                    optionsHtml += `<option value="${subject.id}">${subject.name}</option>`;
                    });

                    select.innerHTML = optionsHtml;

                    // √•terst√§ll tidigare v√§rde (j√§mf√∂r som str√§ng f√∂r s√§kerhet)
                    if (currentValue) {
                    const optToSet = Array.from(select.options).find(o => String(o.value) === currentValue);
                    if (optToSet) select.value = currentValue;
                    }
                });
            }



            let scheduleSaveState = {
                hasUnsavedChanges: false,
                lastSavedSchedule: null,
                classScheduleStatus: {}
            };

            // Uppdatera createSubjectItem funktionen f√∂r att anv√§nda schoolSubjects
           

            // Initiera √§mneslistan n√§r sidan laddas
            document.addEventListener('DOMContentLoaded', function() {
                renderSubjects();
            });


            
            


            
                

            // Fyll l√§rar-filtret - f√∂rs√∂k med availableTeachers, annars l√§mna "Alla l√§rare" tills schemat finns
            function populateTeacherFilter() {
                const sel = document.getElementById('teacherFilter');
                if (!sel) return;
                // Rensa tidigare genererade
                sel.querySelectorAll('option[data-generated]').forEach(o => o.remove());

                if (typeof availableTeachers !== 'undefined' && Array.isArray(availableTeachers) && availableTeachers.length > 0) {
                    availableTeachers.forEach(t => {
                        const opt = document.createElement('option');
                        opt.value = t.id ?? t.name;
                        opt.textContent = t.name ?? t.displayName ?? t.id;
                        opt.setAttribute('data-generated', '1');
                        sel.appendChild(opt);
                    });
                    return;
                }

                // Om inga l√§rardata finns √§nnu - l√§mna standard 'Alla l√§rare' (vi kommer att fylla fr√•n schedule senare)
            }

            // Fyll teacher-filter fr√•n ett genererat schema (anv√§nds efter generering om backend ej skickade teachers)
            function populateTeacherFilterFromSchedule(schedule) {
                const sel = document.getElementById('teacherFilter');
                if (!sel || !schedule || !Array.isArray(schedule.lessons)) return;
                // Ta bort gamla genererade options
                sel.querySelectorAll('option[data-generated]').forEach(o => o.remove());

                const teacherSet = new Map();
                schedule.lessons.forEach(lesson => {
                    // F√∂rv√§ntar att lesson har property lesson.teacher_name eller lesson.teacher_id
                    const teacherName = lesson.teacher_name || lesson.teacher || null;
                    const teacherId = lesson.teacher_id || lesson.teacher || teacherName;
                    if (teacherName) {
                        if (!teacherSet.has(teacherId)) teacherSet.set(teacherId, teacherName);
                    }
                });

                Array.from(teacherSet.entries()).forEach(([id, name]) => {
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = name;
                    opt.setAttribute('data-generated', '1');
                    sel.appendChild(opt);
                });
            }

            // H√§ndelsehanterare f√∂r filter
            function onClassFilterChange() {
                const classSel = document.getElementById('classFilter');
                const teacherSel = document.getElementById('teacherFilter');
                const classVal = classSel && classSel.value !== 'all' ? classSel.value : null;
                const teacherVal = teacherSel && teacherSel.value !== 'all' ? teacherSel.value : null;
                if (currentSchedule) displayMultiClassSchedule(currentSchedule, classVal, teacherVal);
            }

            function onTeacherFilterChange() {
                const classSel = document.getElementById('classFilter');
                const teacherSel = document.getElementById('teacherFilter');
                const classVal = classSel && classSel.value !== 'all' ? classSel.value : null;
                const teacherVal = teacherSel && teacherSel.value !== 'all' ? teacherSel.value : null;
                if (currentSchedule) displayMultiClassSchedule(currentSchedule, classVal, teacherVal);
            }

            // Efter att currentSchedule deklarerats:
            window.currentSchedule = window.currentSchedule || null;
            window.multiClassSchedule = window.multiClassSchedule || window.currentSchedule;

            // N√§r du uppdaterar schemat, h√•ll b√•da synkade:
            function setCurrentSchedule(schedule) {
            currentSchedule = schedule;
            window.currentSchedule = schedule;
            window.multiClassSchedule = schedule;
            }


            function renderClassSubjectSections() {
                const container = document.getElementById('subjectsContainer');
                const placeholder = document.getElementById('subjectsPlaceholder');
                container.innerHTML = ''; // clear

                if (selectedClasses.length === 0) {
                    placeholder && container.appendChild(placeholder);
                    return;
                }

                // For each selected class, create a section
                selectedClasses.forEach((cls, idx) => {
                    const section = document.createElement('div');
                    section.className = 'class-subject-section';
                    section.id = `class_subjects_${cls.id}`;
                    section.setAttribute('data-class-id', cls.id);

                    const header = document.createElement('div');
                    header.className = 'class-subject-header';
                    header.innerHTML = `
                        <div style="display:flex; align-items:center; gap:0.5rem;">
                            <span class="class-color-indicator" style="background:${classColors[idx % classColors.length]}"></span>
                            <strong>${cls.name}</strong>
                            <span style="color:#718096; font-size:0.9rem; margin-left:0.5rem;">(Ange √§mnen & timmar f√∂r denna klass)</span>
                        </div>
                        <div>
                            <button type="button" class="add-subject-btn" onclick="addSubjectForClass('${cls.id}')">+ L√§gg till √§mne</button>
                        </div>
                    `;
                    section.appendChild(header);

                    const list = document.createElement('div');
                    list.className = 'class-subject-list';
                    list.id = `class_subject_list_${cls.id}`;

                    // Add initial subject row
                    const subjectRow = createSubjectItem(cls.id);
                    list.appendChild(subjectRow);

                    section.appendChild(list);
                    container.appendChild(section);
                });

                // Re-validate subjects UI
                validateSubjectHours();
            }



            function populateClassFilter() {
                const sel = document.getElementById('classFilter');
                if (!sel) return;
                // Rensa utom 'Alla'
                sel.querySelectorAll('option[data-generated]').forEach(o => o.remove());
                // L√§gg till klasser fr√•n availableClasses
                availableClasses.forEach(cls => {
                    const opt = document.createElement('option');
                    opt.value = cls.id;
                    opt.textContent = cls.name;
                    opt.setAttribute('data-generated', '1');
                    sel.appendChild(opt);
                });
            }


            // Uppdatera renderSubjects funktionen f√∂r att inkludera l√§rarhantering
            function renderSubjects() {
                const container = document.getElementById('existingSubjects');
                const noMessage = document.getElementById('noSubjectsMessage');
                
                if (schoolSubjects.length === 0) {
                    noMessage.style.display = 'block';
                    container.innerHTML = '<div style="color: #666; text-align: center;" id="noSubjectsMessage">Inga √§mnen √§nnu. L√§gg till √§mnen ovan.</div>';
                    return;
                }
                
                noMessage.style.display = 'none';
                
                let html = '';
                schoolSubjects.forEach(subject => {
                    html += `
                        <div class="subject-item" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: white; border-radius: 6px; margin-bottom: 0.5rem; border: 1px solid #e2e8f0;">
                            <div style="flex: 1;">
                                <div>
                                    <strong style="color: #2d3748;">${subject.name}</strong>
                                    <span id="teacherCount_${subject.id}" style="color: #718096; font-size: 0.85rem; margin-left: 0.5rem;">
                                        (Laddar l√§rare...)
                                    </span>
                                </div>
                                <div id="qualifiedTeachers_${subject.id}" style="margin-top: 0.25rem; font-size: 0.8rem; color: #4a5568;">
                                    <!-- Beh√∂riga l√§rare visas h√§r -->
                                </div>
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button type="button" class="btn" onclick="manageTeachers(${subject.id}, '${subject.name}')" 
                                        style="background: #4299e1; color: white; padding: 0.375rem 0.75rem; font-size: 0.8rem;">
                                    üë®‚Äçüè´ L√§rare
                                </button>
                                <button type="button" class="remove-subject-btn" onclick="removeSubject(${subject.id})" 
                                        style="background: #f56565; color: white; padding: 0.25rem 0.5rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Ta bort
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                container.innerHTML = html;
                
                // Ladda l√§rarbeh√∂righeter f√∂r varje √§mne
                schoolSubjects.forEach(subject => {
                    loadTeacherQualifications(subject.id);
                });
                
                // Uppdatera √§mnesdropdowns i formul√§ret
                updateSubjectDropdowns();
            }

            // Ladda och visa beh√∂riga l√§rare f√∂r ett √§mne
            async function loadTeacherQualifications(subjectId) {
                try {
                    const response = await fetch(`/api/teacher_qualifications/${subjectId}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        const countSpan = document.getElementById(`teacherCount_${subjectId}`);
                        const teachersDiv = document.getElementById(`qualifiedTeachers_${subjectId}`);
                        
                        const qualifiedCount = data.qualified_teachers.length;
                        countSpan.textContent = `(${qualifiedCount} beh√∂rig${qualifiedCount !== 1 ? 'a' : ''} l√§rare)`;
                        countSpan.style.color = qualifiedCount > 0 ? '#38a169' : '#e53e3e';
                        
                        if (qualifiedCount > 0) {
                            const teacherNames = data.qualified_teachers.map(t => t.name).slice(0, 3);
                            let displayText = teacherNames.join(', ');
                            if (qualifiedCount > 3) {
                                displayText += ` +${qualifiedCount - 3} till`;
                            }
                            teachersDiv.innerHTML = `Beh√∂riga: ${displayText}`;
                        } else {
                            teachersDiv.innerHTML = '<span style="color: #e53e3e;">‚ö†Ô∏è Inga beh√∂riga l√§rare - schema kan inte genereras</span>';
                        }
                    }
                } catch (error) {
                    console.error('Error loading teacher qualifications:', error);
                    const countSpan = document.getElementById(`teacherCount_${subjectId}`);
                    if (countSpan) {
                        countSpan.textContent = '(Fel vid laddning)';
                        countSpan.style.color = '#e53e3e';
                    }
                }
            }


            function markScheduleAsUnsaved() {
                scheduleSaveState.hasUnsavedChanges = true;
                updateScheduleUI();
            }

            // Hantera l√§rare f√∂r ett √§mne
            async function manageTeachers(subjectId, subjectName) {
                try {
                    const response = await fetch(`/api/teacher_qualifications/${subjectId}`);
                    const data = await response.json();
                    
                    if (!data.success) {
                        alert('Fel vid laddning av l√§rardata');
                        return;
                    }
                    
                    const modalTitle = document.getElementById('modalTitle');
                    const modalContent = document.getElementById('modalContent');
                    
                    modalTitle.textContent = `L√§rarbeh√∂righeter f√∂r ${subjectName}`;
                    
                    let html = `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="color: #2d3748; margin-bottom: 0.75rem;">Beh√∂riga l√§rare (${data.qualified_teachers.length})</h4>
                            <div id="qualifiedTeachersList" style="background: #f0fff4; border: 1px solid #38a169; border-radius: 6px; padding: 1rem; min-height: 60px;">
                    `;
                    
                    if (data.qualified_teachers.length > 0) {
                        data.qualified_teachers.forEach(teacher => {
                            html += `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.5rem; border: 1px solid #c6f6d5;">
                                    <div>
                                        <strong>${teacher.name}</strong>
                                        <span style="color: #666; font-size: 0.9rem; margin-left: 0.5rem;">(${teacher.username})</span>
                                    </div>
                                    <button onclick="removeTeacherQualification(${subjectId}, ${teacher.id}, '${teacher.name}', '${subjectName}')" 
                                            style="background: #f56565; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                                        Ta bort
                                    </button>
                                </div>
                            `;
                        });
                    } else {
                        html += '<p style="color: #666; text-align: center; margin: 0;">Inga beh√∂riga l√§rare √§nnu</p>';
                    }
                    
                    html += `
                            </div>
                        </div>
                        
                        <div>
                            <h4 style="color: #2d3748; margin-bottom: 0.75rem;">L√§gg till beh√∂rig l√§rare</h4>
                            <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 1rem;">
                                <select id="teacherSelect" style="width: 100%; padding: 0.75rem; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 1rem;">
                                    <option value="">V√§lj l√§rare...</option>
                    `;
                    
                    data.available_teachers.forEach(teacher => {
                        if (!teacher.is_qualified) {
                            html += `<option value="${teacher.id}">${teacher.name} (${teacher.username})</option>`;
                        }
                    });
                    
                    html += `
                                </select>
                                <button onclick="addTeacherQualification(${subjectId}, '${subjectName}')" 
                                        style="background: #48bb78; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 6px; cursor: pointer;">
                                    + L√§gg till beh√∂righet
                                </button>
                            </div>
                        </div>
                    `;
                    
                    modalContent.innerHTML = html;
                    document.getElementById('teacherModal').style.display = 'block';
                    
                } catch (error) {
                    console.error('Error loading teachers:', error);
                    alert('Fel vid laddning av l√§rardata');
                }
            }

            // L√§gg till l√§rarbeh√∂righet
            async function addTeacherQualification(subjectId, subjectName) {
                const select = document.getElementById('teacherSelect');
                const teacherId = select.value;
                
                if (!teacherId) {
                    alert('V√§lj en l√§rare f√∂rst');
                    return;
                }
                
                try {
                    const response = await fetch(`/api/teacher_qualifications/${subjectId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ teacher_id: parseInt(teacherId) })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // St√§ng modal och uppdatera visning
                        closeTeacherModal();
                        loadTeacherQualifications(subjectId);
                        alert(data.message);
                    } else {
                        alert(data.error || 'Fel vid till√§gg av beh√∂righet');
                    }
                } catch (error) {
                    console.error('Error adding teacher qualification:', error);
                    alert('Fel vid kommunikation med servern');
                }
            }



            // Ta bort l√§rarbeh√∂righet
            async function removeTeacherQualification(subjectId, teacherId, teacherName, subjectName) {
                if (!confirm(`√Ñr du s√§ker p√• att du vill ta bort ${teacherName}s beh√∂righet att undervisa i ${subjectName}?`)) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/teacher_qualifications/${subjectId}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ teacher_id: teacherId })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // St√§ng modal och uppdatera visning
                        closeTeacherModal();
                        loadTeacherQualifications(subjectId);
                        alert(data.message);
                    } else {
                        alert(data.error || 'Fel vid borttagning av beh√∂righet');
                    }
                } catch (error) {
                    console.error('Error removing teacher qualification:', error);
                    alert('Fel vid kommunikation med servern');
                }
            }

            function closeTeacherModal() {
                document.getElementById('teacherModal').style.display = 'none';
            }

            // St√§ng modal vid klick utanf√∂r
            window.onclick = function(event) {
                const modal = document.getElementById('teacherModal');
                if (event.target === modal) {
                    closeTeacherModal();
                }
            }

            



            function createSubjectItem(classId, selectedSubjectId = '') {
                const item = document.createElement('div');
                item.className = 'subject-item';

                let optionsHtml = '<option value="">V√§lj √§mne...</option>';
                schoolSubjects.forEach(subject => {
                    optionsHtml += `<option value="${subject.id}">${subject.name}</option>`;
                });

                item.innerHTML = `
                    <select name="subjects_${classId}[]" required onchange="validateSubjectHours()">
                    ${optionsHtml}
                    </select>
                    <input type="number" name="hours_${classId}[]" min="1" max="5" placeholder="Timmar/vecka (max 5)" required onchange="validateSubjectHours()">
                    <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">Ta bort</button>
                `;

                // s√§tt valt √§mne om det skickats in
                if (selectedSubjectId) {
                    item.querySelector('select').value = String(selectedSubjectId);
                }

                return item;
            }


            function getSubjectNameById(subjectId) {
                if (subjectId === null || subjectId === undefined) return null;
                const idStr = String(subjectId);

                // 1) S√∂k i schoolSubjects (prim√§rt)
                const fromSchool = (Array.isArray(schoolSubjects) ? schoolSubjects : []).find(x => String(x.id) === idStr);
                if (fromSchool) return fromSchool.name;

                // 2) S√∂k i availableSubjects (fallback / √§ldre tabell)
                const fromAvailable = (Array.isArray(availableSubjects) ? availableSubjects : []).find(x => String(x.id) === idStr);
                if (fromAvailable) return fromAvailable.name;

                return null;
            }



    




            function addSubjectForClass(classId) {
                const list = document.getElementById(`class_subject_list_${classId}`);
                if (!list) return;
                const newRow = createSubjectItem(classId);
                list.appendChild(newRow);
                debugLog(`Added subject row for class ${classId}`);
            }

            function removeSubject(button) {
                const list = button.parentElement.parentElement; // .class-subject-list or just parent
                const sectionList = list.classList && list.classList.contains('class-subject-list') ? list : button.parentElement.parentElement;
                // Try to find the sibling rows to ensure at least one remains per class
                const container = button.closest('.class-subject-section');
                if (!container) return;
                const rows = container.querySelectorAll('.subject-item');
                if (rows.length > 1) {
                    button.parentElement.remove();
                    validateSubjectHours();
                    debugLog('Removed subject row', {classSection: container.id});
                } else {
                    // Don't allow removing last row
                    alert('Minst ett √§mne m√•ste finnas per klass. L√§gg till ett annat √§mne f√∂rst om du vill ta bort detta.');
                    debugLog('Attempted to remove last subject row - blocked');
                }
            }

            function validateSubjectHours() {
                const allHourInputs = document.querySelectorAll('input[type="number"][name^="hours_"]');
                const validationWarning = document.getElementById('subjectValidation');
                let hasViolation = false;

                allHourInputs.forEach(input => {
                    const value = parseInt(input.value);
                    if (value > 5) {
                        hasViolation = true;
                        input.style.borderColor = '#e53e3e';
                        input.style.backgroundColor = '#fed7d7';
                    } else {
                        input.style.borderColor = '#e2e8f0';
                        input.style.backgroundColor = 'white';
                    }
                });

                if (hasViolation) {
                    validationWarning.style.display = 'block';
                } else {
                    validationWarning.style.display = 'none';
                }
            }

            function getAvailableRooms() {
                const roomCheckboxes = document.querySelectorAll('input[name="rooms[]"]:checked');
                const rooms = [];
                roomCheckboxes.forEach(checkbox => {
                    rooms.push(checkbox.value);
                });
                return rooms;
            }


            function mapSchoolSubjectToSubject(schoolSubjectId) {
                // This function should map from SchoolSubject ID to Subject ID
                // You'll need to implement the mapping logic based on your database structure
                
                // Option 1: If you have a direct mapping in your backend data
                // Look for a mapping table or field that connects SchoolSubject to Subject
                
                // Option 2: Match by name (if names are consistent)
                const schoolSubject = schoolSubjects.find(s => String(s.id) === String(schoolSubjectId));
                if (schoolSubject) {
                    // Look for matching subject in main subjects table by name
                    const matchingSubject = availableSubjects.find(s => s.name === schoolSubject.name);
                    if (matchingSubject) {
                        return matchingSubject.id;
                    }
                }
                
                // Option 3: Return the school subject ID if no mapping exists
                // (This assumes your backend can handle school_subject_ids in the subject_id field)
                return schoolSubjectId;
            }







            // --- Klistra in denna funktion i din scriptsektion (funktion-deklaration, allts√• hoistas) ---
            function generateMultiClassScheduleWithConstraints(classes, classSubjectMap, rooms, startTime, endTime, lessonDuration) {
                debugLog('Generating multi-class schedule with teacher conflict prevention:', {
                    classes: classes.length, 
                    classSubjectMap, 
                    rooms: rooms.length, 
                    startTime, 
                    endTime, 
                    lessonDuration
                });

                const actualRooms = (rooms && rooms.length) ? rooms : getAvailableRooms();
                if (!actualRooms || actualRooms.length === 0) {
                    throw new Error('Inga klassrum valda. V√§lj minst ett klassrum.');
                }

                const weekdays = ['m√•ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'];
                const timeSlots = generateTimeSlots(startTime || '08:00', endTime || '15:00', lessonDuration);
                const allLessons = [];

                // Create teacher availability tracker
                const teacherAvailability = {};
                const teacherMinBreak = 5; // 5 minutes minimum break between lessons
                
                // Initialize teacher availability structure
                if (typeof availableTeachers !== 'undefined' && Array.isArray(availableTeachers) && availableTeachers.length > 0) {
                    availableTeachers.forEach(teacher => {
                        teacherAvailability[teacher.id] = {};
                        weekdays.forEach(day => {
                            teacherAvailability[teacher.id][day] = []; // Array of {start, end, lessonId} objects
                        });
                    });
                }

                // Create subject plans for each class
                const classSubjectPlans = {};
                let totalLessonsNeeded = 0;
                
                classes.forEach(classInfo => {
                    const cid = classInfo.id;
                    classSubjectPlans[cid] = [];

                    const items = classSubjectMap[cid] || [];
                    items.forEach(item => {
                        const subjectId = item.subject_id;
                        // sj√∂kfunktion (l√§gg h√∂gst upp i filen om du inte redan har den)
                            function getSubjectNameById(subjectId) {
                            if (subjectId === null || subjectId === undefined) return null;
                            const s = (Array.isArray(schoolSubjects) ? schoolSubjects : []).find(x => String(x.id) === String(subjectId));
                            return s ? s.name : null;
                        }

                            // sedan h√§r:
                        const subjectName = getSubjectNameById(subjectId) || (availableSubjects.find(s => String(s.id) === String(subjectId))?.name) || `√Ñmne ${subjectId}`;


                        const hoursPerWeek = parseInt(item.hours);

                        if (hoursPerWeek > 5) {
                            throw new Error(`√Ñmnet "${subjectName}" f√∂r klass ${classInfo.name} har ${hoursPerWeek} lektioner, men max 5 √§r till√•tet (1 per dag)`);
                        }

                        for (let h = 0; h < hoursPerWeek; h++) {
                            classSubjectPlans[cid].push({
                                class_id: classInfo.id,
                                class_name: classInfo.name,
                                subject_id: subjectId,
                                subject_name: subjectName,
                                color: classInfo.color || classColors[Math.floor(Math.random() * classColors.length)]
                            });
                            totalLessonsNeeded++;
                        }
                    });
                });

                // Global schedule structures for conflict management
                const globalSchedule = {};
                const roomOccupancy = {};
                const classSubjectsByDay = {};
                
                // Initialize structures
                weekdays.forEach(day => {
                    globalSchedule[day] = [];
                    roomOccupancy[day] = {};
                    classSubjectsByDay[day] = {};
                    
                    classes.forEach(classInfo => {
                        classSubjectsByDay[day][classInfo.id] = new Set();
                    });
                    
                    timeSlots.forEach(slot => {
                        roomOccupancy[day][slot] = new Set();
                    });
                });

                // Enhanced function to check teacher availability
                function isTeacherAvailable(teacherId, day, timeSlot, lessonDuration) {
                    if (!teacherAvailability[teacherId] || !teacherAvailability[teacherId][day]) {
                        return true; // If teacher tracking is not available, assume available
                    }

                    const [startTime, endTime] = timeSlot.split('-');
                    const startMinutes = timeToMinutes(startTime);
                    const endMinutes = timeToMinutes(endTime);

                    const teacherLessons = teacherAvailability[teacherId][day];

                    for (const lesson of teacherLessons) {
                        // Check for overlap or insufficient break time
                        if (!(endMinutes + teacherMinBreak <= lesson.start || 
                            startMinutes >= lesson.end + teacherMinBreak)) {
                            return false; // Conflict found
                        }
                    }

                    return true; // No conflicts
                }

                // Enhanced function to assign teacher to lesson
                // Enhanced function to assign teacher to lesson with subject qualification check
                // Fix 3: Improved teacher qualification checking
                function assignTeacherToLesson(lesson, day, timeSlot) {
                    const [startTime, endTime] = timeSlot.split('-');
                    const startMinutes = timeToMinutes(startTime);
                    const endMinutes = timeToMinutes(endTime);

                    if (typeof availableTeachers !== 'undefined' && Array.isArray(availableTeachers) && availableTeachers.length > 0) {
                        // Filter teachers who are both available AND qualified for this subject
                        const qualifiedAndAvailableTeachers = availableTeachers.filter(teacher => {
                            // Check if teacher is available at this time
                            const isTimeAvailable = isTeacherAvailable(teacher.id, day, timeSlot, 60);
                            
                            // Check if teacher is qualified for this subject
                            let isQualified = true; // Default to true for backward compatibility
                            if (teacher.qualified_subjects && Array.isArray(teacher.qualified_subjects)) {
                                isQualified = teacher.qualified_subjects.includes(parseInt(lesson.subject_id));
                            }
                            
                            return isTimeAvailable && isQualified;
                        });

                        if (qualifiedAndAvailableTeachers.length > 0) {
                            const selectedTeacher = qualifiedAndAvailableTeachers[Math.floor(Math.random() * qualifiedAndAvailableTeachers.length)];
                            
                            // Reserve the teacher for this time slot
                            if (!teacherAvailability[selectedTeacher.id]) {
                                teacherAvailability[selectedTeacher.id] = {};
                            }
                            if (!teacherAvailability[selectedTeacher.id][day]) {
                                teacherAvailability[selectedTeacher.id][day] = [];
                            }

                            teacherAvailability[selectedTeacher.id][day].push({
                                start: startMinutes,
                                end: endMinutes,
                                lessonId: `${lesson.class_name}-${lesson.subject_name}-${timeSlot}`,
                                class: lesson.class_name,
                                subject: lesson.subject_name
                            });

                            return {
                                teacher_id: selectedTeacher.id,
                                teacher_name: selectedTeacher.name || selectedTeacher.username || 'L√§rare'
                            };
                        } else {
                            // No qualified AND available teachers
                            debugLog(`No qualified teachers available for ${lesson.class_name} - ${lesson.subject_name} on ${day} at ${timeSlot}`);
                            return null;
                        }
                    } else {
                        // Fallback to generic teacher names if no teacher data available
                        const fallbackTeachers = ['L√§rare A', 'L√§rare B', 'L√§rare C', 'L√§rare D', 'L√§rare E'];
                        return {
                            teacher_id: 'fallback',
                            teacher_name: fallbackTeachers[Math.floor(Math.random() * fallbackTeachers.length)]
                        };
                    }
                }

                // Place lessons for all classes with teacher availability checking
                const allLessonsToPlace = [];
                Object.keys(classSubjectPlans).forEach(classId => {
                    classSubjectPlans[classId].forEach(lesson => {
                        allLessonsToPlace.push(lesson);
                    });
                });

                // Randomize for better distribution
                allLessonsToPlace.sort(() => Math.random() - 0.5);

                debugLog('Starting lesson placement with teacher availability checking...', {totalLessons: allLessonsToPlace.length});

                let placedLessons = 0;
                let teacherConflicts = 0;

                for (const lesson of allLessonsToPlace) {
                    let placed = false;
                    let attempts = 0;
                    const maxAttempts = 300; // Increased attempts due to teacher constraints

                    while (!placed && attempts < maxAttempts) {
                        // Choose day that doesn't already have this subject for this class
                        const availableDays = weekdays.filter(day => 
                            !classSubjectsByDay[day][lesson.class_id].has(lesson.subject_name)
                        );
                        
                        if (availableDays.length === 0) {
                            throw new Error(`Kan inte placera fler lektioner i ${lesson.subject_name} f√∂r klass ${lesson.class_name} - alla dagar upptagna`);
                        }

                        // Prioritize days with fewer lessons for this class
                        availableDays.sort((a, b) => {
                            const aCount = globalSchedule[a].filter(l => l.class_id === lesson.class_id).length;
                            const bCount = globalSchedule[b].filter(l => l.class_id === lesson.class_id).length;
                            return aCount - bCount;
                        });
                        
                        const day = availableDays[0];

                        // Find available time slots for this class
                        const availableSlots = findAvailableTimeSlotsForClass(
                            globalSchedule[day], lesson.class_id, timeSlots, 10
                        );
                        
                        if (availableSlots.length > 0) {
                            // Try to find a slot with both room and teacher availability
                            let slotFound = false;
                            
                            for (const timeSlot of availableSlots) {
                                // Check room availability
                                const occupiedRooms = roomOccupancy[day][timeSlot];
                                const availableRooms = actualRooms.filter(room => !occupiedRooms.has(room));
                                
                                if (availableRooms.length > 0) {
                                    // Try to assign a teacher
                                    const teacherAssignment = assignTeacherToLesson(lesson, day, timeSlot);
                                    
                                    if (teacherAssignment) {
                                        const selectedRoom = availableRooms[Math.floor(Math.random() * availableRooms.length)];
                                        
                                        const lessonData = {
                                            day: day,
                                            time: timeSlot,
                                            class_id: lesson.class_id,
                                            class_name: lesson.class_name,
                                            // Skicka b√•de f√∂r s√§kerhets skull ‚Äî backend anv√§nder school_subject_id
                                            subject_id: lesson.subject_id || null,
                                            school_subject_id: lesson.school_subject_id || lesson.subject_id || null,
                                            subject_name: getSubjectNameById(lesson.subject_id) || lesson.subject_name || 'Ok√§nt √§mne',
                                            room: selectedRoom,
                                            teacher_id: teacherAssignment.teacher_id,
                                            teacher_name: teacherAssignment.teacher_name,
                                            color: lesson.color,
                                            start_minutes: timeToMinutes(timeSlot.split('-')[0])
                                        };



                                        // Place the lesson
                                        globalSchedule[day].push(lessonData);
                                        roomOccupancy[day][timeSlot].add(selectedRoom);
                                        classSubjectsByDay[day][lesson.class_id].add(lesson.subject_name);
                                        allLessons.push(lessonData);
                                        
                                        placed = true;
                                        placedLessons++;
                                        slotFound = true;

                                        debugLog(`Placed lesson ${placedLessons}/${allLessonsToPlace.length}: ${lesson.class_name} - ${lesson.subject_name} on ${day} at ${timeSlot} in ${selectedRoom} with ${teacherAssignment.teacher_name}`);
                                        break;
                                    } else {
                                        teacherConflicts++;
                                        debugLog(`Teacher conflict for ${lesson.class_name} - ${lesson.subject_name} on ${day} at ${timeSlot}`);
                                    }
                                }
                            }
                            
                            if (!slotFound) {
                                debugLog(`No available slots (room+teacher) for ${lesson.class_name} - ${lesson.subject_name} on ${day}`);
                            }
                        }

                        attempts++;
                    }

                    if (!placed) {
                        throw new Error(`Kunde inte placera lektion i ${lesson.subject_name} f√∂r klass ${lesson.class_name} efter ${maxAttempts} f√∂rs√∂k. F√∂rs√∂k med fler l√§rare, klassrum eller f√§rre klasser.`);
                    }
                }

                // Clean up helper data
                allLessons.forEach(lesson => {
                    delete lesson.start_minutes;
                });

                debugLog('Multi-class lesson placement completed with teacher management:', {
                    totalPlaced: placedLessons,
                    totalNeeded: allLessonsToPlace.length,
                    teacherConflicts: teacherConflicts
                });

                return {
                    lessons: allLessons,
                    time_slots: timeSlots,
                    classes: classes,
                    stats: {
                        total_lessons: allLessons.length,
                        lessons_per_class: classes.reduce((acc, cls) => {
                            acc[cls.name] = allLessons.filter(l => l.class_id === cls.id).length;
                            return acc;
                        }, {}),
                        rooms_used: [...new Set(allLessons.map(l => l.room))],
                        teachers_used: [...new Set(allLessons.map(l => l.teacher_name))],
                        balance_score: calculateMultiClassBalanceScore(globalSchedule, classes),
                        room_conflicts: checkRoomConflicts(allLessons),
                        teacher_conflicts: checkTeacherConflicts(allLessons),
                        constraint_violations: validateMultiClassConstraints(globalSchedule, classes),
                        teacher_conflict_attempts: teacherConflicts
                    }
                };
            }
            // --- Slut p√• funktionen ---


            // Fix 1: Remove duplicate function declaration
            async function generateMultiClassSchedule() {
                const preview = document.getElementById('schedulePreview');
                const controls = document.getElementById('generationControls');

                // S√§kerst√§ll att selectedClasses speglar DOM
                const checkedBoxes = Array.from(document.querySelectorAll('input[name="class_ids[]"]:checked'));
                if (checkedBoxes.length > 0) {
                    selectedClasses = checkedBoxes.map(cb => {
                        const classId = cb.value;
                        const classData = availableClasses.find(c => c.id == classId);
                        return {
                            id: classId,
                            name: classData ? classData.name : `Klass ${classId}`
                        };
                    });
                }

                if (selectedClasses.length === 0) {
                    alert('V√§lj minst en klass!');
                    debugLog('Validation failed: No classes selected');
                    return;
                }

                // Bygg per-klass √§mneskartor
                const classSubjectMap = {};
                for (const cls of selectedClasses) {
                    const classId = cls.id;
                    const container = document.getElementById(`class_subjects_${classId}`);
                    if (!container) {
                        alert(`Ingen √§mnessektion hittades f√∂r klass ${cls.name}.`);
                        debugLog('Validation failed: missing class subject container', {class: cls});
                        return;
                    }

                    const rows = Array.from(container.querySelectorAll('.subject-item'));
                    if (rows.length === 0) {
                        alert(`Ingen √§mneskonfiguration f√∂r klass ${cls.name}. Ange minst ett √§mne.`);
                        debugLog('Validation failed: No subject rows for class', {class: cls});
                        return;
                    }

                    const items = [];
                    for (let i = 0; i < rows.length; i++) {
                        const row = rows[i];
                        const subjSelect = row.querySelector('select');
                        const hourInput = row.querySelector('input[type="number"]');

                        const subjVal = subjSelect ? subjSelect.value.trim() : '';
                        const hrsValRaw = hourInput ? hourInput.value.trim() : '';
                        const hrsVal = hrsValRaw === '' ? NaN : parseInt(hrsValRaw, 10);

                        if (!subjVal) {
                            alert(`V√§lj √§mne i alla rader f√∂r klass ${cls.name}`);
                            debugLog('Validation failed: empty subject row', {class: cls, index: i});
                            return;
                        }
                        if (isNaN(hrsVal) || hrsVal <= 0) {
                            alert(`Ange giltigt antal timmar f√∂r √§mnet i klass ${cls.name}`);
                            debugLog('Validation failed: invalid hours', {class: cls, index: i, hours: hrsValRaw});
                            return;
                        }
                        if (hrsVal > 5) {
                            alert(`Max 5 lektioner per vecka per √§mne. Du angav ${hrsVal} f√∂r √§mnet i klass ${cls.name}`);
                            debugLog('Validation failed: hours > 5', {class: cls, hours: hrsVal});
                            return;
                        }

                        // F√∂rs√∂k tolka valt v√§rde som ett SchoolSubject-id
                        const schoolSubjectId = parseInt(subjVal, 10);

                        // H√§mta namn fr√•n schoolSubjects (fallback: availableSubjects)
                        const subjectNameFromSchool = getSubjectNameById(schoolSubjectId);
                        const subjectNameFromAvailable = (availableSubjects||[]).find(s => String(s.id) === String(schoolSubjectId))?.name;
                        const resolvedSubjectName = subjectNameFromSchool || subjectNameFromAvailable || `√Ñmne ${schoolSubjectId}`;

                        // Push med b√•de school_subject_id och subject_id (bak√•tkompatibilitet)
                        items.push({
                            subject_id: schoolSubjectId,          // backend-fallback (tidigare f√§lt)
                            school_subject_id: schoolSubjectId,   // uttryckligt school_subject id
                            subject_name: resolvedSubjectName,
                            hours: hrsVal
                        });

                        // Debug-logg (ta bort n√§r det funkar)
                        debugLog('Added subject item', { classId, schoolSubjectId, resolvedSubjectName, hours: hrsVal });


                    }

                    classSubjectMap[classId] = items;
                }

                const rooms = getAvailableRooms();
                const maxSimultaneousClasses = selectedClasses.length;
                if (rooms.length < maxSimultaneousClasses) {
                    const proceed = confirm(
                        `Du har valt ${maxSimultaneousClasses} klasser men bara ${rooms.length} klassrum. ` +
                        `Detta kan orsaka schemal√§ggningsproblem n√§r klasser har lektioner samtidigt. Forts√§tt √§nd√•?`
                    );
                    if (!proceed) {
                        debugLog('User cancelled due to insufficient rooms');
                        return;
                    }
                }

                debugLog('Multi-class validation passed, generating schedule...', {
                    classes: selectedClasses.length,
                    classSubjectMap,
                    rooms: rooms.length
                });

                // Visa loading
                preview.innerHTML = `
                    <div style="text-align: center;">
                        <div class="loading-spinner"></div>
                        <p style="margin-top: 1rem;">Genererar multi-klass schema...</p>
                        <p style="font-size: 0.9rem; color: #666;">
                            Schemal√§ggning f√∂r ${selectedClasses.length} klasser med klassrumshantering
                        </p>
                        <p style="font-size: 0.85rem; color: #888;">
                            F√∂ljer: Ingen klassrumskonflikt, max 1 √§mne/dag per klass, 5-min intervall
                        </p>
                    </div>
                `;

                try {
                    const form = document.getElementById('scheduleForm');
                    const formData = new FormData(form);
                    const lessonDuration = parseInt(formData.get('lesson_duration') || '60');
                    const multiClassSchedule = generateMultiClassScheduleWithConstraints(
                        selectedClasses, classSubjectMap, rooms, 
                        formData.get('start_time'), formData.get('end_time'), lessonDuration
                    );

                    setTimeout(() => {
                        debugLog('Multi-class schedule generated successfully', multiClassSchedule);
                        currentSchedule = multiClassSchedule;
                        
                        // Fill teacher filter from schedule if not already available
                        if (!(typeof availableTeachers !== 'undefined' && Array.isArray(availableTeachers) && availableTeachers.length > 0)) {
                            populateTeacherFilterFromSchedule(currentSchedule);
                        }
                        
                        // Display with current filters
                        const classSel = document.getElementById('classFilter');
                        const teacherSel = document.getElementById('teacherFilter');
                        const selectedClass = classSel && classSel.value !== 'all' ? classSel.value : null;
                        const selectedTeacher = teacherSel && teacherSel.value !== 'all' ? teacherSel.value : null;
                        
                        displayMultiClassSchedule(currentSchedule, selectedClass, selectedTeacher);
                        controls.style.display = 'flex';
                    }, 1000);

                } catch (error) {
                    debugLog('Error generating multi-class schedule:', error);
                    console.error('Error generating multi-class schedule:', error);
                    preview.innerHTML = `
                        <div style="text-align: center; color: #e53e3e;">
                            <p>‚ùå Fel vid multi-klass schemagenerering</p>
                            <p style="font-size: 0.9rem;">${error.message}</p>
                            <p style="font-size: 0.85rem; color: #666;">
                                Tips: Minska antalet lektioner, √∂ka antalet klassrum, eller minska antalet klasser
                            </p>
                        </div>
                    `;
                    controls.style.display = 'none';
                }
            }

            // Fix 2: Ensure availableTeachers is properly initialized
            function initializeData() {
                // Make sure availableTeachers is defined
                if (typeof availableTeachers === 'undefined') {
                    availableTeachers = [];
                }
                
                // Make sure other global variables are properly initialized
                if (typeof availableSubjects === 'undefined') {
                    availableSubjects = [];
                }
                
                if (typeof availableClasses === 'undefined') {
                    availableClasses = [];
                }
                
                if (typeof schoolSubjects === 'undefined') {
                    schoolSubjects = availableSubjects || [];
                }
            }



            


            function findAvailableTimeSlotsForClass(daySchedule, classId, allTimeSlots, minBreakMinutes) {
                const availableSlots = [];
                const classLessons = daySchedule.filter(lesson => lesson.class_id === classId);
                
                for (const timeSlot of allTimeSlots) {
                    const [startTime, endTime] = timeSlot.split('-');
                    const startMinutes = timeToMinutes(startTime);
                    const endMinutes = timeToMinutes(endTime);
                    
                    let canPlace = true;
                    
                    // Kontrollera mot denna klass befintliga lektioner
                    for (const existingLesson of classLessons) {
                        const [existingStart, existingEnd] = existingLesson.time.split('-');
                        const existingStartMinutes = timeToMinutes(existingStart);
                        const existingEndMinutes = timeToMinutes(existingEnd);
                        
                        // Kontrollera √∂verlappning och paus
                        if (!(endMinutes + minBreakMinutes <= existingStartMinutes || 
                            startMinutes >= existingEndMinutes + minBreakMinutes)) {
                            canPlace = false;
                            break;
                        }
                    }
                    
                    if (canPlace) {
                        availableSlots.push(timeSlot);
                    }
                }
                
                return availableSlots;
            }


            function checkTeacherConflicts(lessons) {
                const conflicts = [];
                
                // Gruppera lektioner efter dag och tid
                const lessonsByDayTime = {};
                lessons.forEach(lesson => {
                    const key = `${lesson.day}-${lesson.time}`;
                    if (!lessonsByDayTime[key]) {
                        lessonsByDayTime[key] = [];
                    }
                    lessonsByDayTime[key].push(lesson);
                });
                
                // Kontrollera l√§rarkonflikter
                Object.keys(lessonsByDayTime).forEach(key => {
                    const timeLessons = lessonsByDayTime[key];
                    const teachersUsed = {};
                    
                    timeLessons.forEach(lesson => {
                        const teacherKey = lesson.teacher_id || lesson.teacher_name || lesson.teacher;
                        if (teacherKey && teachersUsed[teacherKey]) {
                            conflicts.push({
                                teacher: teacherKey,
                                time: key,
                                classes: [teachersUsed[teacherKey].class_name, lesson.class_name]
                            });
                        } else if (teacherKey) {
                            teachersUsed[teacherKey] = lesson;
                        }
                    });
                });
                
                return conflicts;
            }

            function checkRoomConflicts(lessons) {
                const conflicts = [];
                
                // Gruppera lektioner efter dag och tid
                const lessonsByDayTime = {};
                lessons.forEach(lesson => {
                    const key = `${lesson.day}-${lesson.time}`;
                    if (!lessonsByDayTime[key]) {
                        lessonsByDayTime[key] = [];
                    }
                    lessonsByDayTime[key].push(lesson);
                });
                
                // Kontrollera konflikter
                Object.keys(lessonsByDayTime).forEach(key => {
                    const timeLessons = lessonsByDayTime[key];
                    const roomsUsed = {};
                    
                    timeLessons.forEach(lesson => {
                        if (roomsUsed[lesson.room]) {
                            conflicts.push({
                                room: lesson.room,
                                time: key,
                                classes: [roomsUsed[lesson.room].class_name, lesson.class_name]
                            });
                        } else {
                            roomsUsed[lesson.room] = lesson;
                        }
                    });
                });
                
                return conflicts;
            }

            function calculateMultiClassBalanceScore(schedule, classes) {
                let totalBalance = 0;
                
                classes.forEach(classInfo => {
                    const dailyCounts = Object.keys(schedule).map(day => 
                        schedule[day].filter(lesson => lesson.class_id === classInfo.id).length
                    );
                    const max = Math.max(...dailyCounts);
                    const min = Math.min(...dailyCounts);
                    
                    const balance = max === 0 ? 100 : Math.round((1 - (max - min) / max) * 100);
                    totalBalance += balance;
                });
                
                return Math.round(totalBalance / classes.length);
            }

            function validateMultiClassConstraints(schedule, classes) {
                let violations = 0;
                
                classes.forEach(classInfo => {
                    Object.values(schedule).forEach(dayLessons => {
                        const classLessons = dayLessons.filter(l => l.class_id === classInfo.id);
                        const subjects = classLessons.map(l => l.subject_name);
                        const uniqueSubjects = new Set(subjects);
                        if (subjects.length !== uniqueSubjects.size) {
                            violations++;
                        }
                    });
                });
                
                return violations;
            }

            // classFilter: null eller classId
            // teacherFilter: null eller teacherId/name
            function escapeHtml(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            }
            function timeToMinutes(t) { const [hh, mm] = String(t).split(':').map(Number); return hh*60 + (mm||0); }

                // Robust display-funktion (ers√§tt befintlig)
            function displayMultiClassSchedule(schedule, classFilter = null, teacherFilter = null) {
                    const preview = document.getElementById('schedulePreview');
                    if (!preview) {
                        console.warn('displayMultiClassSchedule: schedulePreview saknas i DOM');
                        return;
                    }
                    if (!schedule || !Array.isArray(schedule.lessons)) {
                        preview.innerHTML = '<div style="text-align:center;color:#666;">Inget schema att visa</div>';
                        return;
                    }

                    // Bygg lessonMap per dag f√∂r snabbare uppslag
                    const lessonMap = {};
                    schedule.lessons.forEach(ls => {
                        // ls √§r s√§kert definierad h√§r
                        const day = ls.day || 'ok√§nd';
                        if (!lessonMap[day]) lessonMap[day] = [];
                        lessonMap[day].push(ls);
                    });

                    // times: anv√§nd schedule.time_slots om tillg√§nglig, annars fallback
                    const times = Array.isArray(schedule.time_slots) && schedule.time_slots.length > 0
                        ? schedule.time_slots.slice()
                        : (typeof generateTimeSlots === 'function' ? generateTimeSlots('08:00','15:00', 60) : ['08:00-09:00']);

                    const weekdays = ['m√•ndag','tisdag','onsdag','torsdag','fredag'];

                    // Bygg HTML-tabell
                    let html = '<div style="overflow-x:auto;"><table class="schedule-table" style="width:100%; border-collapse:collapse;">';
                    html += '<thead><tr><th style="min-width:70px; text-align:left; padding:6px;">Tid</th>';
                    weekdays.forEach(d => html += `<th style="text-align:left; padding:6px;">${d.charAt(0).toUpperCase()+d.slice(1)}</th>`);
                    html += '</tr></thead><tbody>';

                    times.forEach(currentTime => {
                        html += `<tr><td style="padding:6px; font-weight:600; vertical-align:top;">${escapeHtml(currentTime)}</td>`;

                        weekdays.forEach(day => {
                        const dayLessons = lessonMap[day] || [];
                        // Hitta lektioner som t√§cker currentTime
                        const activeLessons = dayLessons.filter(l => {
                            if (!l.time) return false;
                            const parts = String(l.time).split('-');
                            if (parts.length !== 2) return false;
                            const start = parts[0].trim(), end = parts[1].trim();
                            const cur = timeToMinutes(currentTime.split('-')[0]);
                            return cur >= timeToMinutes(start) && cur < timeToMinutes(end);
                        });

                        if (activeLessons.length === 0) {
                            html += '<td class="empty-cell" style="padding:6px; color:#a0aec0;">-</td>';
                        } else {
                            // Skapa cellinneh√•ll f√∂r varje aktiv lektion (anv√§nd local variabel 'les' i map)
                            const cellContent = activeLessons.map(les => {
                            // s√§kra f√§lt

                            // F√∂rs√∂k i denna ordning: explicit subject_name -> lookup via school_subject_id -> lookup via subject_id -> fallback
                            const subjectLabel =
                                les.subject_name
                                || getSubjectNameById(les.school_subject_id)
                                || getSubjectNameById(les.subject_id)
                                || 'Ok√§nt √§mne';

                            const classLabel = les.class_name || les.class_id || '';
                            const room = les.room || '';
                            const teacher = les.teacher_name || les.teacher || '';
                            const color = les.color || '#9f7aea';

                            return `
                                <div style="margin-bottom:6px; padding:6px; border-left:4px solid ${escapeHtml(color)}; background: ${escapeHtml(color)}15; border-radius:6px;">
                                <div style="font-weight:700;">${escapeHtml(subjectLabel)}</div>
                                <div style="font-size:0.9rem; color:#4a5568;">${escapeHtml(classLabel)} ‚Ä¢ <span style="font-size:0.8rem; color:#718096">${escapeHtml(room)}</span></div>
                                ${teacher ? `<div style="font-size:0.85rem; color:#4a5568;">L√§rare: ${escapeHtml(teacher)}</div>` : ''}
                                </div>
                            `;
                            }).join('');
                            html += `<td class="lesson-cell" style="padding:6px; vertical-align:top;">${cellContent}</td>`;
                        }
                        });

                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';

                    preview.innerHTML = html;

                    // Visa generationControls (om vi har ett schema att visa)
                    const controls = document.getElementById('generationControls');
                    if (controls) controls.style.display = '';
                    
                    // Fyll teacher-filter om tomt
                    populateTeacherFilterFromSchedule(schedule);
            }


            document.addEventListener('DOMContentLoaded', function() {
                debugLog('Multi-class schedule generator loaded');
                validateSubjectHours();
                populateClassFilter();
            });

            document.addEventListener('DOMContentLoaded', function() {
                debugLog('Multi-class schedule generator loaded');
                validateSubjectHours();
                populateClassFilter();
                populateTeacherFilter();
            });

            document.addEventListener('DOMContentLoaded', function() {
                initializeData();
                debugLog('Multi-class schedule generator loaded');
                validateSubjectHours();
                populateClassFilter();
                populateTeacherFilter();
                renderSubjects();
            });




            // Efter att schemat skapats
            currentSchedule = multiClassSchedule;
            // Fyll teacher-filter fr√•n schemat om backend inte skickade teachers
            if (!(typeof availableTeachers !== 'undefined' && Array.isArray(availableTeachers) && availableTeachers.length > 0)) {
                populateTeacherFilterFromSchedule(currentSchedule);
            }
            // Rendera med eventuellt redan valt filter
            const classSel = document.getElementById('classFilter');
            const teacherSel = document.getElementById('teacherFilter');
            const selectedClass = classSel && classSel.value !== 'all' ? classSel.value : null;
            const selectedTeacher = teacherSel && teacherSel.value !== 'all' ? teacherSel.value : null;
            displayMultiClassSchedule(currentSchedule, selectedClass, selectedTeacher);
            controls.style.display = 'flex';




            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + minutes;
            }

            function minutesToTime(minutes) {
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
            }

            function generateTimeSlots(startTime, endTime, lessonDuration) {
                const slots = [];
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                
                let currentTime = startMinutes;
                
                while (currentTime + lessonDuration <= endMinutes) {
                    const slotStart = minutesToTime(currentTime);
                    const slotEnd = minutesToTime(currentTime + lessonDuration);
                    slots.push(`${slotStart}-${slotEnd}`);
                    
                    // In edit mode, use 5-minute intervals, in normal mode use lesson duration
                    currentTime += isEditMode ? 5 : lessonDuration;
                }
                
                return slots;
            }









            function hideScheduleOverview() {
                document.getElementById('scheduleOverview').style.display = 'none';
            }

            /**
             * View detailed schedule for a specific class
             */
            async function viewClassScheduleDetails(classId, className) {
                try {
                    debugLog(`Loading schedule details for class ${className} (${classId})`);
                    
                    const response = await fetch(`/api/class_schedule/status/${classId}`);
                    const result = await response.json();

                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte h√§mta schemadetaljer');
                    }

                    // Create modal to show schedule details
                    showClassScheduleModal(result);
                    
                } catch (error) {
                    console.error('Error loading class schedule details:', error);
                    alert(`Fel vid laddning av schemadetaljer: ${error.message}`);
                }
            }

            /**
             * Show class schedule in modal
             */
            function showClassScheduleModal(scheduleData) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                    overflow-y: auto; padding: 1rem;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; border-radius: 0.5rem; max-width: 800px; width: 100%;
                    max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                `;

                const weekdays = ['m√•ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'];
                
                let scheduleHtml = `
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            üìÖ Schema f√∂r ${scheduleData.class_name}
                            <button onclick="this.closest('[style*=position]').remove()" 
                                    style="background: #f56565; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">
                                ‚úï
                            </button>
                        </h3>
                        <p style="margin: 0.5rem 0 0 0; color: #666;">
                            Totalt ${scheduleData.lesson_count} lektioner per vecka
                        </p>
                    </div>
                    
                    <div style="padding: 1.5rem;">
                `;

                if (scheduleData.has_schedule) {
                    scheduleHtml += `<div style="overflow-x: auto;"><table class="schedule-table" style="width: 100%; border-collapse: collapse;">`;
                    scheduleHtml += `<thead><tr style="background: #f7fafc;"><th style="padding: 0.75rem; border: 1px solid #e2e8f0;">Dag</th><th style="padding: 0.75rem; border: 1px solid #e2e8f0;">Tid</th><th style="padding: 0.75rem; border: 1px solid #e2e8f0;">√Ñmne</th><th style="padding: 0.75rem; border: 1px solid #e2e8f0;">Rum</th></tr></thead><tbody>`;

                    weekdays.forEach(day => {
                        const dayLessons = scheduleData.lessons_by_day[day] || [];
                        
                        if (dayLessons.length === 0) {
                            scheduleHtml += `
                                <tr>
                                    <td style="padding: 0.75rem; border: 1px solid #e2e8f0; font-weight: 600; text-transform: capitalize;">${day}</td>
                                    <td colspan="3" style="padding: 0.75rem; border: 1px solid #e2e8f0; color: #999; font-style: italic;">Inga lektioner</td>
                                </tr>
                            `;
                        } else {
                            dayLessons.forEach((lesson, index) => {
                                scheduleHtml += `
                                    <tr>
                                        ${index === 0 ? `<td rowspan="${dayLessons.length}" style="padding: 0.75rem; border: 1px solid #e2e8f0; font-weight: 600; text-transform: capitalize; vertical-align: top;">${day}</td>` : ''}
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0; font-family: monospace;">${lesson.time}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${lesson.subject}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${lesson.room}</td>
                                    </tr>
                                `;
                            });
                        }
                    });

                    scheduleHtml += `</tbody></table></div>`;
                } else {
                    scheduleHtml += `<div style="text-align: center; color: #666; font-style: italic;">Inget schema har skapats f√∂r denna klass.</div>`;
                }

                scheduleHtml += `
                    </div>
                `;

                content.innerHTML = scheduleHtml;
                modal.appendChild(content);
                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            /**
             * Edit schedule for a specific class
             */
            async function editClassSchedule(classId, className) {
                try {
                    debugLog(`Starting edit mode for class ${className} (${classId})`);
                    
                    // Set edit mode state
                    isEditMode = true;
                    editingClassId = classId;
                    editingClassName = className;
                    
                    // Select only this class
                    document.querySelectorAll('input[name="class_ids[]"]').forEach(cb => {
                        cb.checked = cb.id === `class_${classId}`;
                    });
                    
                    // Update selected classes
                    updateSelectedClasses();
                    
                    // Load existing schedule data
                    const response = await fetch(`/api/class_schedule/status/${classId}`);
                    const result = await response.json();
                    
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte ladda befintligt schema');
                    }
                    
                    if (!result.has_schedule) {
                        // No existing schedule - redirect to creation
                        alert(`Klass "${className}" har inget befintligt schema. Du kommer att skapa ett nytt schema ist√§llet.`);
                        isEditMode = false;
                        editingClassId = null;
                        editingClassName = null;
                        document.getElementById('scheduleForm').scrollIntoView({ behavior: 'smooth', block: 'start' });
                        return;
                    }
                    
                    // Store original data for potential rollback
                    originalScheduleData = result;
                    
                    // Enter edit mode UI
                    enterEditMode(result);
                    
                    // Display editable schedule
                    displayEditableSchedule(result);
                    
                    // Update controls
                    updateEditControls();
                    
                    // Show controls
                    document.getElementById('generationControls').style.display = 'flex';
                    
                    // Scroll to preview
                    document.getElementById('schedulePreview').scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                    
                    // Hide overview if visible
                    const overview = document.getElementById('scheduleOverview');
                    if (overview && overview.style.display === 'block') {
                        hideScheduleOverview();
                    }
                    
                    debugLog('Edit mode entered successfully', { classId, className, lessonCount: result.lesson_count });
                    
                } catch (error) {
                    console.error('Error entering edit mode:', error);
                    
                    // Reset edit state on error
                    isEditMode = false;
                    editingClassId = null;
                    editingClassName = null;
                    originalScheduleData = null;
                    
                    handleApiError(error, 'redigering av schema');
                }
            }

            /**
             * Create schedule for a specific class
             */
            function createScheduleForClass(classId, className) {
                editClassSchedule(classId, className);
            }

            /**
             * Reset schedule for a single class
             */
            async function resetSingleClassSchedule(classId, className) {
                if (!confirm(`√Ñr du s√§ker p√• att du vill ta bort schemat f√∂r "${className}"?\n\nDetta kan inte √•ngras.`)) {
                    return;
                }

                try {
                    const response = await fetch(`/api/class_schedule/reset/${classId}`, {
                        method: 'DELETE'
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        alert(`‚úÖ Schema f√∂r "${className}" har rensats.\n${result.deleted_lessons} lektioner togs bort.`);
                        
                        // Refresh overview
                        viewAllClassSchedules();
                    } else {
                        throw new Error(result.error || 'Ok√§nt fel');
                    }

                } catch (error) {
                    console.error('Error resetting single class schedule:', error);
                    alert(`‚ùå Fel vid rensning av schema: ${error.message}`);
                }
            }

            /**
             * Export schedules to CSV
             */
            async function exportSchedulesToCSV() {
                try {
                    debugLog('Exporting schedules to CSV...');
                    
                    // Get all class schedules
                    const allClassIds = availableClasses.map(c => c.id);
                    const response = await fetch('/api/multi_class_schedule/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_ids: allClassIds
                        })
                    });

                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte h√§mta scheman');
                    }

                    // Get detailed schedule data for classes with schedules
                    const classesWithSchedule = result.classes_status.filter(cls => cls.has_schedule);
                    
                    if (classesWithSchedule.length === 0) {
                        alert('Inga scheman att exportera');
                        return;
                    }

                    // Prepare CSV data
                    const csvRows = [];
                    csvRows.push(['Klass', 'Dag', 'Starttid', 'Sluttid', '√Ñmne', 'Rum', 'Antal lektioner']);

                    // Get detailed data for each class
                    for (const cls of classesWithSchedule) {
                        const detailResponse = await fetch(`/api/class_schedule/status/${cls.class_id}`);
                        const detailResult = await detailResponse.json();
                        
                        if (detailResult.success && detailResult.lessons_by_day) {
                            Object.entries(detailResult.lessons_by_day).forEach(([day, lessons]) => {
                                lessons.forEach(lesson => {
                                    const [startTime, endTime] = lesson.time.split('-');
                                    csvRows.push([
                                        cls.class_name,
                                        day,
                                        startTime,
                                        endTime,
                                        lesson.subject,
                                        lesson.room,
                                        '1'
                                    ]);
                                });
                            });
                        }
                    }

                    // Generate CSV
                    const csvContent = csvRows.map(row => 
                        row.map(field => `"${field}"`).join(',')
                    ).join('\n');

                    // Download CSV
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `scheman_${new Date().toISOString().split('T')[0]}.csv`;
                    link.click();

                    debugLog('CSV export completed');
                    alert(`‚úÖ Scheman exporterade!\n${csvRows.length - 1} lektioner fr√•n ${classesWithSchedule.length} klasser.`);

                } catch (error) {
                    console.error('Error exporting schedules:', error);
                    alert(`‚ùå Fel vid export: ${error.message}`);
                }
            }

            /**
             * Show schedule statistics
             */
            async function showScheduleStatistics() {
                try {
                    debugLog('Loading schedule statistics...');
                    
                    const allClassIds = availableClasses.map(c => c.id);
                    const response = await fetch('/api/multi_class_schedule/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_ids: allClassIds
                        })
                    });

                    const result = await response.json();
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte h√§mta statistik');
                    }

                    // Calculate statistics
                    const stats = calculateScheduleStatistics(result);
                    
                    // Show statistics modal
                    showStatisticsModal(stats);
                    
                } catch (error) {
                    console.error('Error loading statistics:', error);
                    alert(`‚ùå Fel vid laddning av statistik: ${error.message}`);
                }
            }

            /**
             * Calculate schedule statistics
             */
            function calculateScheduleStatistics(statusData) {
                const { classes_status, summary } = statusData;
                
                const stats = {
                    total_classes: summary.total_classes,
                    classes_with_schedule: summary.classes_with_schedule,
                    total_lessons: summary.total_lessons,
                    avg_lessons_per_class: summary.classes_with_schedule > 0 ? 
                        (summary.total_lessons / summary.classes_with_schedule).toFixed(1) : 0,
                    schedule_coverage: summary.total_classes > 0 ? 
                        ((summary.classes_with_schedule / summary.total_classes) * 100).toFixed(1) : 0,
                    
                    lessons_by_class: {},
                    most_lessons: { class: null, count: 0 },
                    least_lessons: { class: null, count: Infinity },
                    
                    completion_rate: summary.all_classes_have_schedule ? 100 : 
                        (summary.classes_with_schedule / summary.total_classes * 100).toFixed(1)
                };
                
                // Analyze per class
                classes_status.forEach(cls => {
                    if (cls.has_schedule) {
                        stats.lessons_by_class[cls.class_name] = cls.lesson_count;
                        
                        if (cls.lesson_count > stats.most_lessons.count) {
                            stats.most_lessons = { class: cls.class_name, count: cls.lesson_count };
                        }
                        
                        if (cls.lesson_count < stats.least_lessons.count) {
                            stats.least_lessons = { class: cls.class_name, count: cls.lesson_count };
                        }
                    }
                });
                
                // Reset least if no classes have schedules
                if (stats.least_lessons.count === Infinity) {
                    stats.least_lessons = { class: null, count: 0 };
                }
                
                return stats;
            }

            /**
             * Show statistics modal
             */
            function showStatisticsModal(stats) {
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                    background: rgba(0,0,0,0.5); z-index: 10000;
                    display: flex; align-items: center; justify-content: center;
                    overflow-y: auto; padding: 1rem;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; border-radius: 0.5rem; max-width: 600px; width: 100%;
                    max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                `;

                let html = `
                    <div style="padding: 1.5rem; border-bottom: 1px solid #e2e8f0;">
                        <h3 style="margin: 0; display: flex; justify-content: space-between; align-items: center;">
                            üìà Schemastatistik
                            <button onclick="this.closest('[style*=position]').remove()" 
                                    style="background: #f56565; color: white; border: none; padding: 0.5rem; border-radius: 0.25rem; cursor: pointer;">
                                ‚úï
                            </button>
                        </h3>
                    </div>
                    
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            <div style="text-align: center; padding: 1rem; background: #f0fff4; border-radius: 0.5rem; border: 1px solid #9ae6b4;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #22543d;">${stats.total_classes}</div>
                                <div style="color: #4a5568;">Totalt klasser</div>
                            </div>
                            
                            <div style="text-align: center; padding: 1rem; background: #ebf8ff; border-radius: 0.5rem; border: 1px solid #90cdf4;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2a4365;">${stats.classes_with_schedule}</div>
                                <div style="color: #4a5568;">Med scheman</div>
                            </div>
                            
                            <div style="text-align: center; padding: 1rem; background: #fef5e7; border-radius: 0.5rem; border: 1px solid #f6ad55;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #744210;">${stats.total_lessons}</div>
                                <div style="color: #4a5568;">Totalt lektioner</div>
                            </div>
                            
                            <div style="text-align: center; padding: 1rem; background: #f7fafc; border-radius: 0.5rem; border: 1px solid #cbd5e0;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: #2d3748;">${stats.avg_lessons_per_class}</div>
                                <div style="color: #4a5568;">‚åÄ per klass</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; color: #2d3748;">üéØ Schemal√§ggningsstatus</h4>
                            <div style="background: #f7fafc; padding: 1rem; border-radius: 0.5rem; border-left: 4px solid #4299e1;">
                                <div style="margin-bottom: 0.5rem;">
                                    <strong>T√§ckningsgrad:</strong> ${stats.schedule_coverage}% 
                                    (${stats.classes_with_schedule}/${stats.total_classes} klasser)
                                </div>
                                <div style="background: #e2e8f0; height: 0.5rem; border-radius: 0.25rem; overflow: hidden;">
                                    <div style="background: ${stats.completion_rate == 100 ? '#38a169' : stats.completion_rate > 50 ? '#ed8936' : '#f56565'}; 
                                                height: 100%; width: ${stats.completion_rate}%; transition: width 0.3s ease;"></div>
                                </div>
                            </div>
                        </div>
                `;

                if (Object.keys(stats.lessons_by_class).length > 0) {
                    html += `
                        <div style="margin-bottom: 1.5rem;">
                            <h4 style="margin-bottom: 0.75rem; color: #2d3748;">üìä Lektioner per klass</h4>
                            <div style="max-height: 200px; overflow-y: auto; background: #f7fafc; padding: 1rem; border-radius: 0.5rem;">
                    `;

                    Object.entries(stats.lessons_by_class)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([className, lessonCount]) => {
                            const percentage = (lessonCount / Math.max(...Object.values(stats.lessons_by_class))) * 100;
                            html += `
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                                        <span>${className}</span>
                                        <strong>${lessonCount} lektioner</strong>
                                    </div>
                                    <div style="background: #e2e8f0; height: 0.25rem; border-radius: 0.125rem; overflow: hidden;">
                                        <div style="background: #4299e1; height: 100%; width: ${percentage}%; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            `;
                        });

                    html += `</div></div>`;

                    if (stats.most_lessons.class && stats.least_lessons.class) {
                        html += `
                            <div>
                                <h4 style="margin-bottom: 0.75rem; color: #2d3748;">üèÜ Extremv√§rden</h4>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                    <div style="background: #c6f6d5; padding: 1rem; border-radius: 0.5rem; border: 1px solid #9ae6b4;">
                                        <div style="font-weight: bold; color: #22543d;">Mest lektioner</div>
                                        <div>${stats.most_lessons.class}</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #22543d;">${stats.most_lessons.count} lektioner</div>
                                    </div>
                                    <div style="background: #fed7d7; padding: 1rem; border-radius: 0.5rem; border: 1px solid #feb2b2;">
                                        <div style="font-weight: bold; color: #742a2a;">Minst lektioner</div>
                                        <div>${stats.least_lessons.class}</div>
                                        <div style="font-size: 1.2rem; font-weight: bold; color: #742a2a;">${stats.least_lessons.count} lektioner</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                }

                html += `
                        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e2e8f0;">
                            <div style="color: #666; font-size: 0.9rem; margin-bottom: 1rem;">
                                Statistik genererad: ${new Date().toLocaleString('sv-SE')}
                            </div>
                            <button type="button" class="btn" onclick="exportStatisticsReport()" style="background: #48bb78; margin-right: 0.5rem;">
                                üìä Exportera rapport
                            </button>
                            <button type="button" class="btn" onclick="this.closest('[style*=position]').remove()" style="background: #718096;">
                                St√§ng
                            </button>
                        </div>
                    </div>
                `;

                content.innerHTML = html;
                modal.appendChild(content);
                document.body.appendChild(modal);

                // Close on background click
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // Store stats globally for export
                window.currentScheduleStats = stats;
            }

            /**
             * Export statistics report
             */
            function exportStatisticsReport() {
                if (!window.currentScheduleStats) {
                    alert('Ingen statistik att exportera');
                    return;
                }

                const stats = window.currentScheduleStats;
                const timestamp = new Date().toLocaleString('sv-SE');
                
                let report = `SCHEMASTATISTIK RAPPORT\n`;
                report += `Genererad: ${timestamp}\n`;
                report += `${'='.repeat(50)}\n\n`;
                
                report += `√ñVERSIKT:\n`;
                report += `- Totalt klasser: ${stats.total_classes}\n`;
                report += `- Klasser med scheman: ${stats.classes_with_schedule}\n`;
                report += `- Totalt lektioner: ${stats.total_lessons}\n`;
                report += `- Genomsnitt lektioner per klass: ${stats.avg_lessons_per_class}\n`;
                report += `- Schemat√§ckningsgrad: ${stats.schedule_coverage}%\n\n`;
                
                if (Object.keys(stats.lessons_by_class).length > 0) {
                    report += `LEKTIONER PER KLASS:\n`;
                    Object.entries(stats.lessons_by_class)
                        .sort((a, b) => b[1] - a[1])
                        .forEach(([className, lessonCount]) => {
                            report += `- ${className}: ${lessonCount} lektioner\n`;
                        });
                    report += `\n`;
                    
                    if (stats.most_lessons.class && stats.least_lessons.class) {
                        report += `EXTREMV√ÑRDEN:\n`;
                        report += `- Mest lektioner: ${stats.most_lessons.class} (${stats.most_lessons.count} lektioner)\n`;
                        report += `- Minst lektioner: ${stats.least_lessons.class} (${stats.least_lessons.count} lektioner)\n\n`;
                    }
                }
                
                report += `REKOMMENDATIONER:\n`;
                if (stats.completion_rate < 100) {
                    report += `- ${stats.total_classes - stats.classes_with_schedule} klasser saknar scheman\n`;
                }
                if (stats.most_lessons.count > stats.least_lessons.count + 5) {
                    report += `- √ñverv√§g att balansera lektioner mellan klasser\n`;
                }
                if (stats.completion_rate == 100) {
                    report += `- Alla klasser har scheman - bra jobbat!\n`;
                }

                // Create and download report
                const blob = new Blob([report], { type: 'text/plain;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `schemastatistik_${new Date().toISOString().split('T')[0]}.txt`;
                link.click();

                debugLog('Statistics report exported');
            }

            /**
             * Enhanced initialization function
             */
            function initializeScheduleManagement() {
                // Initialize data
                initializeData();
                
                // Setup auto-save detection
                let scheduleChangeDetected = false;
                
                // Monitor for schedule changes
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.target.id === 'schedulePreview' && currentSchedule) {
                            if (!scheduleChangeDetected) {
                                scheduleChangeDetected = true;
                                markScheduleAsUnsaved();
                            }
                        }
                    });
                });
                
                const previewElement = document.getElementById('schedulePreview');
                if (previewElement) {
                    observer.observe(previewElement, {
                        childList: true,
                        subtree: true
                    });
                }
                
                // Auto-update status periodically
                setInterval(() => {
                    if (selectedClasses.length > 0) {
                        updateClassScheduleStatus();
                    }
                }, 30000); // Every 30 seconds
                
                debugLog('Schedule management initialized');
            }

            /**
             * Enhanced error handling for API calls
             */
            function handleApiError(error, context = '') {
                console.error(`API Error ${context}:`, error);
                
                let userMessage = 'Ett fel uppstod';
                if (context) userMessage += ` vid ${context}`;
                
                if (error.message.includes('Unauthorized') || error.message.includes('403')) {
                    userMessage += '.\n\nDu har inte beh√∂righet f√∂r denna √•tg√§rd.';
                } else if (error.message.includes('Not Found') || error.message.includes('404')) {
                    userMessage += '.\n\nData hittades inte. Sidan kan beh√∂va laddas om.';
                } else if (error.message.includes('500')) {
                    userMessage += '.\n\nServerfel. F√∂rs√∂k igen senare.';
                } else {
                    userMessage += `.\n\nDetaljer: ${error.message}`;
                }
                
                alert(`‚ùå ${userMessage}`);
                debugLog(`Error handled for ${context}:`, error);
            }

            /**
             * Utility function to format time strings
             */
            function formatTimeRange(timeRange) {
                if (!timeRange || !timeRange.includes('-')) return timeRange;
                
                const [start, end] = timeRange.split('-');
                return `${start}‚Äì${end}`;
            }

            /**
             * Utility function to get class color by ID
             */
            function getClassColorById(classId) {
                const classIndex = availableClasses.findIndex(c => c.id == classId);
                return classIndex >= 0 ? classColors[classIndex % classColors.length] : '#718096';
            }

            /**
             * Debounce function for API calls
             */
            function debounce(func, wait) {
                let timeout;
                return function executedFunction(...args) {
                    const later = () => {
                        clearTimeout(timeout);
                        func(...args);
                    };
                    clearTimeout(timeout);
                    timeout = setTimeout(later, wait);
                };
            }

            // Debounced version of updateClassScheduleStatus
            const debouncedUpdateStatus = debounce(updateClassScheduleStatus, 500);

            // Override the existing DOMContentLoaded handler
            document.addEventListener('DOMContentLoaded', function() {
                // Call original initialization
                initializeData();
                debugLog('Multi-class schedule generator loaded');
                validateSubjectHours();
                populateClassFilter();
                populateTeacherFilter();
                renderSubjects();
                
                // Initialize schedule management
                initializeScheduleManagement();
                
                // Add keyboard shortcuts
                document.addEventListener('keydown', function(e) {
                    // Ctrl+S to save
                    if (e.ctrlKey && e.key === 's') {
                        e.preventDefault();
                        if (currentSchedule) {
                            saveMultiClassSchedule();
                        }
                    }
                    
                    // Ctrl+R to reset (with confirmation)
                    if (e.ctrlKey && e.key === 'r' && selectedClasses.length > 0) {
                        e.preventDefault();
                        resetClassSchedules();
                    }
                    
                    // Ctrl+G to generate
                    if (e.ctrlKey && e.key === 'g') {
                        e.preventDefault();
                        generateMultiClassSchedule();
                    }
                });
                
                debugLog('Enhanced schedule management loaded with keyboard shortcuts');
            });
    



            function displayAllClassSchedules(statusData) {
                const overviewDiv = document.getElementById('scheduleOverview');
                const { classes_status, summary } = statusData;

                let html = `
                    <div class="schedule-overview-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding: 1rem; background: #f7fafc; border-radius: 0.5rem;">
                        <h4 style="margin: 0;">üìä √ñversikt - Alla klasser</h4>
                        <div style="text-align: right; font-size: 0.9rem;">
                            <div><strong>${summary.classes_with_schedule}/${summary.total_classes}</strong> klasser har scheman</div>
                            <div style="color: #666;"><strong>${summary.total_lessons}</strong> totalt lektioner</div>
                        </div>
                    </div>

                    <div class="classes-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                `;

                classes_status.forEach((cls, index) => {
                    const classColor = classColors[index % classColors.length];
                    const statusColor = cls.has_schedule ? '#38a169' : '#e53e3e';
                    const statusIcon = cls.has_schedule ? '‚úÖ' : '‚ùå';
                    const statusText = cls.has_schedule ? 'Schema sparat' : 'Inget schema';

                    html += `
                        <div class="class-schedule-card" style="border: 2px solid ${classColor}; border-radius: 0.5rem; padding: 1rem; background: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                                <h5 style="margin: 0; color: ${classColor};">${cls.class_name}</h5>
                                <span style="color: ${statusColor}; font-weight: 600;">${statusIcon} ${statusText}</span>
                            </div>
                            
                            ${cls.has_schedule ? `
                                <div style="margin-bottom: 0.75rem;">
                                    <div style="font-size: 0.9rem; color: #4a5568;">
                                        üìö <strong>${cls.lesson_count}</strong> lektioner per vecka
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                    <button type="button" class="btn" onclick="viewClassScheduleDetails(${cls.class_id}, '${cls.class_name}')" 
                                            style="background: #4299e1; font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                        üëÅÔ∏è Visa
                                    </button>
                                    <button type="button" class="btn" onclick="editClassSchedule(${cls.class_id}, '${cls.class_name}')" 
                                            style="background: #ed8936; font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                        ‚úèÔ∏è Redigera
                                    </button>
                                    <button type="button" class="btn" onclick="resetSingleClassSchedule(${cls.class_id}, '${cls.class_name}')" 
                                            style="background: #f56565; font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                        üóëÔ∏è Rensa
                                    </button>
                                </div>
                            ` : `
                                <div style="color: #666; font-style: italic; margin-bottom: 0.75rem;">
                                    Inget schema har skapats f√∂r denna klass √§n.
                                </div>
                                <button type="button" class="btn" onclick="createScheduleForClass(${cls.class_id}, '${cls.class_name}')" 
                                        style="background: #48bb78; font-size: 0.8rem; padding: 0.25rem 0.5rem;">
                                    ‚ûï Skapa schema
                                </button>
                            `}
                        </div>
                    `;
                });

                html += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 1.5rem;">
                        <button type="button" class="btn" onclick="hideScheduleOverview()" style="background: #718096;">
                            ‚¨ÜÔ∏è D√∂lj √∂versikt
                        </button>
                    </div>
                `;

                overviewDiv.innerHTML = html;
                debugLog('All class schedules displayed');
            }




            async function viewAllClassSchedules() {
                try {
                    debugLog('Loading all class schedules...');
                    
                    // Show loading state
                    const overviewDiv = document.getElementById('scheduleOverview');
                    overviewDiv.style.display = 'block';
                    overviewDiv.innerHTML = '<div style="text-align: center;"><div class="loading-spinner"></div><p>Laddar scheman...</p></div>';

                    // Get status for all classes in school
                    const allClassIds = availableClasses.map(c => c.id);
                    const response = await fetch('/api/multi_class_schedule/status', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            class_ids: allClassIds
                        })
                    });

                    const result = await response.json();

                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte h√§mta scheman');
                    }

                    // Display overview
                    displayAllClassSchedules(result);
                    
                } catch (error) {
                    console.error('Error loading all schedules:', error);
                    const overviewDiv = document.getElementById('scheduleOverview');
                    overviewDiv.innerHTML = `<div style="color: #e53e3e; text-align: center;">Fel vid laddning: ${error.message}</div>`;
                }
            }




            async function resetClassSchedules() {
                if (selectedClasses.length === 0) {
                    alert('Inga klasser valda f√∂r rensning');
                    return;
                }

                // Check which classes have existing schedules
                const classesWithSchedule = [];
                const classesWithoutSchedule = [];
                
                for (const cls of selectedClasses) {
                    const status = scheduleSaveState.classScheduleStatus[cls.id];
                    if (status && status.has_schedule) {
                        classesWithSchedule.push(cls);
                    } else {
                        classesWithoutSchedule.push(cls);
                    }
                }

                if (classesWithSchedule.length === 0) {
                    alert('Inga av de valda klasserna har befintliga scheman att rensa');
                    return;
                }

                // Confirm reset
                let confirmMessage = `‚ö†Ô∏è VARNING: Detta kommer att permanent ta bort scheman f√∂r:\n\n`;
                classesWithSchedule.forEach(cls => {
                    const status = scheduleSaveState.classScheduleStatus[cls.id];
                    confirmMessage += `‚Ä¢ ${cls.name} (${status ? status.lesson_count : '?'} lektioner)\n`;
                });
                
                if (classesWithoutSchedule.length > 0) {
                    confirmMessage += `\nF√∂ljande klasser har inga befintliga scheman:\n`;
                    classesWithoutSchedule.forEach(cls => confirmMessage += `‚Ä¢ ${cls.name}\n`);
                }
                
                confirmMessage += `\n√Ñr du s√§ker p√• att du vill forts√§tta?`;

                if (!confirm(confirmMessage)) {
                    debugLog('Reset cancelled by user');
                    return;
                }

                try {
                    debugLog('Resetting class schedules...', {classes: classesWithSchedule.map(c => c.name)});

                    let totalDeleted = 0;
                    let resetResults = [];

                    // Reset each class individually
                    for (const cls of classesWithSchedule) {
                        const response = await fetch(`/api/class_schedule/reset/${cls.id}`, {
                            method: 'DELETE'
                        });

                        const result = await response.json();

                        if (response.ok && result.success) {
                            totalDeleted += result.deleted_lessons;
                            resetResults.push(`${cls.name}: ${result.deleted_lessons} lektioner`);
                            debugLog(`Reset successful for class ${cls.name}:`, result);
                        } else {
                            throw new Error(`Fel f√∂r ${cls.name}: ${result.error}`);
                        }
                    }

                    // Clear current schedule if it was for the reset classes
                    currentSchedule = null;
                    const preview = document.getElementById('schedulePreview');
                    preview.innerHTML = `
                        <div style="text-align: center; color: #38a169;">
                            <h3>‚úÖ Scheman rensade framg√•ngsrikt</h3>
                            <p><strong>Totalt ${totalDeleted} lektioner borttagna</strong></p>
                            <div style="margin-top: 1rem; text-align: left; display: inline-block;">
                                ${resetResults.map(r => `<div>üìö ${r}</div>`).join('')}
                            </div>
                            <p style="margin-top: 1.5rem;">Generera ett nytt schema f√∂r att forts√§tta.</p>
                        </div>
                    `;

                    // Hide generation controls
                    const controls = document.getElementById('generationControls');
                    if (controls) controls.style.display = 'none';

                    // Update status
                    await updateClassScheduleStatus();
                    
                    // Update save state
                    scheduleSaveState.hasUnsavedChanges = false;
                    scheduleSaveState.lastSavedSchedule = null;

                    showSuccessMessage(`‚úÖ Scheman rensade framg√•ngsrikt!\n\n${totalDeleted} lektioner borttagna fr√•n ${classesWithSchedule.length} klass${classesWithSchedule.length !== 1 ? 'er' : ''}.`);

                } catch (error) {
                    console.error('Error resetting schedules:', error);
                    alert(`‚ùå Fel vid rensning av scheman:\n${error.message}`);
                    debugLog('Reset failed:', error);
                }
            }


            function showSuccessMessage(message) {
                // Create simple success modal
                const modal = document.createElement('div');
                modal.style.cssText = `
                    position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                    background: rgba(0,0,0,0.5); z-index: 10000; 
                    display: flex; align-items: center; justify-content: center;
                `;

                const content = document.createElement('div');
                content.style.cssText = `
                    background: white; padding: 2rem; border-radius: 0.5rem; 
                    max-width: 500px; margin: 1rem; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                `;

                content.innerHTML = `
                    <div style="text-align: center;">
                        <div style="white-space: pre-line; margin-bottom: 1.5rem;">${message}</div>
                        <button onclick="this.closest('[style*=position]').remove()" 
                                style="background: #48bb78; color: white; padding: 0.5rem 1.5rem; 
                                    border: none; border-radius: 0.375rem; cursor: pointer;">
                            OK
                        </button>
                    </div>
                `;

                modal.appendChild(content);
                document.body.appendChild(modal);

                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (modal.parentNode) modal.remove();
                }, 5000);
            }


            document.addEventListener('DOMContentLoaded', function() {
                // Add event listener for page unload to warn about unsaved changes
                window.addEventListener('beforeunload', function(e) {
                    if (scheduleSaveState.hasUnsavedChanges) {
                        const message = 'Du har osparade √§ndringar i schemat. √Ñr du s√§ker p√• att du vill l√§mna sidan?';
                        e.returnValue = message;
                        return message;
                    }
                });
                
                // Update status after initial load
                setTimeout(() => {
                    if (selectedClasses.length > 0) {
                        updateClassScheduleStatus();
                    }
                }, 500);
            });


            const originalUpdateSelectedClasses = updateSelectedClasses;
            updateSelectedClasses = function() {
                // Call original function
                originalUpdateSelectedClasses();
                
                // Update status for newly selected classes
                setTimeout(() => {
                    updateClassScheduleStatus();
                }, 100);
            };



            const originalGenerateMultiClassSchedule = generateMultiClassSchedule;
            generateMultiClassSchedule = async function() {
                // Call original function
                await originalGenerateMultiClassSchedule();
                
                // Mark as having unsaved changes if generation was successful
                if (currentSchedule) {
                    markScheduleAsUnsaved();
                    await updateClassScheduleStatus();
                }
            };



            

            /**
             * Enter edit mode UI state
             */
            function enterEditMode(scheduleData) {
                // Update header to show edit mode
                const preview = document.getElementById('schedulePreview');
                if (preview) {
                    const editHeader = document.createElement('div');
                    editHeader.id = 'editModeHeader';
                    editHeader.className = 'edit-mode-header';
                    editHeader.style.cssText = `
                        background: linear-gradient(135deg, #ed8936, #f56565);
                        color: white;
                        padding: 1rem;
                        border-radius: 0.5rem;
                        margin-bottom: 1rem;
                        text-align: center;
                        font-weight: bold;
                        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    `;
                    editHeader.innerHTML = `
                        <div style="display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                            <span>‚úèÔ∏è REDIGERINGSL√ÑGE</span>
                            <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">
                                ${editingClassName}
                            </span>
                        </div>
                        <div style="font-size: 0.85rem; margin-top: 0.5rem; opacity: 0.9;">
                            Dra och sl√§pp lektioner f√∂r att flytta dem. R√∂da celler = konflikt.
                        </div>
                    `;
                    
                    // Insert before preview content
                    preview.insertBefore(editHeader, preview.firstChild);
                }
                
                // Hide class selection (already selected)
                const classContainer = document.getElementById('classesContainer');
                if (classContainer) {
                    classContainer.style.opacity = '0.5';
                    classContainer.style.pointerEvents = 'none';
                }
                
                // Disable subject configuration
                const subjectsContainer = document.getElementById('subjectsContainer');
                if (subjectsContainer) {
                    subjectsContainer.innerHTML = `
                        <div style="padding: 1rem; background: #f7fafc; border-radius: 0.5rem; border: 1px solid #e2e8f0; text-align: center; color: #4a5568;">
                            <strong>Redigeringsl√§ge:</strong> √Ñmnen och timmar best√§ms av befintligt schema
                        </div>
                    `;
                }
            }

            /**
             * Exit edit mode and return to normal state
             */
            function exitEditMode() {
                isEditMode = false;
                editingClassId = null;
                editingClassName = null;
                originalScheduleData = null;
                
                // Remove edit header
                const editHeader = document.getElementById('editModeHeader');
                if (editHeader) editHeader.remove();
                
                // Restore UI elements
                const classContainer = document.getElementById('classesContainer');
                if (classContainer) {
                    classContainer.style.opacity = '1';
                    classContainer.style.pointerEvents = 'auto';
                }
                
                // Restore subject configuration
                renderClassSubjectSections();
                
                // Clear preview
                const preview = document.getElementById('schedulePreview');
                preview.innerHTML = `
                    <div style="text-align: center;">
                        <p>V√§lj klasser och √§mnen f√∂r att generera ett multi-klass schema</p>
                    </div>
                `;
                
                // Hide controls
                document.getElementById('generationControls').style.display = 'none';
                
                debugLog('Edit mode exited');
            }

            /**
             * Display schedule in editable format with drag-and-drop
             */
            // 4. F√∂rb√§ttra displayEditableSchedule f√∂r att hantera lesson data korrekt
            // Uppdatera displayEditableSchedule f√∂r att anv√§nda riktiga lesson IDs
            function displayEditableSchedule(scheduleData) {
                const preview = document.getElementById('schedulePreview');
                
                // Build schedule grid with drag-and-drop support
                const weekdays = ['m√•ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'];
                const timeSlots = generateTimeSlots('08:00', '15:00', 60);
                
                // Store lesson data for lookup
                window.editModeLessons = {};
                
                let html = '<div style="overflow-x: auto;"><table class="editable-schedule-table" style="width: 100%; border-collapse: collapse; user-select: none;">';
                html += '<thead><tr><th style="min-width: 70px; padding: 8px; background: #f7fafc; border: 1px solid #e2e8f0;">Tid</th>';
                weekdays.forEach(day => {
                    html += `<th style="padding: 8px; background: #f7fafc; border: 1px solid #e2e8f0; text-align: center;">
                        ${day.charAt(0).toUpperCase() + day.slice(1)}
                    </th>`;
                });
                html += '</tr></thead><tbody>';
                
                // Build time slot rows
                timeSlots.forEach(timeSlot => {
                    html += `<tr><td style="padding: 8px; font-weight: 600; background: #f7fafc; border: 1px solid #e2e8f0;">${timeSlot}</td>`;
                    
                    weekdays.forEach(day => {
                        const lessons = scheduleData.lessons_by_day[day] || [];
                        const lesson = lessons.find(l => l.time === timeSlot);
                        
                        const cellId = `cell-${day}-${timeSlot.replace(':', '-')}`;
                        const isOccupied = lesson ? 'occupied' : 'empty';
                        
                        html += `<td id="${cellId}" 
                                    class="schedule-cell ${isOccupied}" 
                                    data-day="${day}" 
                                    data-time="${timeSlot}"
                                    ondrop="handleLessonDrop(event)" 
                                    ondragover="handleDragOver(event)"
                                    style="padding: 4px; border: 1px solid #e2e8f0; min-height: 60px; position: relative; vertical-align: top;">`;
                        
                        if (lesson) {
                            // Store lesson data for drag operations
                            window.editModeLessons[lesson.id] = lesson;
                            html += createEditableLessonBlock(lesson, day, timeSlot);
                        }
                        
                        html += '</td>';
                    });
                    
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                
                // Add existing edit header if present, then schedule
                const existingHeader = document.getElementById('editModeHeader');
                const headerHtml = existingHeader ? existingHeader.outerHTML : '';
                
                preview.innerHTML = headerHtml + html;
                
                debugLog('Editable schedule displayed with real lesson IDs');
            }


            /**
             * Create draggable lesson block for editing
             */
            // 1. Fix f√∂r createEditableLessonBlock - l√§gg till korrekt lesson ID
            // Uppdatera createEditableLessonBlock f√∂r att anv√§nda riktiga lesson IDs
            function createEditableLessonBlock(lesson, day, timeSlot) {
                const lessonId = lesson.id; // Use real database ID
                
                return `
                    <div id="lesson-${lessonId}" 
                        class="draggable-lesson" 
                        draggable="true"
                        ondragstart="handleLessonDragStart(event)"
                        ondragend="handleLessonDragEnd(event)"
                        data-lesson-id="${lessonId}"
                        data-subject="${lesson.subject}"
                        data-room="${lesson.room}"
                        data-original-day="${day}"
                        data-original-time="${timeSlot}"
                        style="
                            background: linear-gradient(135deg, #4299e1, #3182ce);
                            color: white;
                            padding: 8px;
                            border-radius: 6px;
                            cursor: move;
                            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                            transition: all 0.2s ease;
                            border: 2px solid transparent;
                        "
                        onmouseenter="this.style.transform='scale(1.02)'"
                        onmouseleave="this.style.transform='scale(1)'">
                        <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 2px;">
                            ${escapeHtml(lesson.subject)}
                        </div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">
                            ${escapeHtml(lesson.room || 'Inget rum')}
                        </div>
                        <div class="drag-handle" style="
                            position: absolute;
                            top: 2px;
                            right: 2px;
                            width: 12px;
                            height: 12px;
                            background: rgba(255,255,255,0.3);
                            border-radius: 2px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 8px;
                        ">‚ãÆ‚ãÆ</div>
                    </div>
                `;
            }

            /**
             * Handle drag start for lessons
             */
            // Add enhanced drag visual feedback
            function handleLessonDragStart(event) {
                draggedLesson = {
                    element: event.target,
                    lessonId: event.target.dataset.lessonId,
                    subject: event.target.dataset.subject,
                    room: event.target.dataset.room,
                    originalDay: event.target.dataset.originalDay,
                    originalTime: event.target.dataset.originalTime
                };
                
                event.target.style.opacity = '0.5';
                event.target.style.transform = 'rotate(5deg)';
                event.target.style.zIndex = '1000';
                
                // Add visual feedback to valid drop zones
                document.querySelectorAll('.schedule-cell').forEach(cell => {
                    if (!cell.classList.contains('occupied') || cell.contains(event.target)) {
                        cell.classList.add('drop-zone');
                        cell.style.background = 'rgba(66, 153, 225, 0.1)';
                        cell.style.border = '2px dashed #4299e1';
                    } else {
                        // Mark occupied cells as invalid
                        cell.style.background = 'rgba(245, 101, 101, 0.05)';
                        cell.style.border = '2px dashed #f56565';
                    }
                });
                
                debugLog('Enhanced drag started', draggedLesson);
            }

            /**
             * Handle drag end
             */
            function handleLessonDragEnd(event) {
                event.target.style.opacity = '1';
                event.target.style.transform = 'scale(1)';
                
                // Remove visual feedback
                document.querySelectorAll('.drop-zone').forEach(cell => {
                    cell.classList.remove('drop-zone');
                    cell.style.background = '';
                });
            }

            /**
             * Handle drag over for drop zones
             */
            function handleDragOver(event) {
                event.preventDefault();
                event.currentTarget.style.background = 'rgba(72, 187, 120, 0.2)';
            }

            /**
             * Handle lesson drop with conflict checking
             */
            async function handleLessonDrop(event) {
                event.preventDefault();
                event.currentTarget.style.background = '';
                
                if (!draggedLesson) return;
                
                const targetCell = event.currentTarget;
                const newDay = targetCell.dataset.day;
                const newTime = targetCell.dataset.time;
                const lessonElement = draggedLesson.element;
                
                // Check if dropping on same location
                if (newDay === draggedLesson.originalDay && newTime === draggedLesson.originalTime) {
                    debugLog('Dropped on same location, no action needed');
                    return;
                }
                
                // Check if target cell is already occupied by another lesson
                if (targetCell.classList.contains('occupied') && !targetCell.contains(lessonElement)) {
                    showConflictMessage('Den tiden √§r redan upptagen av en annan lektion');
                    return;
                }
                
                // Check for teacher and room conflicts
                const conflictCheck = await checkMoveConflicts(draggedLesson, newDay, newTime);
                if (!conflictCheck.canMove) {
                    showConflictMessage(conflictCheck.reason);
                    return;
                }
                
                // Perform the move
                try {
                    const moveResult = await moveLesson(draggedLesson.lessonId, newDay, newTime);
                    if (moveResult.success) {
                        // Update UI
                        performLessonMove(lessonElement, targetCell, newDay, newTime);
                        showSuccessToast(`Lektion flyttad till ${newDay} ${newTime}`);
                        
                        // Check for any new conflicts
                        setTimeout(checkScheduleConflicts, 100);
                        
                        debugLog('Lesson moved successfully', moveResult);
                    } else {
                        throw new Error(moveResult.error || 'Kunde inte flytta lektion');
                    }
                } catch (error) {
                    console.error('Error moving lesson:', error);
                    showConflictMessage(`Fel vid flyttning: ${error.message}`);
                }
                
                draggedLesson = null;
            }

            /**
             * Check for conflicts when moving a lesson
             */
            // 2. F√∂renkla conflict checking - ta bort API-anrop som inte finns
            // Uppdatera checkMoveConflicts funktionen

            function timeToMinutes(timeStr) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                return hours * 60 + (minutes || 0);
            }
            
            async function checkMoveConflicts(lesson, newDay, newTime) {
                // Parse the new time slot
                const [newStartTime, newEndTime] = newTime.split('-');
                const newStartMinutes = timeToMinutes(newStartTime);
                const newEndMinutes = timeToMinutes(newEndTime);
                
                const currentLessons = Array.from(document.querySelectorAll('.draggable-lesson')).map(lessonEl => {
                    const cell = lessonEl.closest('.schedule-cell');
                    const lessonTime = cell.dataset.time;
                    const [startTime, endTime] = lessonTime.split('-');
                    
                    return {
                        id: lessonEl.dataset.lessonId,
                        day: cell.dataset.day,
                        time: lessonTime,
                        startMinutes: timeToMinutes(startTime),
                        endMinutes: timeToMinutes(endTime),
                        subject: lessonEl.dataset.subject,
                        room: lessonEl.dataset.room
                    };
                });

                // Check for time overlaps instead of exact matches
                const overlappingLessons = currentLessons.filter(l => 
                    l.day === newDay && 
                    l.id !== lesson.lessonId &&
                    // Time overlap condition: newStart < lessonEnd AND newEnd > lessonStart
                    newStartMinutes < l.endMinutes && newEndMinutes > l.startMinutes
                );

                if (overlappingLessons.length > 0) {
                    const conflictDetails = overlappingLessons.map(l => 
                        `${l.subject} (${l.time})`
                    ).join(', ');
                    
                    return { 
                        canMove: false, 
                        reason: `Tidskonflikt med: ${conflictDetails}` 
                    };
                }

                return { canMove: true };
            }


            /**
             * Move lesson in database
             */
            // Uppdatera moveLesson funktionen f√∂r att anv√§nda riktig API
            async function moveLesson(lessonId, newDay, newTime) {
                try {
                    const [startTime, endTime] = newTime.split('-');
                    
                    const response = await fetch(`/api/schedule/move_lesson/${lessonId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            weekday: newDay,
                            start_time: startTime,
                            end_time: endTime
                        })
                    });

                    const result = await response.json();
                    
                    if (!response.ok || !result.success) {
                        throw new Error(result.error || 'Kunde inte flytta lektion');
                    }

                    return result;

                } catch (error) {
                    console.error('Error moving lesson:', error);
                    throw error;
                }
            }

            /**
             * Perform UI update after successful lesson move
             */
            function performLessonMove(lessonElement, targetCell, newDay, newTime) {
                // Remove from original location
                const originalCell = lessonElement.parentElement;
                originalCell.classList.remove('occupied');
                originalCell.classList.add('empty');
                
                // Add to new location
                targetCell.appendChild(lessonElement);
                targetCell.classList.add('occupied');
                targetCell.classList.remove('empty');
                
                // Update lesson data attributes
                lessonElement.dataset.originalDay = newDay;
                lessonElement.dataset.originalTime = newTime;
            }

            /**
             * Check and highlight schedule conflicts
             */
            // Enhanced conflict checking with real-time validation
            // 5. F√∂renkla konflikt-checking
            async function checkScheduleConflicts() {
                if (!isEditMode) return;
                
                // Clear existing conflict indicators
                document.querySelectorAll('.conflict-indicator').forEach(el => el.remove());
                document.querySelectorAll('.schedule-cell').forEach(cell => {
                    cell.classList.remove('has-conflict');
                    cell.style.background = '';
                });
                
                // Get all current lessons from the UI
                const currentLessons = Array.from(document.querySelectorAll('.draggable-lesson')).map(lessonEl => {
                    const cell = lessonEl.closest('.schedule-cell');
                    return {
                        id: lessonEl.dataset.lessonId,
                        day: cell.dataset.day,
                        time: cell.dataset.time,
                        subject: lessonEl.dataset.subject,
                        room: lessonEl.dataset.room
                    };
                });
                
                // Simple client-side conflict detection
                const roomConflicts = new Map();
                const timeConflicts = new Map();
                
                currentLessons.forEach(lesson => {
                    const timeKey = `${lesson.day}-${lesson.time}`;
                    const roomKey = `${lesson.room}-${timeKey}`;
                    
                    // Check for time conflicts (multiple lessons same time)
                    if (!timeConflicts.has(timeKey)) {
                        timeConflicts.set(timeKey, []);
                    }
                    timeConflicts.get(timeKey).push(lesson);
                    
                    // Check for room conflicts
                    if (!roomConflicts.has(roomKey)) {
                        roomConflicts.set(roomKey, []);
                    }
                    roomConflicts.get(roomKey).push(lesson);
                });
                
                // Mark conflicts
                roomConflicts.forEach((lessons, roomKey) => {
                    if (lessons.length > 1) {
                        lessons.forEach(lesson => {
                            const cell = document.getElementById(`cell-${lesson.day}-${lesson.time.replace(':', '-')}`);
                            if (cell) {
                                cell.classList.add('has-conflict');
                                
                                const indicator = document.createElement('div');
                                indicator.className = 'conflict-indicator';
                                indicator.style.cssText = `
                                    position: absolute;
                                    top: 2px;
                                    left: 2px;
                                    background: #f56565;
                                    color: white;
                                    font-size: 10px;
                                    padding: 2px 4px;
                                    border-radius: 2px;
                                    z-index: 100;
                                `;
                                indicator.textContent = '‚ö†Ô∏è';
                                indicator.title = `Konflikt: Flera lektioner anv√§nder samma rum (${lesson.room})`;
                                
                                cell.style.position = 'relative';
                                cell.appendChild(indicator);
                            }
                        });
                    }
                });
                
                debugLog('Client-side conflict check completed');
            }


            /**
             * Show conflict message to user
             */
            function showConflictMessage(message) {
                // Create temporary notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #f56565, #e53e3e);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 0.5rem;
                    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
                    z-index: 10000;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;
                notification.innerHTML = `‚ö†Ô∏è ${message}`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }

            /**
             * Show success toast message
             */
            function showSuccessToast(message) {
                const toast = document.createElement('div');
                toast.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: linear-gradient(135deg, #48bb78, #38a169);
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 0.5rem;
                    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                    z-index: 10000;
                    font-weight: 500;
                    animation: slideIn 0.3s ease-out;
                `;
                toast.innerHTML = `‚úÖ ${message}`;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease-in';
                    setTimeout(() => toast.remove(), 300);
                }, 2000);
            }

            /**
             * Update edit controls in generation panel
             */
            function updateEditControls() {
                const controls = document.getElementById('generationControls');
                if (!controls) return;
                
                // Replace normal controls with edit controls
                controls.innerHTML = `
                    <div class="edit-controls-header" style="margin-bottom: 1rem; padding: 1rem; background: #fef5e7; border-radius: 0.5rem; border-left: 4px solid #ed8936;">
                        <h4 style="margin: 0 0 0.5rem 0; color: #744210;">‚úèÔ∏è Redigeringsl√§ge aktiv</h4>
                        <p style="margin: 0; color: #744210; font-size: 0.9rem;">
                            Dra och sl√§pp lektioner f√∂r att flytta dem. Alla √§ndringar sparas automatiskt.
                        </p>
                    </div>
                    
                    <div class="schedule-actions" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button type="button" class="btn" onclick="saveEditedSchedule()" style="background: #48bb78;">
                            üíæ Spara √§ndringar
                        </button>
                        <button type="button" class="btn" onclick="discardScheduleChanges()" style="background: #f56565;">
                            ‚ùå Avbryt redigering
                        </button>
                        <button type="button" class="btn" onclick="reloadEditSchedule()" style="background: #4299e1;">
                            üîÑ Ladda om schema
                        </button>
                    </div>
                    
                    <div class="edit-info" style="margin-top: 1rem; padding: 0.75rem; background: #ebf8ff; border-radius: 0.375rem; font-size: 0.85rem; color: #2a4365;">
                        <strong>üí° Tips f√∂r redigering:</strong>
                        <ul style="margin: 0.5rem 0 0 1.5rem; padding: 0;">
                            <li>Dra lektioner till nya tider - systemet kollar automatiskt efter konflikter</li>
                            <li>R√∂da celler indikerar konflikter som m√•ste l√∂sas</li>
                            <li>L√§rare och klassrum kan inte dubbelbokas</li>
                        </ul>
                    </div>
                `;
            }


            // Enhanced initialization for edit mode
            document.addEventListener('DOMContentLoaded', function() {
                // Add global error handler for drag operations
                window.addEventListener('error', function(e) {
                    if (isEditMode && e.message.includes('drag')) {
                        console.error('Drag operation error:', e);
                        showConflictMessage('Fel vid drag-and-drop operation. Ladda om sidan om problemet kvarst√•r.');
                    }
                });
                
                // Add visibility change handler to prevent data loss
                document.addEventListener('visibilitychange', function() {
                    if (document.hidden && isEditMode && draggedLesson) {
                        // User switched tabs while dragging - reset drag state
                        draggedLesson = null;
                        document.querySelectorAll('.draggable-lesson').forEach(el => {
                            el.style.opacity = '1';
                            el.style.transform = 'scale(1)';
                        });
                        document.querySelectorAll('.drop-zone').forEach(el => {
                            el.classList.remove('drop-zone');
                            el.style.background = '';
                            el.style.border = '';
                        });
                    }
                });
            });


            // Add keyboard shortcuts for edit mode
            document.addEventListener('keydown', function(e) {
                if (!isEditMode) return;
                
                // Escape to exit edit mode
                if (e.key === 'Escape') {
                    e.preventDefault();
                    discardScheduleChanges();
                }
                
                // Ctrl+S to save in edit mode
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveEditedSchedule();
                }
                
                // Ctrl+Z for undo (reload from database)
                if (e.ctrlKey && e.key === 'z') {
                    e.preventDefault();
                    reloadEditSchedule();
                }
            });

            /**
             * Save edited schedule changes
             */
            // Enhanced save function for edited schedules
            // 6. F√∂renkla save-funktionen f√∂r editerat schema
            // Uppdatera saveEditedSchedule f√∂r att anv√§nda r√§tt API
            async function saveEditedSchedule() {
                if (!confirm('Spara alla √§ndringar i schemat?')) {
                    return;
                }
                
                const saveButton = event.target;
                const originalText = saveButton.textContent;
                saveButton.disabled = true;
                saveButton.textContent = 'üíæ Sparar...';
                
                try {
                    // F√∂r redigeringsl√§ge, spara direkt via database-uppdatering
                    // √Ñndringarna har redan gjorts via moveLesson API-anrop
                    
                    showSuccessToast('‚úÖ Alla √§ndringar sparade i databasen!');
                    debugLog('Schedule changes saved successfully');
                    
                    // Exit edit mode och visa uppdaterat schema
                    setTimeout(() => {
                        exitEditMode();
                        // Ladda om schemat fr√•n databasen f√∂r att visa uppdateringarna
                        if (editingClassId) {
                            editClassSchedule(editingClassId, editingClassName);
                        }
                    }, 1000);
                    
                } catch (error) {
                    console.error('Error saving edited schedule:', error);
                    showConflictMessage(`Fel vid sparning: ${error.message}`);
                } finally {
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
            }

            /**
             * Discard changes and exit edit mode
             */
            function discardScheduleChanges() {
                if (!confirm('Avbryt redigeringen och f√∂rlora alla √§ndringar?')) {
                    return;
                }
                
                exitEditMode();
                showSuccessToast('Redigering avbruten - inga √§ndringar sparade');
            }

            /**
             * Reload schedule from database
             */
            async function reloadEditSchedule() {
                if (!confirm('Ladda om schemat fr√•n databasen? Alla osparade √§ndringar g√•r f√∂rlorade.')) {
                    return;
                }
                
                try {
                    const response = await fetch(`/api/class_schedule/status/${editingClassId}`);
                    const result = await response.json();
                    
                    if (result.success) {
                        originalScheduleData = result;
                        displayEditableSchedule(result);
                        showSuccessToast('Schema laddat om fr√•n databasen');
                    } else {
                        throw new Error(result.error);
                    }
                    
                } catch (error) {
                    console.error('Error reloading schedule:', error);
                    showConflictMessage(`Fel vid laddning: ${error.message}`);
                }
            }

            // Add CSS animations for notifications
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
                
                .draggable-lesson:hover {
                    box-shadow: 0 4px 12px rgba(0,0,0,0.2) !important;
                }
                
                .schedule-cell.drop-zone {
                    border: 2px dashed #4299e1 !important;
                }
                
                .schedule-cell.has-conflict {
                    background: rgba(245, 101, 101, 0.1) !important;
                    border-color: #f56565 !important;
                }
            `;
            document.head.appendChild(style);

            async function saveMultiClassSchedule() {
                if (!currentSchedule || !currentSchedule.lessons) {
                    alert('Inget schema att spara');
                    debugLog('Save attempted with no schedule');
                    return;
                }

                if (selectedClasses.length === 0) {
                    alert('Inga klasser valda');
                    debugLog('Save attempted with no classes selected');
                    return;
                }

                // Confirm save action
                const confirmMessage = `Spara schema f√∂r ${selectedClasses.length} klass${selectedClasses.length !== 1 ? 'er' : ''}?\n\n` +
                    `Detta kommer att ers√§tta eventuella befintliga scheman f√∂r:\n${selectedClasses.map(c => `‚Ä¢ ${c.name}`).join('\n')}`;
                
                if (!confirm(confirmMessage)) {
                    debugLog('Save cancelled by user');
                    return;
                }




                // Show saving indicator
                const saveButton = document.querySelector('button[onclick="saveMultiClassSchedule()"]');
                const originalText = saveButton.textContent;
                saveButton.disabled = true;
                saveButton.textContent = 'üíæ Sparar...';

                try {
                    debugLog('Saving multi-class schedule...', {
                        classes: selectedClasses.length,
                        lessons: currentSchedule.lessons.length
                    });

                    const response = await fetch('/api/multi_class_schedule/save', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            schedule: currentSchedule,
                            class_ids: selectedClasses.map(c => parseInt(c.id))
                        })
                    });

                    const result = await response.json();

                    if (response.ok && result.success) {
                        // Update save state
                        scheduleSaveState.hasUnsavedChanges = false;
                        scheduleSaveState.lastSavedSchedule = JSON.parse(JSON.stringify(currentSchedule));
                        
                        // Update class status
                        await updateClassScheduleStatus();
                        
                        // Show success message
                        showSuccessMessage(`‚úÖ Schema sparat framg√•ngsrikt!\n\n` +
                            `üìä ${result.lessons_saved} lektioner sparade\n` +
                            `üè´ ${result.classes_updated} klasser uppdaterade\n` +
                            `${result.classes_deleted_lessons > 0 ? `üóëÔ∏è ${result.classes_deleted_lessons} gamla lektioner ersatta` : ''}`);
                        
                        debugLog('Schedule saved successfully:', result);

                        // Update UI to show saved state
                        updateScheduleUI();

                    } else {
                        throw new Error(result.error || 'Ok√§nt fel vid sparning');
                    }

                } catch (error) {
                    console.error('Error saving schedule:', error);
                    alert(`‚ùå Fel vid sparning av schema:\n${error.message}`);
                    debugLog('Save failed:', error);
                } finally {
                    // Restore button
                    saveButton.disabled = false;
                    saveButton.textContent = originalText;
                }
            }


            // Initiera n√§r sidan laddas
            document.addEventListener('DOMContentLoaded', function() {
                debugLog('Multi-class schedule generator loaded');
                validateSubjectHours();
            });
    </script>
</body>
</html>
