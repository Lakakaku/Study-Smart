<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Schemagenerator - {{ school.name if school else 'Ok√§nd skola' }}</title>
    <style>
        /* --- (Samma stil som innan, of√∂r√§ndrad) --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 {
            margin: 0;
            color: #2d3748;
            font-size: 1.8rem;
        }
        .back-btn {
            background: #718096;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            text-decoration: none;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .back-btn:hover {
            background: #4a5568;
        }
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        .generator-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .card h3 {
            margin-top: 0;
            color: #2d3748;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #4a5568;
        }
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
        }
        /* Multi-select klasser */
        .classes-container {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
            max-height: 200px;
            overflow-y: auto;
        }
        .class-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            border: 1px solid #e2e8f0;
        }
        .class-item:last-child {
            margin-bottom: 0;
        }
        .class-item input[type="checkbox"] {
            margin-right: 0.75rem;
            width: auto;
        }
        .class-item-info {
            flex: 1;
        }
        .class-name {
            font-weight: 600;
            color: #2d3748;
        }
        .class-details {
            font-size: 0.85rem;
            color: #718096;
        }
        .subjects-container {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
        }
        .class-subject-section {
            margin-bottom: 1rem;
        }
        .class-subject-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            gap: 0.5rem;
        }
        .subject-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.5rem;
        }
        .subject-item:last-child {
            margin-bottom: 0;
        }
        .subject-item input, .subject-item select {
            padding: 0.5rem;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
            width: 100%;
            box-sizing: border-box;
        }
        .add-subject-btn {
            background: #48bb78;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .add-subject-btn:hover {
            background: #38a169;
        }
        .remove-subject-btn {
            background: #f56565;
            color: white;
            padding: 0.25rem 0.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .remove-subject-btn:hover {
            background: #e53e3e;
        }
        .rooms-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .room-item {
            display: flex;
            align-items: center;
            background: #f7fafc;
            padding: 0.5rem;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .room-item input[type="checkbox"] {
            margin-right: 0.5rem;
            width: auto;
        }
        .constraints-section {
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            background: #f7fafc;
        }
        .constraint-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .constraint-item input[type="checkbox"] {
            margin-right: 0.5rem;
            width: auto;
        }
        .time-range {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        .lesson-duration-section {
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 6px;
            border-left: 4px solid #4299e1;
        }
        .btn {
            background: #4299e1;
            color: white;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: all 0.2s;
            font-weight: 600;
        }
        .btn:hover {
            background: #3182ce;
            transform: translateY(-1px);
        }
        .btn:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        .btn-generate {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 100%;
            justify-self: center;
        }
        .btn-generate:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }
        .schedule-preview {
            min-height: 400px;
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #718096;
            font-size: 1.1rem;
            position: relative;
            overflow-x: auto;
        }
        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 800px;
        }
        .schedule-table th {
            background: #4299e1;
            color: white;
            padding: 0.75rem;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .schedule-table td {
            padding: 0.5rem;
            border-bottom: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: middle;
            font-size: 0.85rem;
            min-width: 120px;
        }
        .schedule-table tr:hover {
            background: #f7fafc;
        }
        .lesson-cell {
            background: #ebf8ff;
            border-left: 3px solid #4299e1;
            font-size: 0.8rem;
            line-height: 1.1;
            text-align: left;
            padding: 0.4rem;
        }
        .lesson-subject {
            font-weight: 600;
            color: #2d3748;
            font-size: 0.8rem;
        }
        .lesson-class {
            color: #4299e1;
            font-size: 0.75rem;
            font-weight: 500;
        }
        .lesson-room {
            color: #718096;
            font-size: 0.7rem;
        }
        .empty-cell {
            color: #a0aec0;
            font-style: italic;
            font-size: 0.8rem;
        }
        .generation-controls {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4299e1;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .alert {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #f0fff4;
            color: #22543d;
            border-color: #38a169;
        }
        .alert-error {
            background: #fed7d7;
            color: #c53030;
            border-color: #e53e3e;
        }
        .alert-info {
            background: #ebf8ff;
            color: #2c5282;
            border-color: #4299e1;
        }
        .alert-warning {
            background: #fffbeb;
            color: #744210;
            border-color: #f59e0b;
        }
        .debug-info {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 1rem;
            font-size: 0.9rem;
            color: #4a5568;
        }
        .validation-warning {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            color: #744210;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 6px;
        }
        .selected-classes-info {
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 0.5rem;
            color: #234e52;
        }
        .class-color-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 0.5rem;
            vertical-align: middle;
        }
        @media (max-width: 1200px) {
            .generator-layout {
                grid-template-columns: 1fr;
            }
            .subject-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            .rooms-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üìÖ Multi-klass Schemagenerator - {{ school.name if school else 'Testskolan' }}</h1>
        <a href="#" class="back-btn">‚Üê Tillbaka till Dashboard</a>
    </div>

    <div class="container">
        <!-- Informationsbox om nya regler -->
        <div class="alert alert-info">
            <h4>üìã Multi-klass schemal√§ggningsregler</h4>
            <ul style="margin: 0.5rem 0;">
                <li><strong>5-minutersintervall:</strong> Lektioner kan starta var 5:e minut f√∂r flexibilitet</li>
                <li><strong>10-minuters paus:</strong> Minst 10 minuter mellan alla lektioner</li>
                <li><strong>Max 1 √§mne per dag per klass:</strong> Varje klass kan bara ha 1 lektion i samma √§mne per dag</li>
                <li><strong>Ingen klassrumskonflikt:</strong> Samma klassrum kan inte anv√§ndas samtidigt av flera klasser</li>
                <li><strong>Max 5 lektioner per √§mne:</strong> Per vecka och klass (1 per dag √ó 5 dagar)</li>
            </ul>
        </div>

        <div class="generator-layout">
            <!-- V√§nster sida - Inst√§llningar -->
            <div class="card">
                <h3>‚öôÔ∏è Multi-klass Schemainst√§llningar</h3>
                
                <form id="scheduleForm">
                    <!-- Klassval - Nu multi-select -->
                    <div class="form-group">
                        <label>V√§lj klasser (flera klasser till√•tet):</label>
                        <div class="classes-container" id="classesContainer">
                            {% if classes %}
                                {% for class in classes %}
                                    <div class="class-item">
                                        <input type="checkbox" name="class_ids[]" value="{{ class.id }}" id="class_{{ class.id }}" onchange="updateSelectedClasses()">
                                        <div class="class-item-info">
                                            <div class="class-name">{{ class.name }}</div>
                                            <div class="class-details">
                                                {{ class.users|length if class.users else 0 }} elever
                                                {% if class.year_level %} - √Örskurs {{ class.year_level }}{% endif %}
                                            </div>
                                        </div>
                                        <div class="class-color-indicator" style="background-color: {{ loop.cycle('#4299e1', '#48bb78', '#f56565', '#ed8936', '#9f7aea', '#38b2ac') }};"></div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div style="text-align: center; color: #666;">
                                    <p>Inga klasser tillg√§ngliga</p>
                                </div>
                            {% endif %}
                        </div>
                        <div class="selected-classes-info" id="selectedClassesInfo" style="display: none;">
                            <strong>Valda klasser:</strong> <span id="selectedClassesList"></span>
                        </div>
                    </div>

                    <!-- √Ñmnen och timmar per klass -->
                    <div class="form-group">
                        <label>√Ñmnen och timmar per vecka (per klass):</label>
                        <div class="validation-warning" id="subjectValidation" style="display: none;">
                            <strong>‚ö†Ô∏è Viktigt:</strong> Varje √§mne kan max ha 5 lektioner per vecka per klass (1 per dag).
                        </div>
                        <div class="subjects-container" id="subjectsContainer">
                            <div id="subjectsPlaceholder" style="color:#666;">
                                V√§lj en eller flera klasser till v√§nster f√∂r att ange √§mnen och timmar per klass.
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tillg√§ngliga klassrum:</label>
                        <div class="rooms-container">
                            {% if school and school.classrooms %}
                                {% set classrooms = school.classrooms | from_json %}
                                {% for classroom in classrooms %}
                                    <div class="room-item">
                                        <input type="checkbox" name="rooms[]" value="{{ classroom }}" id="room_{{ loop.index }}" checked>
                                        <label for="room_{{ loop.index }}">{{ classroom }}</label>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <!-- Fallback if no classrooms are defined -->
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal A" id="room_a" checked>
                                    <label for="room_a">Sal A</label>
                                </div>
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal B" id="room_b" checked>
                                    <label for="room_b">Sal B</label>
                                </div>
                                <div class="room-item">
                                    <input type="checkbox" name="rooms[]" value="Sal C" id="room_c" checked>
                                    <label for="room_c">Sal C</label>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Tidsinst√§llningar -->
                    <div class="form-group">
                        <label>Schema-begr√§nsningar:</label>
                        <div class="constraints-section">
                            <div class="constraint-item">
                                <input type="checkbox" id="balanced_days" name="constraints[]" value="balanced_days" checked>
                                <label for="balanced_days">J√§mn f√∂rdelning √∂ver veckan</label>
                            </div>
                            <div class="constraint-item">
                                <input type="checkbox" id="morning_priority" name="constraints[]" value="morning_priority">
                                <label for="morning_priority">Prioritera f√∂rmiddagstid</label>
                            </div>
                            <div class="constraint-item">
                                <input type="checkbox" id="no_room_conflicts" name="constraints[]" value="no_room_conflicts" checked disabled>
                                <label for="no_room_conflicts">F√∂rhindra klassrumskonflikter (automatiskt aktivt)</label>
                            </div>
                            
                            <div style="margin-top: 1rem;">
                                <label>Skoldagens timmar:</label>
                                <div class="time-range">
                                    <input type="time" name="start_time" value="08:00">
                                    <input type="time" name="end_time" value="15:00">
                                </div>
                            </div>

                            <!-- Lektionsl√§ngd sektion -->
                            <div class="lesson-duration-section">
                                <label for="lesson_duration">Lektionsl√§ngd (minuter):</label>
                                <select name="lesson_duration" id="lesson_duration">
                                    <option value="45">45 minuter</option>
                                    <option value="60" selected>60 minuter</option>
                                    <option value="90">90 minuter</option>
                                </select>
                                <p style="font-size: 0.85rem; margin-top: 0.5rem; color: #666;">
                                    üí° Multi-klass schema med automatisk klassrumshantering.
                                </p>
                            </div>
                        </div>
                    </div>

                    <button type="button" class="btn btn-generate" onclick="generateMultiClassSchedule()">
                        üé≤ Generera Multi-klass Schema
                    </button>
                </form>
                
                <!-- Debug info -->
                <div id="debugInfo" class="debug-info" style="display: none;">
                    <h4>Debug Information:</h4>
                    <div id="debugContent"></div>
                </div>
            </div>

            <!-- H√∂ger sida - Schemaf√∂rhandsvisning -->
            <div class="card">
                <h3>üìã Multi-klass Schemaf√∂rhandsvisning</h3>

                <div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.75rem;">
                    <label for="classFilter" style="margin:0; font-weight:600; color:#4a5568;">Visa:</label>
                    <select id="classFilter" onchange="onClassFilterChange()" style="padding:0.5rem; border-radius:6px; border:1px solid #e2e8f0;">
                        <option value="all">Alla klasser</option>
                        <!-- Options will be populated av JS -->
                    </select>
                </div>



                
                <div class="schedule-preview" id="schedulePreview">
                    <div style="text-align: center;">
                        <p>V√§lj klasser och √§mnen f√∂r att generera ett multi-klass schema</p>
                        <p style="color: #a0aec0; font-size: 0.9rem;">
                            Multi-klass schema f√∂ljer:<br>
                            ‚Ä¢ Automatisk klassrumshantering<br>
                            ‚Ä¢ Max 1 √§mne per dag per klass<br>
                            ‚Ä¢ 5-minutersintervall med 10-min paus
                        </p>
                    </div>
                </div>

                <div class="generation-controls" id="generationControls" style="display: none;">
                    <button type="button" class="btn" onclick="generateMultiClassSchedule()">üîÑ Generera nytt</button>
                    <button type="button" class="btn" style="background: #48bb78;" onclick="saveMultiClassSchedule()">üíæ Spara schema</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSchedule = null;
        let availableSubjects = {{ available_subjects | tojson }};
        let availableClasses = {{ classes | tojson }};
        let selectedClasses = [];

        // Class colors for visual distinction
        const classColors = ['#4299e1', '#48bb78', '#f56565', '#ed8936', '#9f7aea', '#38b2ac', '#ec407a', '#26c6da', '#ab47bc', '#66bb6a'];

        // Debug flag
        const DEBUG = true;

        function debugLog(message, data = null) {
            if (DEBUG) {
                console.log(`[MULTI-CLASS SCHEDULE DEBUG] ${message}`, data);
                
                const debugInfo = document.getElementById('debugInfo');
                const debugContent = document.getElementById('debugContent');
                
                debugInfo.style.display = 'block';
                debugContent.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${message}</div>`;
                if (data) {
                    debugContent.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
            }
        }

        function updateSelectedClasses() {
            const checkboxes = document.querySelectorAll('input[name="class_ids[]"]:checked');
            const infoDiv = document.getElementById('selectedClassesInfo');
            const listSpan = document.getElementById('selectedClassesList');
            
            // Build selectedClasses anew
            const tempSelected = Array.from(checkboxes).map(cb => {
                const classId = cb.value;
                const classData = availableClasses.find(c => c.id == classId);
                return {
                    id: classId,
                    name: classData ? classData.name : `Klass ${classId}`
                };
            });

            selectedClasses = tempSelected;

            if (selectedClasses.length > 0) {
                infoDiv.style.display = 'block';
                listSpan.innerHTML = selectedClasses.map((cls, index) => 
                    `<span style="color: ${classColors[index % classColors.length]};">‚óè</span> ${cls.name}`
                ).join(', ');
                debugLog('Selected classes updated:', selectedClasses);
            } else {
                infoDiv.style.display = 'none';
                debugLog('No classes selected');
            }

            // Re-render per-class subject sections
            renderClassSubjectSections();
        }

        function renderClassSubjectSections() {
            const container = document.getElementById('subjectsContainer');
            const placeholder = document.getElementById('subjectsPlaceholder');
            container.innerHTML = ''; // clear

            if (selectedClasses.length === 0) {
                placeholder && container.appendChild(placeholder);
                return;
            }

            // For each selected class, create a section
            selectedClasses.forEach((cls, idx) => {
                const section = document.createElement('div');
                section.className = 'class-subject-section';
                section.id = `class_subjects_${cls.id}`;
                section.setAttribute('data-class-id', cls.id);

                const header = document.createElement('div');
                header.className = 'class-subject-header';
                header.innerHTML = `
                    <div style="display:flex; align-items:center; gap:0.5rem;">
                        <span class="class-color-indicator" style="background:${classColors[idx % classColors.length]}"></span>
                        <strong>${cls.name}</strong>
                        <span style="color:#718096; font-size:0.9rem; margin-left:0.5rem;">(Ange √§mnen & timmar f√∂r denna klass)</span>
                    </div>
                    <div>
                        <button type="button" class="add-subject-btn" onclick="addSubjectForClass('${cls.id}')">+ L√§gg till √§mne</button>
                    </div>
                `;
                section.appendChild(header);

                const list = document.createElement('div');
                list.className = 'class-subject-list';
                list.id = `class_subject_list_${cls.id}`;

                // Add initial subject row
                const subjectRow = createSubjectItem(cls.id);
                list.appendChild(subjectRow);

                section.appendChild(list);
                container.appendChild(section);
            });

            // Re-validate subjects UI
            validateSubjectHours();
        }



        function populateClassFilter() {
            const sel = document.getElementById('classFilter');
            if (!sel) return;
            // Rensa utom 'Alla'
            sel.querySelectorAll('option[data-generated]').forEach(o => o.remove());
            // L√§gg till klasser fr√•n availableClasses
            availableClasses.forEach(cls => {
                const opt = document.createElement('option');
                opt.value = cls.id;
                opt.textContent = cls.name;
                opt.setAttribute('data-generated', '1');
                sel.appendChild(opt);
            });
        }

        function onClassFilterChange() {
            const sel = document.getElementById('classFilter');
            if (!sel) return;
            const selected = sel.value; // 'all' eller classId
            // Om det finns ett genererat schema, rendera om med filter
            if (currentSchedule) {
                displayMultiClassSchedule(currentSchedule, selected === 'all' ? null : selected);
            }
        }



        function createSubjectItem(classId) {
            // Create a subject-row element for classId
            const item = document.createElement('div');
            item.className = 'subject-item';

            let optionsHtml = '<option value="">V√§lj √§mne...</option>';
            availableSubjects.forEach(subject => {
                optionsHtml += `<option value="${subject.id}">${subject.name}</option>`;
            });

            // Note: name attributes include class id so they are per-class
            item.innerHTML = `
                <select name="subjects_${classId}[]" required onchange="validateSubjectHours()">
                    ${optionsHtml}
                </select>
                <input type="number" name="hours_${classId}[]" min="1" max="5" placeholder="Timmar/vecka (max 5)" required onchange="validateSubjectHours()">
                <button type="button" class="remove-subject-btn" onclick="removeSubject(this)">Ta bort</button>
            `;

            return item;
        }

        function addSubjectForClass(classId) {
            const list = document.getElementById(`class_subject_list_${classId}`);
            if (!list) return;
            const newRow = createSubjectItem(classId);
            list.appendChild(newRow);
            debugLog(`Added subject row for class ${classId}`);
        }

        function removeSubject(button) {
            const list = button.parentElement.parentElement; // .class-subject-list or just parent
            const sectionList = list.classList && list.classList.contains('class-subject-list') ? list : button.parentElement.parentElement;
            // Try to find the sibling rows to ensure at least one remains per class
            const container = button.closest('.class-subject-section');
            if (!container) return;
            const rows = container.querySelectorAll('.subject-item');
            if (rows.length > 1) {
                button.parentElement.remove();
                validateSubjectHours();
                debugLog('Removed subject row', {classSection: container.id});
            } else {
                // Don't allow removing last row
                alert('Minst ett √§mne m√•ste finnas per klass. L√§gg till ett annat √§mne f√∂rst om du vill ta bort detta.');
                debugLog('Attempted to remove last subject row - blocked');
            }
        }

        function validateSubjectHours() {
            const allHourInputs = document.querySelectorAll('input[type="number"][name^="hours_"]');
            const validationWarning = document.getElementById('subjectValidation');
            let hasViolation = false;

            allHourInputs.forEach(input => {
                const value = parseInt(input.value);
                if (value > 5) {
                    hasViolation = true;
                    input.style.borderColor = '#e53e3e';
                    input.style.backgroundColor = '#fed7d7';
                } else {
                    input.style.borderColor = '#e2e8f0';
                    input.style.backgroundColor = 'white';
                }
            });

            if (hasViolation) {
                validationWarning.style.display = 'block';
            } else {
                validationWarning.style.display = 'none';
            }
        }

        function getAvailableRooms() {
            const roomCheckboxes = document.querySelectorAll('input[name="rooms[]"]:checked');
            const rooms = [];
            roomCheckboxes.forEach(checkbox => {
                rooms.push(checkbox.value);
            });
            return rooms;
        }






        // --- Klistra in denna funktion i din scriptsektion (funktion-deklaration, allts√• hoistas) ---
        function generateMultiClassScheduleWithConstraints(classes, classSubjectMap, rooms, startTime, endTime, lessonDuration) {
            debugLog('Generating multi-class schedule with constraints:', {
                classes: classes.length, 
                classSubjectMap, 
                rooms: rooms.length, 
                startTime, 
                endTime, 
                lessonDuration
            });

            const actualRooms = (rooms && rooms.length) ? rooms : getAvailableRooms();
            if (!actualRooms || actualRooms.length === 0) {
                throw new Error('Inga klassrum valda. V√§lj minst ett klassrum.');
            }

            const weekdays = ['m√•ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'];
            const timeSlots = generateTimeSlots(startTime || '08:00', endTime || '15:00', lessonDuration);
            const allLessons = [];

            // Skapa √§mnesplan f√∂r varje klass baserat p√• classSubjectMap
            const classSubjectPlans = {};
            let totalLessonsNeeded = 0;
            
            classes.forEach(classInfo => {
                const cid = classInfo.id;
                classSubjectPlans[cid] = [];

                const items = classSubjectMap[cid] || [];
                items.forEach(item => {
                    const subjectId = item.subject_id;
                    const subjectName = availableSubjects.find(s => s.id == subjectId)?.name || `√Ñmne ${subjectId}`;
                    const hoursPerWeek = parseInt(item.hours);

                    if (hoursPerWeek > 5) {
                        throw new Error(`√Ñmnet "${subjectName}" f√∂r klass ${classInfo.name} har ${hoursPerWeek} lektioner, men max 5 √§r till√•tet (1 per dag)`);
                    }

                    for (let h = 0; h < hoursPerWeek; h++) {
                        classSubjectPlans[cid].push({
                            class_id: classInfo.id,
                            class_name: classInfo.name,
                            subject_id: subjectId,
                            subject_name: subjectName,
                            color: classInfo.color || classColors[Math.floor(Math.random() * classColors.length)]
                        });
                        totalLessonsNeeded++;
                    }
                });
            });

            debugLog('Subject plans created per class:', {classSubjectPlans, totalLessonsNeeded});

            // Globala schemastrukturer f√∂r konflikthantering
            const globalSchedule = {};
            const roomOccupancy = {}; // Sp√•rar vilka rum som √§r upptagna n√§r
            const classSubjectsByDay = {}; // Sp√•rar vilka √§mnen varje klass har per dag
            
            // Initiera strukturer
            weekdays.forEach(day => {
                globalSchedule[day] = [];
                roomOccupancy[day] = {};
                classSubjectsByDay[day] = {};
                
                classes.forEach(classInfo => {
                    classSubjectsByDay[day][classInfo.id] = new Set();
                });
                
                timeSlots.forEach(slot => {
                    roomOccupancy[day][slot] = new Set(); // Vilka rum som √§r upptagna under denna tid
                });
            });

            // Placera lektioner f√∂r alla klasser samtidigt
            const allLessonsToPlace = [];
            Object.keys(classSubjectPlans).forEach(classId => {
                classSubjectPlans[classId].forEach(lesson => {
                    allLessonsToPlace.push(lesson);
                });
            });

            // Randomisera f√∂r b√§ttre f√∂rdelning
            allLessonsToPlace.sort(() => Math.random() - 0.5);

            debugLog('Starting lesson placement for all classes...', {totalLessons: allLessonsToPlace.length});

            let placedLessons = 0;
            for (const lesson of allLessonsToPlace) {
                let placed = false;
                let attempts = 0;
                const maxAttempts = 200;

                while (!placed && attempts < maxAttempts) {
                    // V√§lj dag som inte redan har detta √§mne f√∂r denna klass
                    const availableDays = weekdays.filter(day => 
                        !classSubjectsByDay[day][lesson.class_id].has(lesson.subject_name)
                    );
                    
                    if (availableDays.length === 0) {
                        throw new Error(`Kan inte placera fler lektioner i ${lesson.subject_name} f√∂r klass ${lesson.class_name} - alla dagar upptagna`);
                    }

                    // Prioritera dagar med f√§rre lektioner f√∂r denna klass
                    availableDays.sort((a, b) => {
                        const aCount = globalSchedule[a].filter(l => l.class_id === lesson.class_id).length;
                        const bCount = globalSchedule[b].filter(l => l.class_id === lesson.class_id).length;
                        return aCount - bCount;
                    });
                    
                    const day = availableDays[0];

                    // Hitta tillg√§ngliga tidsluckor
                    const availableSlots = findAvailableTimeSlotsForClass(
                        globalSchedule[day], lesson.class_id, timeSlots, 10
                    );
                    
                    if (availableSlots.length > 0) {
                        // F√∂rs√∂k hitta ett ledigt klassrum f√∂r varje tillg√§nglig tidslucka
                        let roomFound = false;
                        
                        for (const timeSlot of availableSlots) {
                            const occupiedRooms = roomOccupancy[day][timeSlot];
                            const availableRooms = actualRooms.filter(room => !occupiedRooms.has(room));
                            
                            if (availableRooms.length > 0) {
                                const selectedRoom = availableRooms[Math.floor(Math.random() * availableRooms.length)];
                                
                                const lessonData = {
                                    day: day,
                                    time: timeSlot,
                                    class_id: lesson.class_id,
                                    class_name: lesson.class_name,
                                    subject_id: lesson.subject_id,
                                    subject_name: lesson.subject_name,
                                    room: selectedRoom,
                                    color: lesson.color,
                                    start_minutes: timeToMinutes(timeSlot.split('-')[0])
                                };

                                // Placera lektionen
                                globalSchedule[day].push(lessonData);
                                roomOccupancy[day][timeSlot].add(selectedRoom);
                                classSubjectsByDay[day][lesson.class_id].add(lesson.subject_name);
                                allLessons.push(lessonData);
                                
                                placed = true;
                                placedLessons++;
                                roomFound = true;

                                debugLog(`Placed lesson ${placedLessons}/${allLessonsToPlace.length}: ${lesson.class_name} - ${lesson.subject_name} on ${day} at ${timeSlot} in ${selectedRoom}`);
                                break;
                            }
                        }
                        
                        if (!roomFound) {
                            debugLog(`No available rooms found for ${lesson.class_name} - ${lesson.subject_name} on ${day}`);
                        }
                    }

                    attempts++;
                }

                if (!placed) {
                    throw new Error(`Kunde inte placera lektion i ${lesson.subject_name} f√∂r klass ${lesson.class_name} efter ${maxAttempts} f√∂rs√∂k. F√∂rs√∂k med fler klassrum eller f√§rre klasser.`);
                }
            }

            // Rensa hj√§lpdata
            allLessons.forEach(lesson => {
                delete lesson.start_minutes;
            });

            debugLog('Multi-class lesson placement completed:', {
                totalPlaced: placedLessons,
                totalNeeded: allLessonsToPlace.length
            });

            return {
                lessons: allLessons,
                time_slots: timeSlots,
                classes: classes,
                stats: {
                    total_lessons: allLessons.length,
                    lessons_per_class: classes.reduce((acc, cls) => {
                        acc[cls.name] = allLessons.filter(l => l.class_id === cls.id).length;
                        return acc;
                    }, {}),
                    rooms_used: [...new Set(allLessons.map(l => l.room))],
                    balance_score: calculateMultiClassBalanceScore(globalSchedule, classes),
                    room_conflicts: checkRoomConflicts(allLessons),
                    constraint_violations: validateMultiClassConstraints(globalSchedule, classes)
                }
            };
        }
        // --- Slut p√• funktionen ---


        async function generateMultiClassSchedule() {
            // Uppdatera selected classes och UI
            updateSelectedClasses();

            const preview = document.getElementById('schedulePreview');
            const controls = document.getElementById('generationControls');

            if (selectedClasses.length === 0) {
                alert('V√§lj minst en klass!');
                debugLog('Validation failed: No classes selected');
                return;
            }

            // Bygg per-klass √§mneskartor
            const classSubjectMap = {}; // classId -> [{subject_id, hours}, ...]
            for (const cls of selectedClasses) {
                const classId = cls.id;
                const container = document.getElementById(`class_subjects_${classId}`);
                if (!container) {
                    alert(`Ingen √§mnessektion hittades f√∂r klass ${cls.name}.`);
                    debugLog('Validation failed: missing class subject container', {class: cls});
                    return;
                }

                const rows = Array.from(container.querySelectorAll('.subject-item'));
                if (rows.length === 0) {
                    alert(`Ingen √§mneskonfiguration f√∂r klass ${cls.name}. Ange minst ett √§mne.`);
                    debugLog('Validation failed: No subject rows for class', {class: cls});
                    return;
                }

                const items = [];
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const subjSelect = row.querySelector('select');
                    const hourInput = row.querySelector('input[type="number"]');

                    const subjVal = subjSelect ? subjSelect.value.trim() : '';
                    const hrsValRaw = hourInput ? hourInput.value.trim() : '';
                    const hrsVal = hrsValRaw === '' ? NaN : parseInt(hrsValRaw, 10);

                    if (!subjVal) {
                        alert(`V√§lj √§mne i alla rader f√∂r klass ${cls.name}`);
                        debugLog('Validation failed: empty subject row', {class: cls, index: i});
                        return;
                    }
                    if (isNaN(hrsVal) || hrsVal <= 0) {
                        alert(`Ange giltigt antal timmar f√∂r √§mnet i klass ${cls.name}`);
                        debugLog('Validation failed: invalid hours', {class: cls, index: i, hours: hrsValRaw});
                        return;
                    }
                    if (hrsVal > 5) {
                        alert(`Max 5 lektioner per vecka per √§mne. Du angav ${hrsVal} f√∂r √§mnet i klass ${cls.name}`);
                        debugLog('Validation failed: hours > 5', {class: cls, hours: hrsVal});
                        return;
                    }

                    items.push({ subject_id: subjVal, hours: hrsVal });
                }

                classSubjectMap[classId] = items;
            }

            const rooms = getAvailableRooms();
            const maxSimultaneousClasses = selectedClasses.length;
            if (rooms.length < maxSimultaneousClasses) {
                const proceed = confirm(
                    `Du har valt ${maxSimultaneousClasses} klasser men bara ${rooms.length} klassrum. ` +
                    `Detta kan orsaka schemal√§ggningsproblem n√§r klasser har lektioner samtidigt. Forts√§tt √§nd√•?`
                );
                if (!proceed) {
                    debugLog('User cancelled due to insufficient rooms');
                    return;
                }
            }

            debugLog('Multi-class validation passed, generating schedule...', {
                classes: selectedClasses.length,
                classSubjectMap,
                rooms: rooms.length
            });

            // Visa loading
            preview.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem;">Genererar multi-klass schema...</p>
                    <p style="font-size: 0.9rem; color: #666;">
                        Schemal√§ggning f√∂r ${selectedClasses.length} klasser med klassrumshantering
                    </p>
                    <p style="font-size: 0.85rem; color: #888;">
                        F√∂ljer: Ingen klassrumskonflikt, max 1 √§mne/dag per klass, 5-min intervall
                    </p>
                </div>
            `;

            try {
                const form = document.getElementById('scheduleForm');
                const formData = new FormData(form);
                const lessonDuration = parseInt(formData.get('lesson_duration') || '60');
                const multiClassSchedule = generateMultiClassScheduleWithConstraints(
                    selectedClasses, classSubjectMap, rooms, 
                    formData.get('start_time'), formData.get('end_time'), lessonDuration
                );

                setTimeout(() => {
                    debugLog('Multi-class schedule generated successfully', multiClassSchedule);
                    currentSchedule = multiClassSchedule;
                    displayMultiClassSchedule(multiClassSchedule);
                    controls.style.display = 'flex';
                }, 1000);

            } catch (error) {
                debugLog('Error generating multi-class schedule:', error);
                console.error('Error generating multi-class schedule:', error);
                preview.innerHTML = `
                    <div style="text-align: center; color: #e53e3e;">
                        <p>‚ùå Fel vid multi-klass schemagenerering</p>
                        <p style="font-size: 0.9rem;">${error.message}</p>
                        <p style="font-size: 0.85rem; color: #666;">
                            Tips: Minska antalet lektioner, √∂ka antalet klassrum, eller minska antalet klasser
                        </p>
                    </div>
                `;
                controls.style.display = 'none';
            }
        }

        async function generateMultiClassSchedule() {
            // OBS: anropa INTE updateSelectedClasses() h√§r ‚Äî det √•ter-renderar √§mnessektionerna och nollst√§ller anv√§ndarens val.
            // Ist√§llet: l√§s direkt vilka klasser som √§r ikryssade (men undvik att re-rendera UI).
            const preview = document.getElementById('schedulePreview');
            const controls = document.getElementById('generationControls');

            // S√§kerst√§ll att selectedClasses speglar DOM om anv√§ndaren inte redan √§ndrat det via checkbox onchange
            const checkedBoxes = Array.from(document.querySelectorAll('input[name="class_ids[]"]:checked'));
            if (checkedBoxes.length > 0) {
                selectedClasses = checkedBoxes.map(cb => {
                    const classId = cb.value;
                    const classData = availableClasses.find(c => c.id == classId);
                    return {
                        id: classId,
                        name: classData ? classData.name : `Klass ${classId}`
                    };
                });
            }

            if (selectedClasses.length === 0) {
                alert('V√§lj minst en klass!');
                debugLog('Validation failed: No classes selected');
                return;
            }

            // Bygg per-klass √§mneskartor (robust: g√•r igenom varje .subject-item f√∂r respektive klass)
            const classSubjectMap = {}; // classId -> [{subject_id, hours}, ...]
            for (const cls of selectedClasses) {
                const classId = cls.id;
                const container = document.getElementById(`class_subjects_${classId}`);
                if (!container) {
                    alert(`Ingen √§mnessektion hittades f√∂r klass ${cls.name}.`);
                    debugLog('Validation failed: missing class subject container', {class: cls});
                    return;
                }

                const rows = Array.from(container.querySelectorAll('.subject-item'));
                if (rows.length === 0) {
                    alert(`Ingen √§mneskonfiguration f√∂r klass ${cls.name}. Ange minst ett √§mne.`);
                    debugLog('Validation failed: No subject rows for class', {class: cls});
                    return;
                }

                const items = [];
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    const subjSelect = row.querySelector('select');
                    const hourInput = row.querySelector('input[type="number"]');

                    const subjVal = subjSelect ? subjSelect.value.trim() : '';
                    const hrsValRaw = hourInput ? hourInput.value.trim() : '';
                    const hrsVal = hrsValRaw === '' ? NaN : parseInt(hrsValRaw, 10);

                    if (!subjVal) {
                        alert(`V√§lj √§mne i alla rader f√∂r klass ${cls.name}`);
                        debugLog('Validation failed: empty subject row', {class: cls, index: i});
                        return;
                    }
                    if (isNaN(hrsVal) || hrsVal <= 0) {
                        alert(`Ange giltigt antal timmar f√∂r √§mnet i klass ${cls.name}`);
                        debugLog('Validation failed: invalid hours', {class: cls, index: i, hours: hrsValRaw});
                        return;
                    }
                    if (hrsVal > 5) {
                        alert(`Max 5 lektioner per vecka per √§mne. Du angav ${hrsVal} f√∂r √§mnet i klass ${cls.name}`);
                        debugLog('Validation failed: hours > 5', {class: cls, hours: hrsVal});
                        return;
                    }

                    items.push({ subject_id: subjVal, hours: hrsVal });
                }

                classSubjectMap[classId] = items;
            }

            const rooms = getAvailableRooms();
            const maxSimultaneousClasses = selectedClasses.length;
            if (rooms.length < maxSimultaneousClasses) {
                const proceed = confirm(
                    `Du har valt ${maxSimultaneousClasses} klasser men bara ${rooms.length} klassrum. ` +
                    `Detta kan orsaka schemal√§ggningsproblem n√§r klasser har lektioner samtidigt. Forts√§tt √§nd√•?`
                );
                if (!proceed) {
                    debugLog('User cancelled due to insufficient rooms');
                    return;
                }
            }

            debugLog('Multi-class validation passed, generating schedule...', {
                classes: selectedClasses.length,
                classSubjectMap,
                rooms: rooms.length
            });

            // Visa loading
            preview.innerHTML = `
                <div style="text-align: center;">
                    <div class="loading-spinner"></div>
                    <p style="margin-top: 1rem;">Genererar multi-klass schema...</p>
                    <p style="font-size: 0.9rem; color: #666;">
                        Schemal√§ggning f√∂r ${selectedClasses.length} klasser med klassrumshantering
                    </p>
                    <p style="font-size: 0.85rem; color: #888;">
                        F√∂ljer: Ingen klassrumskonflikt, max 1 √§mne/dag per klass, 5-min intervall
                    </p>
                </div>
            `;

            try {
                const form = document.getElementById('scheduleForm');
                const formData = new FormData(form);
                const lessonDuration = parseInt(formData.get('lesson_duration') || '60');
                const multiClassSchedule = generateMultiClassScheduleWithConstraints(
                    selectedClasses, classSubjectMap, rooms, 
                    formData.get('start_time'), formData.get('end_time'), lessonDuration
                );

                setTimeout(() => {
                    debugLog('Multi-class schedule generated successfully', multiClassSchedule);
                    currentSchedule = multiClassSchedule;
                    // om anv√§ndaren redan valt ett filter, anv√§nd det:
                    const sel = document.getElementById('classFilter');
                    const selectedFilter = sel && sel.value !== 'all' ? sel.value : null;
                    displayMultiClassSchedule(currentSchedule, selectedFilter);
                    controls.style.display = 'flex';
                    displayMultiClassSchedule(multiClassSchedule);
                    controls.style.display = 'flex';
                }, 1000);

            } catch (error) {
                debugLog('Error generating multi-class schedule:', error);
                console.error('Error generating multi-class schedule:', error);
                preview.innerHTML = `
                    <div style="text-align: center; color: #e53e3e;">
                        <p>‚ùå Fel vid multi-klass schemagenerering</p>
                        <p style="font-size: 0.9rem;">${error.message}</p>
                        <p style="font-size: 0.85rem; color: #666;">
                            Tips: Minska antalet lektioner, √∂ka antalet klassrum, eller minska antalet klasser
                        </p>
                    </div>
                `;
                controls.style.display = 'none';
            }
        }


        function findAvailableTimeSlotsForClass(daySchedule, classId, allTimeSlots, minBreakMinutes) {
            const availableSlots = [];
            const classLessons = daySchedule.filter(lesson => lesson.class_id === classId);
            
            for (const timeSlot of allTimeSlots) {
                const [startTime, endTime] = timeSlot.split('-');
                const startMinutes = timeToMinutes(startTime);
                const endMinutes = timeToMinutes(endTime);
                
                let canPlace = true;
                
                // Kontrollera mot denna klass befintliga lektioner
                for (const existingLesson of classLessons) {
                    const [existingStart, existingEnd] = existingLesson.time.split('-');
                    const existingStartMinutes = timeToMinutes(existingStart);
                    const existingEndMinutes = timeToMinutes(existingEnd);
                    
                    // Kontrollera √∂verlappning och paus
                    if (!(endMinutes + minBreakMinutes <= existingStartMinutes || 
                          startMinutes >= existingEndMinutes + minBreakMinutes)) {
                        canPlace = false;
                        break;
                    }
                }
                
                if (canPlace) {
                    availableSlots.push(timeSlot);
                }
            }
            
            return availableSlots;
        }

        function checkRoomConflicts(lessons) {
            const conflicts = [];
            
            // Gruppera lektioner efter dag och tid
            const lessonsByDayTime = {};
            lessons.forEach(lesson => {
                const key = `${lesson.day}-${lesson.time}`;
                if (!lessonsByDayTime[key]) {
                    lessonsByDayTime[key] = [];
                }
                lessonsByDayTime[key].push(lesson);
            });
            
            // Kontrollera konflikter
            Object.keys(lessonsByDayTime).forEach(key => {
                const timeLessons = lessonsByDayTime[key];
                const roomsUsed = {};
                
                timeLessons.forEach(lesson => {
                    if (roomsUsed[lesson.room]) {
                        conflicts.push({
                            room: lesson.room,
                            time: key,
                            classes: [roomsUsed[lesson.room].class_name, lesson.class_name]
                        });
                    } else {
                        roomsUsed[lesson.room] = lesson;
                    }
                });
            });
            
            return conflicts;
        }

        function calculateMultiClassBalanceScore(schedule, classes) {
            let totalBalance = 0;
            
            classes.forEach(classInfo => {
                const dailyCounts = Object.keys(schedule).map(day => 
                    schedule[day].filter(lesson => lesson.class_id === classInfo.id).length
                );
                const max = Math.max(...dailyCounts);
                const min = Math.min(...dailyCounts);
                
                const balance = max === 0 ? 100 : Math.round((1 - (max - min) / max) * 100);
                totalBalance += balance;
            });
            
            return Math.round(totalBalance / classes.length);
        }

        function validateMultiClassConstraints(schedule, classes) {
            let violations = 0;
            
            classes.forEach(classInfo => {
                Object.values(schedule).forEach(dayLessons => {
                    const classLessons = dayLessons.filter(l => l.class_id === classInfo.id);
                    const subjects = classLessons.map(l => l.subject_name);
                    const uniqueSubjects = new Set(subjects);
                    if (subjects.length !== uniqueSubjects.size) {
                        violations++;
                    }
                });
            });
            
            return violations;
        }

        function displayMultiClassSchedule(schedule, classFilter = null) {
            debugLog('Displaying multi-class schedule (filter):', { filter: classFilter, schedule });

            const preview = document.getElementById('schedulePreview');
            if (!schedule || !schedule.lessons) {
                preview.innerHTML = '<p>Inget multi-klass schema att visa</p>';
                return;
            }

            const weekdays = ['m√•ndag', 'tisdag', 'onsdag', 'torsdag', 'fredag'];

            // V√§nsterspalten 07:00 -> 18:00 i 5-minuterssteg
            const times = [];
            const startMinutesAll = 7 * 60;
            const endMinutesAll = 18 * 60;
            for (let m = startMinutesAll; m <= endMinutesAll; m += 5) times.push(minutesToTime(m));

            // Bygg lektion-map MEN filtrera om classFilter √§r satt
            const lessonMap = {};
            schedule.lessons.forEach(lesson => {
                if (classFilter && String(lesson.class_id) !== String(classFilter)) return; // filtrera bort
                if (!lessonMap[lesson.day]) lessonMap[lesson.day] = [];
                lessonMap[lesson.day].push(lesson);
            });

            let tableHTML = `<div style="overflow-x: auto;"><table class="schedule-table"><thead><tr><th style="min-width: 60px;">Tid</th>${weekdays.map(d=>`<th>${d.charAt(0).toUpperCase()+d.slice(1)}</th>`).join('')}</tr></thead><tbody>`;

            times.forEach(currentTime => {
                const currentMinutes = timeToMinutes(currentTime);
                tableHTML += `<tr><td style="font-weight: 600; font-size: 0.8rem;">${currentTime}</td>`;
                weekdays.forEach(day => {
                    const dayLessons = lessonMap[day] || [];
                    let cellContent = '';
                    let cellClass = 'empty-cell';

                    const activeLessons = [];
                    for (const lesson of dayLessons) {
                        if (lesson.time && lesson.time.includes('-')) {
                            const [startTime, endTime] = lesson.time.split('-');
                            const startMinutes = timeToMinutes(startTime);
                            const endMinutes = timeToMinutes(endTime);
                            if (currentMinutes >= startMinutes && currentMinutes < endMinutes) activeLessons.push(lesson);
                        }
                    }

                    if (activeLessons.length > 0) {
                        cellClass = 'lesson-cell';
                        cellContent = activeLessons.map(lesson => `
                            <div style="margin-bottom:4px; padding:4px; border-left:3px solid ${lesson.color}; background:${lesson.color}15;">
                            <div class="lesson-subject">${lesson.subject_name}</div>
                            <div class="lesson-class">${lesson.class_name} ‚Ä¢ <span style="font-size:0.75rem;color:#718096">${lesson.room}</span></div>
                            </div>
                        `).join('');
                    }

                    if (cellContent) {
                        tableHTML += `<td class="${cellClass}" style="padding:0.3rem;">${cellContent}</td>`;
                    } else {
                        tableHTML += `<td class="${cellClass}">${cellClass === 'empty-cell' ? '-' : ''}</td>`;
                    }
                });
                tableHTML += '</tr>';
            });

            tableHTML += `</tbody></table></div>`;

            // Statistik: om classFilter √§r satt, visa stats f√∂r just den klassen
            const stats = schedule.stats;
            if (classFilter) {
                const cls = availableClasses.find(c => String(c.id) === String(classFilter));
                const className = cls ? cls.name : classFilter;
                const lessonsCount = stats.lessons_per_class[className] || 0;

                tableHTML += `
                    <div style="margin-top:1rem; padding:1rem; background:#f7fafc; border-radius:6px;">
                    <h4 style="margin:0 0 0.5rem 0;">Schema f√∂r ${className}</h4>
                    <div style="font-size:0.95rem;">
                        üìö Lektioner visade: ${lessonsCount}<br>
                        üè´ Rum anv√§nda: ${stats.rooms_used.length}
                    </div>
                    </div>
                `;
            } else {
                // Beh√•ll full statistik som tidigare
                tableHTML += `
                    <div style="margin-top:1rem; padding:1rem; background:#f7fafc; border-radius:6px;">
                    <h4 style="margin:0 0 0.5rem 0;">Multi-klass Schemastatistik</h4>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:1rem; font-size:0.9rem;">
                        <div>üìö Totalt lektioner: ${stats.total_lessons}</div>
                        <div>üë• Klasser: ${schedule.classes.length}</div>
                        <div>üè´ Rum anv√§nda: ${stats.rooms_used.length}</div>
                        <div>‚öñÔ∏è Balans: ${stats.balance_score}%</div>
                        <div>üö´ Rumskonflikter: ${stats.room_conflicts.length}</div>
                        <div>‚úÖ Regelefterlevnad: ${stats.constraint_violations === 0 ? 'Perfekt' : `${stats.constraint_violations} fel`}</div>
                    </div>
                    </div>
                `;
            }

            preview.innerHTML = tableHTML;
            debugLog('Multi-class schedule displayed successfully (filtered):', { filter: classFilter });
        }

        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Multi-class schedule generator loaded');
            validateSubjectHours();
            populateClassFilter();
        });




        function timeToMinutes(timeStr) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function generateTimeSlots(startTime, endTime, lessonDuration) {
            const slots = [];
            const startMinutes = timeToMinutes(startTime);
            const endMinutes = timeToMinutes(endTime);
            
            let currentTime = startMinutes;
            
            while (currentTime + lessonDuration <= endMinutes) {
                const slotStart = minutesToTime(currentTime);
                const slotEnd = minutesToTime(currentTime + lessonDuration);
                slots.push(`${slotStart}-${slotEnd}`);
                
                currentTime += 5; // 5-minutersintervall
            }
            
            return slots;
        }

        async function saveMultiClassSchedule() {
            if (!currentSchedule) {
                alert('Inget schema att spara');
                return;
            }

            if (selectedClasses.length === 0) {
                alert('Inga klasser valda');
                return;
            }

            debugLog('Saving multi-class schedule for classes:', selectedClasses.map(c => c.name));

            // Simulera sparning
            setTimeout(() => {
                alert(`‚úÖ Multi-klass schema sparat framg√•ngsrikt f√∂r ${selectedClasses.length} klasser!`);
                debugLog('Multi-class schedule saved successfully');
            }, 500);
        }

        // Initiera n√§r sidan laddas
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Multi-class schedule generator loaded');
            validateSubjectHours();
        });
    </script>
</body>
</html>
