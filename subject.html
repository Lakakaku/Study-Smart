<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ subject_name }} - Study Smart</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subject_styles.css') }}">
  <style>

    .quiz-section {
    margin-bottom: 40px;
    }

    .section-title {
      display: flex;
      align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
}

.quiz-count {
  background: #e9ecef;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.9em;
  font-weight: 500;
  color: #666;
}

.quiz-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 15px;
  margin-bottom: 30px;
  max-height: 650px; /* √ñkad h√∂jd */
  overflow-y: auto;
  padding-right: 10px;
  grid-auto-rows: 1fr;
}

.quiz-grid::-webkit-scrollbar {
  width: 6px;
}

.quiz-grid::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.quiz-grid::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.quiz-grid::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.quiz-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  background: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  height: auto;
  justify-content: space-between;
}

.quiz-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.quiz-info {
  margin-top: 12px;
  margin-bottom: 12px;
  padding-top: 12px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.quiz-card.subject-quiz {
  border-left: 4px solid #007bff;
}

.quiz-card.personal-quiz {
  border-left: 4px solid #28a745;
}

.quiz-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.quiz-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  flex: 1;
}

.quiz-creator {
  font-size: 0.85em;
  color: #666;
  font-style: italic;
}

.personal-badge {
  background: #28a745;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
}

.quiz-meta {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.quiz-type {
  background: #f8f9fa;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  color: #495057;
}

.quiz-date {
  font-size: 0.85em;
  color: #6c757d;
}

.quiz-description {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 15px;
  line-height: 1.4;
}
.quiz-description-container {
  margin-bottom: 12px;
}

.quiz-description {
  position: relative;
}

.expand-description-btn {
  background: #007bff;
  border: 1px solid #007bff;
  color: white;
  font-size: 12px;
  cursor: pointer;
  padding: 4px 8px;
  margin-left: 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
}

.expand-description-btn:hover {
  background: #0056b3;
  border-color: #0056b3;
}

.description-expanded .description-text {
  display: block;
}

.quiz-actions {
  margin-top: 4px;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-end;
}

.created-info {
  font-size: 0.85em;
  color: #6c757d;
  flex: 1;
}

.start-button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.start-button:hover {
  background: #0056b3;
}

.start-button.personal {
  background: #28a745;
}

.start-button.personal:hover {
  background: #1e7e34;
}

.delete-button {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.delete-button:hover {
  background: #c82333;
}

.delete-form {
  margin: 0;
}

.quiz-action-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.quiz-action-btn:hover {
  background: #c82333;
}

.create-quiz-section {
  text-align: center;
  padding: 30px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-top: 20px;
}

.create-quiz-button {
  display: inline-block;
  background: #28a745;
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.create-quiz-button:hover {
  background: #218838;
  text-decoration: none;
  color: white;
}

.create-quiz-info {
  margin-top: 10px;
  font-size: 0.9em;
  color: #6c757d;
}

.no-quizzes {
  text-align: center;
  padding: 40px;
  color: #666;
}

.create-first-quiz-button {
  display: inline-block;
  background: #007bff;
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  margin-top: 20px;
  transition: background-color 0.2s ease;
}

.create-first-quiz-button:hover {
  background: #0056b3;
  text-decoration: none;
  color: white;
}

/* Styling for member role badges */
.member-role-badge {
  background: #6c757d;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
  margin-left: 8px;
}

.member-role-badge.owner {
  background: #dc3545;
}

.member-role-badge.admin {
  background: #ffc107;
  color: #212529;
}

.member-role-badge.member {
  background: #28a745;
}

/* Share section styling */
.share-section {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.share-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
}

.share-status {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 15px;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.status-indicator.active {
  background: #28a745;
}

.status-indicator.inactive {
  background: #dc3545;
}

.share-code-display {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.share-code {
  background: white;
  border: 1px solid #ced4da;
  padding: 8px 12px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 1.1em;
  font-weight: 600;
  color: #007bff;
  min-width: 120px;
}

.copy-button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background-color 0.2s ease;
}

.copy-button:hover {
  background: #0056b3;
}

.copy-button.copied {
  background: #28a745;
}

.toggle-sharing, .regenerate-code {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  margin-right: 10px;
  transition: background-color 0.2s ease;
}

.toggle-sharing:hover, .regenerate-code:hover {
  background: #5a6268;
}

.members-count {
  margin-top: 10px;
  font-size: 0.9em;
  color: #6c757d;
}

/* Shared files section */
.shared-files-section {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.files-section-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.file-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  margin-bottom: 20px;
  transition: border-color 0.2s ease;
}

.file-upload-area:hover,
.file-upload-area.drag-over {
  border-color: #007bff;
}

.file-upload-input {
  display: none;
}



.file-upload-label:hover,
.send-message-button:hover {
  background: #0056b3;
}


.file-description-input {
  width: 100%;
  max-width: 400px;
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  margin-top: 15px;
  resize: vertical;
  min-height: 60px;
}

.upload-progress {
  margin-top: 15px;
  background: #f8f9fa;
  border-radius: 4px;
  overflow: hidden;
}

.upload-progress-bar {
  height: 4px;
  background: #007bff;
  width: 0%;
  transition: width 0.3s ease;
}

.upload-status {
  margin-top: 10px;
  padding: 8px;
  border-radius: 4px;
  font-size: 0.9em;
}

.upload-status.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.upload-status.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.file-list {
  min-height: 100px;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  margin-bottom: 10px;
}

.file-info {
  flex: 1;
}

.file-name {
  font-weight: 500;
  color: #333;
  margin-bottom: 4px;
}

.file-extension {
  background: #e9ecef;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.75em;
  margin-left: 8px;
}

.file-download-count {
  color: #6c757d;
  font-size: 0.85em;
  margin-left: 8px;
}

.file-meta {
  font-size: 0.85em;
  color: #6c757d;
}

.file-description {
  font-size: 0.9em;
  color: #555;
  margin-top: 4px;
  font-style: italic;
}

.file-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.download-btn {
  background: #007bff;
  color: white;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.download-btn:hover {
  background: #0056b3;
  text-decoration: none;
  color: white;
}

.delete-file-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.delete-file-btn:hover {
  background: #c82333;
}

.no-files-message {
  text-align: center;
  padding: 40px;
  color: #6c757d;
  font-style: italic;
}

.file-stats {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #dee2e6;
  font-size: 0.9em;
  color: #6c757d;
}

/* Lessons section styling - UPPDATERAD */
.lessons-section {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
 
  max-height: 730px; /* √ñkad h√∂jd fr√•n 600px till 730px */
  display: flex;
  flex-direction: column;
}

.lessons-section-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.lesson-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  transition: border-color 0.2s ease;
  /* S√§kerst√§ll att inneh√•llet h√•ller sig inom gr√§nserna */
  overflow: hidden;
  box-sizing: border-box;
}


.lesson-upload-area:hover,
.lesson-upload-area.drag-over {
  border-color: #007bff;
}

/* UPPDATERAD lesson-upload-form - b√§ttre spacing och layout */
.lesson-upload-form {
  display: grid;
  grid-template-columns: 1fr;
  gap: 15px;
  width: 100%;
  box-sizing: border-box;
}

/* UPPDATERAD form-row - mer responsiv layout */
.form-row {
  display: grid;
  grid-template-columns: 1fr 180px; /* Minskad fr√•n 200px till 180px */
  gap: 15px;
  align-items: center;
  width: 100%;
}


.lesson-title-input, .lesson-date-input {
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9em;
  box-sizing: border-box;
  width: 100%;
}


.lesson-description-input {
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9em;
  min-height: 60px;
  resize: vertical;
  box-sizing: border-box;
  width: 100%;
}

.lesson-upload-input {
  display: none;
}

/* FIXAD lesson-upload-label - nu h√•ller den sig inom gr√§nserna */
.lesson-upload-label {
  display: block;
  padding: 15px;
  border: 2px dashed #ced4da;
  border-radius: 4px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
  /* S√§kerst√§ll att den inte g√•r utanf√∂r container */
  box-sizing: border-box;
  width: 100%;
  max-width: 100%;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

.lesson-upload-label:hover {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.upload-lesson-button {
  padding: 10px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.2s ease;
  box-sizing: border-box;
  width: 100%;
  max-width: 200px; /* Begr√§nsa knappens bredd */
  justify-self: start; /* V√§nsterjustera knappen */
  max-width: 200px; /* Begr√§nsa knappens bredd */
  margin: 0 auto; /* Centrera knappen v√•gr√§tt */
}

.upload-lesson-button:hover:not(:disabled) {
  background: #0056b3;
}

.upload-lesson-button:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

/* UPPDATERADE responsiva regler f√∂r mobiler */
@media (max-width: 768px) {
  .form-row {
    grid-template-columns: 1fr; /* Stack vertikalt p√• mobiler */
    gap: 10px;
  }
  
  .lesson-upload-label {
    padding: 12px; /* Mindre padding p√• mobiler */
    font-size: 0.9em;
  }
  
  .upload-lesson-button {
    max-width: 100%; /* Full bredd p√• mobiler */
  }
}

/* Extra s√§kerhet f√∂r st√∂rre sk√§rmar */
@media (min-width: 1200px) {
  .form-row {
    grid-template-columns: 1fr 160px; /* √Ñnnu mindre datumf√§lt p√• stora sk√§rmar */
  }
  
  .lesson-upload-label {
    /* Begr√§nsa texten ytterligare p√• stora sk√§rmar om beh√∂vs */
    max-width: 100%;
  }
}








/* UPPDATERAD lesson-timeline - √∂kad max-h√∂jd */
.lesson-timeline {
  flex: 1;
  overflow-y: auto;
  margin-top: 20px;
  padding-right: 5px;
}

.lesson-timeline::-webkit-scrollbar {
  width: 6px;
}

.lesson-timeline::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.lesson-timeline::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.lesson-timeline::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.lesson-item {
  display: flex;
  align-items: center;
  padding: 15px;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  margin-bottom: 10px;
  transition: all 0.2s ease;
  cursor: pointer;
  position: relative;
  flex-wrap: wrap;
  min-height: 80px;
  order: -1; /* TILLAGD - g√∂r att nyare lektioner hamnar h√∂gst upp */
}





.message-item {
  display: flex;
  align-items: flex-start;
  padding: 15px;
  border: 1px solid #e9ecef;
  border-radius: 8px;
  margin-bottom: 10px;
  background: #f8f9fa;
  border-left: 4px solid #17a2b8;
}

.message-info {
  display: flex;
  align-items: flex-start;
  flex: 1;
  gap: 12px;
}

.message-icon {
  font-size: 20px;
  margin-top: 2px;
}

.message-content {
  flex: 1;
}

.message-text {
  font-weight: 500;
  color: #333;
  margin-bottom: 5px;
  word-wrap: break-word;
}

.message-meta {
  font-size: 0.9em;
  color: #6c757d;
}

.message-actions {
  display: flex;
  align-items: center;
  gap: 10px;
}

.lesson-item:hover {
  background-color: #f8f9fa;
  border-color: #007bff;
}

.lesson-date-badge {
  background: #007bff;
  color: white;
  padding: 6px 10px;
  border-radius: 15px;
  font-size: 0.8em;
  font-weight: 600;
  margin-right: 15px;
  min-width: 70px;
  text-align: center;
  flex-shrink: 0;
}

.lesson-content {
  flex: 1;
  min-width: 200px;
}

.lesson-title {
  font-weight: 600;
  font-size: 1em;
  margin-bottom: 5px;
  color: #333;
}

.lesson-meta {
  color: #6c757d;
  font-size: 0.8em;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.lesson-type-icon {
  width: 35px;
  height: 35px;
  background: #e9ecef;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  font-size: 16px;
  flex-shrink: 0;
}

.lesson-type-icon.video {
  background: #dc3545;
  color: white;
}

.lesson-type-icon.audio {
  background: #28a745;
  color: white;
}

.lesson-status-section {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto;
  flex-shrink: 0;
}

.transcribed-badge {
  background: #28a745;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.lesson-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}

.lesson-action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  font-size: 0.8em;
  transition: background 0.2s ease;
  white-space: nowrap;
}

.lesson-action-btn.download {
  background: #28a745;
  color: white;
}

.lesson-action-btn.delete {
  background: #dc3545;
  color: white;
}

.lesson-action-btn:hover {
  opacity: 0.8;
}

.no-lessons-message {
  text-align: center;
  color: #6c757d;
  padding: 40px;
  font-size: 1em;
}

/* Lesson Player Modal */
.lesson-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lesson-modal-content {
  background: white;
  border-radius: 10px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
}

.lesson-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
}

.lesson-modal-header h2 {
  margin: 0;
  font-size: 1.2em;
}

.lesson-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.lesson-modal-close:hover {
  background: #f8f9fa;
}

.lesson-modal-body {
  padding: 20px;
  max-height: calc(90vh - 120px);
  overflow-y: auto;
}

#lesson-player-container {
  margin-bottom: 20px;
}

#lesson-player-container video,
#lesson-player-container audio {
  width: 100%;
  border-radius: 5px;
}

.lesson-info {
  margin-bottom: 20px;
}

.lesson-transcription-section {
  margin-top: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.transcription-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.transcription-header h3 {
  margin: 0;
  color: #495057;
  font-size: 1.1em;
}

.transcription-status {
  font-size: 0.9em;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 500;
}

.transcription-status.pending {
  background-color: #fff3cd;
  color: #856404;
}

.transcription-status.processing {
  background-color: #cce5ff;
  color: #0066cc;
  animation: pulse 2s infinite;
}

.transcription-status.completed {
  background-color: #d4edda;
  color: #155724;
}

.transcription-status.failed {
  background-color: #f8d7da;
  color: #721c24;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.transcription-content {
  max-height: 300px;
  overflow-y: auto;
  padding: 15px;
  background-color: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  color: #333;
}

.transcription-loading {
  text-align: center;
  color: #6c757d;
  font-style: italic;
}

.transcription-text {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.transcription-empty {
  text-align: center;
  color: #6c757d;
  font-style: italic;
}

.retry-transcription-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
}

.retry-transcription-btn:hover {
  background-color: #0056b3;
}

.retry-transcription-btn:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

        html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }

    .subject-title-container {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 10vh;
        font-weight: bold;
        border: 1px solid;
    }

    .under-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 10vh;
        border: 1px solid;
        padding: 0 5vw;
        position: relative;
    }

    .spacer {
        width: 33%;
    }

    .study-button-wrapper {
        position: absolute;
        left: 25%;
        transform: translateX(-50%);
    }

    .add-button-wrapper {
        position: absolute;
        right: 25%;
        transform: translateX(50%);
    }

    .study-now {
        background-color: greenyellow;
        border-radius: 25px;
        height: 7vh;
        width: 15vw;
        font-size: 3vh;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }

    .add-button {
        background-color: white;
        border: 3px solid black;
        border-radius: 50%;
        height: 8vh;
        width: 8vh;
        font-size: 4vh;
        font-weight: bold;
        cursor: pointer;
    }

    

    .quiz-container {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 730px; /* √ñkad h√∂jd f√∂r att matcha lessons-section */
    }

    .lessons-section {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        max-height: 730px; /* Konsekvent h√∂jd */
    }

    /* UPPDATERAD placeholder-panel - √∂kad h√∂jd f√∂r att matcha */
    .placeholder-panel {
        background-color: #f5f5f5;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        max-height: 730px; /* √ñkad h√∂jd f√∂r att matcha andra sektioner */
    }

    .return-button {
        position: absolute;
        top: 15px;
        left: 15px;
        text-decoration: none;
        background-color: lightgray;
        color: black;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: bold;
        font-family: sans-serif;
        border: 1px solid gray;
    }

    /* Document upload styles */
    .documents-section {
        flex: 1;
        overflow-y: auto;
    }

    .documents-section h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.4rem;
    }

    .upload-area {
        margin-bottom: 20px;
        text-align: center;
    }

    #pdf-upload {
        display: none;
    }

    .upload-label {
        display: inline-block;
        padding: 12px 24px;
        background-color: #4CAF50;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .upload-label:hover {
        background-color: #45a049;
    }

    .upload-info {
        margin-top: 8px;
        font-size: 0.9rem;
        color: #666;
    }

    .document-type-selector {
        margin-bottom: 20px;
    }

    .document-type-selector label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    #document-type {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        background-color: white;
    }

    #documents-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        flex: 1;
        overflow-y: auto;
    }

    .document-item {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: white;
        position: relative;
    }

    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .document-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: #333;
    }

    .document-type {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .document-preview {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        background-color: #fafafa;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .document-preview canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .preview-loading {
        color: #666;
        font-style: italic;
    }

    .remove-document {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
    }

    .remove-document:hover {
        background-color: #c0392b;
    }

    /* Shared Files Section Styling */
    .shared-files-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #e9ecef;
    }

    .files-section-title {
        font-size: 1.4em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #file-stats {
        font-size: 0.9em;
        color: #6c757d;
        font-weight: normal;
    }

    /* File Upload Area */
    .file-upload-area {
        background: #fff;
        border: 2px dashed #007bff;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .file-upload-area:hover {
        border-color: #0056b3;
        background: #f8f9ff;
    }

    .file-upload-area.drag-over {
        border-color: #28a745;
        background: #f8fff8;
    }

    .file-upload-input {
        display: none;
    }

    .file-upload-label,
    .send-message-button {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 40px;           /* samma h√∂jd f√∂r b√•da */
      line-height: 40px;      /* centrerar texten vertikalt */
      padding: 0 20px;        /* bara horisontell padding */
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      text-decoration: none;
      transition: background-color 0.2s ease;
      box-sizing: border-box; /* s√§kerst√§ller att h√∂jden r√§knas korrekt */
      margin:5px;
      font-size: 16px;
    }

    
    .file-description-input {
        width: 100%;
        min-height: 80px;
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
    }

    .file-description-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Upload Progress */
    .upload-progress {
        margin-top: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        overflow: hidden;
    }

    .upload-progress-bar {
        height: 4px;
        background: #007bff;
        transition: width 0.3s ease;
        width: 0%;
    }

    .upload-status {
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .upload-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .upload-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* File List */
    .file-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .file-item {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .file-item:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1em;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-extension {
        background: #007bff;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .file-download-count {
        background: #6c757d;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .file-meta {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .file-description {
        color: #495057;
        font-size: 0.9em;
        font-style: italic;
        margin-top: 5px;
    }

    .file-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .download-btn {
        background: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }

    .download-btn:hover {
        background: #218838;
        color: white;
        text-decoration: none;
    }

    .delete-file-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
    }

    .delete-file-btn:hover {
        background: #c82333;
    }

    .no-files-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    /* File Statistics */
    .file-stats {
        margin-top: 15px;
        padding: 10px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        font-size: 0.9em;
        color: #6c757d;
    }

    /* Share Section Styling */
    .share-section {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }

    .share-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .share-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }


    .members-management {
      border-top: 1px solid #e0e0e0;
      padding-top: 15px;
    }

    .view-members-btn {
      background: #007bff;
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }

    .view-members-btn:hover {
      background: #0056b3;
    }

    .members-list {
      margin-top: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      background: #f8f9fa;
      padding: 15px;
      max-height: 400px;
      overflow-y: auto;
    }

    .members-list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }










    /* RENSAD OCH FIXAD CSS - TA BORT ALLA GAMLA MEDIA QUERIES OCH ERS√ÑTT MED DESSA */

    /* GRUNDL√ÑGGANDE LAYOUT */
    .main-layout {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 20px;
        height: calc(100vh - 10px);
        padding: 20px;
    }

    /* MEMBER VIEW - GRUNDL√ÑGGANDE (VERTIKAL STACK) */
    .main-layout.member-view {
        grid-template-columns: 1fr !important;
        grid-template-rows: auto auto auto !important;
        height: auto !important;
        min-height: calc(100vh - 150px) !important;
    }

    /* KRITISK FIX: SIDE-BY-SIDE LAYOUT F√ñR MEDLEMMAR P√Ö STORA SK√ÑRMAR */
    @media (min-width: 1200px) and (min-aspect-ratio: 4/3) {
        .main-layout.member-view {
            grid-template-columns: 1fr 1fr !important;
            grid-template-rows: auto 1fr !important;
            gap: 20px !important;
            height: auto !important;
            min-height: calc(100vh - 150px) !important;
        }
        
        /* Quiz-container str√§cker sig √∂ver b√•da kolumnerna */
        .main-layout.member-view .quiz-container {
            grid-column: 1 / -1 !important;
            grid-row: 1 !important;
            max-height: 400px !important;
        }
        
        /* Lessons-section i andra raden, f√∂rsta kolumnen */
        .main-layout.member-view .lessons-section {
            grid-column: 1 !important;
            grid-row: 2 !important;
            margin: 0 !important;
            max-height: 500px !important;
        }
        
        /* Shared-files-section i andra raden, andra kolumnen */
        .main-layout.member-view .shared-files-section {
            grid-column: 2 !important;
            grid-row: 2 !important;
            margin: 0 !important;
            max-height: 500px !important;
        }
    }

    /* ULTRAWIDE SK√ÑRMAR */
    @media (min-width: 1400px) and (min-aspect-ratio: 16/10) {
        .main-layout.member-view {
            grid-template-columns: 1fr 1fr !important;
            grid-template-rows: auto 1fr !important;
            gap: 25px !important;
        }
        
        .main-layout.member-view .quiz-container {
            max-height: 450px !important;
        }
        
        .main-layout.member-view .lessons-section,
        .main-layout.member-view .shared-files-section {
            max-height: 550px !important;
        }
    }

    /* S√ÑKERST√ÑLL VERTIKAL STACK P√Ö MINDRE SK√ÑRMAR */
    @media (max-width: 1199px) {
        .main-layout.member-view {
            grid-template-columns: 1fr !important;
            grid-template-rows: auto auto auto !important;
        }
        
        .main-layout.member-view .quiz-container,
        .main-layout.member-view .lessons-section,
        .main-layout.member-view .shared-files-section {
            grid-column: 1 !important;
            grid-row: auto !important;
            margin: 20px 0 !important;
            max-height: 600px !important;
        }
        .main-layout:not(.member-view) .lessons-section {
          /* Ge mer h√∂jd baserat p√• viewport */
          max-height: 80vh !important;
        }
        
        .main-layout:not(.member-view) .lesson-timeline {
          /* Ta bort tidigare h√•rdkodad max-height, ers√§tt med flexibelt v√§rde */
          max-height: calc(80vh - 200px) !important;
      
        }
    }

    /* OWNERS/ADMINS LAYOUT - P√ÖVERKAS INTE */
    .main-layout:not(.member-view) {
        grid-template-columns: 2fr 1fr 1fr !important;
        gap: 20px !important;
        height: calc(100vh - 10px) !important;
        padding: 20px !important;
    }

    @media (max-width: 992px) {
        .main-layout:not(.member-view) {
            grid-template-columns: 1fr !important;
            grid-template-rows: auto auto auto !important;
            height: auto !important;
            min-height: calc(100vh - 150px) !important;
        }
    }

    /* MOBIL LAYOUT */
    @media (max-width: 768px) {
        .main-layout {
            padding: 10px !important;
            gap: 15px !important;
        }
        
        .main-layout.member-view {
            grid-template-columns: 1fr !important;
            grid-template-rows: auto auto auto !important;
        }
        
        .quiz-container, 
        .lessons-section, 
        .placeholder-panel,
        .shared-files-section {
            max-height: 500px !important;
        }
    }

    .members-list-header h4 {
      margin: 0;
      color: #333;
    }

    .member-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 4px;
      margin-bottom: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .member-info {
      flex-grow: 1;
    }

    .member-name {
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
    }

    .member-meta {
      font-size: 12px;
      color: #666;
      display: flex;
      gap: 15px;
    }

    .member-role {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }

    .member-role.owner {
      background: #e3f2fd;
      color: #1976d2;
    }

    .member-role.admin {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .member-role.member {
      background: #e8f5e8;
      color: #388e3c;
    }

    .member-actions {
      display: flex;
      gap: 8px;
    }

    .kick-member-btn {
      background: #dc3545;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .kick-member-btn:hover {
      background: #c82333;
    }

    .kick-member-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .loading-members, .no-members {
      text-align: center;
      padding: 20px;
      color: #666;
      font-style: italic;
    }

    .error-loading-members {
      text-align: center;
      padding: 20px;
      color: #dc3545;
      background: #f8d7da;
      border-radius: 4px;
      border: 1px solid #f5c6cb;
    }

    .status-indicator.active {
        background: #28a745;
    }

    .status-indicator.inactive {
        background: #dc3545;
    }

    .share-code-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .share-code {
        font-family: 'Courier New', monospace;
        font-size: 1.2em;
        font-weight: 600;
        color: #007bff;
        background: #fff;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #007bff;
    }

    .copy-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }

    .copy-button:hover {
        background: #0056b3;
    }

    .copy-button.copied {
        background: #28a745;
    }

    .share-help {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 10px 15px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #1976d2;
    }

    .toggle-sharing, .regenerate-code {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        margin-right: 10px;
        transition: background-color 0.2s;
    }

    .toggle-sharing:hover, .regenerate-code:hover {
        background: #0056b3;
    }

    .regenerate-code {
        background: #ffc107;
        color: #212529;
    }

    .regenerate-code:hover {
        background: #e0a800;
    }

    .members-count {
        margin-top: 15px;
        font-size: 0.9em;
        color: #6c757d;
    }

    .member-role-badge {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
        margin-left: 10px;
    }

    .member-role-badge.owner {
        background: #28a745;
    }

    .member-role-badge.admin {
        background: #ffc107;
        color: #212529;
    }

    .member-role-badge.member {
        background: #6c757d;
    }

    .quiz-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s ease;
    }

    .quiz-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .quiz-header {
      margin-bottom: 12px;
    }

    .quiz-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .quiz-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .quiz-type-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .quiz-type-badge.ten { background: #e3f2fd; color: #1976d2; }
    .quiz-type-badge.twenty-five { background: #f3e5f5; color: #7b1fa2; }
    .quiz-type-badge.fifty { background: #fff3e0; color: #f57c00; }
    .quiz-type-badge.extended-response { background: #e8f5e8; color: #388e3c; }
    .quiz-type-badge.exam { background: #ffebee; color: #d32f2f; }

    .question-count {
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .personal-badge {
      font-size: 11px;
      background: #fff3cd;
      color: #856404;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
    }

    .quiz-description {
      font-size: 14px;
      color: #555;
      line-height: 1.4;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #007bff;
    }

    .quiz-info {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .created-info {
      color: #888;
      font-size: 12px;
    }

    .quiz-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .quiz-action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quiz-action-btn.play {
      background: #007bff;
      color: white;
      flex: 1;
    }

    .quiz-action-btn.play:hover {
      background: #0056b3;
    }

    .quiz-action-btn.delete {
      background: #dc3545;
      color: white;
      font-size: 12px;
      padding: 6px 12px;
    }


    .open-file-btn {
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border-radius: 4px;
      text-decoration: none;
      font-size: 0.9em;
      transition: background-color 0.2s;
    }
    .open-file-btn:hover {
      background-color: #45A049;
    }


    .quiz-action-btn.delete:hover {
      background: #c82333;
    }

    .delete-form {
      margin: 0;
    }

    /* Mobile responsiveness */
    @media (max-width: 1200px) {
      .quiz-grid {
        grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
        gap: 12px;
      }
    }

    

    @media (max-width: 768px) {
      .quiz-grid {
        grid-template-columns: 1fr;
      }
      
      .quiz-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .quiz-actions {
        flex-direction: column;
        width: 100%;
      }
      
      .start-button,
      .delete-button {
        width: 100%;
        justify-content: center;
      }
      
      .share-code-display {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      
      .file-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
      
      .file-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
      
      .lesson-item {
        flex-direction: column;
        align-items: flex-start;
        padding: 15px;
        min-height: auto;
      }
      
      .lesson-date-badge {
        margin-right: 0;
        margin-bottom: 10px;
        align-self: flex-start;
      }

      .lesson-content {
        width: 100%;
        margin-bottom: 10px;
      }

      .lesson-status-section {
        width: 100%;
        justify-content: space-between;
        margin-left: 0;
        margin-top: 10px;
      }

      .lesson-actions {
        margin-left: 0;
      }
      
      .lesson-modal-content {
        width: 95%;
        margin: 20px;
      }

      .quiz-info {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }

      .quiz-actions {
        width: 100%;
        justify-content: flex-end;
      }

      .main-layout {
        padding: 10px;
        gap: 15px;
      }
    }

  </style>
</head>
<body>

  <a href="{{ url_for('index') }}" class="return-button">‚Üê Return</a>

  <div class="subject-title-container">
    <div id="subject-title">
      {{ subject_name }}
      {% if user_role %}
        <span class="member-role-badge {{ user_role }}">{{ user_role.title() }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Share Section - only for owners -->
  {% if user_role == 'owner' %}
  <div class="share-section">
    <div class="share-title">üì§ Dela √Ñmnet</div>
    
    <div class="share-status">
      <div class="status-indicator {{ 'active' if subject.is_shared else 'inactive' }}"></div>
      <span> Delning √§r {{ 'aktiverad' if subject.is_shared else 'inaktiverad' }}</span>
    </div>
    
    {% if subject.is_shared %}
    <div class="share-code-display">
      <label>Delningskod:</label>
      <div class="share-code" id="share-code-display">{{ subject.share_code }}</div>
      <button class="copy-button" onclick="copyShareCode()">Kopiera</button>
    </div>
    {% endif %}
    
    <div style="margin-top: 15px; display: flex; justify-content: space-between; align-items: center;">
      <div>
        <button class="toggle-sharing" onclick="toggleSharing()">
          {{ 'Inaktivera Delning' if subject.is_shared else 'Enable Sharing' }}
        </button>
        
        {% if subject.is_shared %}
        <button class="regenerate-code" onclick="regenerateCode()">
          Regenerera Kod
        </button>
        {% endif %}
      </div>
      
      <button class="view-members-btn" onclick="toggleMembersList()">
        üë• Visa Medlemmar
      </button>
    </div>

    <div class="members-list" id="members-list" style="display: none; margin-top: 15px;">
      <div class="members-list-header">
        <h4>Medlemmar</h4>
        <span id="members-list-count">Laddar...</span>
      </div>
      <div class="members-container" id="members-container">
        <div class="loading-members">Laddar medlemmar...</div>
      </div>
    </div>
    
    <div class="members-count" id="members-count">
      Loading member count...
    </div>

    
  </div>

  {% endif %}














  <div class="main-layout {% if user_role not in ['owner', 'admin'] %}member-view{% endif %}">
    <div class="quiz-container">
      <h3>üéØ Quizzes</h3>
      <!-- Uppdaterad HTML f√∂r quiz-sektionen med sortering -->
      {% if quizzes %}
        <div class="quiz-grid">
          
          <!-- Uppdaterad HTML f√∂r quiz-korten med sortering: nyaste f√∂rst -->
          {% for quiz in quizzes|sort(attribute='created_at', reverse=true) %}
          <div class="quiz-card">
            <div class="quiz-header">
              <div class="quiz-title">
                {{ quiz.title }}
              </div>

              <!-- Quiz-typ och antal fr√•gor -->
              <div class="quiz-meta">
                <span class="question-count">
                  {{ quiz.question_count }} fr√•gor
                </span>
                {% if quiz.is_personal %}
                <span class="personal-badge">Personlig</span>
                {% endif %}
              </div>
            </div>

            <!-- Quiz beskrivning med expand-funktionalitet -->
            {% if quiz.display_description %}
            <div class="quiz-description-container">
              <div class="quiz-description" data-full-text="{{ quiz.display_description }}">
                <span class="description-text">{{ quiz.display_description[:100] }}{% if quiz.display_description|length > 100 %}...{% endif %}</span>
                {% if quiz.display_description|length > 100 %}
                <button class="expand-description-btn" onclick="toggleDescription(this)">
                  <span class="expand-text">+</span>
                  <span class="collapse-text" style="display: none;">-</span>
                </button>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Quiz info och actions -->
            <div class="quiz-info">
              <small class="created-info">
                Skapad {{ quiz.created_at[:10] if quiz.created_at else 'Ok√§nt datum' }}
                {% if quiz.user_id != current_user.id %}
                  av annan anv√§ndare
                {% endif %}
              </small>

              <!-- Delete-knappen - √§ndrad f√∂r att anv√§nda quiz ID -->
              <div class="quiz-actions">
                {% if quiz.user_id == current_user.id or user_role == 'owner' %}
                <form method="POST"
                      action="{{ url_for('delete_quiz',
                                        subject_name=subject_name,
                                        quiz_id=quiz.id) }}"
                      class="delete-form"
                      onsubmit="return confirm('√Ñr du s√§ker p√• att du vill ta bort detta quiz?');">
                    <button type="submit" class="quiz-action-btn delete">Ta bort</button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}

        </div>
      {% else %}
        <p>No quizzes available for this subject yet.</p>
      {% endif %}
    </div>

    <!-- Lessons Section -->
    <div class="lessons-section">
      <div class="lessons-section-title">
        üé• Lektioner
        <span id="lesson-stats"></span>
      </div>

      <!-- Lesson Upload Area - Only for owners -->
      {% if user_role == 'owner' %}
      <div class="lesson-upload-area" id="lesson-upload-area">
        <div class="lesson-upload-form">
          <div class="form-row">
            <input type="text" id="lesson-title" class="lesson-title-input" placeholder="Titel *" required>
            <input type="date" id="lesson-date" class="lesson-date-input" required>
          </div>
      
          <textarea id="lesson-description" class="lesson-description-input" placeholder="Beskrivning..."></textarea>
      
          <input type="file" id="lesson-upload-input" class="lesson-upload-input" accept="video/*,audio/*">
          <label for="lesson-upload-input" class="lesson-upload-label">
            V√§lj Video/Ljudfil eller Drag & Drop
          </label>
          <div id="lesson-file-name" class="file-name-display" style="margin-top:4px; font-style:italic; color:#555;">
            <!-- H√§r kommer filnamnet att visas -->
          </div>
      
          <button id="upload-lesson-btn" class="upload-lesson-button" disabled>
            Ladda upp Lektion
          </button>
      
          <div id="lesson-upload-progress" class="upload-progress" style="display: none;">
            <div class="upload-progress-bar" id="lesson-progress-bar"></div>
          </div>
      
          <div id="lesson-upload-status" class="upload-status" style="display: none;"></div>
        </div>
      </div>
      {% endif %}

      <!-- Lesson Timeline -->
      <div class="lesson-timeline" id="lesson-timeline">
        <div class="no-lessons-message" id="no-lessons-message">
          Loading lessons...
        </div>
      </div>

      <!-- Lesson Statistics for owners -->
      {% if user_role == 'owner' %}
      <div class="lesson-stats" id="lesson-stats-details" style="display: none;">
      </div>
      {% endif %}
    </div>



    <!-- Shared Files Section - Moved to bottom for members -->
    {% if user_role not in ['owner', 'admin'] %}
    <div class="shared-files-section">
      <div class="files-section-title">
        Delade Filer
        <span id="file-stats"></span>
      </div>

      <!-- File List -->
      <div class="file-list" id="file-list">
        <div class="no-files-message" id="no-files-message">
          Loading files...
        </div>
      </div>
    </div>
    {% endif %}
    

    <!-- Documents Section - Only show for owners and admins -->
    {% if user_role in ['owner', 'admin'] %}
    <div class="placeholder-panel">
      <div class="documents-section">
        <h3>üìÑ Dokument</h3>

        <!-- Upload area for owners/admins -->
        <div class="upload-area">
          <input type="file" id="pdf-upload" accept=".pdf" multiple>
          <label for="pdf-upload" class="upload-label">
            Ladda upp PDF-dokument
          </label>
        </div>

        <div class="document-type-selector">
          <label for="document-type">Dokumenttyp:</label>
          <select id="document-type">
            <option value="begrippslista">Begreppslista</option>
            <option value="kunskapskrav">Kunskapskrav</option>
            <option value="kunskapsmal">Kunskapsm√•l</option>
          </select>
        </div>

        <div id="documents-container">
          {% if krav_docs %}
            {% for doc in krav_docs %}
              <div class="document-item" data-doc-type="{{ doc.doc_type }}">
                <button class="remove-document"
                        data-doc-type="{{ doc.doc_type }}"
                        data-doc-id="{{ doc.id }}">√ó</button>
                <div class="document-header">
                  <span class="document-title">
                    {{ doc.doc_type|capitalize }}
                  </span>
                </div>
                <div class="document-preview">
                  <!-- Iframe mot server-sparad PDF -->
                  <iframe
                    src="{{ url_for('static',
                                    filename='uploads/krav/' ~ current_user.id ~ '/' ~ subject_name ~ '/' ~ doc.doc_type ~ '.pdf') }}"
                    width="100%"
                    height="300px"
                    style="border:1px solid #ccc;"
                  ></iframe>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>Inga dokument uppladdade √§n.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End of Documents Section -->

  </div>

  <!-- Shared Files Section for owners/admins -->
  {% if user_role == 'owner' %}
  <div class="shared-files-section">
    <div class="files-section-title">
      üìÅ Delade Filer
      <span id="file-stats"></span>
    </div>

    <!-- File Upload Area - Only for owners -->
    {% if user_role == 'owner' %}
    <div class="file-upload-area" id="file-upload-area">
      <input type="file" id="file-upload-input" class="file-upload-input" multiple>
      <label for="file-upload-input" class="file-upload-label">
        V√§lj fil eller Dra och Sl√§pp
      </label>
      <button id="send-message-btn" class="send-message-button">
        Skicka Meddelande
      </button>
      <div style="margin-top: 10px; color: #6c757d;">
        (Max 50MB per fil)
      </div>
      <textarea id="file-description" class="file-description-input" placeholder="Description"></textarea>
      <div id="upload-progress" class="upload-progress" style="display: none;">
        <div class="upload-progress-bar" id="progress-bar"></div>
      </div>
      <div id="upload-status" class="upload-status" style="display: none;"></div>
    </div>
    {% endif %}

  

    <!-- File List -->
    <div class="file-list" id="file-list">
      <div class="no-files-message" id="no-files-message">
        Loading files...
      </div>
    </div>

    <!-- File Statistics for owners -->
    {% if user_role == 'owner' %}
    <div class="file-stats" id="file-stats-details" style="display: none;">
    </div>
    {% endif %}
  </div>
  {% endif %}

  <!-- Lesson Player Modal -->
  <div id="lesson-player-modal" class="lesson-modal" style="display: none;">
    <div class="lesson-modal-content">
      <div class="lesson-modal-header">
        <h2 id="lesson-player-title"></h2>
        <button class="lesson-modal-close" onclick="closeLessonPlayer()">&times;</button>
      </div>

      <div class="lesson-modal-body">
        <div id="lesson-player-container">
          <!-- Video/Audio player will be inserted here -->
        </div>

        <div class="lesson-info">
          <div id="lesson-player-description"></div>
          <div class="lesson-meta">
            <span id="lesson-player-date"></span>
            <span id="lesson-player-views"></span>
            <span id="lesson-player-size"></span>
          </div>
        </div>

        <!-- Transkriptions-sektion -->
        <div class="lesson-transcription-section">
          <div class="transcription-header">
            <h3>üìù Transkription</h3>
            <span id="transcription-status" class="transcription-status"></span>
          </div>
          <div id="transcription-content" class="transcription-content">
            <div class="transcription-loading">Laddar transkription...</div>
          </div>
          <button id="retry-transcription-btn" class="retry-transcription-btn" style="display: none;" onclick="retryTranscription()">
            F√∂rs√∂k igen
          </button>
        </div>

        <div class="lesson-actions">
          <a id="lesson-download-link" class="lesson-action-btn download">Ladda ner</a>
          <button id="lesson-delete-btn" class="lesson-action-btn delete" style="display: none;" onclick="deleteCurrentLesson()">Ta bort</button>
        </div>
      </div>
    </div>
  </div>




























































































  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="{{ url_for('static', filename='js/subject.js') }}"></script>
  <script>
    // Globala variabler som subject.js beh√∂ver
    const currentSubject = '{{ subject_name|safe }}';
    const currentUserId = '{{ current_user.id }}';
    const subjectId = {{ subject.id }};
    const userRole = '{{ user_role }}';
    
    // Eventuella befintliga quiz-data (f√∂r bak√•tkompatibilitet)
    {% if quizzes %}
    const initialQuizzes = {{ quizzes|tojson|safe }};
    {% else %}
    const initialQuizzes = [];
    {% endif %}
    
    // Befintliga dokument (f√∂r bak√•tkompatibilitet)
    {% if krav_docs %}
    const initialDocuments = {{ krav_docs|tojson|safe }};
    {% else %}
    const initialDocuments = [];
    {% endif %}

    // Share code functions
    async function copyShareCode() {
      const shareCode = document.getElementById('share-code-display').textContent;
      const copyButton = document.querySelector('.copy-button');
      
      try {
        await navigator.clipboard.writeText(shareCode);
        copyButton.textContent = 'Kopierad!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = shareCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        copyButton.textContent = 'Copied!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      }
    }






































    // Krav Document Management Functions
    // These handle curriculum documents (kunskapskrav, kunskapsm√•l, begrippslista)

    let kravUploadInProgress = false;

    // Initialize krav document functionality
    function initializeKravDocuments() {
        if (userRole !== 'owner' && userRole !== 'admin') return; // Only owners/admins can manage krav documents
        
        setupKravDocumentUpload();
        setupKravDocumentRemoval();
        loadExistingKravDocuments();
    }

    // Setup krav document upload functionality
    function setupKravDocumentUpload() {
        // Setup file input change handler
        const pdfUploadInput = document.getElementById('pdf-upload');
        if (pdfUploadInput) {
            pdfUploadInput.addEventListener('change', handleKravFileSelection);
        }
        
        // Setup document type selector
        const docTypeSelector = document.getElementById('document-type');
        if (docTypeSelector) {
            // Set default selection if needed
            if (!docTypeSelector.value) {
                docTypeSelector.value = 'begrippslista';
            }
        }
    }

    // Handle file selection for krav documents
    async function handleKravFileSelection(event) {
        const files = event.target.files;
        const docTypeSelector = document.getElementById('document-type');
        
        if (!files.length || !docTypeSelector) {
            return;
        }
        
        const selectedDocType = docTypeSelector.value;
        
        // Process each selected file
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            await uploadKravDocument(selectedDocType, file);
        }
        
        // Clear the file input after upload
        event.target.value = '';
    }

    // Upload krav document
    async function uploadKravDocument(docType, file) {
        if (kravUploadInProgress) {
            showKravStatus('Upload already in progress', 'warning');
            return;
        }
        
        // Validate file
        if (!file) {
            showKravStatus('Please select a file', 'error');
            return;
        }
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showKravStatus('Only PDF files are allowed', 'error');
            return;
        }
        
        if (file.size > 50 * 1024 * 1024) { // 50MB limit
            showKravStatus('File too large. Maximum size is 50MB', 'error');
            return;
        }
        
        // Validate document type
        const allowedTypes = ['begrippslista', 'kunskapskrav', 'kunskapsmal'];
        if (!allowedTypes.includes(docType)) {
            showKravStatus('Invalid document type', 'error');
            return;
        }
        
        kravUploadInProgress = true;
        
        try {
            showKravStatus(`Uploading ${docType}...`, 'info');
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('subject', currentSubject);
            formData.append('type', docType);
            
            // Upload with progress tracking
            const response = await uploadKravWithProgress(formData, docType);
            
            if (response.status === 'success') {
                showKravStatus(`${docType} uploaded successfully!`, 'success');
                
                // Update the documents display
                await refreshKravDocuments();
                
            } else {
                throw new Error(response.message || 'Upload failed');
            }
            
        } catch (error) {
            console.error('Krav document upload error:', error);
            showKravStatus(`Upload failed: ${error.message}`, 'error');
        } finally {
            kravUploadInProgress = false;
        }
    }

    // Upload with progress tracking
    function uploadKravWithProgress(formData, docType) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            // Progress handler
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    showKravStatus(`Uploading ${docType}... ${percentComplete}%`, 'info');
                }
            });
            
            // Success handler
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response);
                    } catch (e) {
                        reject(new Error('Invalid server response'));
                    }
                } else {
                    reject(new Error(`Server error ${xhr.status}`));
                }
            });
            
            // Error handler
            xhr.addEventListener('error', () => {
                reject(new Error('Network error during upload'));
            });
            
            // Send request
            xhr.open('POST', '/upload_krav_pdf');
            xhr.send(formData);
        });
    }

    // Setup removal functionality
    function setupKravDocumentRemoval() {
        // Use event delegation for remove buttons
        document.addEventListener('click', function(e) {
            const removeButton = e.target.closest('.remove-document');
            if (removeButton && removeButton.dataset.docType) {
                e.preventDefault();
                e.stopPropagation();
                
                const docType = removeButton.getAttribute('data-doc-type');
                const docId = removeButton.getAttribute('data-doc-id');
                
                if (docType) {
                    removeKravDocument(docType, docId);
                }
            }
        });
    }

    // Remove krav document
    async function removeKravDocument(docType, docId = null) {
        const confirmMessage = `Are you sure you want to remove the ${docType} document?`;
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            showKravStatus(`Removing ${docType}...`, 'info');
            
            const requestData = {
                subject: currentSubject,
                type: docType
            };
            
            if (docId) {
                requestData.document_id = docId;
            }
            
            const response = await fetch('/remove_krav_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showKravStatus(`${docType} removed successfully!`, 'success');
                
                // Remove the document item from DOM
                const documentItem = document.querySelector(`[data-doc-type="${docType}"]`);
                if (documentItem) {
                    documentItem.style.transition = 'opacity 0.3s ease';
                    documentItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        documentItem.remove();
                        
                        // Check if no documents remain
                        const remainingDocs = Array.from(
                          document.querySelectorAll('.document-item')
                        ).map(el => ({ doc_type: el.dataset.docType }));
                        updateDocTypeOptions(remainingDocs);
                        // Uppdatera dropdownen
                        if (remainingDocs === 0) {
                            const container = document.getElementById('documents-container');
                            if (container) {
                                container.innerHTML = '<p>Inga dokument uppladdade √§n.</p>';
                            }
                        }
                    }, 300);
                }
                
            } else {
                throw new Error(data.message || 'Removal failed');
            }
            
        } catch (error) {
            console.error('Krav document removal error:', error);
            showKravStatus(`Removal failed: ${error.message}`, 'error');
        }
    }

    // Load existing krav documents
    async function loadExistingKravDocuments() {
        try {
            const response = await fetch(`/api/krav_documents/${encodeURIComponent(currentSubject)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'success') {
                updateKravDocumentsDisplay(data.documents || []);
            } else {
                console.error('Failed to load krav documents:', data.message);
                // If API endpoint doesn't exist, try to use the initial data from template
                if (typeof initialDocuments !== 'undefined') {
                    updateKravDocumentsDisplay(initialDocuments);
                }
            }
            
        } catch (error) {
            console.error('Error loading krav documents:', error);
            // Fallback to initial data if available
            if (typeof initialDocuments !== 'undefined') {
                updateKravDocumentsDisplay(initialDocuments);
            }
        }
    }

    // Refresh krav documents display
    async function refreshKravDocuments() {
        await loadExistingKravDocuments();
    }

    // Update krav documents display
    function updateKravDocumentsDisplay(documents) {
        const container = document.getElementById('documents-container');
        if (!container) return;
        
        if (!documents || documents.length === 0) {
            container.innerHTML = '<p>Inga dokument uppladdade √§n.</p>';
            return;
        }
        
        const documentsHtml = documents.map(doc => {
            // Create the file URL - try multiple possible URL patterns
            let fileUrl = '';
            if (doc.file_url) {
                fileUrl = doc.file_url;
            } else if (doc.doc_type && currentSubject) {
                // Fallback to the pattern used in the template
                fileUrl = `/static/uploads/krav/${currentUserId}/${encodeURIComponent(currentSubject)}/${doc.doc_type}.pdf`;
            }
            
            return `
                <div class="document-item" data-doc-type="${escapeHtml(doc.doc_type)}">
                    ${userRole === 'owner' || userRole === 'admin' ? `
                        <button class="remove-document"
                                data-doc-type="${escapeHtml(doc.doc_type)}"
                                data-doc-id="${doc.id || ''}">√ó</button>
                    ` : ''}
                    <div class="document-header">
                        <span class="document-title">
                            ${escapeHtml(doc.doc_type.charAt(0).toUpperCase() + doc.doc_type.slice(1))}
                        </span>
                    </div>
                    <div class="document-preview">
                        <iframe
                            src="${escapeHtml(fileUrl)}"
                            width="100%"
                            height="300px"
                            style="border:1px solid #ccc;"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        </iframe>
                        <div style="display:none; padding:20px; text-align:center; color:#666; border:1px solid #ccc;">
                            Document could not be loaded
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = documentsHtml;
        updateDocTypeOptions(documents);
    }


    /**
     * Uppdaterar alternativen i dokument-typen baserat p√• vilka dokument som redan finns.
     * @param {Array} documents - Array av dokument-objekt med f√§ltet doc_type.
     */
    function updateDocTypeOptions(documents) {
        const selector = document.getElementById('document-type');
        if (!selector) return;

        // Till√•tna typer
        const allowedTypes = [
            { value: 'begrippslista', label: 'Begreppslista' },
            { value: 'kunskapskrav', label: 'Kunskapskrav' },
            { value: 'kunskapsmal',   label: 'Kunskapsm√•l' }
        ];

        // Rensa gamla options
        selector.innerHTML = '';

        // L√§gg bara till typer som inte finns i documents
        allowedTypes.forEach(typeObj => {
            const exists = documents.some(doc => doc.doc_type === typeObj.value);
            if (!exists) {
                const opt = document.createElement('option');
                opt.value = typeObj.value;
                opt.textContent = typeObj.label;
                selector.appendChild(opt);
            }
        });

        // Om inga typer √§r kvar, disablea b√•de select och upload-input
        const pdfInput = document.getElementById('pdf-upload');
        if (selector.options.length === 0) {
            selector.disabled = true;
            if (pdfInput) pdfInput.disabled = true;
        } else {
            selector.disabled = false;
            if (pdfInput) pdfInput.disabled = false;
        }
    }




    // Show krav status messages
    function showKravStatus(message, type = 'info') {
        // Try to use existing status div first
        let statusDiv = document.getElementById('krav-upload-status');
        
        // If no dedicated krav status div, create one
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'krav-upload-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 4px;
                z-index: 1000;
                max-width: 300px;
                font-weight: 500;
                display: none;
            `;
            document.body.appendChild(statusDiv);
        }
        
        // Set colors based on type
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
        
        const color = colors[type] || colors.info;
        statusDiv.style.backgroundColor = color.bg;
        statusDiv.style.borderLeft = `4px solid ${color.border}`;
        statusDiv.style.color = color.text;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Auto-hide after delay
        const hideDelay = (type === 'error') ? 5000 : 3000;
        setTimeout(() => {
            if (statusDiv.style.display === 'block') {
                statusDiv.style.display = 'none';
            }
        }, hideDelay);
    }

    // Utility function to escape HTML (reuse existing if available)
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof userRole !== 'undefined' && (userRole === 'owner' || userRole === 'admin')) {
            initializeKravDocuments();
        }
    });

    // Export functions for external use
    if (typeof window !== 'undefined') {
        window.uploadKravDocument = uploadKravDocument;
        window.removeKravDocument = removeKravDocument;
        window.refreshKravDocuments = refreshKravDocuments;
        window.initializeKravDocuments = initializeKravDocuments;
    }






    function toggleDescription(button) {
      const descriptionDiv = button.closest('.quiz-description');
      const textSpan = descriptionDiv.querySelector('.description-text');
      const expandText = button.querySelector('.expand-text');
      const collapseText = button.querySelector('.collapse-text');
      const fullText = descriptionDiv.getAttribute('data-full-text');
  
      if (expandText.style.display !== 'none') {
        // Expandera
        textSpan.textContent = fullText;
        expandText.style.display = 'none';
        collapseText.style.display = 'inline';
        descriptionDiv.classList.add('description-expanded');
      } else {
        // Kollapsa
        textSpan.textContent = fullText.substring(0, 100) + (fullText.length > 100 ? '...' : '');
        expandText.style.display = 'inline';
        collapseText.style.display = 'none';
        descriptionDiv.classList.remove('description-expanded');
      }
    }














    async function toggleSharing() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/share`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          location.reload(); // Reload to update the UI
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error toggling sharing:', error);
        alert('Failed to toggle sharing');
      }
    }

    async function regenerateCode() {
      if (!confirm('Are you sure you want to regenerate the share code? The old code will no longer work.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/subject/${subjectId}/regenerate_code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('share-code-display').textContent = data.share_code;
          alert('Share code regenerated successfully!');
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error regenerating code:', error);
        alert('Failed to regenerate code');
      }
    }

    let membersData = [];

    // Toggle members list visibility
    async function toggleMembersList() {
      const membersList = document.getElementById('members-list');
      
      if (membersList.style.display === 'none' || membersList.style.display === '') {
        // Show members list
        membersList.style.display = 'block';
        
        // Load members if not already loaded
        if (membersData.length === 0) {
          await loadMembersList();
        }
        
        // Update button text
        const button = document.querySelector('.view-members-btn');
        if (button) {
          button.textContent = 'üë• D√∂lj Medlemmar';
        }
      } else {
        // Hide members list
        membersList.style.display = 'none';
        
        // Update button text
        const button = document.querySelector('.view-members-btn');
        if (button) {
          button.textContent = 'üë• Visa Medlemmar';
        }
      }
    }

    // Load member count
    async function loadMemberCount() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/members`);
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('members-count').textContent = 
            `üë• ${data.total_members} medlemmar${data.total_members !== 1 ? '' : ''}`;
        }
      } catch (error) {
        console.error('Error loading member count:', error);
        document.getElementById('members-count').textContent = 'üë• Member count unavailable';
      }
    }
    
    
    // Load members list from server
    async function loadMembersList() {
      const container = document.getElementById('members-container');
      const countSpan = document.getElementById('members-list-count');
      
      try {
        container.innerHTML = '<div class="loading-members">Laddar medlemmar...</div>';
        
        const response = await fetch(`/api/subject/${subjectId}/members/detailed`);
        const data = await response.json();
        
        if (data.status === 'success') {
          membersData = data.members;
          renderMembersList(membersData);
          countSpan.textContent = `${membersData.length} medlem${membersData.length !== 1 ? 'mar' : ''}`;
        } else {
          throw new Error(data.message || 'Kunde inte ladda medlemmar');
        }
      } catch (error) {
        console.error('Error loading members:', error);
        container.innerHTML = `
          <div class="error-loading-members">
            Fel vid laddning av medlemmar: ${error.message}
          </div>
        `;
        countSpan.textContent = 'Fel';
      }
    }

    // Render members list in DOM
    function renderMembersList(members) {
      const container = document.getElementById('members-container');
      
      if (!members || members.length === 0) {
        container.innerHTML = '<div class="no-members">Inga medlemmar hittades</div>';
        return;
      }
      
      // Sort members: owner first, then admin, then regular members
      const sortedMembers = [...members].sort((a, b) => {
        const roleOrder = { owner: 0, admin: 1, member: 2 };
        return roleOrder[a.role] - roleOrder[b.role];
      });
      
      const membersHtml = sortedMembers.map(member => {
        const canKick = member.role !== 'owner' && member.id !== currentUserId;
        const joinedDate = member.joined_at ? 
          new Date(member.joined_at).toLocaleDateString('sv-SE') : 
          'Ok√§nt datum';
        
        return `
          <div class="member-item" data-member-id="${member.id}">
            <div class="member-info">
              <div class="member-name">${escapeHtml(member.username || 'Ok√§nt namn')}</div>
              <div class="member-meta">
                <span class="member-role ${member.role}">${member.role}</span>
                <span>üìÖ Gick med: ${joinedDate}</span>
                ${member.email ? `<span>üìß ${escapeHtml(member.email)}</span>` : ''}
              </div>
            </div>
            <div class="member-actions">
              ${canKick ? `
                <button class="kick-member-btn" onclick="kickMember(${member.id}, '${escapeHtml(member.username || 'medlem')}')">
                  Kicka
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = membersHtml;
    }


    // Kick member function
    // Kick member function
    async function kickMember(memberId, memberName) {
      if (!confirm(`√Ñr du s√§ker p√• att du vill kicka "${memberName}" fr√•n √§mnet? De kommer att f√∂rlora √•tkomst omedelbart.`)) {
        return;
      }
      
      const memberItem = document.querySelector(`[data-member-id="${memberId}"]`);
      const kickButton = memberItem?.querySelector('.kick-member-btn');
      
      try {
        // Disable button during request
        if (kickButton) {
          kickButton.disabled = true;
          kickButton.textContent = 'Kickar...';
        }
        
        const response = await fetch('/api/subject/kick_member', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            subject_id: subjectId,
            member_id: memberId
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          showAlert(`"${memberName}" har kickats fr√•n √§mnet`, 'success');
          
          // Remove member from DOM with animation
          if (memberItem) {
            memberItem.style.transition = 'opacity 0.3s ease';
            memberItem.style.opacity = '0';
            
            setTimeout(() => {
              memberItem.remove();
              
              // Update member count
              membersData = membersData.filter(m => m.id !== memberId);
              const countSpan = document.getElementById('members-list-count');
              if (countSpan) {
                countSpan.textContent = `${membersData.length} medlem${membersData.length !== 1 ? 'mar' : ''}`;
              }
              
              // Update main member count if visible
              loadMemberCount();
              
              // Show no members message if list is empty
              if (membersData.length === 0) {
                const container = document.getElementById('members-container');
                container.innerHTML = '<div class="no-members">Inga medlemmar kvar</div>';
              }
            }, 300);
          }
          
        } else {
          throw new Error(data.message || 'Kunde inte kicka medlem');
        }
        
      } catch (error) {
        console.error('Error kicking member:', error);
        showAlert(`Fel vid kickning av "${memberName}": ${error.message}`, 'error');
        
        // Re-enable button on error
        if (kickButton) {
          kickButton.disabled = false;
          kickButton.textContent = 'Kicka';
        }
      }
    }

    // File sharing functions
    async function loadSharedFiles() {
      try {
        const url = `/api/shared_files/${encodeURIComponent(currentSubject)}?_=${Date.now()}`;
        const response = await fetch(url, { cache: 'no-store' });
        const data = await response.json();
        if (data.status === 'success') {
          displayFiles(data.files);
          updateFileStats(data.total_files);
        } else {
          showNoFilesMessage(data.message);
        }
      } catch (error) {
        console.error('Error loading shared files:', error);
        showNoFilesMessage('Failed to load files');
      }
    }


    // FIXAD displayFiles funktion - meddelanden behandlas helt separat
    function displayFiles(files) {
      const fileList = document.getElementById('file-list');
      let noFilesMessage = document.getElementById('no-files-message');
      
      // Debug: logga vad vi f√•r fr√•n servern
      console.log('displayFiles called with:', files);
      
      if (!fileList) {
        console.error('file-list element not found');
        return;
      }
      
      // Skapa no-files-message om det inte finns
      if (!noFilesMessage) {
        console.log('Creating no-files-message element');
        noFilesMessage = document.createElement('div');
        noFilesMessage.id = 'no-files-message';
        noFilesMessage.className = 'no-files-message';
        fileList.appendChild(noFilesMessage);
      }
      
      if (files.length === 0) {
        noFilesMessage.style.display = 'block';
        noFilesMessage.textContent = 'Inga filer eller meddelanden har delats √§n.';
        fileList.innerHTML = '';
        return;
      }
      
      noFilesMessage.style.display = 'none';
      fileList.innerHTML = '';
      
      files.forEach(file => {
        console.log('Processing file:', file); // Debug log
        console.log('is_message:', file.is_message); // Extra debug f√∂r meddelanden
        
        const fileItem = document.createElement('div');
        fileItem.setAttribute('data-file-id', file.id);
        
        // VIKTIGT: Identifiera meddelanden baserat p√• filename = 'message' ELLER extension = ''
        const isMessage = (
          file.is_message === true || 
          file.is_message === 'true' || 
          file.filename === 'message' ||
          (file.extension === '' && file.filename && file.filename.includes('message'))
        );
        
        if (isMessage) {
          console.log('Rendering as MESSAGE for:', file.filename); // Debug
          
          fileItem.className = 'message-item';
          fileItem.innerHTML = `
            <div class="message-info">
              <div class="message-icon">üí¨</div>
              <div class="message-content">
                <div class="message-text">${escapeHtml(file.description || 'Meddelande')}</div>
                <div class="message-meta">
                  ${escapeHtml(file.uploader || 'Ok√§nd')} ‚Ä¢ ${escapeHtml(file.created_at || 'Ok√§nt datum')}
                </div>
              </div>
            </div>
            <div class="message-actions">
              ${file.can_delete ? `<button class="delete-file-btn" onclick="deleteFile(${file.id})">√ó</button>` : ''}
            </div>
          `;
        } else {
          console.log('Rendering as FILE'); // Debug
          
          fileItem.className = 'file-item';
          const extension = file.extension || '';
          const downloadCount = file.download_count || 0;
          const fileSize = file.file_size || 'Ok√§nd storlek';
          
          fileItem.innerHTML = `
            <div class="file-info">
              <div class="file-name">
                ${escapeHtml(file.filename || 'Ok√§nt filnamn')}
                ${extension ? `<span class="file-extension">${escapeHtml(extension.toUpperCase())}</span>` : ''}
                <span class="file-download-count">‚Üì ${downloadCount}</span>
              </div>
              <div class="file-meta">
                 ${escapeHtml(file.uploader || 'Ok√§nd')} ‚Ä¢ ${escapeHtml(fileSize)} ‚Ä¢ ${escapeHtml(file.created_at || 'Ok√§nt datum')}
              </div>
              ${file.description ? `<div class="file-description">${escapeHtml(file.description)}</div>` : ''}
            </div>
            <div class="file-actions">
              <a href="/view_shared_file/${file.id}" class="open-file-btn" target="_blank">√ñppna</a>
              <a href="/download_shared_file/${file.id}" class="download-btn">Ladda Ner</a>
              ${file.can_delete ? `<button class="delete-file-btn" onclick="deleteFile(${file.id})">√ó</button>` : ''}
            </div>
          `;
        }
        fileList.appendChild(fileItem);
      });
    }



    function showNoFilesMessage(message) {
      const noFilesMessage = document.getElementById('no-files-message');
      const fileList = document.getElementById('file-list');
      noFilesMessage.style.display = 'block';
      noFilesMessage.textContent = message;
      fileList.innerHTML = '';
    }

    function updateFileStats(totalFiles) {
      const fileStats = document.getElementById('file-stats');
      if (fileStats) {
        fileStats.textContent = `(${totalFiles} file${totalFiles !== 1 ? 's' : ''})`;
      }
    }

    // FIXED: Delete file function - properly removes from DOM
    async function deleteFile(fileId) {
      if (!confirm('Are you sure you want to delete this file?')) {
        return;
      }
      
      try {
        const response = await fetch('/delete_shared_file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            file_id: fileId
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          // FIXED: Remove the file item from DOM immediately
          const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
          if (fileItem) {
            // Add fade-out animation
            fileItem.style.transition = 'opacity 0.3s ease';
            fileItem.style.opacity = '0';
            
            // Remove after animation
            setTimeout(() => {
              fileItem.remove();
              
              // Update file count after removal
              const remainingFiles = document.querySelectorAll('.file-item').length;
              updateFileStats(remainingFiles);
              
              // Show no files message if no files left
              if (remainingFiles === 0) {
                showNoFilesMessage('No files have been shared yet.');
              }
            }, 300);
          }
          
          showUploadStatus('File deleted successfully!', 'success');
          
          // Update file statistics for owners
          if (userRole === 'owner') {
            loadFileStats();
          }
        } else {
          showUploadStatus('Error: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting file:', error);
        showUploadStatus('Succeded to delete file', 'error');
      }
    }

    function showUploadStatus(message, type) {
      const statusDiv = document.getElementById('upload-status');
      if (!statusDiv) return;
      
      statusDiv.textContent = message;
      statusDiv.className = `upload-status ${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide success/info messages after 3 seconds, errors after 5 seconds
      const hideDelay = (type === 'error') ? 5000 : 3000;
      setTimeout(() => {
        if (statusDiv.style.display === 'block') {
          statusDiv.style.display = 'none';
        }
      }, hideDelay);
    }

    function handleFiles(files) {
      if (uploadInProgress) return;
      
      // Om inga filer valts men det finns en beskrivning, skicka som meddelande
      const description = descriptionInput.value.trim();
      if (files.length === 0 && description) {
        sendMessageOnly(description);
        return;
      }
      
      if (files.length === 0) return;
      startUpload(files);
    }


    // COMPLETELY REWRITTEN FILE UPLOAD SYSTEM
    if (userRole === 'owner') {
      // Elementreferenser
      const fileInput    = document.getElementById('file-upload-input');
      const uploadArea   = document.getElementById('file-upload-area');
      const progressBar  = document.getElementById('progress-bar');
      const progressDiv  = document.getElementById('upload-progress');
      const descriptionInput = document.getElementById('file-description');

      let uploadInProgress = false;
      let abortController  = null;

      // Gemensam hanterare f√∂r b√•de drag & drop + filval
      function handleFiles(files) {
        if (uploadInProgress) return;
        
        // Om inga filer valts men det finns en beskrivning, skicka som meddelande
        const description = descriptionInput.value.trim();
        if (files.length === 0 && description) {
          sendMessageOnly(description);
          return;
        }
        
        if (files.length === 0) return;
        startUpload(files);
      }
  

      // Uppdaterad sendMessageOnly funktion med b√§ttre felhantering
      async function sendMessageOnly(message) {
        if (!message.trim()) {
          showUploadStatus('Skriv ett meddelande f√∂rst', 'error');
          return;
        }

        const descriptionInput = document.getElementById('file-description');
        if (!descriptionInput) {
          console.error('file-description element not found');
          showUploadStatus('Kunde inte hitta meddelandef√§lt', 'error');
          return;
        }

        uploadInProgress = true;
        showUploadStatus('Skickar meddelande...', 'info');

        try {
          console.log('Sending message:', message); // Debug log
          
          const response = await fetch('/send_message_only', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              subject: currentSubject,
              message: message
            })
          });

          const data = await response.json();
          console.log('Server response:', data); // Debug log

          if (data.status === 'success') {
            showUploadStatus('Meddelande skickat!', 'success');
            
            // Rensa beskrivning
            descriptionInput.value = '';
            
            // Uppdatera fillistan med en liten f√∂rdr√∂jning
            setTimeout(async () => {
              try {
                await loadSharedFiles();
              } catch (error) {
                console.error('Error reloading files after message:', error);
              }
            }, 500);
            
          } else {
            throw new Error(data.message || 'Kunde inte skicka meddelande');
          }
        } catch (error) {
          console.error('Error sending message:', error);
          showUploadStatus('Fel vid skickande: ' + error.message, 'error');
        } finally {
          uploadInProgress = false;
        }
      }

      // S√§kerst√§ll att escapeHtml funktionen finns
      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }


      // √ÑNDRING 4: L√§gg till event listener f√∂r "Skicka meddelande" knappen
      document.getElementById('send-message-btn').addEventListener('click', () => {
        const description = descriptionInput.value.trim();
        if (description) {
          sendMessageOnly(description);
        } else {
          showUploadStatus('Skriv ett meddelande f√∂rst', 'error');
        }
      });

      // Drag‚Äëover och drag‚Äëleave
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      uploadArea.addEventListener('dragleave', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
      });

      // Drop: h√§mta filerna och skicka dem
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        handleFiles(Array.from(e.dataTransfer.files));
      });

      // Filval via knapp
      fileInput.addEventListener('change', e => {
        handleFiles(Array.from(e.target.files));
      });

      async function startUpload(files) {
        uploadInProgress = true;
        abortController  = new AbortController();
        const desc       = descriptionInput.value.trim();

        progressDiv.style.display = 'block';
        progressBar.style.width   = '0%';
        showUploadStatus('F√∂rbereder uppladdning‚Ä¶', 'info');

        let success = 0, fail = 0;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > 50 * 1024 * 1024) {
            showUploadStatus(`"${file.name}" √§r f√∂r stor (>50MB)`, 'error');
            fail++;
            continue;
          }
          try {
            await uploadSingle(file, desc, i+1, files.length);
            success++;
          } catch (err) {
            showUploadStatus(`Misslyckades: "${file.name}" ‚Äì ${err.message}`, 'error');
            fail++;
          }
          if (abortController.signal.aborted) break;
        }

        const msg = success
          ? `Uppladdade ${success} fil${success>1?'er':''}` + (fail? `, ${fail} misslyckades` : '')
          : 'Inga filer laddades upp';
        showUploadStatus(msg, success && !fail ? 'success' : 'warning');

        // --- Rensa gamla och visa riktig placeholder med korrekt id ---
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '<div id="no-files-message">Laddar filer‚Ä¶</div>';

        // F√∂rs√∂k h√§mta om filerna ‚Äì ta bort placeholder i finally-blocket
        try {
          await loadSharedFiles();
        } catch (e) {
          console.error('loadSharedFiles failed:', e);
        } finally {
          const placeholder = document.getElementById('no-files-message');
          if (placeholder) placeholder.remove();
        }

        // √Öterst√§ll input & progress
        fileInput.value        = '';
        descriptionInput.value = '';
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width   = '0%';
          uploadInProgress          = false;
          abortController           = null;
        }, 800);
      }



      function uploadSingle(file, description, index, total) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const form = new FormData();
          form.append('file', file);
          form.append('subject', currentSubject);
          form.append('description', description);

          // Avbryt-st√∂d
          abortController.signal.addEventListener('abort', () => {
            xhr.abort();
            reject(new Error('Avbrutet'));
          });

          // Progress
          xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded/e.total)*100);
              progressBar.style.width = pct + '%';
              showUploadStatus(`Uppladdar ${index}/${total}: ${file.name} (${pct}%)`, 'info');
            }
          };

          // Klart
          xhr.onload = () => {
            if (xhr.status === 200) {
              const resp = JSON.parse(xhr.responseText);
              if (resp.status==='success') return resolve();
              else return reject(new Error(resp.message||'Server avvisade'));
            }
            reject(new Error(`Serverfel ${xhr.status}`));
          };
          xhr.onerror = () => reject(new Error('N√§tverksfel'));
          xhr.timeout = 300000;

          xhr.open('POST','/upload_shared_file');
          xhr.send(form);
        });
      }

      // Load file statistics for owners
      async function loadFileStats() {
        try {
          const response = await fetch(`/api/shared_files/${subjectId}/stats`);
          const data = await response.json();
          
          if (data.status === 'success') {
            const statsDiv = document.getElementById('file-stats-details');
            if (statsDiv) {
              statsDiv.innerHTML = `
                Antal nedladdningar: ${data.total_downloads}
              `;
              statsDiv.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Error loading file stats:', error);
        }
      }
      
      loadFileStats();
    }



    // Load member count when page loads
    if (userRole === 'owner') {
      loadMemberCount();
    }
    
    // Load shared files when page loads
    loadSharedFiles();
























    // Lesson management variables
    let currentLesson = null;
    let lessons = [];

    // Initialize lesson functionality
    document.addEventListener('DOMContentLoaded', function() {
      if (userRole === 'owner') {
        initializeLessonUpload();
        loadLessonStats();
      }
      loadLessons();
    });

    function initializeLessonUpload() {

      
      const titleInput = document.getElementById('lesson-title');
      const dateInput = document.getElementById('lesson-date');
      const fileInput = document.getElementById('lesson-upload-input');
      const uploadBtn = document.getElementById('upload-lesson-btn');
      const uploadArea = document.getElementById('lesson-upload-area');
  
      // Set default date to today
      dateInput.valueAsDate = new Date();
  
      // Enable upload button when all required fields are filled
      function checkFormValidity() {
        const title = titleInput.value.trim();
        const date = dateInput.value;
        const file = fileInput.files[0];
    
        uploadBtn.disabled = !(title && date && file);
      }
  
      titleInput.addEventListener('input', checkFormValidity);
      dateInput.addEventListener('change', checkFormValidity);
      fileInput.addEventListener('change', checkFormValidity);
  
      // Drag and drop functionality
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
  
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });

      fileInput.addEventListener('change', e => {
        const files = Array.from(e.target.files);
        updateLessonFileNameDisplay(files);
        checkFormValidity();
      });
  
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        const files = Array.from(e.dataTransfer.files);
        fileInput.files = e.dataTransfer.files; // s√• FormData plockar upp dem
        updateLessonFileNameDisplay(files);
        checkFormValidity();
      });
  
      // Upload button click handler
      uploadBtn.addEventListener('click', uploadLesson);
    }

    async function uploadLesson() {
        const titleInput = document.getElementById('lesson-title');
        const dateInput = document.getElementById('lesson-date');
        const descriptionInput = document.getElementById('lesson-description');
        const fileInput = document.getElementById('lesson-upload-input');
        const uploadBtn = document.getElementById('upload-lesson-btn');
        const progressDiv = document.getElementById('lesson-upload-progress');
        const progressBar = document.getElementById('lesson-progress-bar');
        const statusDiv = document.getElementById('lesson-upload-status');

        const title = titleInput.value.trim();
        const date = dateInput.value;
        const description = descriptionInput.value.trim();
        const file = fileInput.files[0];

        if (!title || !date || !file) {
            showAlert('V√§nligen fyll i alla obligatoriska f√§lt', 'error');
            return;
        }

        // File size check (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('Filen √§r f√∂r stor. Max storlek √§r 500MB.', 'error');
            return;
        }

        if (!subjectId) {
            showAlert('Kunde inte identifiera √§mne', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('subject_id', subjectId);
        formData.append('title', title);
        formData.append('lesson_date', date);
        if (description) {
            formData.append('description', description);
        }

        // Show progress
        uploadBtn.disabled = true;
        progressDiv.style.display = 'block';
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Laddar upp...';
        statusDiv.className = 'upload-status';

        try {
            const xhr = new XMLHttpRequest();

            // Upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    statusDiv.textContent = `Laddar upp... ${Math.round(percentComplete)}%`;
                }
            });

            // Handle response
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            statusDiv.textContent = 'Uppladdning slutf√∂rd!';
                            statusDiv.className = 'upload-status success';

                            // Reset form
                            titleInput.value = '';
                            descriptionInput.value = '';
                            fileInput.value = '';
                            dateInput.valueAsDate = new Date();

                            // Reload lessons
                            loadLessons().then(() => {
                                // F√ñRB√ÑTTRAT: Starta transkriberingspoll f√∂r den nya lektionen
                                if (response.lesson_id) {
                                    console.log('Starting transcription check for new lesson:', response.lesson_id);
                                    // V√§nta lite s√• att lektionen hinner laddas i listan
                                    setTimeout(() => {
                                        startTranscriptionCheck(response.lesson_id);
                                    }, 2000);
                                }
                            });
                            
                            if (userRole === 'owner') {
                                loadLessonStats();
                            }

                            showAlert('Lektion uppladdad! Transkribering startar automatiskt.', 'success');
                        } else {
                            throw new Error(response.message || 'Uppladdning misslyckades');
                        }
                    } catch (e) {
                        throw new Error('Invalid server response: ' + xhr.responseText.substring(0, 100));
                    }
                } else if (xhr.status === 404) {
                    throw new Error('Upload endpoint not found. Check your Flask routes.');
                } else {
                    throw new Error(`Server error ${xhr.status}: ${xhr.statusText}`);
                }
            });

            xhr.addEventListener('error', (e) => {
                console.error('XHR error:', e);
                throw new Error('N√§tverksfel vid uppladdning');
            });

            xhr.open('POST', '/upload_lesson');
            xhr.send(formData);

        } catch (error) {
            console.error('Upload error:', error);
            statusDiv.textContent = 'Fel vid uppladdning: ' + error.message;
            statusDiv.className = 'upload-status error';
            showAlert('Fel vid uppladdning: ' + error.message, 'error');
        } finally {
            // Hide progress after a delay
            setTimeout(() => {
                progressDiv.style.display = 'none';
                statusDiv.style.display = 'none';
                uploadBtn.disabled = false;
                progressBar.style.width = '0%';
            }, 3000);
        }
      document.getElementById('lesson-file-name').textContent = '';

    }











    function updateLessonFileNameDisplay(files) {
      const nameDiv = document.getElementById('lesson-file-name');
      if (!files || files.length === 0) {
        nameDiv.textContent = ''; 
      } else if (files.length === 1) {
        nameDiv.textContent = `Fil vald: ${files[0].name}`;
      } else {
        const names = Array.from(files).map(f => f.name).join(', ');
        nameDiv.textContent = `Filer valda: ${names}`;
      }
    }
      



    // F√∂rb√§ttrad loadLessons som startar transcription polling f√∂r processing lektioner
    // F√∂rb√§ttrad loadLessons som startar transcription polling f√∂r processing lektioner
    async function loadLessons() {
        try {
            console.log('Loading lessons for subject:', subjectId);
            const response = await fetch(`/api/lessons/${subjectId}`);
        
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        
            const text = await response.text();
            console.log('Response text:', text);
        
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
            }
        
            if (data.status === 'success') {
                lessons = data.lessons;
                renderLessons(lessons);
                console.log('Successfully loaded', lessons.length, 'lessons');
                
                // NYTT: Starta automatisk polling f√∂r lektioner som h√•ller p√• att transkriberas
                const processingLessons = lessons.filter(lesson => 
                    lesson.transcription_status === 'processing' || 
                    lesson.transcription_status === 'pending'
                );
                
                if (processingLessons.length > 0) {
                    console.log(`Found ${processingLessons.length} lessons with pending/processing transcription`);
                    // Starta polling f√∂r den senaste processing-lektionen
                    const latestProcessing = processingLessons[0];
                    startTranscriptionCheck(latestProcessing.id);
                }
                
            } else {
                throw new Error(data.message || 'Kunde inte ladda lektioner');
            }
        } catch (error) {
            console.error('Error loading lessons:', error);
            const timeline = document.getElementById('lesson-timeline');
            if (timeline) {
                timeline.innerHTML = `
                    <div class="no-lessons-message error">
                        Fel vid laddning av lektioner: ${error.message}
                    </div>
                `;
            }
            showAlert('Kunde inte ladda lektioner: ' + error.message, 'error');
        }
    }




    document.addEventListener('DOMContentLoaded', function() {
      // St√§ng modal vid klick utanf√∂r inneh√•llet
      const modal = document.getElementById('lesson-player-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeLessonPlayer();
          }
        });
      }
  
      // St√§ng modal med Escape-tangent
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      });
    });





    let transcriptionCheckInterval = null;

    
    // F√∂rb√§ttrad startTranscriptionCheck med mer responsiv uppdatering
    function startTranscriptionCheck(lessonId) {  
        // Stoppa eventuell p√•g√•ende polling
        if (transcriptionCheckInterval) {
            clearInterval(transcriptionCheckInterval);
        }

        let checkCount = 0;
        const maxChecks = 60; // √ñka till 10 minuter (60 * 10 sekunder)

        console.log(`Starting transcription polling for lesson ${lessonId}`);

        transcriptionCheckInterval = setInterval(async () => {
            checkCount++;
            
            if (checkCount > maxChecks) {
                console.log('Transcription check timeout - stopping polling');
                clearInterval(transcriptionCheckInterval);
                transcriptionCheckInterval = null;
                return;
            }

            try {
                // H√§mta transkriberingsstatus
                const response = await fetch(`/api/lesson/${lessonId}/transcription`);
                const data = await response.json();

                if (data.status === 'success') {
                    const newStatus = data.transcription_status;
                    const previousStatus = getCurrentLessonStatus(lessonId);
                    
                    console.log(`Transcription status for lesson ${lessonId}: ${previousStatus} -> ${newStatus}`);
                    
                    // VIKTIGT: Uppdatera currentLesson om det √§r samma lektion
                    if (currentLesson && currentLesson.id === lessonId) {
                        currentLesson.transcription_status = newStatus;
                        currentLesson.transcription = data.transcription;
                        // Uppdatera modal-transkriptionen omedelbart
                        await loadTranscription(lessonId);
                    }

                    // Uppdatera lektionen i listan
                    updateLessonInList(lessonId, { 
                        transcription_status: newStatus,
                        transcription: data.transcription 
                    });

                    // VIKTIGT: Uppdatera DOM-elementet direkt ocks√•
                    updateTranscriptionIndicatorInDOM(lessonId, newStatus);

                    // Stop the interval if transcription is completed or failed
                    if (newStatus === 'completed' || newStatus === 'failed') {
                        console.log(`Transcription ${newStatus} for lesson ${lessonId} - stopping polling`);
                        clearInterval(transcriptionCheckInterval);
                        transcriptionCheckInterval = null;
                        
                        // Visa meddelande om det √§r klart
                        if (newStatus === 'completed' && previousStatus !== 'completed') {
                            showAlert('Transkribering klar!', 'success');
                        } else if (newStatus === 'failed' && previousStatus !== 'failed') {
                            showAlert('Transkribering misslyckades', 'error');
                        }
                    }
                }
            } catch (error) {
                console.error('Error checking transcription status:', error);
            }
        }, 5000); // Minska till 5 sekunder f√∂r snabbare uppdateringar
    }












    function renderLessons(lessonsData) {
      const timeline = document.getElementById('lesson-timeline');

      if (!lessonsData || lessonsData.length === 0) {
        timeline.innerHTML = `
          <div class="no-lessons-message">
            Inga lektioner har lagts till √§n.
          </div>
        `;
        return;
      }

      // Sortera lektioner s√• att de nyaste kommer f√∂rst
      const sortedLessons = [...lessonsData].sort((a, b) => {
        // F√∂rst sortera p√• lesson_date (nyaste datum f√∂rst)
        const dateA = new Date(a.lesson_date);
        const dateB = new Date(b.lesson_date);
        
        if (dateA.getTime() !== dateB.getTime()) {
          return dateB.getTime() - dateA.getTime(); // Nyaste f√∂rst
        }
        
        // Om samma datum, sortera p√• ID (h√∂gre ID = nyare)
        return (b.id || 0) - (a.id || 0);
      });

      const lessonsHtml = sortedLessons.map(lesson => {
        const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
        const isAudio = lesson.file_type && lesson.file_type.startsWith('audio/');
        const iconClass = isVideo ? 'video' : isAudio ? 'audio' : '';
        const icon = isVideo ? 'üé•' : isAudio ? 'üéµ' : 'üìÅ';

        const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
          day: 'numeric',
          month: 'short'
        });

        // Transkriptionsstatus-indikator
        let transcriptionIndicator = '';
        if (lesson.transcription_status === 'completed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator completed">üìù Transkriberad</div>';
        } else if (lesson.transcription_status === 'processing') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator processing">‚è≥ Transkriberar...</div>';
        } else if (lesson.transcription_status === 'failed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator failed">‚ùå Transkription misslyckades</div>';
        }

        return `
          <div class="lesson-item" onclick="openLessonPlayer(${lesson.id})">
            <div class="lesson-date-badge">${formattedDate}</div>
            <div class="lesson-type-icon ${iconClass}">${icon}</div>
            <div class="lesson-content">
              <div class="lesson-title">${escapeHtml(lesson.title)}</div>
              <div class="lesson-meta">
                <span>üìÅ ${lesson.display_size}</span>
                <span>
              </div>
            </div>
            ${lesson.can_edit ? `
              <div class="lesson-actions" onclick="event.stopPropagation()">
                <button class="lesson-action-btn delete" onclick="deleteLesson(${lesson.id})">
                  Ta bort
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      timeline.innerHTML = lessonsHtml;
    }






    async function openLessonPlayer(lessonId) {
  try {
    const lesson = lessons.find(l => l.id === lessonId);
    if (!lesson) {
      showAlert('Lektion hittades inte', 'error');
      return;
    }

    currentLesson = lesson;

    // Update modal content
    document.getElementById('lesson-player-title').textContent = lesson.title;
    document.getElementById('lesson-player-description').textContent = lesson.description || '';

    const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })

    document.getElementById('lesson-player-date').textContent = `üìÖ ${formattedDate}`;
    document.getElementById('lesson-player-size').textContent = `üìÅ ${lesson.display_size}`;

    // Create player
    const playerContainer = document.getElementById('lesson-player-container');
    const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
    const streamUrl = `/stream_lesson/${lesson.id}`;

    if (isVideo) {
      playerContainer.innerHTML = `
        <video controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbl√§sare st√∂der inte video.
        </video>
      `;
    } else {
      playerContainer.innerHTML = `
        <audio controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbl√§sare st√∂der inte ljud.
        </audio>
      `;
    }

    // Setup download link
    const downloadLink = document.getElementById('lesson-download-link');
    downloadLink.href = `/download_lesson/${lesson.id}`;
    downloadLink.download = lesson.filename;

    // Show/hide delete button
    const deleteBtn = document.getElementById('lesson-delete-btn');
    if (lesson.can_edit) {
      deleteBtn.style.display = 'inline-block';
    } else {
      deleteBtn.style.display = 'none';
    }

    // FIXED: Load transcription with proper function name
    await loadTranscription(lesson.id);
    
    // Start auto-refresh if transcription is processing
    if (lesson.transcription_status === 'processing' || lesson.transcription_status === 'pending') {
      startTranscriptionCheck(lesson.id);
    }

    // Show modal
    document.getElementById('lesson-player-modal').style.display = 'flex';

  } catch (error) {
    console.error('Error opening lesson player:', error);
    showAlert('Kunde inte √∂ppna lektion: ' + error.message, 'error');
  }
}








    // Function to add transcription search functionality
function addTranscriptionSearch() {
  const transcriptionSection = document.querySelector('.lesson-transcription-section');
  if (!transcriptionSection) return;

  // Check if search already exists
  if (document.getElementById('transcription-search-input')) return;

  const searchHtml = `
    <div class="transcription-search" style="margin-bottom: 10px;">
      <input type="text" id="transcription-search-input" placeholder="S√∂k i transkription..." 
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
  `;

  const header = transcriptionSection.querySelector('.transcription-header');
  if (header) {
    header.insertAdjacentHTML('afterend', searchHtml);

    // Add search functionality
    const searchInput = document.getElementById('transcription-search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        highlightTranscriptionText(this.value);
      });
    }
  }
}

function highlightTranscriptionText(searchTerm) {
  const transcriptionText = document.querySelector('.transcription-text');
  if (!transcriptionText || !searchTerm) {
    if (transcriptionText) {
      // Reset highlighting if no search term
      const originalText = transcriptionText.getAttribute('data-original-text');
      if (originalText) {
        transcriptionText.innerHTML = escapeHtml(originalText);
      }
    }
    return;
  }

  // Store original text if not already stored
  if (!transcriptionText.getAttribute('data-original-text')) {
    transcriptionText.setAttribute('data-original-text', transcriptionText.textContent || transcriptionText.innerText);
  }

  const originalText = transcriptionText.getAttribute('data-original-text');
  if (!originalText) return;

  if (searchTerm.trim() === '') {
    transcriptionText.innerHTML = escapeHtml(originalText);
    return;
  }

  const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
  const highlightedText = escapeHtml(originalText).replace(regex, '<mark style="background-color: yellow; padding: 2px;">$1</mark>');
  transcriptionText.innerHTML = highlightedText;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

    // Export functions if using modules (optional)
    if (typeof module !== 'undefined' && module.exports) {
      module.exports = {
        loadTranscription,
        retryTranscription,
        openLessonPlayer,
        closeLessonPlayer,
        deleteCurrentLesson,
        deleteLesson,
        renderLessons,
        getTranscriptionStatusText
      };
    }












    function formatTranscriptionText(text) {
      if (!text) return '';
  
      // Grundl√§ggande formatering
      return text
        .replace(/\n/g, '<br>')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
        .trim();
    }


    function closeLessonPlayer() {
      const modal = document.getElementById('lesson-player-modal');
      const playerContainer = document.getElementById('lesson-player-container');

      // Stop any playing media
      const media = playerContainer.querySelector('video, audio');
      if (media) {
        media.pause();
        media.currentTime = 0;
      }

      // Clear player
      playerContainer.innerHTML = '';

      // Hide modal
      modal.style.display = 'none';
      currentLesson = null;

      // Clear any running transcription check interval
      if (transcriptionCheckInterval) {
        clearInterval(transcriptionCheckInterval);
        transcriptionCheckInterval = null;
      }
    }

        async function deleteLesson(lessonId) {
          if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna lektion?')) {
            return;
          }
      
          try {
            const response = await fetch('/delete_lesson', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                lesson_id: lessonId
              })
            });
        
            const data = await response.json();
        
            if (data.status === 'success') {
              showAlert('Lektion borttagen', 'success');
              loadLessons();
              if (userRole === 'owner') {
                loadLessonStats();
              }
          
              // Close modal if this lesson is currently open
              if (currentLesson && currentLesson.id === lessonId) {
                closeLessonPlayer();
              }
            } else {
              throw new Error(data.message || 'Kunde inte ta bort lektion');
            }
        
          } catch (error) {
            console.error('Error deleting lesson:', error);
            showAlert('Fel vid borttagning: ' + error.message, 'error');
          }
        }


    async function debugTranscription(lessonId) {
  console.log('Testing transcription for lesson:', lessonId);
  
  try {
    const response = await fetch(`/api/lesson/${lessonId}/retranscribe`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const result = await response.json();
    console.log('Transcription start result:', result);
    
    if (result.status === 'success') {
      startTranscriptionCheck(lessonId);
    }
  } catch (error) {
    console.error('Debug transcription error:', error);
  }
}
window.debugTranscription = debugTranscription;

    async function deleteCurrentLesson() {
      if (!currentLesson) return;
  
      const confirmDelete = confirm(`√Ñr du s√§ker p√• att du vill ta bort lektionen "${currentLesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
        method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: currentLesson.id
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          closeLessonPlayer();
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }


    // Funktion f√∂r att ta bort lektion fr√•n listan (utan att √∂ppna player)
    async function deleteLesson(lessonId, event) {
      if (event) {
        event.stopPropagation();
      }
  
      const lesson = lessons.find(l => l.id === lessonId);
      if (!lesson) {
        showAlert('Lektion hittades inte', 'error');
        return;
      }
  
      const confirmDelete = confirm(`√Ñr du s√§ker p√• att du vill ta bort lektionen "${lesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: lessonId
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }





    async function loadLessonStats() {
      if (userRole !== 'owner') return;
  
      try {
        const response = await fetch(`/api/lessons/${subjectId}/stats`);
        const data = await response.json();
    
        if (data.status === 'success') {
          const statsText = ` ${data.total_lessons}`;
          document.getElementById('lesson-stats').textContent = statsText;
      
          
        }
      } catch (error) {
        console.error('Error loading lesson stats:', error);
      }
    }




    async function loadTranscription(lessonId) {
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');
  const retryBtn = document.getElementById('retry-transcription-btn');

  if (!statusSpan || !contentDiv) {
    console.warn('Transcription elements not found in DOM');
    return;
  }

  try {
    const response = await fetch(`/api/lesson/${lessonId}/transcription`);
    const data = await response.json();

    console.log('Transcription data:', data); // Debug log

    if (data.status === 'success') {
      // Update status
      statusSpan.textContent = getTranscriptionStatusText(data.transcription_status);
      statusSpan.className = `transcription-status ${data.transcription_status}`;

      // Update content based on status
      if (data.transcription_status === 'completed' && data.transcription) {
        contentDiv.innerHTML = `<div class="transcription-text">${escapeHtml(data.transcription)}</div>`;
        if (retryBtn) retryBtn.style.display = 'none';
        
        // Add search functionality if transcription is completed
        addTranscriptionSearch();
        
      } else if (data.transcription_status === 'processing') {
        contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering p√•g√•r...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
      } else if (data.transcription_status === 'failed') {
        contentDiv.innerHTML = '<div class="transcription-empty">‚ùå Transkribering misslyckades</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
        
      } else if (data.transcription_status === 'pending') {
        contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering √§r schemalagd...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
        // F√∂r pending status, f√∂rs√∂k starta transkribering automatiskt
        if (currentLesson && currentLesson.can_edit) {
          console.log('Auto-starting transcription for pending lesson');
          setTimeout(() => {
            fetch(`/api/lesson/${lessonId}/retranscribe`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'}
            }).then(response => response.json())
              .then(result => {
                if (result.status === 'success') {
                  console.log('Auto-transcription started');
                  // Starta om polling
                  startTranscriptionCheck(lessonId);
                }
              })
              .catch(err => console.log('Auto-start failed:', err));
          }, 2000); // V√§nta 2 sekunder innan auto-start
        }
        
      } else {
        contentDiv.innerHTML = '<div class="transcription-empty">Ingen transkription tillg√§nglig</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
      }
    } else {
      contentDiv.innerHTML = '<div class="transcription-empty">Kunde inte ladda transkription</div>';
      if (retryBtn && currentLesson && currentLesson.can_edit) {
        retryBtn.style.display = 'block';
      }
    }

  } catch (error) {
    console.error('Error loading transcription:', error);
    contentDiv.innerHTML = '<div class="transcription-empty">Fel vid laddning av transkription</div>';
    if (retryBtn && currentLesson && currentLesson.can_edit) {
      retryBtn.style.display = 'block';
    }
  }
}


    // NY: Funktion f√∂r att f√∂rs√∂ka transkribera igen
    async function retryTranscription() {
  if (!currentLesson) return;

  const retryBtn = document.getElementById('retry-transcription-btn');
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');

  try {
    retryBtn.disabled = true;
    retryBtn.textContent = 'Startar...';

    const response = await fetch(`/api/lesson/${currentLesson.id}/retranscribe`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (data.status === 'success') {
      showAlert('Transkribering startad om', 'success');
      statusSpan.textContent = 'Bearbetar...';
      statusSpan.className = 'transcription-status processing';
      contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering p√•g√•r...</div>';
      retryBtn.style.display = 'none';
  
      // Reload lessons to update status
      loadLessons();
  
      // Start checking status again
      startTranscriptionCheck(currentLesson.id);
    } else {
      showAlert('Kunde inte starta transkribering: ' + data.message, 'error');
      retryBtn.disabled = false;
      retryBtn.textContent = 'F√∂rs√∂k igen';
    }

  } catch (error) {
    console.error('Error retrying transcription:', error);
    showAlert('Fel vid omstart av transkribering', 'error');
    retryBtn.disabled = false;
    retryBtn.textContent = 'F√∂rs√∂k igen';
  }
}




    // Hj√§lpfunktion f√∂r att f√• statustext
    function getTranscriptionStatusText(status) {
  switch (status) {
    case 'pending': return 'V√§ntar';
    case 'processing': return 'Bearbetar';
    case 'completed': return 'Klar';
    case 'failed': return 'Misslyckades';
    default: return 'Ok√§nd';
  }
}

    // Funktion f√∂r att st√§nga lesson player
    function closeLessonPlayer() {
      const modal = document.getElementById('lesson-player-modal');
      modal.style.display = 'none';
  
      // Stoppa video/audio
      const playerContainer = document.getElementById('lesson-player-container');
      const video = playerContainer.querySelector('video');
      const audio = playerContainer.querySelector('audio');
  
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
  
      currentLesson = null;
    }


















    function showAlert(message, type = 'info') {
        // Skapa eller anv√§nd befintligt alert-element
        let alertDiv = document.getElementById('global-alert');
        if (!alertDiv) {
            alertDiv = document.createElement('div');
            alertDiv.id = 'global-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                font-weight: 500;
            `;
            document.body.appendChild(alertDiv);
        }
    
        // F√§rger baserat p√• typ
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
    
        const color = colors[type] || colors.info;
        alertDiv.style.backgroundColor = color.bg;
        alertDiv.style.borderLeft = `4px solid ${color.border}`;
        alertDiv.style.color = color.text;
        alertDiv.textContent = message;
        alertDiv.style.display = 'block';
    
        // D√∂lj efter 5 sekunder
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }



    // Utility function to escape HTML
    function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('lesson-player-modal');
      if (e.target === modal) {
        closeLessonPlayer();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('lesson-player-modal');
        if (modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      }
    });
























    




  </script>

</body>
</html>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="{{ url_for('static', filename='js/subject.js') }}"></script>
  <script>
    // Globala variabler som subject.js beh√∂ver
    const currentSubject = '{{ subject_name|safe }}';
    const currentUserId = '{{ current_user.id }}';
    const subjectId = {{ subject.id }};
    const userRole = '{{ user_role }}';
    
    // Eventuella befintliga quiz-data (f√∂r bak√•tkompatibilitet)
    {% if quizzes %}
    const initialQuizzes = {{ quizzes|tojson|safe }};
    {% else %}
    const initialQuizzes = [];
    {% endif %}
    
    // Befintliga dokument (f√∂r bak√•tkompatibilitet)
    {% if krav_docs %}
    const initialDocuments = {{ krav_docs|tojson|safe }};
    {% else %}
    const initialDocuments = [];
    {% endif %}

    // Share code functions
    async function copyShareCode() {
      const shareCode = document.getElementById('share-code-display').textContent;
      const copyButton = document.querySelector('.copy-button');
      
      try {
        await navigator.clipboard.writeText(shareCode);
        copyButton.textContent = 'Copied!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = shareCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        copyButton.textContent = 'Copied!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      }
    }






































    // Krav Document Management Functions
    // These handle curriculum documents (kunskapskrav, kunskapsm√•l, begrippslista)

    let kravUploadInProgress = false;

    // Initialize krav document functionality
    function initializeKravDocuments() {
        if (userRole !== 'owner' && userRole !== 'admin') return; // Only owners/admins can manage krav documents
        
        setupKravDocumentUpload();
        setupKravDocumentRemoval();
        loadExistingKravDocuments();
    }

    // Setup krav document upload functionality
    function setupKravDocumentUpload() {
        // Setup file input change handler
        const pdfUploadInput = document.getElementById('pdf-upload');
        if (pdfUploadInput) {
            pdfUploadInput.addEventListener('change', handleKravFileSelection);
        }
        
        // Setup document type selector
        const docTypeSelector = document.getElementById('document-type');
        if (docTypeSelector) {
            // Set default selection if needed
            if (!docTypeSelector.value) {
                docTypeSelector.value = 'begrippslista';
            }
        }
    }

    // Handle file selection for krav documents
    async function handleKravFileSelection(event) {
        const files = event.target.files;
        const docTypeSelector = document.getElementById('document-type');
        
        if (!files.length || !docTypeSelector) {
            return;
        }
        
        const selectedDocType = docTypeSelector.value;
        
        // Process each selected file
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            await uploadKravDocument(selectedDocType, file);
        }
        
        // Clear the file input after upload
        event.target.value = '';
    }

    // Upload krav document
    async function uploadKravDocument(docType, file) {
        if (kravUploadInProgress) {
            showKravStatus('Upload already in progress', 'warning');
            return;
        }
        
        // Validate file
        if (!file) {
            showKravStatus('Please select a file', 'error');
            return;
        }
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showKravStatus('Only PDF files are allowed', 'error');
            return;
        }
        
        if (file.size > 50 * 1024 * 1024) { // 50MB limit
            showKravStatus('File too large. Maximum size is 50MB', 'error');
            return;
        }
        
        // Validate document type
        const allowedTypes = ['begrippslista', 'kunskapskrav', 'kunskapsmal'];
        if (!allowedTypes.includes(docType)) {
            showKravStatus('Invalid document type', 'error');
            return;
        }
        
        kravUploadInProgress = true;
        
        try {
            showKravStatus(`Uploading ${docType}...`, 'info');
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('subject', currentSubject);
            formData.append('type', docType);
            
            // Upload with progress tracking
            const response = await uploadKravWithProgress(formData, docType);
            
            if (response.status === 'success') {
                showKravStatus(`${docType} uploaded successfully!`, 'success');
                
                // Update the documents display
                await refreshKravDocuments();
                
            } else {
                throw new Error(response.message || 'Upload failed');
            }
            
        } catch (error) {
            console.error('Krav document upload error:', error);
            showKravStatus(`Upload failed: ${error.message}`, 'error');
        } finally {
            kravUploadInProgress = false;
        }
    }

    // Upload with progress tracking
    function uploadKravWithProgress(formData, docType) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            // Progress handler
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    showKravStatus(`Uploading ${docType}... ${percentComplete}%`, 'info');
                }
            });
            
            // Success handler
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response);
                    } catch (e) {
                        reject(new Error('Invalid server response'));
                    }
                } else {
                    reject(new Error(`Server error ${xhr.status}`));
                }
            });
            
            // Error handler
            xhr.addEventListener('error', () => {
                reject(new Error('Network error during upload'));
            });
            
            // Send request
            xhr.open('POST', '/upload_krav_pdf');
            xhr.send(formData);
        });
    }

    // Setup removal functionality
    function setupKravDocumentRemoval() {
        // Use event delegation for remove buttons
        document.addEventListener('click', function(e) {
            const removeButton = e.target.closest('.remove-document');
            if (removeButton && removeButton.dataset.docType) {
                e.preventDefault();
                e.stopPropagation();
                
                const docType = removeButton.getAttribute('data-doc-type');
                const docId = removeButton.getAttribute('data-doc-id');
                
                if (docType) {
                    removeKravDocument(docType, docId);
                }
            }
        });
    }

    

    // Refresh krav documents display
    async function refreshKravDocuments() {
        await loadExistingKravDocuments();
    }

   

    // Show krav status messages
    function showKravStatus(message, type = 'info') {
        // Try to use existing status div first
        let statusDiv = document.getElementById('krav-upload-status');
        
        // If no dedicated krav status div, create one
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'krav-upload-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 4px;
                z-index: 1000;
                max-width: 300px;
                font-weight: 500;
                display: none;
            `;
            document.body.appendChild(statusDiv);
        }
        
        // Set colors based on type
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
        
        const color = colors[type] || colors.info;
        statusDiv.style.backgroundColor = color.bg;
        statusDiv.style.borderLeft = `4px solid ${color.border}`;
        statusDiv.style.color = color.text;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Auto-hide after delay
        const hideDelay = (type === 'error') ? 5000 : 3000;
        setTimeout(() => {
            if (statusDiv.style.display === 'block') {
                statusDiv.style.display = 'none';
            }
        }, hideDelay);
    }

    // Utility function to escape HTML (reuse existing if available)
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof userRole !== 'undefined' && (userRole === 'owner' || userRole === 'admin')) {
            initializeKravDocuments();
            if (typeof initialDocuments !== 'undefined') {
             updateDocTypeOptions(initialDocuments);
            }

        }
    });

    // Export functions for external use
    if (typeof window !== 'undefined') {
        window.uploadKravDocument = uploadKravDocument;
        window.removeKravDocument = removeKravDocument;
        window.refreshKravDocuments = refreshKravDocuments;
        window.initializeKravDocuments = initializeKravDocuments;
    }






    function toggleDescription(button) {
      const descriptionDiv = button.closest('.quiz-description');
      const textSpan = descriptionDiv.querySelector('.description-text');
      const expandText = button.querySelector('.expand-text');
      const collapseText = button.querySelector('.collapse-text');
      const fullText = descriptionDiv.getAttribute('data-full-text');
  
      if (expandText.style.display !== 'none') {
        // Expandera
        textSpan.textContent = fullText;
        expandText.style.display = 'none';
        collapseText.style.display = 'inline';
        descriptionDiv.classList.add('description-expanded');
      } else {
        // Kollapsa
        textSpan.textContent = fullText.substring(0, 100) + (fullText.length > 100 ? '...' : '');
        expandText.style.display = 'inline';
        collapseText.style.display = 'none';
        descriptionDiv.classList.remove('description-expanded');
      }
    }














    async function toggleSharing() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/share`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          location.reload(); // Reload to update the UI
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error toggling sharing:', error);
        alert('Failed to toggle sharing');
      }
    }

    async function regenerateCode() {
      if (!confirm('Are you sure you want to regenerate the share code? The old code will no longer work.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/subject/${subjectId}/regenerate_code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('share-code-display').textContent = data.share_code;
          alert('Share code regenerated successfully!');
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error regenerating code:', error);
        alert('Failed to regenerate code');
      }
    }

    // Update the existing loadMemberCount function to be more detailed
    async function loadMemberCount() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/members`);
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('members-count').textContent = 
            `üë• ${data.total_members} medlem${data.total_members !== 1 ? 'mar' : ''}`;
        }
      } catch (error) {
        console.error('Error loading member count:', error);
        document.getElementById('members-count').textContent = 'üë• Medlem antal ej tillg√§ngligt';
      }
    }


    // File sharing functions
    async function loadSharedFiles() {
      try {
        const url = `/api/shared_files/${encodeURIComponent(currentSubject)}?_=${Date.now()}`;
        const response = await fetch(url, { cache: 'no-store' });
        const data = await response.json();
        if (data.status === 'success') {
          displayFiles(data.files);
          updateFileStats(data.total_files);
        } else {
          showNoFilesMessage(data.message);
        }
      } catch (error) {
        console.error('Error loading shared files:', error);
        showNoFilesMessage('Failed to load files');
      }
    }


    

    function showNoFilesMessage(message) {
      const noFilesMessage = document.getElementById('no-files-message');
      const fileList = document.getElementById('file-list');
      noFilesMessage.style.display = 'block';
      noFilesMessage.textContent = message;
      fileList.innerHTML = '';
    }

    function updateFileStats(totalFiles) {
      const fileStats = document.getElementById('file-stats');
      if (fileStats) {
        fileStats.textContent = `(${totalFiles} file${totalFiles !== 1 ? 's' : ''})`;
      }
    }

    // FIXED: Delete file function - properly removes from DOM
    async function deleteFile(fileId) {
      if (!confirm('Are you sure you want to delete this file?')) {
        return;
      }
      
      try {
        const response = await fetch('/delete_shared_file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            file_id: fileId
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          // FIXED: Remove the file item from DOM immediately
          const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
          if (fileItem) {
            // Add fade-out animation
            fileItem.style.transition = 'opacity 0.3s ease';
            fileItem.style.opacity = '0';
            
            // Remove after animation
            setTimeout(() => {
              fileItem.remove();
              
              // Update file count after removal
              const remainingFiles = document.querySelectorAll('.file-item').length;
              updateFileStats(remainingFiles);
              
              // Show no files message if no files left
              if (remainingFiles === 0) {
                showNoFilesMessage('No files have been shared yet.');
              }
            }, 300);
          }
          
          showUploadStatus('File deleted successfully!', 'success');
          
          // Update file statistics for owners
          if (userRole === 'owner') {
            loadFileStats();
          }
        } else {
          showUploadStatus('Error: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting file:', error);
        showUploadStatus('Succeded to delete file', 'error');
      }
    }

    function showUploadStatus(message, type) {
      const statusDiv = document.getElementById('upload-status');
      if (!statusDiv) return;
      
      statusDiv.textContent = message;
      statusDiv.className = `upload-status ${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide success/info messages after 3 seconds, errors after 5 seconds
      const hideDelay = (type === 'error') ? 5000 : 3000;
      setTimeout(() => {
        if (statusDiv.style.display === 'block') {
          statusDiv.style.display = 'none';
        }
      }, hideDelay);
    }

    // COMPLETELY REWRITTEN FILE UPLOAD SYSTEM
    if (userRole === 'owner') {
      // Elementreferenser
      const fileInput    = document.getElementById('file-upload-input');
      const uploadArea   = document.getElementById('file-upload-area');
      const progressBar  = document.getElementById('progress-bar');
      const progressDiv  = document.getElementById('upload-progress');
      const descriptionInput = document.getElementById('file-description');

      let uploadInProgress = false;
      let abortController  = null;

      

      // Drag‚Äëover och drag‚Äëleave
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      uploadArea.addEventListener('dragleave', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
      });

      // Drop: h√§mta filerna och skicka dem
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        handleFiles(Array.from(e.dataTransfer.files));
      });

      // Filval via knapp
      fileInput.addEventListener('change', e => {
        handleFiles(Array.from(e.target.files));
      });

      async function startUpload(files) {
        uploadInProgress = true;
        abortController  = new AbortController();
        const desc       = descriptionInput.value.trim();

        progressDiv.style.display = 'block';
        progressBar.style.width   = '0%';
        showUploadStatus('F√∂rbereder uppladdning‚Ä¶', 'info');

        let success = 0, fail = 0;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > 50 * 1024 * 1024) {
            showUploadStatus(`"${file.name}" √§r f√∂r stor (>50MB)`, 'error');
            fail++;
            continue;
          }
          try {
            await uploadSingle(file, desc, i+1, files.length);
            success++;
          } catch (err) {
            showUploadStatus(`Misslyckades: "${file.name}" ‚Äì ${err.message}`, 'error');
            fail++;
          }
          if (abortController.signal.aborted) break;
        }

        const msg = success
          ? `Uppladdade ${success} fil${success>1?'er':''}` + (fail? `, ${fail} misslyckades` : '')
          : 'Inga filer laddades upp';
        showUploadStatus(msg, success && !fail ? 'success' : 'warning');

        // --- Rensa gamla och visa riktig placeholder med korrekt id ---
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '<div id="no-files-message">Laddar filer‚Ä¶</div>';

        // F√∂rs√∂k h√§mta om filerna ‚Äì ta bort placeholder i finally-blocket
        try {
          await loadSharedFiles();
        } catch (e) {
          console.error('loadSharedFiles failed:', e);
        } finally {
          const placeholder = document.getElementById('no-files-message');
          if (placeholder) placeholder.remove();
        }

        // √Öterst√§ll input & progress
        fileInput.value        = '';
        descriptionInput.value = '';
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width   = '0%';
          uploadInProgress          = false;
          abortController           = null;
        }, 800);
      }



      function uploadSingle(file, description, index, total) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const form = new FormData();
          form.append('file', file);
          form.append('subject', currentSubject);
          form.append('description', description);

          // Avbryt-st√∂d
          abortController.signal.addEventListener('abort', () => {
            xhr.abort();
            reject(new Error('Avbrutet'));
          });

          // Progress
          xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded/e.total)*100);
              progressBar.style.width = pct + '%';
              showUploadStatus(`Uppladdar ${index}/${total}: ${file.name} (${pct}%)`, 'info');
            }
          };

          // Klart
          xhr.onload = () => {
            if (xhr.status === 200) {
              const resp = JSON.parse(xhr.responseText);
              if (resp.status==='success') return resolve();
              else return reject(new Error(resp.message||'Server avvisade'));
            }
            reject(new Error(`Serverfel ${xhr.status}`));
          };
          xhr.onerror = () => reject(new Error('N√§tverksfel'));
          xhr.timeout = 300000;

          xhr.open('POST','/upload_shared_file');
          xhr.send(form);
        });
      }

      // Load file statistics for owners
      async function loadFileStats() {
        try {
          const response = await fetch(`/api/shared_files/${subjectId}/stats`);
          const data = await response.json();
          
          if (data.status === 'success') {
            const statsDiv = document.getElementById('file-stats-details');
            if (statsDiv) {
              statsDiv.innerHTML = `
                üìä Total files: ${data.total_files} ‚Ä¢ Total downloads: ${data.total_downloads}
              `;
              statsDiv.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Error loading file stats:', error);
        }
      }
      
      loadFileStats();
    }



    // Load member count when page loads
    if (userRole === 'owner') {
      loadMemberCount();
    }
    
    // Load shared files when page loads
    loadSharedFiles();
























    // Lesson management variables
    let currentLesson = null;
    let lessons = [];

    // Initialize lesson functionality
    document.addEventListener('DOMContentLoaded', function() {
      if (userRole === 'owner') {
        initializeLessonUpload();
        loadLessonStats();
      }
      loadLessons();
    });

    function initializeLessonUpload() {
      const titleInput = document.getElementById('lesson-title');
      const dateInput = document.getElementById('lesson-date');
      const fileInput = document.getElementById('lesson-upload-input');
      const uploadBtn = document.getElementById('upload-lesson-btn');
      const uploadArea = document.getElementById('lesson-upload-area');
  
      // Set default date to today
      dateInput.valueAsDate = new Date();
  
      // Enable upload button when all required fields are filled
      function checkFormValidity() {
        const title = titleInput.value.trim();
        const date = dateInput.value;
        const file = fileInput.files[0];
    
        uploadBtn.disabled = !(title && date && file);
      }
  
      titleInput.addEventListener('input', checkFormValidity);
      dateInput.addEventListener('change', checkFormValidity);
      fileInput.addEventListener('change', checkFormValidity);
  
      // Drag and drop functionality
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
  
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });
  
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          checkFormValidity();
        }
      });
  
      // Upload button click handler
      uploadBtn.addEventListener('click', uploadLesson);
    }

    // Uppdaterad uploadLesson-funktion
    async function uploadLesson() {
        const titleInput = document.getElementById('lesson-title');
        const dateInput = document.getElementById('lesson-date');
        const descriptionInput = document.getElementById('lesson-description');
        const fileInput = document.getElementById('lesson-upload-input');
        const uploadBtn = document.getElementById('upload-lesson-btn');
        const progressDiv = document.getElementById('lesson-upload-progress');
        const progressBar = document.getElementById('lesson-progress-bar');
        const statusDiv = document.getElementById('lesson-upload-status');

        const title = titleInput.value.trim();
        const date = dateInput.value;
        const description = descriptionInput.value.trim();
        const file = fileInput.files[0];

        if (!title || !date || !file) {
            showAlert('V√§nligen fyll i alla obligatoriska f√§lt', 'error');
            return;
        }

        // File size check (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('Filen √§r f√∂r stor. Max storlek √§r 500MB.', 'error');
            return;
        }

        // Kontrollera att subjectId √§r definierat
        if (!subjectId) {
            showAlert('Kunde inte identifiera √§mne', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('subject_id', subjectId);
        formData.append('title', title);
        formData.append('lesson_date', date);
        if (description) {
            formData.append('description', description);
        }

        // Debug: logga FormData inneh√•ll
        console.log('FormData contents:');
        for (let [key, value] of formData.entries()) {
            console.log(key, ':', value instanceof File ? `File: ${value.name}` : value);
        }

        // Show progress
        uploadBtn.disabled = true;
        progressDiv.style.display = 'block';
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Laddar upp...';
        statusDiv.className = 'upload-status';

        try {
            const xhr = new XMLHttpRequest();

            // Upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    statusDiv.textContent = `Laddar upp... ${Math.round(percentComplete)}%`;
                }
            });

            // Handle response
            xhr.addEventListener('load', () => {
                console.log('XHR response status:', xhr.status);
                console.log('XHR response text:', xhr.responseText);
            
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            statusDiv.textContent = 'Uppladdning slutf√∂rd!';
                            statusDiv.className = 'upload-status success';

                            // Reset form
                            titleInput.value = '';
                            descriptionInput.value = '';
                            fileInput.value = '';
                            dateInput.valueAsDate = new Date();

                            // Reload lessons
                            loadLessons();
                            if (userRole === 'owner') {
                                loadLessonStats();
                            }

                            showAlert('Lektion uppladdad!', 'success');
                        } else {
                            throw new Error(response.message || 'Uppladdning misslyckades');
                        }
                    } catch (e) {
                        throw new Error('Invalid server response: ' + xhr.responseText.substring(0, 100));
                    }
                } else if (xhr.status === 404) {
                    throw new Error('Upload endpoint not found. Check your Flask routes.');
                } else {
                    throw new Error(`Server error ${xhr.status}: ${xhr.statusText}`);
                }
            });

            xhr.addEventListener('error', (e) => {
                console.error('XHR error:', e);
                throw new Error('N√§tverksfel vid uppladdning');
            });

            console.log('Sending XHR request to /upload_lesson');
            xhr.open('POST', '/upload_lesson');
            xhr.send(formData);

        } catch (error) {
            console.error('Upload error:', error);
            statusDiv.textContent = 'Fel vid uppladdning: ' + error.message;
            statusDiv.className = 'upload-status error';
            showAlert('Fel vid uppladdning: ' + error.message, 'error');
        } finally {
            // Hide progress after a delay
            setTimeout(() => {
                progressDiv.style.display = 'none';
                statusDiv.style.display = 'none';
                uploadBtn.disabled = false;
                progressBar.style.width = '0%';
            }, 3000);
        }
    }













    async function loadLessons() {
        try {
            console.log('Loading lessons for subject:', subjectId);
            const response = await fetch(`/api/lessons/${subjectId}`);
        
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        
            const text = await response.text();
            console.log('Response text:', text);
        
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
            }
        
            if (data.status === 'success') {
                lessons = data.lessons;
                renderLessons(lessons);
                console.log('Successfully loaded', lessons.length, 'lessons');
            } else {
                throw new Error(data.message || 'Kunde inte ladda lektioner');
            }
        } catch (error) {
            console.error('Error loading lessons:', error);
            const timeline = document.getElementById('lesson-timeline');
            if (timeline) {
                timeline.innerHTML = `
                    <div class="no-lessons-message error">
                        Fel vid laddning av lektioner: ${error.message}
                    </div>
                `;
            }
            showAlert('Kunde inte ladda lektioner: ' + error.message, 'error');
        }
    }




    document.addEventListener('DOMContentLoaded', function() {
      // St√§ng modal vid klick utanf√∂r inneh√•llet
      const modal = document.getElementById('lesson-player-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeLessonPlayer();
          }
        });
      }
  
      // St√§ng modal med Escape-tangent
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      });
    });





    let transcriptionCheckInterval = null;


    function updateLessonInList(lessonId, updates) {
        const lessonIndex = lessons.findIndex(l => l.id === lessonId);
        if (lessonIndex !== -1) {
            // Uppdatera lesson-objektet
            const oldStatus = lessons[lessonIndex].transcription_status;
            lessons[lessonIndex] = { ...lessons[lessonIndex], ...updates };
            
            console.log(`Updated lesson ${lessonId} in list:`, updates);
            
            // Log status change
            if (updates.transcription_status && updates.transcription_status !== oldStatus) {
                console.log(`Status changed from ${oldStatus} to ${updates.transcription_status}`);
            }
        }
    }

    // Modifierad startTranscriptionCheck funktion
    function startTranscriptionCheck(lessonId) {  
      if (transcriptionCheckInterval) {
        clearInterval(transcriptionCheckInterval);
      }

      let checkCount = 0;
      const maxChecks = 30; // Maximal 5 minuter (30 * 10 sekunder)

      transcriptionCheckInterval = setInterval(async () => {
        checkCount++;
        
        if (checkCount > maxChecks) {
          console.log('Transcription check timeout - stopping polling');
          clearInterval(transcriptionCheckInterval);
          transcriptionCheckInterval = null;
          return;
        }

        try {
          // H√§mta transkriberingsstatus
          const response = await fetch(`/api/lesson/${lessonId}/transcription`);
          const data = await response.json();

          if (data.status === 'success') {
            const newStatus = data.transcription_status;
            
            // Uppdatera currentLesson om det √§r samma lektion
            if (currentLesson && currentLesson.id === lessonId) {
              currentLesson.transcription_status = newStatus;
              await loadTranscription(lessonId);
            }

            // Uppdatera lektionen i listan
            updateLessonInList(lessonId, { 
              transcription_status: newStatus,
              transcription: data.transcription 
            });

            // Stop the interval if transcription is completed or failed
            if (newStatus === 'completed' || newStatus === 'failed') {
              clearInterval(transcriptionCheckInterval);
              transcriptionCheckInterval = null;
              
              // Visa meddelande om det √§r klart
              if (newStatus === 'completed') {
                showAlert('Transkribering klar!', 'success');
              } else if (newStatus === 'failed') {
                showAlert('Transkribering misslyckades', 'error');
              }
            }
          }
        } catch (error) {
          console.error('Error checking transcription status:', error);
        }
      }, 10000); // Check every 10 seconds
    }

    function getCurrentLessonStatus(lessonId) {
      const lesson = lessons.find(l => l.id === lessonId);
      return lesson ? lesson.transcription_status : null;
    }



    // F√∂rb√§ttrad updateTranscriptionIndicatorInDOM funktion
    function updateTranscriptionIndicatorInDOM(lessonId, newStatus) {
        console.log(`Updating DOM indicator for lesson ${lessonId} to status: ${newStatus}`);
        
        // Find the lesson item in the DOM
        const lessonItems = document.querySelectorAll('.lesson-item');
        
        lessonItems.forEach(item => {
            // Check if this is the right lesson by looking at the onclick attribute
            const onclickAttr = item.getAttribute('onclick');
            if (onclickAttr && onclickAttr.includes(`openLessonPlayer(${lessonId})`)) {
                
                // Find or create the transcription indicator
                let indicator = item.querySelector('.lesson-transcription-indicator');
                
                if (newStatus === 'completed') {
                    if (indicator) {
                        indicator.className = 'lesson-transcription-indicator completed';
                        indicator.textContent = 'üìù Transkriberad';
                    } else {
                        // Create new indicator if it doesn't exist
                        const newIndicator = document.createElement('div');
                        newIndicator.className = 'lesson-transcription-indicator completed';
                        newIndicator.textContent = 'üìù Transkriberad';
                        
                        // Insert after the type icon
                        const typeIcon = item.querySelector('.lesson-type-icon');
                        if (typeIcon) {
                            typeIcon.insertAdjacentElement('afterend', newIndicator);
                        }
                    }
                    console.log(`DOM updated: lesson ${lessonId} now shows as completed`);
                    
                } else if (newStatus === 'processing') {
                    if (indicator) {
                        indicator.className = 'lesson-transcription-indicator processing';
                        indicator.textContent = '‚è≥ Transkriberar...';
                    } else {
                        const newIndicator = document.createElement('div');
                        newIndicator.className = 'lesson-transcription-indicator processing';
                        newIndicator.textContent = '‚è≥ Transkriberar...';
                        
                        const typeIcon = item.querySelector('.lesson-type-icon');
                        if (typeIcon) {
                            typeIcon.insertAdjacentElement('afterend', newIndicator);
                        }
                    }
                    
                } else if (newStatus === 'failed') {
                    if (indicator) {
                        indicator.className = 'lesson-transcription-indicator failed';
                        indicator.textContent = '‚ùå Transkription misslyckades';
                    } else {
                        const newIndicator = document.createElement('div');
                        newIndicator.className = 'lesson-transcription-indicator failed';
                        newIndicator.textContent = '‚ùå Transkription misslyckades';
                        
                        const typeIcon = item.querySelector('.lesson-type-icon');
                        if (typeIcon) {
                            typeIcon.insertAdjacentElement('afterend', newIndicator);
                        }
                    }
                } else {
                    // Remove indicator for other statuses
                    if (indicator) {
                        indicator.remove();
                    }
                }
                
                return; // Found the lesson, no need to continue
            }
        });
    }











    function renderLessons(lessonsData) {
      const timeline = document.getElementById('lesson-timeline');

      if (!lessonsData || lessonsData.length === 0) {
        timeline.innerHTML = `
          <div class="no-lessons-message">
            Inga lektioner har lagts till √§n.
          </div>
        `;
        return;
      }

      // Sortera lektioner s√• att de nyaste kommer f√∂rst
      const sortedLessons = [...lessonsData].sort((a, b) => {
        // F√∂rst sortera p√• lesson_date (nyaste datum f√∂rst)
        const dateA = new Date(a.lesson_date);
        const dateB = new Date(b.lesson_date);
        
        if (dateA.getTime() !== dateB.getTime()) {
          return dateB.getTime() - dateA.getTime(); // Nyaste f√∂rst
        }
        
        // Om samma datum, sortera p√• ID (h√∂gre ID = nyare)
        return (b.id || 0) - (a.id || 0);
      });

      const lessonsHtml = sortedLessons.map(lesson => {
        const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
        const isAudio = lesson.file_type && lesson.file_type.startsWith('audio/');
        const iconClass = isVideo ? 'video' : isAudio ? 'audio' : '';
        const icon = isVideo ? 'üé•' : isAudio ? 'üéµ' : 'üìÅ';

        const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
          day: 'numeric',
          month: 'short'
        });

        // Transkriptionsstatus-indikator
        let transcriptionIndicator = '';
        if (lesson.transcription_status === 'completed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator completed">üìù Transkriberad</div>';
        } else if (lesson.transcription_status === 'processing') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator processing">‚è≥ Transkriberar...</div>';
        } else if (lesson.transcription_status === 'failed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator failed">‚ùå Transkription misslyckades</div>';
        }

        return `
          <div class="lesson-item" onclick="openLessonPlayer(${lesson.id})">
            <div class="lesson-date-badge">${formattedDate}</div>
            <div class="lesson-type-icon ${iconClass}">${icon}</div>
            ${transcriptionIndicator}
            <div class="lesson-content">
              <div class="lesson-title">${escapeHtml(lesson.title)}</div>
              <div class="lesson-meta">
                <span>üìÅ ${lesson.display_size}</span>
                <span>
              </div>
            </div>
            ${lesson.can_edit ? `
              <div class="lesson-actions" onclick="event.stopPropagation()">
                <button class="lesson-action-btn delete" onclick="deleteLesson(${lesson.id})">
                  Ta bort
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      timeline.innerHTML = lessonsHtml;
    }






    async function openLessonPlayer(lessonId) {
  try {
    const lesson = lessons.find(l => l.id === lessonId);
    if (!lesson) {
      showAlert('Lektion hittades inte', 'error');
      return;
    }

    currentLesson = lesson;

    // Update modal content
    document.getElementById('lesson-player-title').textContent = lesson.title;
    document.getElementById('lesson-player-description').textContent = lesson.description || '';

    const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })

    document.getElementById('lesson-player-date').textContent = `üìÖ ${formattedDate}`;
    document.getElementById('lesson-player-size').textContent = `üìÅ ${lesson.display_size}`;

    // Create player
    const playerContainer = document.getElementById('lesson-player-container');
    const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
    const streamUrl = `/stream_lesson/${lesson.id}`;

    if (isVideo) {
      playerContainer.innerHTML = `
        <video controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbl√§sare st√∂der inte video.
        </video>
      `;
    } else {
      playerContainer.innerHTML = `
        <audio controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbl√§sare st√∂der inte ljud.
        </audio>
      `;
    }

    // Setup download link
    const downloadLink = document.getElementById('lesson-download-link');
    downloadLink.href = `/download_lesson/${lesson.id}`;
    downloadLink.download = lesson.filename;

    // Show/hide delete button
    const deleteBtn = document.getElementById('lesson-delete-btn');
    if (lesson.can_edit) {
      deleteBtn.style.display = 'inline-block';
    } else {
      deleteBtn.style.display = 'none';
    }

    // FIXED: Load transcription with proper function name
    await loadTranscription(lesson.id);
    
    // Start auto-refresh if transcription is processing
    if (lesson.transcription_status === 'processing' || lesson.transcription_status === 'pending') {
      startTranscriptionCheck(lesson.id);
    }

    // Show modal
    document.getElementById('lesson-player-modal').style.display = 'flex';

  } catch (error) {
    console.error('Error opening lesson player:', error);
    showAlert('Kunde inte √∂ppna lektion: ' + error.message, 'error');
  }
}








    // Function to add transcription search functionality
function addTranscriptionSearch() {
  const transcriptionSection = document.querySelector('.lesson-transcription-section');
  if (!transcriptionSection) return;

  // Check if search already exists
  if (document.getElementById('transcription-search-input')) return;

  const searchHtml = `
    <div class="transcription-search" style="margin-bottom: 10px;">
      <input type="text" id="transcription-search-input" placeholder="S√∂k i transkription..." 
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
  `;

  const header = transcriptionSection.querySelector('.transcription-header');
  if (header) {
    header.insertAdjacentHTML('afterend', searchHtml);

    // Add search functionality
    const searchInput = document.getElementById('transcription-search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        highlightTranscriptionText(this.value);
      });
    }
  }
}

function highlightTranscriptionText(searchTerm) {
  const transcriptionText = document.querySelector('.transcription-text');
  if (!transcriptionText || !searchTerm) {
    if (transcriptionText) {
      // Reset highlighting if no search term
      const originalText = transcriptionText.getAttribute('data-original-text');
      if (originalText) {
        transcriptionText.innerHTML = escapeHtml(originalText);
      }
    }
    return;
  }

  // Store original text if not already stored
  if (!transcriptionText.getAttribute('data-original-text')) {
    transcriptionText.setAttribute('data-original-text', transcriptionText.textContent || transcriptionText.innerText);
  }

  const originalText = transcriptionText.getAttribute('data-original-text');
  if (!originalText) return;

  if (searchTerm.trim() === '') {
    transcriptionText.innerHTML = escapeHtml(originalText);
    return;
  }

  const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
  const highlightedText = escapeHtml(originalText).replace(regex, '<mark style="background-color: yellow; padding: 2px;">$1</mark>');
  transcriptionText.innerHTML = highlightedText;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

    // Export functions if using modules (optional)
    if (typeof module !== 'undefined' && module.exports) {
      module.exports = {
        loadTranscription,
        retryTranscription,
        openLessonPlayer,
        closeLessonPlayer,
        deleteCurrentLesson,
        deleteLesson,
        renderLessons,
        getTranscriptionStatusText
      };
    }












    function formatTranscriptionText(text) {
      if (!text) return '';
  
      // Grundl√§ggande formatering
      return text
        .replace(/\n/g, '<br>')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
        .trim();
    }


    function closeLessonPlayer() {
  const modal = document.getElementById('lesson-player-modal');
  const playerContainer = document.getElementById('lesson-player-container');

  // Stop any playing media
  const media = playerContainer.querySelector('video, audio');
  if (media) {
    media.pause();
    media.currentTime = 0;
  }

  // Clear player
  playerContainer.innerHTML = '';

  // Hide modal
  modal.style.display = 'none';
  currentLesson = null;

  // Clear any running transcription check interval
  if (transcriptionCheckInterval) {
    clearInterval(transcriptionCheckInterval);
    transcriptionCheckInterval = null;
  }
}

    async function deleteLesson(lessonId) {
      if (!confirm('√Ñr du s√§ker p√• att du vill ta bort denna lektion?')) {
        return;
      }
  
      try {
        const response = await fetch('/delete_lesson', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: lessonId
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          loadLessons();
          if (userRole === 'owner') {
            loadLessonStats();
          }
      
          // Close modal if this lesson is currently open
          if (currentLesson && currentLesson.id === lessonId) {
            closeLessonPlayer();
          }
        } else {
          throw new Error(data.message || 'Kunde inte ta bort lektion');
        }
    
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning: ' + error.message, 'error');
      }
    }


    async function debugTranscription(lessonId) {
  console.log('Testing transcription for lesson:', lessonId);
  
  try {
    const response = await fetch(`/api/lesson/${lessonId}/retranscribe`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const result = await response.json();
    console.log('Transcription start result:', result);
    
    if (result.status === 'success') {
      startTranscriptionCheck(lessonId);
    }
  } catch (error) {
    console.error('Debug transcription error:', error);
  }
}
window.debugTranscription = debugTranscription;

    async function deleteCurrentLesson() {
      if (!currentLesson) return;
  
      const confirmDelete = confirm(`√Ñr du s√§ker p√• att du vill ta bort lektionen "${currentLesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
        method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: currentLesson.id
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          closeLessonPlayer();
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }


    // Funktion f√∂r att ta bort lektion fr√•n listan (utan att √∂ppna player)
    async function deleteLesson(lessonId, event) {
      if (event) {
        event.stopPropagation();
      }
  
      const lesson = lessons.find(l => l.id === lessonId);
      if (!lesson) {
        showAlert('Lektion hittades inte', 'error');
        return;
      }
  
      const confirmDelete = confirm(`√Ñr du s√§ker p√• att du vill ta bort lektionen "${lesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: lessonId
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }





    async function loadLessonStats() {
      if (userRole !== 'owner') return;
  
      try {
        const response = await fetch(`/api/lessons/${subjectId}/stats`);
        const data = await response.json();
    
        if (data.status === 'success') {
          const statsText = `(${data.total_lessons} lektioner, ${data.total_views} visningar)`;
          document.getElementById('lesson-stats').textContent = statsText;
      
          
        }
      } catch (error) {
        console.error('Error loading lesson stats:', error);
      }
    }




    async function loadTranscription(lessonId) {
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');
  const retryBtn = document.getElementById('retry-transcription-btn');

  if (!statusSpan || !contentDiv) {
    console.warn('Transcription elements not found in DOM');
    return;
  }

  try {
    const response = await fetch(`/api/lesson/${lessonId}/transcription`);
    const data = await response.json();

    console.log('Transcription data:', data); // Debug log

    if (data.status === 'success') {
      // Update status
      statusSpan.textContent = getTranscriptionStatusText(data.transcription_status);
      statusSpan.className = `transcription-status ${data.transcription_status}`;

      // Update content based on status
      if (data.transcription_status === 'completed' && data.transcription) {
        contentDiv.innerHTML = `<div class="transcription-text">${escapeHtml(data.transcription)}</div>`;
        if (retryBtn) retryBtn.style.display = 'none';
        
        // Add search functionality if transcription is completed
        addTranscriptionSearch();
        
      } else if (data.transcription_status === 'processing') {
        contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering p√•g√•r...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
      } else if (data.transcription_status === 'failed') {
        contentDiv.innerHTML = '<div class="transcription-empty">‚ùå Transkribering misslyckades</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
        
      } else if (data.transcription_status === 'pending') {
        contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering √§r schemalagd...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
        // F√∂r pending status, f√∂rs√∂k starta transkribering automatiskt
        if (currentLesson && currentLesson.can_edit) {
          console.log('Auto-starting transcription for pending lesson');
          setTimeout(() => {
            fetch(`/api/lesson/${lessonId}/retranscribe`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'}
            }).then(response => response.json())
              .then(result => {
                if (result.status === 'success') {
                  console.log('Auto-transcription started');
                  // Starta om polling
                  startTranscriptionCheck(lessonId);
                }
              })
              .catch(err => console.log('Auto-start failed:', err));
          }, 2000); // V√§nta 2 sekunder innan auto-start
        }
        
      } else {
        contentDiv.innerHTML = '<div class="transcription-empty">Ingen transkription tillg√§nglig</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
      }
    } else {
      contentDiv.innerHTML = '<div class="transcription-empty">Kunde inte ladda transkription</div>';
      if (retryBtn && currentLesson && currentLesson.can_edit) {
        retryBtn.style.display = 'block';
      }
    }

  } catch (error) {
    console.error('Error loading transcription:', error);
    contentDiv.innerHTML = '<div class="transcription-empty">Fel vid laddning av transkription</div>';
    if (retryBtn && currentLesson && currentLesson.can_edit) {
      retryBtn.style.display = 'block';
    }
  }
}


    // NY: Funktion f√∂r att f√∂rs√∂ka transkribera igen
    async function retryTranscription() {
  if (!currentLesson) return;

  const retryBtn = document.getElementById('retry-transcription-btn');
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');

  try {
    retryBtn.disabled = true;
    retryBtn.textContent = 'Startar...';

    const response = await fetch(`/api/lesson/${currentLesson.id}/retranscribe`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (data.status === 'success') {
      showAlert('Transkribering startad om', 'success');
      statusSpan.textContent = 'Bearbetar...';
      statusSpan.className = 'transcription-status processing';
      contentDiv.innerHTML = '<div class="transcription-loading">‚è≥ Transkribering p√•g√•r...</div>';
      retryBtn.style.display = 'none';
  
      // Reload lessons to update status
      loadLessons();
  
      // Start checking status again
      startTranscriptionCheck(currentLesson.id);
    } else {
      showAlert('Kunde inte starta transkribering: ' + data.message, 'error');
      retryBtn.disabled = false;
      retryBtn.textContent = 'F√∂rs√∂k igen';
    }

  } catch (error) {
    console.error('Error retrying transcription:', error);
    showAlert('Fel vid omstart av transkribering', 'error');
    retryBtn.disabled = false;
    retryBtn.textContent = 'F√∂rs√∂k igen';
  }
}




    // Hj√§lpfunktion f√∂r att f√• statustext
    function getTranscriptionStatusText(status) {
  switch (status) {
    case 'pending': return 'V√§ntar';
    case 'processing': return 'Bearbetar';
    case 'completed': return 'Klar';
    case 'failed': return 'Misslyckades';
    default: return 'Ok√§nd';
  }
}

    // Funktion f√∂r att st√§nga lesson player
    function closeLessonPlayer() {
      const modal = document.getElementById('lesson-player-modal');
      modal.style.display = 'none';
  
      // Stoppa video/audio
      const playerContainer = document.getElementById('lesson-player-container');
      const video = playerContainer.querySelector('video');
      const audio = playerContainer.querySelector('audio');
  
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
  
      currentLesson = null;
    }


















    function showAlert(message, type = 'info') {
        // Skapa eller anv√§nd befintligt alert-element
        let alertDiv = document.getElementById('global-alert');
        if (!alertDiv) {
            alertDiv = document.createElement('div');
            alertDiv.id = 'global-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                font-weight: 500;
            `;
            document.body.appendChild(alertDiv);
        }
    
        // F√§rger baserat p√• typ
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
    
        const color = colors[type] || colors.info;
        alertDiv.style.backgroundColor = color.bg;
        alertDiv.style.borderLeft = `4px solid ${color.border}`;
        alertDiv.style.color = color.text;
        alertDiv.textContent = message;
        alertDiv.style.display = 'block';
    
        // D√∂lj efter 5 sekunder
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }



    // Utility function to escape HTML
    function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('lesson-player-modal');
      if (e.target === modal) {
        closeLessonPlayer();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('lesson-player-modal');
        if (modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      }
    });
























    




  </script>

</body>
</html>
