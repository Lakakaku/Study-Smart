


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ subject_name }} - Study Smart</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/subject_styles.css') }}">
  <style>

    .quiz-section {
    margin-bottom: 40px;
    }

    .section-title {
      display: flex;
      align-items: center;
  gap: 10px;
  margin-bottom: 20px;
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
}

.quiz-count {
  background: #e9ecef;
  padding: 2px 8px;
  border-radius: 12px;
  font-size: 0.9em;
  font-weight: 500;
  color: #666;
}

.quiz-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.quiz-card {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  background: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  transition: all 0.2s ease;
  display: flex;
  flex-direction: column;
  height: auto;
}

.quiz-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.quiz-info {
  margin-top: 12px;
  margin-bottom: 12px;
  padding-top: 12px;
  border-top: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 10px;
}

.quiz-card.subject-quiz {
  border-left: 4px solid #007bff;
}

.quiz-card.personal-quiz {
  border-left: 4px solid #28a745;
}

.quiz-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.quiz-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  flex: 1;
}

.quiz-creator {
  font-size: 0.85em;
  color: #666;
  font-style: italic;
}

.personal-badge {
  background: #28a745;
  color: white;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
}

.quiz-meta {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.quiz-type {
  background: #f8f9fa;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.85em;
  color: #495057;
}

.quiz-date {
  font-size: 0.85em;
  color: #6c757d;
}

.quiz-description {
  font-size: 0.9em;
  color: #555;
  margin-bottom: 15px;
  line-height: 1.4;
}
.quiz-description-container {
  margin-bottom: 12px;
}

.quiz-description {
  position: relative;
}

.expand-description-btn {
  background: #007bff;
  border: 1px solid #007bff;
  color: white;
  font-size: 12px;
  cursor: pointer;
  padding: 4px 8px;
  margin-left: 8px;
  border-radius: 4px;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
}

.expand-description-btn:hover {
  background: #0056b3;
  border-color: #0056b3;
}

.description-expanded .description-text {
  display: block;
}

.quiz-actions {
  margin-top: 4px;
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: flex-end;
}

.created-info {
  font-size: 0.85em;
  color: #6c757d;
  flex: 1;
}

.start-button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.start-button:hover {
  background: #0056b3;
}

.start-button.personal {
  background: #28a745;
}

.start-button.personal:hover {
  background: #1e7e34;
}

.delete-button {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.delete-button:hover {
  background: #c82333;
}

.delete-form {
  margin: 0;
}

.quiz-action-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 12px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.quiz-action-btn:hover {
  background: #c82333;
}

.create-quiz-section {
  text-align: center;
  padding: 30px;
  background: #f8f9fa;
  border-radius: 8px;
  margin-top: 20px;
}

.create-quiz-button {
  display: inline-block;
  background: #28a745;
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.create-quiz-button:hover {
  background: #218838;
  text-decoration: none;
  color: white;
}

.create-quiz-info {
  margin-top: 10px;
  font-size: 0.9em;
  color: #6c757d;
}

.no-quizzes {
  text-align: center;
  padding: 40px;
  color: #666;
}

.create-first-quiz-button {
  display: inline-block;
  background: #007bff;
  color: white;
  text-decoration: none;
  padding: 12px 24px;
  border-radius: 6px;
  font-weight: 500;
  margin-top: 20px;
  transition: background-color 0.2s ease;
}

.create-first-quiz-button:hover {
  background: #0056b3;
  text-decoration: none;
  color: white;
}

/* Styling for member role badges */
.member-role-badge {
  background: #6c757d;
  color: white;
  padding: 2px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
  margin-left: 8px;
}

.member-role-badge.owner {
  background: #dc3545;
}

.member-role-badge.admin {
  background: #ffc107;
  color: #212529;
}

.member-role-badge.member {
  background: #28a745;
}

/* Share section styling */
.share-section {
  background: #f8f9fa;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.share-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
}

.share-status {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 15px;
}

.status-indicator {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.status-indicator.active {
  background: #28a745;
}

.status-indicator.inactive {
  background: #dc3545;
}

.share-code-display {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.share-code {
  background: white;
  border: 1px solid #ced4da;
  padding: 8px 12px;
  border-radius: 4px;
  font-family: monospace;
  font-size: 1.1em;
  font-weight: 600;
  color: #007bff;
  min-width: 120px;
}

.copy-button {
  background: #007bff;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background-color 0.2s ease;
}

.copy-button:hover {
  background: #0056b3;
}

.copy-button.copied {
  background: #28a745;
}

.toggle-sharing, .regenerate-code {
  background: #6c757d;
  color: white;
  border: none;
  padding: 8px 16px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  margin-right: 10px;
  transition: background-color 0.2s ease;
}

.toggle-sharing:hover, .regenerate-code:hover {
  background: #5a6268;
}

.members-count {
  margin-top: 10px;
  font-size: 0.9em;
  color: #6c757d;
}

/* Shared files section */
.shared-files-section {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
}

.files-section-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.file-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  text-align: center;
  margin-bottom: 20px;
  transition: border-color 0.2s ease;
}

.file-upload-area:hover,
.file-upload-area.drag-over {
  border-color: #007bff;
}

.file-upload-input {
  display: none;
}

.file-upload-label {
  background: #007bff;
  color: white;
  padding: 10px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: 500;
  transition: background-color 0.2s ease;
}

.file-upload-label:hover {
  background: #0056b3;
}

.file-description-input {
  width: 100%;
  max-width: 400px;
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  margin-top: 15px;
  resize: vertical;
  min-height: 60px;
}

.upload-progress {
  margin-top: 15px;
  background: #f8f9fa;
  border-radius: 4px;
  overflow: hidden;
}

.upload-progress-bar {
  height: 4px;
  background: #007bff;
  width: 0%;
  transition: width 0.3s ease;
}

.upload-status {
  margin-top: 10px;
  padding: 8px;
  border-radius: 4px;
  font-size: 0.9em;
}

.upload-status.success {
  background: #d4edda;
  color: #155724;
  border: 1px solid #c3e6cb;
}

.upload-status.error {
  background: #f8d7da;
  color: #721c24;
  border: 1px solid #f5c6cb;
}

.file-list {
  min-height: 100px;
}

.file-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  border: 1px solid #dee2e6;
  border-radius: 4px;
  margin-bottom: 10px;
}

.file-info {
  flex: 1;
}

.file-name {
  font-weight: 500;
  color: #333;
  margin-bottom: 4px;
}

.file-extension {
  background: #e9ecef;
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.75em;
  margin-left: 8px;
}

.file-download-count {
  color: #6c757d;
  font-size: 0.85em;
  margin-left: 8px;
}

.file-meta {
  font-size: 0.85em;
  color: #6c757d;
}

.file-description {
  font-size: 0.9em;
  color: #555;
  margin-top: 4px;
  font-style: italic;
}

.file-actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.download-btn {
  background: #007bff;
  color: white;
  text-decoration: none;
  padding: 6px 12px;
  border-radius: 4px;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.download-btn:hover {
  background: #0056b3;
  text-decoration: none;
  color: white;
}

.delete-file-btn {
  background: #dc3545;
  color: white;
  border: none;
  padding: 6px 8px;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.85em;
  transition: background-color 0.2s ease;
}

.delete-file-btn:hover {
  background: #c82333;
}

.no-files-message {
  text-align: center;
  padding: 40px;
  color: #6c757d;
  font-style: italic;
}

.file-stats {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid #dee2e6;
  font-size: 0.9em;
  color: #6c757d;
}

/* Lessons section styling */
.lessons-section {
  background: white;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin: 20px 0;
  max-height: 600px;
  display: flex;
  flex-direction: column;
}

.lessons-section-title {
  font-size: 1.1em;
  font-weight: 600;
  color: #333;
  margin-bottom: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
  flex-shrink: 0;
}

.lesson-upload-area {
  border: 2px dashed #dee2e6;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  transition: border-color 0.2s ease;
  flex-shrink: 0;
}

.lesson-upload-area:hover,
.lesson-upload-area.drag-over {
  border-color: #007bff;
}

.lesson-upload-form {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.form-row {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 15px;
}

.lesson-title-input, .lesson-date-input {
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9em;
}

.lesson-description-input {
  padding: 8px;
  border: 1px solid #ced4da;
  border-radius: 4px;
  font-size: 0.9em;
  min-height: 60px;
  resize: vertical;
}

.lesson-upload-input {
  display: none;
}

.lesson-upload-label {
  display: block;
  padding: 15px;
  border: 2px dashed #ced4da;
  border-radius: 4px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
}

.lesson-upload-label:hover {
  border-color: #007bff;
  background-color: #f8f9fa;
}

.upload-lesson-button {
  padding: 10px 20px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
  transition: background 0.2s ease;
}

.upload-lesson-button:hover:not(:disabled) {
  background: #0056b3;
}

.upload-lesson-button:disabled {
  background: #6c757d;
  cursor: not-allowed;
}

.lesson-timeline {
  flex: 1;
  overflow-y: auto;
  margin-top: 20px;
  padding-right: 5px;
}

.lesson-timeline::-webkit-scrollbar {
  width: 6px;
}

.lesson-timeline::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.lesson-timeline::-webkit-scrollbar-thumb {
  background: #c1c1c1;
  border-radius: 3px;
}

.lesson-timeline::-webkit-scrollbar-thumb:hover {
  background: #a8a8a8;
}

.lesson-item {
  display: flex;
  align-items: center;
  padding: 15px;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  margin-bottom: 10px;
  transition: all 0.2s ease;
  cursor: pointer;
  position: relative;
  flex-wrap: wrap;
  min-height: 80px;
}

.lesson-item:hover {
  background-color: #f8f9fa;
  border-color: #007bff;
}

.lesson-date-badge {
  background: #007bff;
  color: white;
  padding: 6px 10px;
  border-radius: 15px;
  font-size: 0.8em;
  font-weight: 600;
  margin-right: 15px;
  min-width: 70px;
  text-align: center;
  flex-shrink: 0;
}

.lesson-content {
  flex: 1;
  min-width: 200px;
}

.lesson-title {
  font-weight: 600;
  font-size: 1em;
  margin-bottom: 5px;
  color: #333;
}

.lesson-meta {
  color: #6c757d;
  font-size: 0.8em;
  display: flex;
  gap: 15px;
  align-items: center;
  flex-wrap: wrap;
}

.lesson-type-icon {
  width: 35px;
  height: 35px;
  background: #e9ecef;
  border-radius: 4px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 15px;
  font-size: 16px;
  flex-shrink: 0;
}

.lesson-type-icon.video {
  background: #dc3545;
  color: white;
}

.lesson-type-icon.audio {
  background: #28a745;
  color: white;
}

.lesson-status-section {
  display: flex;
  gap: 10px;
  align-items: center;
  margin-left: auto;
  flex-shrink: 0;
}

.transcribed-badge {
  background: #28a745;
  color: white;
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 0.75em;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 4px;
}

.lesson-actions {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-shrink: 0;
}

.lesson-action-btn {
  padding: 6px 12px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  text-decoration: none;
  font-size: 0.8em;
  transition: background 0.2s ease;
  white-space: nowrap;
}

.lesson-action-btn.download {
  background: #28a745;
  color: white;
}

.lesson-action-btn.delete {
  background: #dc3545;
  color: white;
}

.lesson-action-btn:hover {
  opacity: 0.8;
}

.no-lessons-message {
  text-align: center;
  color: #6c757d;
  padding: 40px;
  font-size: 1em;
}

/* Lesson Player Modal */
.lesson-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.8);
  z-index: 10000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.lesson-modal-content {
  background: white;
  border-radius: 10px;
  width: 90%;
  max-width: 800px;
  max-height: 90vh;
  overflow: hidden;
}

.lesson-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px;
  border-bottom: 1px solid #e9ecef;
}

.lesson-modal-header h2 {
  margin: 0;
  font-size: 1.2em;
}

.lesson-modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
}

.lesson-modal-close:hover {
  background: #f8f9fa;
}

.lesson-modal-body {
  padding: 20px;
  max-height: calc(90vh - 120px);
  overflow-y: auto;
}

#lesson-player-container {
  margin-bottom: 20px;
}

#lesson-player-container video,
#lesson-player-container audio {
  width: 100%;
  border-radius: 5px;
}

.lesson-info {
  margin-bottom: 20px;
}

.lesson-transcription-section {
  margin-top: 20px;
  padding: 15px;
  background-color: #f8f9fa;
  border-radius: 8px;
  border: 1px solid #e9ecef;
}

.transcription-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.transcription-header h3 {
  margin: 0;
  color: #495057;
  font-size: 1.1em;
}

.transcription-status {
  font-size: 0.9em;
  padding: 4px 8px;
  border-radius: 4px;
  font-weight: 500;
}

.transcription-status.pending {
  background-color: #fff3cd;
  color: #856404;
}

.transcription-status.processing {
  background-color: #cce5ff;
  color: #0066cc;
  animation: pulse 2s infinite;
}

.transcription-status.completed {
  background-color: #d4edda;
  color: #155724;
}

.transcription-status.failed {
  background-color: #f8d7da;
  color: #721c24;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.transcription-content {
  max-height: 300px;
  overflow-y: auto;
  padding: 15px;
  background-color: white;
  border-radius: 6px;
  border: 1px solid #dee2e6;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  line-height: 1.6;
  color: #333;
}

.transcription-loading {
  text-align: center;
  color: #6c757d;
  font-style: italic;
}

.transcription-text {
  white-space: pre-wrap;
  word-wrap: break-word;
}

.transcription-empty {
  text-align: center;
  color: #6c757d;
  font-style: italic;
}

.retry-transcription-btn {
  margin-top: 10px;
  padding: 8px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9em;
}

.retry-transcription-btn:hover {
  background-color: #0056b3;
}

.retry-transcription-btn:disabled {
  background-color: #6c757d;
  cursor: not-allowed;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .quiz-grid {
    grid-template-columns: 1fr;
  }
  
  .quiz-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .quiz-actions {
    flex-direction: column;
    width: 100%;
  }
  
  .start-button,
  .delete-button {
    width: 100%;
    justify-content: center;
  }
  
  .share-code-display {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }
  
  .file-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .file-actions {
    width: 100%;
    justify-content: flex-end;
  }

  .form-row {
    grid-template-columns: 1fr;
  }
  
  .lesson-item {
    flex-direction: column;
    align-items: flex-start;
    padding: 15px;
    min-height: auto;
  }
  
  .lesson-date-badge {
    margin-right: 0;
    margin-bottom: 10px;
    align-self: flex-start;
  }

  .lesson-content {
    width: 100%;
    margin-bottom: 10px;
  }

  .lesson-status-section {
    width: 100%;
    justify-content: space-between;
    margin-left: 0;
    margin-top: 10px;
  }

  .lesson-actions {
    margin-left: 0;
  }
  
  .lesson-modal-content {
    width: 95%;
    margin: 20px;
  }

  .quiz-info {
    flex-direction: column;
    align-items: flex-start;
    gap: 8px;
  }

  .quiz-actions {
    width: 100%;
    justify-content: flex-end;
  }
}

    .share-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .share-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #495057;
    }
    
    .share-code-display {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .share-code {
      background: #e9ecef;
      padding: 10px 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      font-size: 1.1em;
      font-weight: bold;
      letter-spacing: 2px;
      color: #495057;
      border: 2px solid #ced4da;
      min-width: 120px;
      text-align: center;
    }
    
    .copy-button {
      background: #007bff;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
    }
    
    .copy-button:hover {
      background: #0056b3;
    }
    
    .copy-button.copied {
      background: #28a745;
    }
    
    .share-status {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #28a745;
    }
    
    .status-indicator.inactive {
      background: #dc3545;
    }
    
    .toggle-sharing {
      background: #6c757d;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      margin-right: 10px;
    }
    
    .toggle-sharing:hover {
      background: #5a6268;
    }
    
    .regenerate-code {
      background: #ffc107;
      color: #212529;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }
    
    .regenerate-code:hover {
      background: #e0a800;
    }
    
    .members-count {
      color: #6c757d;
      font-size: 0.9em;
      margin-top: 10px;
    }
    
    .member-role-badge {
      background: #17a2b8;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.8em;
      margin-left: 10px;
    }
    
    .member-role-badge.owner {
      background: #dc3545;
    }
    
    .member-role-badge.admin {
      background: #ffc107;
      color: #212529;
    }

    /* Stilar för fildelning */
    .shared-files-section {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .files-section-title {
      font-size: 1.2em;
      font-weight: bold;
      margin-bottom: 15px;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .file-upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      transition: border-color 0.3s;
    }

    .file-upload-area:hover {
      border-color: #007bff;
    }

    .file-upload-area.drag-over {
      border-color: #007bff;
      background-color: #e3f2fd;
    }

    .file-upload-input {
      display: none;
    }

    .file-upload-label {
      background: #007bff;
      color: white;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      display: inline-block;
      transition: background-color 0.3s;
    }

    .file-upload-label:hover {
      background: #0056b3;
    }

    .file-description-input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-top: 10px;
      max-width: 400px;
    }

    .file-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .file-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .file-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .file-name {
      font-weight: bold;
      color: #495057;
    }

    .file-meta {
      font-size: 0.9em;
      color: #6c757d;
    }

    .file-description {
      font-size: 0.9em;
      color: #495057;
      font-style: italic;
    }

    .file-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .download-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      text-decoration: none;
      display: inline-block;
      transition: background-color 0.3s;
    }

    .download-btn:hover {
      background: #218838;
    }

    .delete-file-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
      transition: background-color 0.3s;
    }

    .delete-file-btn:hover {
      background: #c82333;
    }

    .file-icon {
      width: 24px;
      height: 24px;
      margin-right: 10px;
    }

    .file-stats {
      background: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
      margin-top: 10px;
    }

    .no-files-message {
      text-align: center;
      padding: 40px;
      color: #6c757d;
      font-style: italic;
    }

    .upload-progress {
      width: 100%;
      height: 4px;
      background: #e9ecef;
      border-radius: 2px;
      overflow: hidden;
      margin-top: 10px;
    }

    .upload-progress-bar {
      height: 100%;
      background: #007bff;
      transition: width 0.3s;
    }

    .file-extension {
      background: #e9ecef;
      color: #495057;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      font-weight: bold;
      margin-left: 10px;
    }

    .file-download-count {
      background: #17a2b8;
      color: white;
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 0.8em;
      margin-left: 5px;
    }

    .upload-status {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
      font-size: 0.9em;
    }

    .upload-status.success {
      background: #d4edda;
      color: #155724;
    }

    .upload-status.error {
      background: #f8d7da;
      color: #721c24;
    }














        html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
    }

    .subject-title-container {
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 10vh;
        font-weight: bold;
        border: 1px solid;
    }

    .under-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        height: 10vh;
        border: 1px solid;
        padding: 0 5vw;
        position: relative;
    }

    .spacer {
        width: 33%;
    }

    .study-button-wrapper {
        position: absolute;
        left: 25%;
        transform: translateX(-50%);
    }

    .add-button-wrapper {
        position: absolute;
        right: 25%;
        transform: translateX(50%);
    }

    .study-now {
        background-color: greenyellow;
        border-radius: 25px;
        height: 7vh;
        width: 15vw;
        font-size: 3vh;
        border: none;
        font-weight: bold;
        cursor: pointer;
    }

    .add-button {
        background-color: white;
        border: 3px solid black;
        border-radius: 50%;
        height: 8vh;
        width: 8vh;
        font-size: 4vh;
        font-weight: bold;
        cursor: pointer;
    }

    .main-layout {
        display: flex;
        flex-direction: row;
        height: 100%;
    }

    .quiz-container {
        flex: 2;
        padding: 20px;
    }

    .placeholder-panel {
        flex: 1;
        border-left: 2px dashed #ccc;
        padding: 20px;
        background-color: #f5f5f5;
        overflow-y: auto;
    }

    .quiz-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        justify-content: flex-start;
    }

    .quiz-card {
        width: 160px;
        height: 240px;
        background: #fff;
        border: 2px solid #ccc;
        border-radius: 10px;
        padding: 16px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.3s ease;
    }

    .quiz-card:hover {
        box-shadow: 0 6px 12px rgba(0,0,0,0.15);
    }

    .quiz-title {
        font-size: 1.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 10px;
        cursor: pointer;
    }

    .delete-form {
        text-align: center;
    }

    .delete-button {
        background-color: #e74c3c;
        border: none;
        color: white;
        padding: 8px 14px;
        font-size: 1rem;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .delete-button:hover {
        background-color: #c0392b;
    } 

    .return-button {
        position: absolute;
        top: 15px;
        left: 15px;
        text-decoration: none;
        background-color: lightgray;
        color: black;
        padding: 8px 14px;
        border-radius: 8px;
        font-weight: bold;
        font-family: sans-serif;
        border: 1px solid gray;
    }

    /* Document upload styles */
    .documents-section {
        margin-top: 20px;
    }

    .documents-section h3 {
        margin-bottom: 15px;
        color: #333;
        font-size: 1.4rem;
    }

    .upload-area {
        margin-bottom: 20px;
        text-align: center;
    }

    #pdf-upload {
        display: none;
    }

    .upload-label {
        display: inline-block;
        padding: 12px 24px;
        background-color: #4CAF50;
        color: white;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: bold;
        transition: background-color 0.3s ease;
    }

    .upload-label:hover {
        background-color: #45a049;
    }

    .upload-info {
        margin-top: 8px;
        font-size: 0.9rem;
        color: #666;
    }

    .document-type-selector {
        margin-bottom: 20px;
    }

    .document-type-selector label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    #document-type {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
        background-color: white;
    }

    #documents-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .document-item {
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        background-color: white;
        position: relative;
    }

    .document-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .document-title {
        font-weight: bold;
        font-size: 1.1rem;
        color: #333;
    }

    .document-type {
        background-color: #e3f2fd;
        color: #1976d2;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: bold;
    }

    .document-preview {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        overflow: hidden;
        background-color: #fafafa;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .document-preview canvas {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .preview-loading {
        color: #666;
        font-style: italic;
    }

    .remove-document {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: #e74c3c;
        color: white;
        border: none;
        border-radius: 50%;
        width: 25px;
        height: 25px;
        font-size: 14px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s ease;
    }

    .remove-document:hover {
        background-color: #c0392b;
    }


    /* Shared Files Section Styling */
    .shared-files-section {
        background: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid #e9ecef;
    }

    .files-section-title {
        font-size: 1.4em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    #file-stats {
        font-size: 0.9em;
        color: #6c757d;
        font-weight: normal;
    }

    /* File Upload Area */
    .file-upload-area {
        background: #fff;
        border: 2px dashed #007bff;
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        margin-bottom: 20px;
        transition: all 0.3s ease;
    }

    .file-upload-area:hover {
        border-color: #0056b3;
        background: #f8f9ff;
    }

    .file-upload-area.drag-over {
        border-color: #28a745;
        background: #f8fff8;
    }

    .file-upload-input {
        display: none;
    }

    .file-upload-label {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: background-color 0.2s;
    }

    .file-upload-label:hover {
        background: #0056b3;
    }

    .file-description-input {
        width: 100%;
        min-height: 80px;
        margin-top: 15px;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: inherit;
        resize: vertical;
    }

    .file-description-input:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
    }

    /* Upload Progress */
    .upload-progress {
        margin-top: 15px;
        background: #f8f9fa;
        border-radius: 4px;
        overflow: hidden;
    }

    .upload-progress-bar {
        height: 4px;
        background: #007bff;
        transition: width 0.3s ease;
        width: 0%;
    }

    .upload-status {
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .upload-status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .upload-status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* File List */
    .file-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .file-item {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.2s ease;
    }

    .file-item:hover {
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        transform: translateY(-1px);
    }

    .file-info {
        flex: 1;
    }

    .file-name {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.1em;
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .file-extension {
        background: #007bff;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .file-download-count {
        background: #6c757d;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: 500;
    }

    .file-meta {
        color: #6c757d;
        font-size: 0.9em;
        margin-bottom: 5px;
    }

    .file-description {
        color: #495057;
        font-size: 0.9em;
        font-style: italic;
        margin-top: 5px;
    }

    .file-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .download-btn {
        background: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 4px;
        text-decoration: none;
        font-size: 0.9em;
        transition: background-color 0.2s;
    }

    .download-btn:hover {
        background: #218838;
        color: white;
        text-decoration: none;
    }

    .delete-file-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1.1em;
        transition: background-color 0.2s;
    }

    .delete-file-btn:hover {
        background: #c82333;
    }

    .no-files-message {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px;
        background: #fff;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    /* File Statistics */
    .file-stats {
        margin-top: 15px;
        padding: 10px;
        background: #fff;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        font-size: 0.9em;
        color: #6c757d;
    }

    /* Share Section Styling */
    .share-section {
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 10px;
        padding: 20px;
        margin: 20px 0;
    }

    .share-title {
        font-size: 1.3em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 15px;
    }

    .share-status {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 15px;
    }

    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .status-indicator.active {
        background: #28a745;
    }

    .status-indicator.inactive {
        background: #dc3545;
    }

    .share-code-display {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .share-code {
        font-family: 'Courier New', monospace;
        font-size: 1.2em;
        font-weight: 600;
        color: #007bff;
        background: #fff;
        padding: 8px 12px;
        border-radius: 4px;
        border: 1px solid #007bff;
    }

    .copy-button {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.2s;
    }

    .copy-button:hover {
        background: #0056b3;
    }

    .copy-button.copied {
        background: #28a745;
    }

    .share-help {
        background: #e3f2fd;
        border-left: 4px solid #2196f3;
        padding: 10px 15px;
        margin-bottom: 15px;
        font-size: 0.9em;
        color: #1976d2;
    }

    .toggle-sharing, .regenerate-code {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9em;
        margin-right: 10px;
        transition: background-color 0.2s;
    }

    .toggle-sharing:hover, .regenerate-code:hover {
        background: #0056b3;
    }

    .regenerate-code {
        background: #ffc107;
        color: #212529;
    }

    .regenerate-code:hover {
        background: #e0a800;
    }

    .members-count {
        margin-top: 15px;
        font-size: 0.9em;
        color: #6c757d;
    }

    .member-role-badge {
        background: #007bff;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.8em;
        font-weight: 500;
        margin-left: 10px;
    }

    .member-role-badge.owner {
        background: #28a745;
    }

    .member-role-badge.admin {
        background: #ffc107;
        color: #212529;
    }

    .member-role-badge.member {
        background: #6c757d;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .file-item {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
        
        .file-actions {
            width: 100%;
            justify-content: flex-end;
        }
        
        .share-code-display {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .file-upload-area {
            padding: 20px;
        }
    }



    .lessons-section {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .lessons-section-title {
      font-size: 1.3em;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .lesson-upload-area {
      border: 2px dashed #ddd;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      transition: border-color 0.3s ease;
    }

    .lesson-upload-area.drag-over {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .lesson-upload-form {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .form-row {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 15px;
    }

    .lesson-title-input, .lesson-date-input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    .lesson-description-input {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
      min-height: 80px;
      resize: vertical;
    }

    .lesson-upload-input {
      display: none;
    }

    .lesson-upload-label {
      display: block;
      padding: 20px;
      border: 2px dashed #ccc;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .lesson-upload-label:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .upload-lesson-button {
      padding: 12px 24px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.3s ease;
    }

    .upload-lesson-button:hover:not(:disabled) {
      background: #0056b3;
    }

    .upload-lesson-button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    /* Lesson Timeline */
    .lesson-timeline {
      margin-top: 20px;
    }

    .lesson-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .lesson-item:hover {
      background-color: #f8f9fa;
      border-color: #007bff;
    }

    .lesson-date-badge {
      background: #007bff;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      margin-right: 15px;
      min-width: 80px;
      text-align: center;
    }

    .lesson-content {
      flex: 1;
    }

    .lesson-title {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .lesson-meta {
      color: #6c757d;
      font-size: 12px;
      display: flex;
      gap: 15px;
      align-items: center;
    }

    .lesson-type-icon {
      width: 40px;
      height: 40px;
      background: #e9ecef;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      font-size: 18px;
    }

    .lesson-type-icon.video {
      background: #dc3545;
      color: white;
    }

    .lesson-type-icon.audio {
      background: #28a745;
      color: white;
    }

    .lesson-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .lesson-action-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 12px;
      transition: background 0.3s ease;
    }

    .lesson-action-btn.download {
      background: #28a745;
      color: white;
    }

    .lesson-action-btn.delete {
      background: #dc3545;
      color: white;
    }

    .lesson-action-btn:hover {
      opacity: 0.8;
    }

    /* Lesson Player Modal */
    .lesson-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .lesson-modal-content {
      background: white;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
    }

    .lesson-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid #e9ecef;
    }

    .lesson-modal-header h2 {
      margin: 0;
      font-size: 20px;
    }

    .lesson-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }

    .lesson-modal-close:hover {
      background: #f8f9fa;
    }

    .lesson-modal-body {
      padding: 20px;
    }

    #lesson-player-container {
      margin-bottom: 20px;
    }

    #lesson-player-container video,
    #lesson-player-container audio {
      width: 100%;
      border-radius: 5px;
    }

    .lesson-info {
      margin-bottom: 20px;
    }

    .lesson-stats {
      margin-top: 15px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 5px;
      font-size: 14px;
      color: #6c757d;
    }

    .no-lessons-message {
      text-align: center;
      color: #6c757d;
      padding: 40px;
      font-size: 16px;
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .lesson-item {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .lesson-date-badge {
        margin-right: 0;
        margin-bottom: 10px;
      }
      
      .lesson-modal-content {
        width: 95%;
        margin: 20px;
      }
    }



    .lesson-transcription-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .transcription-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .transcription-header h3 {
      margin: 0;
      color: #495057;
      font-size: 1.1em;
    }

    .transcription-status {
      font-size: 0.9em;
      padding: 4px 8px;
      border-radius: 4px;
      font-weight: 500;
    }

    .transcription-status.pending {
      background-color: #fff3cd;
      color: #856404;
    }

    .transcription-status.processing {
      background-color: #cce5ff;
      color: #0066cc;
      animation: pulse 2s infinite;
    }

    .transcription-status.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .transcription-status.failed {
      background-color: #f8d7da;
      color: #721c24;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    .transcription-content {
      max-height: 300px;
      overflow-y: auto;
      padding: 15px;
      background-color: white;
      border-radius: 6px;
      border: 1px solid #dee2e6;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      line-height: 1.6;
      color: #333;
    }

    .transcription-loading {
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }

    .transcription-text {
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .transcription-empty {
      text-align: center;
      color: #6c757d;
      font-style: italic;
    }

    .retry-transcription-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .retry-transcription-btn:hover {
      background-color: #0056b3;
    }

    .retry-transcription-btn:disabled {
      background-color: #6c757d;
      cursor: not-allowed;
    }

    /* Uppdaterad lesson-item för att visa transkriptionsstatus */
    .lesson-item {
      position: relative;
    }

    .lesson-transcription-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 0.8em;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 500;
    }

    .lesson-transcription-indicator.completed {
      background-color: #d4edda;
      color: #155724;
    }

    .lesson-transcription-indicator.processing {
      background-color: #cce5ff;
      color: #0066cc;
    }

    .lesson-transcription-indicator.failed {
      background-color: #f8d7da;
      
    }


    .quiz-card {
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 16px;
      background: white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: box-shadow 0.2s ease;
    }

    .quiz-card:hover {
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }

    .quiz-header {
      margin-bottom: 12px;
    }

    .quiz-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .quiz-meta {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }

    .quiz-type-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .quiz-type-badge.ten { background: #e3f2fd; color: #1976d2; }
    .quiz-type-badge.twenty-five { background: #f3e5f5; color: #7b1fa2; }
    .quiz-type-badge.fifty { background: #fff3e0; color: #f57c00; }
    .quiz-type-badge.extended-response { background: #e8f5e8; color: #388e3c; }
    .quiz-type-badge.exam { background: #ffebee; color: #d32f2f; }

    .question-count {
      font-size: 12px;
      color: #666;
      background: #f5f5f5;
      padding: 2px 6px;
      border-radius: 8px;
    }

    .personal-badge {
      font-size: 11px;
      background: #fff3cd;
      color: #856404;
      padding: 2px 6px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
    }

    .quiz-description {
      font-size: 14px;
      color: #555;
      line-height: 1.4;
      margin-bottom: 12px;
      padding: 8px 12px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 3px solid #007bff;
    }

    .quiz-info {
      margin-bottom: 12px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .created-info {
      color: #888;
      font-size: 12px;
    }

    .quiz-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .quiz-action-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .quiz-action-btn.play {
      background: #007bff;
      color: white;
      flex: 1;
    }

    .quiz-action-btn.play:hover {
      background: #0056b3;
    }

    .quiz-action-btn.delete {
      background: #dc3545;
      color: white;
      font-size: 12px;
      padding: 6px 12px;
    }

    .quiz-action-btn.delete:hover {
      background: #c82333;
    }

    .delete-form {
      margin: 0;
    }













  </style>
</head>
<body>

  <a href="{{ url_for('index') }}" class="return-button">← Return</a>

  <div class="subject-title-container">
    <div id="subject-title">
      {{ subject_name }}
      {% if user_role %}
        <span class="member-role-badge {{ user_role }}">{{ user_role.title() }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Share Section - only for owners -->
  {% if user_role == 'owner' %}
  <div class="share-section">
    <div class="share-title">📤 Share This Subject</div>
    
    <div class="share-status">
      <div class="status-indicator {{ 'active' if subject.is_shared else 'inactive' }}"></div>
      <span>Sharing is {{ 'enabled' if subject.is_shared else 'disabled' }}</span>
    </div>
    
    {% if subject.is_shared %}
    <div class="share-code-display">
      <label>Share Code:</label>
      <div class="share-code" id="share-code-display">{{ subject.share_code }}</div>
      <button class="copy-button" onclick="copyShareCode()">Copy</button>
    </div>
    {% endif %}
    
    <div style="margin-top: 15px;">
      <button class="toggle-sharing" onclick="toggleSharing()">
        {{ 'Disable Sharing' if subject.is_shared else 'Enable Sharing' }}
      </button>
      
      {% if subject.is_shared %}
      <button class="regenerate-code" onclick="regenerateCode()">
        Regenerate Code
      </button>
      {% endif %}
    </div>
    
    <div class="members-count" id="members-count">
      Loading member count...
    </div>
  </div>
  {% endif %}

  <!-- Shared Files Section -->
  <div class="shared-files-section">
    <div class="files-section-title">
      📁 Shared Files
      <span id="file-stats"></span>
    </div>

    <!-- File Upload Area - Only for owners -->
    {% if user_role == 'owner' %}
    <div class="file-upload-area" id="file-upload-area">
      <input type="file" id="file-upload-input" class="file-upload-input" multiple>
      <label for="file-upload-input" class="file-upload-label">
        Choose Files or Drag & Drop
      </label>
      <div style="margin-top: 10px; color: #6c757d;">
        Supported: PDF, DOC, DOCX, TXT, Images, Videos, Audio, Archives (Max 50MB per file)
      </div>
      <textarea id="file-description" class="file-description-input" placeholder="Optional description for the file(s)..."></textarea>
      <div id="upload-progress" class="upload-progress" style="display: none;">
        <div class="upload-progress-bar" id="progress-bar"></div>
      </div>
      <div id="upload-status" class="upload-status" style="display: none;"></div>
    </div>
    {% endif %}

    <!-- File List -->
    <div class="file-list" id="file-list">
      <div class="no-files-message" id="no-files-message">
        Loading files...
      </div>
    </div>

    <!-- File Statistics for owners -->
    {% if user_role == 'owner' %}
    <div class="file-stats" id="file-stats-details" style="display: none;">
    </div>
    {% endif %}
  </div>

  <div class="main-layout">
    <div class="quiz-container">
      {% if quizzes %}
        <div class="quiz-grid">
          
          {% for quiz in quizzes %}
          <div class="quiz-card">
            <div class="quiz-header">
              <div class="quiz-title">
                {{ quiz.title }}
              </div>

              <!-- Quiz-typ och antal frågor -->
              <div class="quiz-meta">
                <span class="question-count">
                  {{ quiz.question_count }} frågor
                </span>
                {% if quiz.is_personal %}
                <span class="personal-badge">Personlig</span>
                {% endif %}
              </div>
            </div>

            <!-- Quiz beskrivning med expand-funktionalitet -->
            {% if quiz.display_description %}
            <div class="quiz-description-container">
              <div class="quiz-description" data-full-text="{{ quiz.display_description }}">
                <span class="description-text">{{ quiz.display_description[:100] }}{% if quiz.display_description|length > 100 %}...{% endif %}</span>
                {% if quiz.display_description|length > 100 %}
                <button class="expand-description-btn" onclick="toggleDescription(this)">
                  <span class="expand-text">+</span>
                  <span class="collapse-text" style="display: none;">-</span>
                </button>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <!-- Quiz info och actions - alla inuti kortet -->
            <div class="quiz-info">
              <small class="created-info">
                Skapad {{ quiz.created_at[:10] if quiz.created_at else 'Okänt datum' }}
                {% if quiz.user_id != current_user.id %}
                  av annan användare
                {% endif %}
              </small>

              <!-- Delete-knappen (endast för quiz-ägaren) -->
              <div class="quiz-actions">
                {% if quiz.user_id == current_user.id %}
                <form method="POST"
                      action="{{ url_for('delete_quiz',
                                        subject_name=subject_name,
                                        quiz_index=loop.index0) }}"
                      class="delete-form"
                      onsubmit="return confirm('Är du säker på att du vill ta bort detta quiz?');">
                    <button type="submit" class="quiz-action-btn delete">Ta bort</button>
                </form>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}

        </div>
        {% else %}
        <p>No quizzes available for this subject yet.</p>
      {% endif %}
    </div>

    <!-- Lessons Section -->
    <div class="lessons-section">
      <div class="lessons-section-title">
        🎥 Lektioner
        <span id="lesson-stats"></span>
      </div>

      <!-- Lesson Upload Area - Only for owners -->
      {% if user_role == 'owner' %}
      <div class="lesson-upload-area" id="lesson-upload-area">
        <div class="lesson-upload-form">
          <div class="form-row">
            <input type="text" id="lesson-title" class="lesson-title-input" placeholder="Lektionstitel *" required>
            <input type="date" id="lesson-date" class="lesson-date-input" required>
          </div>
      
          <textarea id="lesson-description" class="lesson-description-input" placeholder="Beskrivning av lektionen (valfritt)..."></textarea>
      
          <input type="file" id="lesson-upload-input" class="lesson-upload-input" accept="video/*,audio/*">
          <label for="lesson-upload-input" class="lesson-upload-label">
            Välj Video/Ljudfil eller Drag & Drop
          </label>
      
          <div style="margin-top: 10px; color: #6c757d;">
            Video: MP4, AVI, MOV, WMV, WebM | Audio: MP3, WAV, AAC, OGG (Max 500MB)
          </div>
      
          <button id="upload-lesson-btn" class="upload-lesson-button" disabled>
            Ladda upp Lektion
          </button>
      
          <div id="lesson-upload-progress" class="upload-progress" style="display: none;">
            <div class="upload-progress-bar" id="lesson-progress-bar"></div>
          </div>
      
          <div id="lesson-upload-status" class="upload-status" style="display: none;"></div>
        </div>
      </div>
      {% endif %}

      <!-- Lesson Timeline -->
      <div class="lesson-timeline" id="lesson-timeline">
        <div class="no-lessons-message" id="no-lessons-message">
          Loading lessons...
        </div>
      </div>

      <!-- Lesson Statistics for owners -->
      {% if user_role == 'owner' %}
      <div class="lesson-stats" id="lesson-stats-details" style="display: none;">
      </div>
      {% endif %}
    </div>

    <!-- Lesson Player Modal -->
    <div id="lesson-player-modal" class="lesson-modal" style="display: none;">
      <div class="lesson-modal-content">
        <div class="lesson-modal-header">
          <h2 id="lesson-player-title"></h2>
          <button class="lesson-modal-close" onclick="closeLessonPlayer()">&times;</button>
        </div>

        <div class="lesson-modal-body">
          <div id="lesson-player-container">
            <!-- Video/Audio player will be inserted here -->
          </div>
  
          <div class="lesson-info">
            <div id="lesson-player-description"></div>
            <div class="lesson-meta">
              <span id="lesson-player-date"></span>
              <span id="lesson-player-views"></span>
              <span id="lesson-player-size"></span>
            </div>
          </div>

          <!-- Transkriptions-sektion -->
          <div class="lesson-transcription-section">
            <div class="transcription-header">
              <h3>📝 Transkription</h3>
              <span id="transcription-status" class="transcription-status"></span>
            </div>
            <div id="transcription-content" class="transcription-content">
              <div class="transcription-loading">Laddar transkription...</div>
            </div>
            <button id="retry-transcription-btn" class="retry-transcription-btn" style="display: none;" onclick="retryTranscription()">
              Försök igen
            </button>
          </div>
  
          <div class="lesson-actions">
            <a id="lesson-download-link" class="lesson-action-btn download">Ladda ner</a>
            <button id="lesson-delete-btn" class="lesson-action-btn delete" style="display: none;" onclick="deleteCurrentLesson()">Ta bort</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Documents Section - Only show for owners and admins -->
    {% if user_role in ['owner', 'admin'] %}
    <div class="placeholder-panel">
      <div class="documents-section">
        <h3>Dokument</h3>

        <!-- Upload area for owners/admins -->
        <div class="upload-area">
          <input type="file" id="pdf-upload" accept=".pdf" multiple>
          <label for="pdf-upload" class="upload-label">
            Ladda upp PDF-dokument
          </label>
          
        </div>

        <div class="document-type-selector">
          <label for="document-type">Dokumenttyp:</label>
          <select id="document-type">
            <option value="begrippslista">Begreppslista</option>
            <option value="kunskapskrav">Kunskapskrav</option>
            <option value="kunskapsmal">Kunskapsmål</option>
          </select>
        </div>

        <div id="documents-container">
          {% if krav_docs %}
            {% for doc in krav_docs %}
              <div class="document-item" data-doc-type="{{ doc.doc_type }}">
                <button class="remove-document"
                        data-doc-type="{{ doc.doc_type }}"
                        data-doc-id="{{ doc.id }}">×</button>
                <div class="document-header">
                  <span class="document-title">
                    {{ doc.doc_type|capitalize }}
                  </span>
                </div>
                <div class="document-preview">
                  <!-- Iframe mot server-sparad PDF -->
                  <iframe
                    src="{{ url_for('static',
                                    filename='uploads/krav/' ~ current_user.id ~ '/' ~ subject_name ~ '/' ~ doc.doc_type ~ '.pdf') }}"
                    width="100%"
                    height="300px"
                    style="border:1px solid #ccc;"
                  ></iframe>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <p>Inga dokument uppladdade än.</p>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
    <!-- End of Documents Section -->

  </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="{{ url_for('static', filename='js/subject.js') }}"></script>
  <script>
    // Globala variabler som subject.js behöver
    const currentSubject = '{{ subject_name|safe }}';
    const currentUserId = '{{ current_user.id }}';
    const subjectId = {{ subject.id }};
    const userRole = '{{ user_role }}';
    
    // Eventuella befintliga quiz-data (för bakåtkompatibilitet)
    {% if quizzes %}
    const initialQuizzes = {{ quizzes|tojson|safe }};
    {% else %}
    const initialQuizzes = [];
    {% endif %}
    
    // Befintliga dokument (för bakåtkompatibilitet)
    {% if krav_docs %}
    const initialDocuments = {{ krav_docs|tojson|safe }};
    {% else %}
    const initialDocuments = [];
    {% endif %}

    // Share code functions
    async function copyShareCode() {
      const shareCode = document.getElementById('share-code-display').textContent;
      const copyButton = document.querySelector('.copy-button');
      
      try {
        await navigator.clipboard.writeText(shareCode);
        copyButton.textContent = 'Copied!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = shareCode;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        copyButton.textContent = 'Copied!';
        copyButton.classList.add('copied');
        
        setTimeout(() => {
          copyButton.textContent = 'Copy';
          copyButton.classList.remove('copied');
        }, 2000);
      }
    }






































    // Krav Document Management Functions
    // These handle curriculum documents (kunskapskrav, kunskapsmål, begrippslista)

    let kravUploadInProgress = false;

    // Initialize krav document functionality
    function initializeKravDocuments() {
        if (userRole !== 'owner' && userRole !== 'admin') return; // Only owners/admins can manage krav documents
        
        setupKravDocumentUpload();
        setupKravDocumentRemoval();
        loadExistingKravDocuments();
    }

    // Setup krav document upload functionality
    function setupKravDocumentUpload() {
        // Setup file input change handler
        const pdfUploadInput = document.getElementById('pdf-upload');
        if (pdfUploadInput) {
            pdfUploadInput.addEventListener('change', handleKravFileSelection);
        }
        
        // Setup document type selector
        const docTypeSelector = document.getElementById('document-type');
        if (docTypeSelector) {
            // Set default selection if needed
            if (!docTypeSelector.value) {
                docTypeSelector.value = 'begrippslista';
            }
        }
    }

    // Handle file selection for krav documents
    async function handleKravFileSelection(event) {
        const files = event.target.files;
        const docTypeSelector = document.getElementById('document-type');
        
        if (!files.length || !docTypeSelector) {
            return;
        }
        
        const selectedDocType = docTypeSelector.value;
        
        // Process each selected file
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            await uploadKravDocument(selectedDocType, file);
        }
        
        // Clear the file input after upload
        event.target.value = '';
    }

    // Upload krav document
    async function uploadKravDocument(docType, file) {
        if (kravUploadInProgress) {
            showKravStatus('Upload already in progress', 'warning');
            return;
        }
        
        // Validate file
        if (!file) {
            showKravStatus('Please select a file', 'error');
            return;
        }
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            showKravStatus('Only PDF files are allowed', 'error');
            return;
        }
        
        if (file.size > 50 * 1024 * 1024) { // 50MB limit
            showKravStatus('File too large. Maximum size is 50MB', 'error');
            return;
        }
        
        // Validate document type
        const allowedTypes = ['begrippslista', 'kunskapskrav', 'kunskapsmal'];
        if (!allowedTypes.includes(docType)) {
            showKravStatus('Invalid document type', 'error');
            return;
        }
        
        kravUploadInProgress = true;
        
        try {
            showKravStatus(`Uploading ${docType}...`, 'info');
            
            // Create form data
            const formData = new FormData();
            formData.append('file', file);
            formData.append('subject', currentSubject);
            formData.append('type', docType);
            
            // Upload with progress tracking
            const response = await uploadKravWithProgress(formData, docType);
            
            if (response.status === 'success') {
                showKravStatus(`${docType} uploaded successfully!`, 'success');
                
                // Update the documents display
                await refreshKravDocuments();
                
            } else {
                throw new Error(response.message || 'Upload failed');
            }
            
        } catch (error) {
            console.error('Krav document upload error:', error);
            showKravStatus(`Upload failed: ${error.message}`, 'error');
        } finally {
            kravUploadInProgress = false;
        }
    }

    // Upload with progress tracking
    function uploadKravWithProgress(formData, docType) {
        return new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            
            // Progress handler
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = Math.round((e.loaded / e.total) * 100);
                    showKravStatus(`Uploading ${docType}... ${percentComplete}%`, 'info');
                }
            });
            
            // Success handler
            xhr.addEventListener('load', () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        resolve(response);
                    } catch (e) {
                        reject(new Error('Invalid server response'));
                    }
                } else {
                    reject(new Error(`Server error ${xhr.status}`));
                }
            });
            
            // Error handler
            xhr.addEventListener('error', () => {
                reject(new Error('Network error during upload'));
            });
            
            // Send request
            xhr.open('POST', '/upload_krav_pdf');
            xhr.send(formData);
        });
    }

    // Setup removal functionality
    function setupKravDocumentRemoval() {
        // Use event delegation for remove buttons
        document.addEventListener('click', function(e) {
            const removeButton = e.target.closest('.remove-document');
            if (removeButton && removeButton.dataset.docType) {
                e.preventDefault();
                e.stopPropagation();
                
                const docType = removeButton.getAttribute('data-doc-type');
                const docId = removeButton.getAttribute('data-doc-id');
                
                if (docType) {
                    removeKravDocument(docType, docId);
                }
            }
        });
    }

    // Remove krav document
    async function removeKravDocument(docType, docId = null) {
        const confirmMessage = `Are you sure you want to remove the ${docType} document?`;
        if (!confirm(confirmMessage)) {
            return;
        }
        
        try {
            showKravStatus(`Removing ${docType}...`, 'info');
            
            const requestData = {
                subject: currentSubject,
                type: docType
            };
            
            if (docId) {
                requestData.document_id = docId;
            }
            
            const response = await fetch('/remove_krav_pdf', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                showKravStatus(`${docType} removed successfully!`, 'success');
                
                // Remove the document item from DOM
                const documentItem = document.querySelector(`[data-doc-type="${docType}"]`);
                if (documentItem) {
                    documentItem.style.transition = 'opacity 0.3s ease';
                    documentItem.style.opacity = '0';
                    
                    setTimeout(() => {
                        documentItem.remove();
                        
                        // Check if no documents remain
                        const remainingDocs = document.querySelectorAll('.document-item').length;
                        if (remainingDocs === 0) {
                            const container = document.getElementById('documents-container');
                            if (container) {
                                container.innerHTML = '<p>Inga dokument uppladdade än.</p>';
                            }
                        }
                    }, 300);
                }
                
            } else {
                throw new Error(data.message || 'Removal failed');
            }
            
        } catch (error) {
            console.error('Krav document removal error:', error);
            showKravStatus(`Removal failed: ${error.message}`, 'error');
        }
    }

    // Load existing krav documents
    async function loadExistingKravDocuments() {
        try {
            const response = await fetch(`/api/krav_documents/${encodeURIComponent(currentSubject)}`);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            
            if (data.status === 'success') {
                updateKravDocumentsDisplay(data.documents || []);
            } else {
                console.error('Failed to load krav documents:', data.message);
                // If API endpoint doesn't exist, try to use the initial data from template
                if (typeof initialDocuments !== 'undefined') {
                    updateKravDocumentsDisplay(initialDocuments);
                }
            }
            
        } catch (error) {
            console.error('Error loading krav documents:', error);
            // Fallback to initial data if available
            if (typeof initialDocuments !== 'undefined') {
                updateKravDocumentsDisplay(initialDocuments);
            }
        }
    }

    // Refresh krav documents display
    async function refreshKravDocuments() {
        await loadExistingKravDocuments();
    }

    // Update krav documents display
    function updateKravDocumentsDisplay(documents) {
        const container = document.getElementById('documents-container');
        if (!container) return;
        
        if (!documents || documents.length === 0) {
            container.innerHTML = '<p>Inga dokument uppladdade än.</p>';
            return;
        }
        
        const documentsHtml = documents.map(doc => {
            // Create the file URL - try multiple possible URL patterns
            let fileUrl = '';
            if (doc.file_url) {
                fileUrl = doc.file_url;
            } else if (doc.doc_type && currentSubject) {
                // Fallback to the pattern used in the template
                fileUrl = `/static/uploads/krav/${currentUserId}/${encodeURIComponent(currentSubject)}/${doc.doc_type}.pdf`;
            }
            
            return `
                <div class="document-item" data-doc-type="${escapeHtml(doc.doc_type)}">
                    ${userRole === 'owner' || userRole === 'admin' ? `
                        <button class="remove-document"
                                data-doc-type="${escapeHtml(doc.doc_type)}"
                                data-doc-id="${doc.id || ''}">×</button>
                    ` : ''}
                    <div class="document-header">
                        <span class="document-title">
                            ${escapeHtml(doc.doc_type.charAt(0).toUpperCase() + doc.doc_type.slice(1))}
                        </span>
                    </div>
                    <div class="document-preview">
                        <iframe
                            src="${escapeHtml(fileUrl)}"
                            width="100%"
                            height="300px"
                            style="border:1px solid #ccc;"
                            onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        </iframe>
                        <div style="display:none; padding:20px; text-align:center; color:#666; border:1px solid #ccc;">
                            Document could not be loaded
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        
        container.innerHTML = documentsHtml;
    }

    // Show krav status messages
    function showKravStatus(message, type = 'info') {
        // Try to use existing status div first
        let statusDiv = document.getElementById('krav-upload-status');
        
        // If no dedicated krav status div, create one
        if (!statusDiv) {
            statusDiv = document.createElement('div');
            statusDiv.id = 'krav-upload-status';
            statusDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 10px 15px;
                border-radius: 4px;
                z-index: 1000;
                max-width: 300px;
                font-weight: 500;
                display: none;
            `;
            document.body.appendChild(statusDiv);
        }
        
        // Set colors based on type
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
        
        const color = colors[type] || colors.info;
        statusDiv.style.backgroundColor = color.bg;
        statusDiv.style.borderLeft = `4px solid ${color.border}`;
        statusDiv.style.color = color.text;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
        
        // Auto-hide after delay
        const hideDelay = (type === 'error') ? 5000 : 3000;
        setTimeout(() => {
            if (statusDiv.style.display === 'block') {
                statusDiv.style.display = 'none';
            }
        }, hideDelay);
    }

    // Utility function to escape HTML (reuse existing if available)
    function escapeHtml(text) {
        if (typeof window.escapeHtml === 'function') {
            return window.escapeHtml(text);
        }
        
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        if (typeof userRole !== 'undefined' && (userRole === 'owner' || userRole === 'admin')) {
            initializeKravDocuments();
        }
    });

    // Export functions for external use
    if (typeof window !== 'undefined') {
        window.uploadKravDocument = uploadKravDocument;
        window.removeKravDocument = removeKravDocument;
        window.refreshKravDocuments = refreshKravDocuments;
        window.initializeKravDocuments = initializeKravDocuments;
    }






    function toggleDescription(button) {
      const descriptionDiv = button.closest('.quiz-description');
      const textSpan = descriptionDiv.querySelector('.description-text');
      const expandText = button.querySelector('.expand-text');
      const collapseText = button.querySelector('.collapse-text');
      const fullText = descriptionDiv.getAttribute('data-full-text');
  
      if (expandText.style.display !== 'none') {
        // Expandera
        textSpan.textContent = fullText;
        expandText.style.display = 'none';
        collapseText.style.display = 'inline';
        descriptionDiv.classList.add('description-expanded');
      } else {
        // Kollapsa
        textSpan.textContent = fullText.substring(0, 100) + (fullText.length > 100 ? '...' : '');
        expandText.style.display = 'inline';
        collapseText.style.display = 'none';
        descriptionDiv.classList.remove('description-expanded');
      }
    }














    async function toggleSharing() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/share`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          location.reload(); // Reload to update the UI
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error toggling sharing:', error);
        alert('Failed to toggle sharing');
      }
    }

    async function regenerateCode() {
      if (!confirm('Are you sure you want to regenerate the share code? The old code will no longer work.')) {
        return;
      }
      
      try {
        const response = await fetch(`/api/subject/${subjectId}/regenerate_code`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('share-code-display').textContent = data.share_code;
          alert('Share code regenerated successfully!');
        } else {
          alert('Error: ' + data.message);
        }
      } catch (error) {
        console.error('Error regenerating code:', error);
        alert('Failed to regenerate code');
      }
    }

    // Load member count
    async function loadMemberCount() {
      try {
        const response = await fetch(`/api/subject/${subjectId}/members`);
        const data = await response.json();
        
        if (data.status === 'success') {
          document.getElementById('members-count').textContent = 
            `👥 ${data.total_members} member${data.total_members !== 1 ? 's' : ''}`;
        }
      } catch (error) {
        console.error('Error loading member count:', error);
        document.getElementById('members-count').textContent = '👥 Member count unavailable';
      }
    }

    // File sharing functions
    async function loadSharedFiles() {
      try {
        const url = `/api/shared_files/${encodeURIComponent(currentSubject)}?_=${Date.now()}`;
        const response = await fetch(url, { cache: 'no-store' });
        const data = await response.json();
        if (data.status === 'success') {
          displayFiles(data.files);
          updateFileStats(data.total_files);
        } else {
          showNoFilesMessage(data.message);
        }
      } catch (error) {
        console.error('Error loading shared files:', error);
        showNoFilesMessage('Failed to load files');
      }
    }


    function displayFiles(files) {
      const fileList = document.getElementById('file-list');
      const noFilesMessage = document.getElementById('no-files-message');
      
      if (files.length === 0) {
        noFilesMessage.style.display = 'block';
        noFilesMessage.textContent = 'No files have been shared yet.';
        fileList.innerHTML = '';
        return;
      }
      
      noFilesMessage.style.display = 'none';
      fileList.innerHTML = '';
      
      files.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.setAttribute('data-file-id', file.id);
        fileItem.innerHTML = `
          <div class="file-info">
            <div class="file-name">
              ${file.filename}
              <span class="file-extension">${file.extension.toUpperCase()}</span>
              <span class="file-download-count">↓ ${file.download_count}</span>
            </div>
            <div class="file-meta">
              ${file.file_size} • Uploaded by ${file.uploader} • ${file.created_at}
            </div>
            ${file.description ? `<div class="file-description">${file.description}</div>` : ''}
          </div>
          <div class="file-actions">
            <a href="/download_shared_file/${file.id}" class="download-btn">Download</a>
            ${file.can_delete ? `<button class="delete-file-btn" onclick="deleteFile(${file.id})">×</button>` : ''}
          </div>
        `;
        fileList.appendChild(fileItem);
      });
    }

    function showNoFilesMessage(message) {
      const noFilesMessage = document.getElementById('no-files-message');
      const fileList = document.getElementById('file-list');
      noFilesMessage.style.display = 'block';
      noFilesMessage.textContent = message;
      fileList.innerHTML = '';
    }

    function updateFileStats(totalFiles) {
      const fileStats = document.getElementById('file-stats');
      if (fileStats) {
        fileStats.textContent = `(${totalFiles} file${totalFiles !== 1 ? 's' : ''})`;
      }
    }

    // FIXED: Delete file function - properly removes from DOM
    async function deleteFile(fileId) {
      if (!confirm('Are you sure you want to delete this file?')) {
        return;
      }
      
      try {
        const response = await fetch('/delete_shared_file', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            file_id: fileId
          })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
          // FIXED: Remove the file item from DOM immediately
          const fileItem = document.querySelector(`[data-file-id="${fileId}"]`);
          if (fileItem) {
            // Add fade-out animation
            fileItem.style.transition = 'opacity 0.3s ease';
            fileItem.style.opacity = '0';
            
            // Remove after animation
            setTimeout(() => {
              fileItem.remove();
              
              // Update file count after removal
              const remainingFiles = document.querySelectorAll('.file-item').length;
              updateFileStats(remainingFiles);
              
              // Show no files message if no files left
              if (remainingFiles === 0) {
                showNoFilesMessage('No files have been shared yet.');
              }
            }, 300);
          }
          
          showUploadStatus('File deleted successfully!', 'success');
          
          // Update file statistics for owners
          if (userRole === 'owner') {
            loadFileStats();
          }
        } else {
          showUploadStatus('Error: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting file:', error);
        showUploadStatus('Succeded to delete file', 'error');
      }
    }

    function showUploadStatus(message, type) {
      const statusDiv = document.getElementById('upload-status');
      if (!statusDiv) return;
      
      statusDiv.textContent = message;
      statusDiv.className = `upload-status ${type}`;
      statusDiv.style.display = 'block';
      
      // Auto-hide success/info messages after 3 seconds, errors after 5 seconds
      const hideDelay = (type === 'error') ? 5000 : 3000;
      setTimeout(() => {
        if (statusDiv.style.display === 'block') {
          statusDiv.style.display = 'none';
        }
      }, hideDelay);
    }

    // COMPLETELY REWRITTEN FILE UPLOAD SYSTEM
    if (userRole === 'owner') {
      // Elementreferenser
      const fileInput    = document.getElementById('file-upload-input');
      const uploadArea   = document.getElementById('file-upload-area');
      const progressBar  = document.getElementById('progress-bar');
      const progressDiv  = document.getElementById('upload-progress');
      const descriptionInput = document.getElementById('file-description');

      let uploadInProgress = false;
      let abortController  = null;

      // Gemensam hanterare för både drag & drop + filval
      function handleFiles(files) {
        if (uploadInProgress || files.length === 0) return;
        startUpload(files);
      }

      // Drag‑over och drag‑leave
      uploadArea.addEventListener('dragover', e => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
      uploadArea.addEventListener('dragleave', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
      });

      // Drop: hämta filerna och skicka dem
      uploadArea.addEventListener('drop', e => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
        handleFiles(Array.from(e.dataTransfer.files));
      });

      // Filval via knapp
      fileInput.addEventListener('change', e => {
        handleFiles(Array.from(e.target.files));
      });

      async function startUpload(files) {
        uploadInProgress = true;
        abortController  = new AbortController();
        const desc       = descriptionInput.value.trim();

        progressDiv.style.display = 'block';
        progressBar.style.width   = '0%';
        showUploadStatus('Förbereder uppladdning…', 'info');

        let success = 0, fail = 0;
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (file.size > 50 * 1024 * 1024) {
            showUploadStatus(`"${file.name}" är för stor (>50MB)`, 'error');
            fail++;
            continue;
          }
          try {
            await uploadSingle(file, desc, i+1, files.length);
            success++;
          } catch (err) {
            showUploadStatus(`Misslyckades: "${file.name}" – ${err.message}`, 'error');
            fail++;
          }
          if (abortController.signal.aborted) break;
        }

        const msg = success
          ? `Uppladdade ${success} fil${success>1?'er':''}` + (fail? `, ${fail} misslyckades` : '')
          : 'Inga filer laddades upp';
        showUploadStatus(msg, success && !fail ? 'success' : 'warning');

        // --- Rensa gamla och visa riktig placeholder med korrekt id ---
        const fileList = document.getElementById('file-list');
        fileList.innerHTML = '<div id="no-files-message">Laddar filer…</div>';

        // Försök hämta om filerna – ta bort placeholder i finally-blocket
        try {
          await loadSharedFiles();
        } catch (e) {
          console.error('loadSharedFiles failed:', e);
        } finally {
          const placeholder = document.getElementById('no-files-message');
          if (placeholder) placeholder.remove();
        }

        // Återställ input & progress
        fileInput.value        = '';
        descriptionInput.value = '';
        setTimeout(() => {
          progressDiv.style.display = 'none';
          progressBar.style.width   = '0%';
          uploadInProgress          = false;
          abortController           = null;
        }, 800);
      }



      function uploadSingle(file, description, index, total) {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          const form = new FormData();
          form.append('file', file);
          form.append('subject', currentSubject);
          form.append('description', description);

          // Avbryt-stöd
          abortController.signal.addEventListener('abort', () => {
            xhr.abort();
            reject(new Error('Avbrutet'));
          });

          // Progress
          xhr.upload.onprogress = e => {
            if (e.lengthComputable) {
              const pct = Math.round((e.loaded/e.total)*100);
              progressBar.style.width = pct + '%';
              showUploadStatus(`Uppladdar ${index}/${total}: ${file.name} (${pct}%)`, 'info');
            }
          };

          // Klart
          xhr.onload = () => {
            if (xhr.status === 200) {
              const resp = JSON.parse(xhr.responseText);
              if (resp.status==='success') return resolve();
              else return reject(new Error(resp.message||'Server avvisade'));
            }
            reject(new Error(`Serverfel ${xhr.status}`));
          };
          xhr.onerror = () => reject(new Error('Nätverksfel'));
          xhr.timeout = 300000;

          xhr.open('POST','/upload_shared_file');
          xhr.send(form);
        });
      }

      // Load file statistics for owners
      async function loadFileStats() {
        try {
          const response = await fetch(`/api/shared_files/${subjectId}/stats`);
          const data = await response.json();
          
          if (data.status === 'success') {
            const statsDiv = document.getElementById('file-stats-details');
            if (statsDiv) {
              statsDiv.innerHTML = `
                📊 Total files: ${data.total_files} • Total downloads: ${data.total_downloads}
              `;
              statsDiv.style.display = 'block';
            }
          }
        } catch (error) {
          console.error('Error loading file stats:', error);
        }
      }
      
      loadFileStats();
    }



    // Load member count when page loads
    if (userRole === 'owner') {
      loadMemberCount();
    }
    
    // Load shared files when page loads
    loadSharedFiles();
























    // Lesson management variables
    let currentLesson = null;
    let lessons = [];

    // Initialize lesson functionality
    document.addEventListener('DOMContentLoaded', function() {
      if (userRole === 'owner') {
        initializeLessonUpload();
        loadLessonStats();
      }
      loadLessons();
    });

    function initializeLessonUpload() {
      const titleInput = document.getElementById('lesson-title');
      const dateInput = document.getElementById('lesson-date');
      const fileInput = document.getElementById('lesson-upload-input');
      const uploadBtn = document.getElementById('upload-lesson-btn');
      const uploadArea = document.getElementById('lesson-upload-area');
  
      // Set default date to today
      dateInput.valueAsDate = new Date();
  
      // Enable upload button when all required fields are filled
      function checkFormValidity() {
        const title = titleInput.value.trim();
        const date = dateInput.value;
        const file = fileInput.files[0];
    
        uploadBtn.disabled = !(title && date && file);
      }
  
      titleInput.addEventListener('input', checkFormValidity);
      dateInput.addEventListener('change', checkFormValidity);
      fileInput.addEventListener('change', checkFormValidity);
  
      // Drag and drop functionality
      uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('drag-over');
      });
  
      uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('drag-over');
      });
  
      uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('drag-over');
    
        const files = Array.from(e.dataTransfer.files);
        if (files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          checkFormValidity();
        }
      });
  
      // Upload button click handler
      uploadBtn.addEventListener('click', uploadLesson);
    }

    // Uppdaterad uploadLesson-funktion
    async function uploadLesson() {
        const titleInput = document.getElementById('lesson-title');
        const dateInput = document.getElementById('lesson-date');
        const descriptionInput = document.getElementById('lesson-description');
        const fileInput = document.getElementById('lesson-upload-input');
        const uploadBtn = document.getElementById('upload-lesson-btn');
        const progressDiv = document.getElementById('lesson-upload-progress');
        const progressBar = document.getElementById('lesson-progress-bar');
        const statusDiv = document.getElementById('lesson-upload-status');

        const title = titleInput.value.trim();
        const date = dateInput.value;
        const description = descriptionInput.value.trim();
        const file = fileInput.files[0];

        if (!title || !date || !file) {
            showAlert('Vänligen fyll i alla obligatoriska fält', 'error');
            return;
        }

        // File size check (500MB limit)
        if (file.size > 500 * 1024 * 1024) {
            showAlert('Filen är för stor. Max storlek är 500MB.', 'error');
            return;
        }

        // Kontrollera att subjectId är definierat
        if (!subjectId) {
            showAlert('Kunde inte identifiera ämne', 'error');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('subject_id', subjectId);
        formData.append('title', title);
        formData.append('lesson_date', date);
        if (description) {
            formData.append('description', description);
        }

        // Debug: logga FormData innehåll
        console.log('FormData contents:');
        for (let [key, value] of formData.entries()) {
            console.log(key, ':', value instanceof File ? `File: ${value.name}` : value);
        }

        // Show progress
        uploadBtn.disabled = true;
        progressDiv.style.display = 'block';
        statusDiv.style.display = 'block';
        statusDiv.textContent = 'Laddar upp...';
        statusDiv.className = 'upload-status';

        try {
            const xhr = new XMLHttpRequest();

            // Upload progress
            xhr.upload.addEventListener('progress', (e) => {
                if (e.lengthComputable) {
                    const percentComplete = (e.loaded / e.total) * 100;
                    progressBar.style.width = percentComplete + '%';
                    statusDiv.textContent = `Laddar upp... ${Math.round(percentComplete)}%`;
                }
            });

            // Handle response
            xhr.addEventListener('load', () => {
                console.log('XHR response status:', xhr.status);
                console.log('XHR response text:', xhr.responseText);
            
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.status === 'success') {
                            statusDiv.textContent = 'Uppladdning slutförd!';
                            statusDiv.className = 'upload-status success';

                            // Reset form
                            titleInput.value = '';
                            descriptionInput.value = '';
                            fileInput.value = '';
                            dateInput.valueAsDate = new Date();

                            // Reload lessons
                            loadLessons();
                            if (userRole === 'owner') {
                                loadLessonStats();
                            }

                            showAlert('Lektion uppladdad!', 'success');
                        } else {
                            throw new Error(response.message || 'Uppladdning misslyckades');
                        }
                    } catch (e) {
                        throw new Error('Invalid server response: ' + xhr.responseText.substring(0, 100));
                    }
                } else if (xhr.status === 404) {
                    throw new Error('Upload endpoint not found. Check your Flask routes.');
                } else {
                    throw new Error(`Server error ${xhr.status}: ${xhr.statusText}`);
                }
            });

            xhr.addEventListener('error', (e) => {
                console.error('XHR error:', e);
                throw new Error('Nätverksfel vid uppladdning');
            });

            console.log('Sending XHR request to /upload_lesson');
            xhr.open('POST', '/upload_lesson');
            xhr.send(formData);

        } catch (error) {
            console.error('Upload error:', error);
            statusDiv.textContent = 'Fel vid uppladdning: ' + error.message;
            statusDiv.className = 'upload-status error';
            showAlert('Fel vid uppladdning: ' + error.message, 'error');
        } finally {
            // Hide progress after a delay
            setTimeout(() => {
                progressDiv.style.display = 'none';
                statusDiv.style.display = 'none';
                uploadBtn.disabled = false;
                progressBar.style.width = '0%';
            }, 3000);
        }
    }













    async function loadLessons() {
        try {
            console.log('Loading lessons for subject:', subjectId);
            const response = await fetch(`/api/lessons/${subjectId}`);
        
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
        
            const text = await response.text();
            console.log('Response text:', text);
        
            let data;
            try {
                data = JSON.parse(text);
            } catch (e) {
                throw new Error('Server returned invalid JSON: ' + text.substring(0, 100));
            }
        
            if (data.status === 'success') {
                lessons = data.lessons;
                renderLessons(lessons);
                console.log('Successfully loaded', lessons.length, 'lessons');
            } else {
                throw new Error(data.message || 'Kunde inte ladda lektioner');
            }
        } catch (error) {
            console.error('Error loading lessons:', error);
            const timeline = document.getElementById('lesson-timeline');
            if (timeline) {
                timeline.innerHTML = `
                    <div class="no-lessons-message error">
                        Fel vid laddning av lektioner: ${error.message}
                    </div>
                `;
            }
            showAlert('Kunde inte ladda lektioner: ' + error.message, 'error');
        }
    }




    document.addEventListener('DOMContentLoaded', function() {
      // Stäng modal vid klick utanför innehållet
      const modal = document.getElementById('lesson-player-modal');
      if (modal) {
        modal.addEventListener('click', function(e) {
          if (e.target === modal) {
            closeLessonPlayer();
          }
        });
      }
  
      // Stäng modal med Escape-tangent
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      });
    });





    let transcriptionCheckInterval = null;

    function startTranscriptionCheck(lessonId) {  
  if (transcriptionCheckInterval) {
    clearInterval(transcriptionCheckInterval);
  }

  let checkCount = 0;
  const maxChecks = 30; // Maximal 5 minuter (30 * 10 sekunder)

  transcriptionCheckInterval = setInterval(async () => {
    checkCount++;
    
    if (checkCount > maxChecks) {
      console.log('Transcription check timeout - stopping polling');
      clearInterval(transcriptionCheckInterval);
      transcriptionCheckInterval = null;
      return;
    }

    if (currentLesson && currentLesson.id === lessonId) {
      await loadTranscription(lessonId);
  
      // Stop the interval if transcription is completed or failed
      const statusSpan = document.getElementById('transcription-status');
      if (statusSpan) {
        const status = statusSpan.className;
        if (status.includes('completed') || status.includes('failed')) {
          clearInterval(transcriptionCheckInterval);
          transcriptionCheckInterval = null;
        }
      }
    } else {
      // Stop the interval if lesson is no longer active
      clearInterval(transcriptionCheckInterval);
      transcriptionCheckInterval = null;
    }
  }, 10000); // Check every 10 seconds
}










    function renderLessons(lessonsData) {
      const timeline = document.getElementById('lesson-timeline');

      if (!lessonsData || lessonsData.length === 0) {
        timeline.innerHTML = `
          <div class="no-lessons-message">
            Inga lektioner har lagts till än.
          </div>
        `;
        return;
      }

      const lessonsHtml = lessonsData.map(lesson => {
        const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
        const isAudio = lesson.file_type && lesson.file_type.startsWith('audio/');
        const iconClass = isVideo ? 'video' : isAudio ? 'audio' : '';
        const icon = isVideo ? '🎥' : isAudio ? '🎵' : '📁';

        const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
          day: 'numeric',
          month: 'short'
        });

        // Transkriptionsstatus-indikator
        let transcriptionIndicator = '';
        if (lesson.transcription_status === 'completed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator completed">📝 Transkriberad</div>';
        } else if (lesson.transcription_status === 'processing') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator processing">⏳ Transkriberar...</div>';
        } else if (lesson.transcription_status === 'failed') {
          transcriptionIndicator = '<div class="lesson-transcription-indicator failed">❌ Transkription misslyckades</div>';
        }

        return `
          <div class="lesson-item" onclick="openLessonPlayer(${lesson.id})">
            <div class="lesson-date-badge">${formattedDate}</div>
            <div class="lesson-type-icon ${iconClass}">${icon}</div>
            ${transcriptionIndicator}
            <div class="lesson-content">
              <div class="lesson-title">${escapeHtml(lesson.title)}</div>
              <div class="lesson-meta">
                <span>📁 ${lesson.display_size}</span>
                <span>
              </div>
            </div>
            ${lesson.can_edit ? `
              <div class="lesson-actions" onclick="event.stopPropagation()">
                <button class="lesson-action-btn delete" onclick="deleteLesson(${lesson.id})">
                  Ta bort
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }).join('');

      timeline.innerHTML = lessonsHtml;
    }






    async function openLessonPlayer(lessonId) {
  try {
    const lesson = lessons.find(l => l.id === lessonId);
    if (!lesson) {
      showAlert('Lektion hittades inte', 'error');
      return;
    }

    currentLesson = lesson;

    // Update modal content
    document.getElementById('lesson-player-title').textContent = lesson.title;
    document.getElementById('lesson-player-description').textContent = lesson.description || '';

    const formattedDate = new Date(lesson.lesson_date).toLocaleDateString('sv-SE', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    })

    document.getElementById('lesson-player-date').textContent = `📅 ${formattedDate}`;
    document.getElementById('lesson-player-size').textContent = `📁 ${lesson.display_size}`;

    // Create player
    const playerContainer = document.getElementById('lesson-player-container');
    const isVideo = lesson.file_type && lesson.file_type.startsWith('video/');
    const streamUrl = `/stream_lesson/${lesson.id}`;

    if (isVideo) {
      playerContainer.innerHTML = `
        <video controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbläsare stöder inte video.
        </video>
      `;
    } else {
      playerContainer.innerHTML = `
        <audio controls preload="metadata">
          <source src="${streamUrl}" type="${lesson.file_type}">
          Din webbläsare stöder inte ljud.
        </audio>
      `;
    }

    // Setup download link
    const downloadLink = document.getElementById('lesson-download-link');
    downloadLink.href = `/download_lesson/${lesson.id}`;
    downloadLink.download = lesson.filename;

    // Show/hide delete button
    const deleteBtn = document.getElementById('lesson-delete-btn');
    if (lesson.can_edit) {
      deleteBtn.style.display = 'inline-block';
    } else {
      deleteBtn.style.display = 'none';
    }

    // FIXED: Load transcription with proper function name
    await loadTranscription(lesson.id);
    
    // Start auto-refresh if transcription is processing
    if (lesson.transcription_status === 'processing' || lesson.transcription_status === 'pending') {
      startTranscriptionCheck(lesson.id);
    }

    // Show modal
    document.getElementById('lesson-player-modal').style.display = 'flex';

  } catch (error) {
    console.error('Error opening lesson player:', error);
    showAlert('Kunde inte öppna lektion: ' + error.message, 'error');
  }
}








    // Function to add transcription search functionality
function addTranscriptionSearch() {
  const transcriptionSection = document.querySelector('.lesson-transcription-section');
  if (!transcriptionSection) return;

  // Check if search already exists
  if (document.getElementById('transcription-search-input')) return;

  const searchHtml = `
    <div class="transcription-search" style="margin-bottom: 10px;">
      <input type="text" id="transcription-search-input" placeholder="Sök i transkription..." 
            style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
    </div>
  `;

  const header = transcriptionSection.querySelector('.transcription-header');
  if (header) {
    header.insertAdjacentHTML('afterend', searchHtml);

    // Add search functionality
    const searchInput = document.getElementById('transcription-search-input');
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        highlightTranscriptionText(this.value);
      });
    }
  }
}

function highlightTranscriptionText(searchTerm) {
  const transcriptionText = document.querySelector('.transcription-text');
  if (!transcriptionText || !searchTerm) {
    if (transcriptionText) {
      // Reset highlighting if no search term
      const originalText = transcriptionText.getAttribute('data-original-text');
      if (originalText) {
        transcriptionText.innerHTML = escapeHtml(originalText);
      }
    }
    return;
  }

  // Store original text if not already stored
  if (!transcriptionText.getAttribute('data-original-text')) {
    transcriptionText.setAttribute('data-original-text', transcriptionText.textContent || transcriptionText.innerText);
  }

  const originalText = transcriptionText.getAttribute('data-original-text');
  if (!originalText) return;

  if (searchTerm.trim() === '') {
    transcriptionText.innerHTML = escapeHtml(originalText);
    return;
  }

  const regex = new RegExp(`(${escapeRegExp(searchTerm)})`, 'gi');
  const highlightedText = escapeHtml(originalText).replace(regex, '<mark style="background-color: yellow; padding: 2px;">$1</mark>');
  transcriptionText.innerHTML = highlightedText;
}

function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

    // Export functions if using modules (optional)
    if (typeof module !== 'undefined' && module.exports) {
      module.exports = {
        loadTranscription,
        retryTranscription,
        openLessonPlayer,
        closeLessonPlayer,
        deleteCurrentLesson,
        deleteLesson,
        renderLessons,
        getTranscriptionStatusText
      };
    }












    function formatTranscriptionText(text) {
      if (!text) return '';
  
      // Grundläggande formatering
      return text
        .replace(/\n/g, '<br>')
        .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
        .trim();
    }


    function closeLessonPlayer() {
  const modal = document.getElementById('lesson-player-modal');
  const playerContainer = document.getElementById('lesson-player-container');

  // Stop any playing media
  const media = playerContainer.querySelector('video, audio');
  if (media) {
    media.pause();
    media.currentTime = 0;
  }

  // Clear player
  playerContainer.innerHTML = '';

  // Hide modal
  modal.style.display = 'none';
  currentLesson = null;

  // Clear any running transcription check interval
  if (transcriptionCheckInterval) {
    clearInterval(transcriptionCheckInterval);
    transcriptionCheckInterval = null;
  }
}

    async function deleteLesson(lessonId) {
      if (!confirm('Är du säker på att du vill ta bort denna lektion?')) {
        return;
      }
  
      try {
        const response = await fetch('/delete_lesson', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: lessonId
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          loadLessons();
          if (userRole === 'owner') {
            loadLessonStats();
          }
      
          // Close modal if this lesson is currently open
          if (currentLesson && currentLesson.id === lessonId) {
            closeLessonPlayer();
          }
        } else {
          throw new Error(data.message || 'Kunde inte ta bort lektion');
        }
    
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning: ' + error.message, 'error');
      }
    }


    async function debugTranscription(lessonId) {
  console.log('Testing transcription for lesson:', lessonId);
  
  try {
    const response = await fetch(`/api/lesson/${lessonId}/retranscribe`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'}
    });
    
    const result = await response.json();
    console.log('Transcription start result:', result);
    
    if (result.status === 'success') {
      startTranscriptionCheck(lessonId);
    }
  } catch (error) {
    console.error('Debug transcription error:', error);
  }
}
window.debugTranscription = debugTranscription;

    async function deleteCurrentLesson() {
      if (!currentLesson) return;
  
      const confirmDelete = confirm(`Är du säker på att du vill ta bort lektionen "${currentLesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
        method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: currentLesson.id
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          closeLessonPlayer();
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }


    // Funktion för att ta bort lektion från listan (utan att öppna player)
    async function deleteLesson(lessonId, event) {
      if (event) {
        event.stopPropagation();
      }
  
      const lesson = lessons.find(l => l.id === lessonId);
      if (!lesson) {
        showAlert('Lektion hittades inte', 'error');
        return;
      }
  
      const confirmDelete = confirm(`Är du säker på att du vill ta bort lektionen "${lesson.title}"?`);
      if (!confirmDelete) return;
  
      try {
        const response = await fetch('/delete_lesson', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            lesson_id: lessonId
          })
        });
    
        const data = await response.json();
    
        if (data.status === 'success') {
          showAlert('Lektion borttagen', 'success');
          loadLessons(); // Ladda om lektionslistan
        } else {
          showAlert('Kunde inte ta bort lektion: ' + data.message, 'error');
        }
      } catch (error) {
        console.error('Error deleting lesson:', error);
        showAlert('Fel vid borttagning av lektion', 'error');
      }
    }





    async function loadLessonStats() {
      if (userRole !== 'owner') return;
  
      try {
        const response = await fetch(`/api/lessons/${subjectId}/stats`);
        const data = await response.json();
    
        if (data.status === 'success') {
          const statsText = `(${data.total_lessons} lektioner, ${data.total_views} visningar)`;
          document.getElementById('lesson-stats').textContent = statsText;
      
          
        }
      } catch (error) {
        console.error('Error loading lesson stats:', error);
      }
    }




    async function loadTranscription(lessonId) {
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');
  const retryBtn = document.getElementById('retry-transcription-btn');

  if (!statusSpan || !contentDiv) {
    console.warn('Transcription elements not found in DOM');
    return;
  }

  try {
    const response = await fetch(`/api/lesson/${lessonId}/transcription`);
    const data = await response.json();

    console.log('Transcription data:', data); // Debug log

    if (data.status === 'success') {
      // Update status
      statusSpan.textContent = getTranscriptionStatusText(data.transcription_status);
      statusSpan.className = `transcription-status ${data.transcription_status}`;

      // Update content based on status
      if (data.transcription_status === 'completed' && data.transcription) {
        contentDiv.innerHTML = `<div class="transcription-text">${escapeHtml(data.transcription)}</div>`;
        if (retryBtn) retryBtn.style.display = 'none';
        
        // Add search functionality if transcription is completed
        addTranscriptionSearch();
        
      } else if (data.transcription_status === 'processing') {
        contentDiv.innerHTML = '<div class="transcription-loading">⏳ Transkribering pågår...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
      } else if (data.transcription_status === 'failed') {
        contentDiv.innerHTML = '<div class="transcription-empty">❌ Transkribering misslyckades</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
        
      } else if (data.transcription_status === 'pending') {
        contentDiv.innerHTML = '<div class="transcription-loading">⏳ Transkribering är schemalagd...</div>';
        if (retryBtn) retryBtn.style.display = 'none';
        
        // För pending status, försök starta transkribering automatiskt
        if (currentLesson && currentLesson.can_edit) {
          console.log('Auto-starting transcription for pending lesson');
          setTimeout(() => {
            fetch(`/api/lesson/${lessonId}/retranscribe`, {
              method: 'POST',
              headers: {'Content-Type': 'application/json'}
            }).then(response => response.json())
              .then(result => {
                if (result.status === 'success') {
                  console.log('Auto-transcription started');
                  // Starta om polling
                  startTranscriptionCheck(lessonId);
                }
              })
              .catch(err => console.log('Auto-start failed:', err));
          }, 2000); // Vänta 2 sekunder innan auto-start
        }
        
      } else {
        contentDiv.innerHTML = '<div class="transcription-empty">Ingen transkription tillgänglig</div>';
        if (retryBtn && currentLesson && currentLesson.can_edit) {
          retryBtn.style.display = 'block';
        }
      }
    } else {
      contentDiv.innerHTML = '<div class="transcription-empty">Kunde inte ladda transkription</div>';
      if (retryBtn && currentLesson && currentLesson.can_edit) {
        retryBtn.style.display = 'block';
      }
    }

  } catch (error) {
    console.error('Error loading transcription:', error);
    contentDiv.innerHTML = '<div class="transcription-empty">Fel vid laddning av transkription</div>';
    if (retryBtn && currentLesson && currentLesson.can_edit) {
      retryBtn.style.display = 'block';
    }
  }
}


    // NY: Funktion för att försöka transkribera igen
    async function retryTranscription() {
  if (!currentLesson) return;

  const retryBtn = document.getElementById('retry-transcription-btn');
  const statusSpan = document.getElementById('transcription-status');
  const contentDiv = document.getElementById('transcription-content');

  try {
    retryBtn.disabled = true;
    retryBtn.textContent = 'Startar...';

    const response = await fetch(`/api/lesson/${currentLesson.id}/retranscribe`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });

    const data = await response.json();

    if (data.status === 'success') {
      showAlert('Transkribering startad om', 'success');
      statusSpan.textContent = 'Bearbetar...';
      statusSpan.className = 'transcription-status processing';
      contentDiv.innerHTML = '<div class="transcription-loading">⏳ Transkribering pågår...</div>';
      retryBtn.style.display = 'none';
  
      // Reload lessons to update status
      loadLessons();
  
      // Start checking status again
      startTranscriptionCheck(currentLesson.id);
    } else {
      showAlert('Kunde inte starta transkribering: ' + data.message, 'error');
      retryBtn.disabled = false;
      retryBtn.textContent = 'Försök igen';
    }

  } catch (error) {
    console.error('Error retrying transcription:', error);
    showAlert('Fel vid omstart av transkribering', 'error');
    retryBtn.disabled = false;
    retryBtn.textContent = 'Försök igen';
  }
}




    // Hjälpfunktion för att få statustext
    function getTranscriptionStatusText(status) {
  switch (status) {
    case 'pending': return 'Väntar';
    case 'processing': return 'Bearbetar';
    case 'completed': return 'Klar';
    case 'failed': return 'Misslyckades';
    default: return 'Okänd';
  }
}

    // Funktion för att stänga lesson player
    function closeLessonPlayer() {
      const modal = document.getElementById('lesson-player-modal');
      modal.style.display = 'none';
  
      // Stoppa video/audio
      const playerContainer = document.getElementById('lesson-player-container');
      const video = playerContainer.querySelector('video');
      const audio = playerContainer.querySelector('audio');
  
      if (video) {
        video.pause();
        video.currentTime = 0;
      }
      if (audio) {
        audio.pause();
        audio.currentTime = 0;
      }
  
      currentLesson = null;
    }


















    function showAlert(message, type = 'info') {
        // Skapa eller använd befintligt alert-element
        let alertDiv = document.getElementById('global-alert');
        if (!alertDiv) {
            alertDiv = document.createElement('div');
            alertDiv.id = 'global-alert';
            alertDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                max-width: 400px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                font-weight: 500;
            `;
            document.body.appendChild(alertDiv);
        }
    
        // Färger baserat på typ
        const colors = {
            success: { bg: '#d4edda', border: '#c3e6cb', text: '#155724' },
            error: { bg: '#f8d7da', border: '#f5c6cb', text: '#721c24' },
            warning: { bg: '#fff3cd', border: '#ffeaa7', text: '#856404' },
            info: { bg: '#d1ecf1', border: '#bee5eb', text: '#0c5460' }
        };
    
        const color = colors[type] || colors.info;
        alertDiv.style.backgroundColor = color.bg;
        alertDiv.style.borderLeft = `4px solid ${color.border}`;
        alertDiv.style.color = color.text;
        alertDiv.textContent = message;
        alertDiv.style.display = 'block';
    
        // Dölj efter 5 sekunder
        setTimeout(() => {
            alertDiv.style.display = 'none';
        }, 5000);
    }



    // Utility function to escape HTML
    function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

    // Close modal when clicking outside
    document.addEventListener('click', function(e) {
      const modal = document.getElementById('lesson-player-modal');
      if (e.target === modal) {
        closeLessonPlayer();
      }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('lesson-player-modal');
        if (modal.style.display === 'flex') {
          closeLessonPlayer();
        }
      }
    });
























    




  </script>

</body>
</html>
